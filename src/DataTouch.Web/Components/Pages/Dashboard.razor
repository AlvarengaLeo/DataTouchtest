@page "/"
@page "/dashboard"
@attribute [Authorize]
@using DataTouch.Web.Services
@using Microsoft.JSInterop
@inject DashboardService DashboardService
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@using static DataTouch.Web.Services.DashboardService
@implements IAsyncDisposable

<PageTitle>Panel de Control - DataTouch</PageTitle>

<div class="dashboard-page">
    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER WITH DATE RANGE SELECTOR (Desktop)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="dashboard-header desktop-only">
        <div class="header-left">
            <h1 class="page-title">Panel de Control</h1>
        </div>
        <div class="header-right">
            <div class="date-selector">
                <select class="date-dropdown" @bind="_selectedDateRange" @bind:after="OnDateRangeChanged">
                    <option value="7d">Ãšltimos 7 dÃ­as</option>
                    <option value="14d">Ãšltimos 14 dÃ­as</option>
                    <option value="30d">Ãšltimos 30 dÃ­as</option>
                    <option value="90d">Ãšltimos 90 dÃ­as</option>
                </select>
                <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE HEADER (Fintech App Style)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="mobile-header">
        <div class="mobile-user">
            <div class="mobile-avatar">
                <span>@GetInitials(AuthService.GetCurrentEmail())</span>
            </div>
            <div class="mobile-user-info">
                <span class="mobile-user-name">@(AuthService.GetCurrentEmail()?.Split('@')[0] ?? "Usuario")</span>
                <span class="mobile-user-role">Panel de Control</span>
            </div>
        </div>
        <div class="mobile-actions">
            <button class="mobile-action-btn" aria-label="Buscar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <button class="mobile-action-btn" aria-label="Notificaciones">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
            </button>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE HERO CARD (Main KPI + Date Range)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="mobile-hero-card">
        <div class="hero-kpi">
            <span class="hero-value">@FormatNumber(_kpis?.TotalInteractions.Value ?? 0)</span>
            <span class="hero-label">Total Interacciones</span>
            <span class="hero-delta @((_kpis?.TotalInteractions.IsPositive ?? true) ? "positive" : "negative")">
                @FormatDelta(_kpis?.TotalInteractions.DeltaPercent ?? 0)
            </span>
        </div>
        <div class="hero-date-chips">
            <button class="date-chip @(_selectedDateRange == "7d" ? "active" : "")" 
                    @onclick='() => SetDateRange("7d")'>7d</button>
            <button class="date-chip @(_selectedDateRange == "14d" ? "active" : "")" 
                    @onclick='() => SetDateRange("14d")'>14d</button>
            <button class="date-chip @(_selectedDateRange == "30d" ? "active" : "")" 
                    @onclick='() => SetDateRange("30d")'>30d</button>
            <button class="date-chip @(_selectedDateRange == "90d" ? "active" : "")" 
                    @onclick='() => SetDateRange("90d")'>90d</button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="loading-overlay">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ROW 1: EXECUTIVE KPIs (4 Cards) - Desktop / Mini-cards Mobile
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="kpi-row">
        @* Total Interactions *@
        <div class="kpi-card">
            <div class="kpi-icon interactions">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-value">@FormatNumber(_kpis?.TotalInteractions.Value ?? 0)</span>
                <span class="kpi-label">Total Interacciones</span>
                <span class="kpi-delta @((_kpis?.TotalInteractions.IsPositive ?? true) ? "positive" : "negative")">
                    @FormatDelta(_kpis?.TotalInteractions.DeltaPercent ?? 0) vs perÃ­odo anterior
                </span>
            </div>
        </div>

        @* Leads Captured *@
        <div class="kpi-card">
            <div class="kpi-icon leads">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-value">@FormatNumber(_kpis?.LeadsCaptured.Value ?? 0)</span>
                <span class="kpi-label">Leads Capturados</span>
                <span class="kpi-delta @((_kpis?.LeadsCaptured.IsPositive ?? true) ? "positive" : "negative")">
                    @FormatDelta(_kpis?.LeadsCaptured.DeltaPercent ?? 0) vs perÃ­odo anterior
                </span>
            </div>
        </div>

        @* Meetings Booked *@
        <div class="kpi-card">
            <div class="kpi-icon meetings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-value">@FormatNumber(_kpis?.MeetingsBooked.Value ?? 0)</span>
                <span class="kpi-label">Reuniones Agendadas</span>
                <span class="kpi-delta @((_kpis?.MeetingsBooked.IsPositive ?? true) ? "positive" : "negative")">
                    @FormatDelta(_kpis?.MeetingsBooked.DeltaPercent ?? 0) vs perÃ­odo anterior
                </span>
            </div>
        </div>

        @* Conversion Rate *@
        <div class="kpi-card">
            <div class="kpi-icon conversion">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                @if (_kpis?.ConversionRate.HasData == true)
                {
                    <span class="kpi-value">@((_kpis?.ConversionRate.Value ?? 0).ToString("F1"))%</span>
                    <span class="kpi-label">Tasa de ConversiÃ³n</span>
                    <span class="kpi-delta @((_kpis?.ConversionRate.IsPositive ?? true) ? "positive" : "negative")">
                        @FormatDelta(_kpis?.ConversionRate.DeltaPercent ?? 0) vs perÃ­odo anterior
                    </span>
                }
                else
                {
                    <span class="kpi-value kpi-na">N/A</span>
                    <span class="kpi-label">Tasa de ConversiÃ³n</span>
                    <span class="kpi-sublabel">Sin interacciones en el rango seleccionado</span>
                }
            </div>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ROW 2: CHART + TOP LOCATIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="main-row">
        @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           WIDGET: Interacciones vs. Leads - Premium Redesign (Mockup Replica)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
        <div class="panel chart-panel analytics-widget @(_widgetState == WidgetState.Loading ? "loading" : "")">
            @* â”€â”€â”€ Header Row â”€â”€â”€ *@
            <div class="analytics-header">
                <div class="analytics-header-left">
                    <h2 class="analytics-title">Interacciones vs. Leads</h2>
                    <span class="analytics-subtitle">Actualizado @GetLastUpdateTimeSpanish()</span>
                </div>
                <div class="analytics-header-right">
                    @* Range Dropdown Pill (Ãºnico control de rango) *@
                    <div class="analytics-range-dropdown">
                        <button class="range-pill" @onclick="ToggleRangeDropdown">
                            <span>@GetRangeLabel()</span>
                            <svg class="chevron @(_showRangeDropdown ? "open" : "")" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        @if (_showRangeDropdown)
                        {
                            <div class="range-dropdown-menu" @onclick:stopPropagation="true">
                                <button class="range-option @(_selectedDateRange == "today" ? "selected" : "")" @onclick='() => SelectRange("today")'>Hoy</button>
                                <button class="range-option @(_selectedDateRange == "7d" ? "selected" : "")" @onclick='() => SelectRange("7d")'>Ãšltimos 7 dÃ­as</button>
                                <button class="range-option @(_selectedDateRange == "15d" ? "selected" : "")" @onclick='() => SelectRange("15d")'>Ãšltimos 15 dÃ­as</button>
                                <button class="range-option @(_selectedDateRange == "30d" ? "selected" : "")" @onclick='() => SelectRange("30d")'>Ãšltimos 30 dÃ­as</button>
                                <button class="range-option @(_selectedDateRange == "6m" ? "selected" : "")" @onclick='() => SelectRange("6m")'>Ãšltimos 6 meses</button>
                                <button class="range-option @(_selectedDateRange == "12m" ? "selected" : "")" @onclick='() => SelectRange("12m")'>Ãšltimos 12 meses</button>
                                <button class="range-option @(_selectedDateRange == "custom" ? "selected" : "")" @onclick="OpenCustomRange">Personalizado</button>
                            </div>
                        }
                    </div>
                    @* Export Menu *@
                    <div class="analytics-export">
                        <button class="export-btn" @onclick="ToggleExportMenu" title="Exportar datos">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </button>
                        @if (_showExportMenu)
                        {
                            <div class="export-dropdown">
                                <button class="export-option" @onclick="ExportToCsv">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    <span>Exportar CSV</span>
                                </button>
                                <button class="export-option" @onclick="ExportToXlsx">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    <span>Exportar XLSX</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @* â”€â”€â”€ Mobile Header (visible only on mobile) â”€â”€â”€ *@
            <div class="analytics-mobile-controls">
                <div class="mobile-range-pill full-width">
                    <button class="range-pill" @onclick="ToggleRangeDropdown">
                        <span>@GetRangeLabel()</span>
                        <svg class="chevron @(_showRangeDropdown ? "open" : "")" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            @* â”€â”€â”€ States: Loading / Empty / Error â”€â”€â”€ *@
            @if (_widgetState == WidgetState.Loading)
            {
                <div class="analytics-loading">
                    <div class="kpi-skeleton-row">
                        <div class="kpi-skeleton"></div>
                        <div class="kpi-skeleton"></div>
                        <div class="kpi-skeleton"></div>
                    </div>
                    <div class="chart-skeleton"></div>
                </div>
            }
            else if (_widgetState == WidgetState.Empty)
            {
                <div class="analytics-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 3v18h18"/>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                    </svg>
                    <span class="empty-title">No hay datos para este rango</span>
                    <span class="empty-subtitle">Intenta seleccionar un perÃ­odo diferente</span>
                    <button class="empty-cta" @onclick="ToggleRangeDropdown">Cambiar rango</button>
                </div>
            }
            else if (_widgetState == WidgetState.Error)
            {
                <div class="analytics-error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <span class="error-title">Error al cargar datos</span>
                    <button class="error-cta" @onclick="RetryLoadData">Reintentar</button>
                </div>
            }
            else
            {
                @* â”€â”€â”€ KPI Cards Row â”€â”€â”€ *@
                <div class="analytics-kpis">
                    <div class="analytics-kpi-card">
                        <span class="kpi-title">INTERACCIONES</span>
                        <span class="kpi-number">@FormatCompactNumber(GetTotalInteractions())</span>
                        <span class="kpi-change @(GetInteractionsDelta() >= 0 ? "positive" : "negative")">
                            @(GetInteractionsDelta() >= 0 ? "â†‘" : "â†“") @Math.Abs(GetInteractionsDelta()).ToString("0.#")% vs. perÃ­odo anterior
                        </span>
                    </div>
                    <div class="analytics-kpi-card">
                        <span class="kpi-title">LEADS</span>
                        <span class="kpi-number">@FormatCompactNumber(GetTotalLeads())</span>
                        <span class="kpi-change @(GetLeadsDelta() >= 0 ? "positive" : "negative")">
                            @(GetLeadsDelta() >= 0 ? "â†‘" : "â†“") @Math.Abs(GetLeadsDelta()).ToString("0.#")% vs. perÃ­odo anterior
                        </span>
                    </div>
                    <div class="analytics-kpi-card">
                        <span class="kpi-title">CONVERSIÃ“N</span>
                        <span class="kpi-number">@GetConversionRate().ToString("0.00")%</span>
                        <span class="kpi-change @(GetConversionDelta() >= 0 ? "positive" : "negative")">
                            @(GetConversionDelta() >= 0 ? "â†‘" : "â†“") @Math.Abs(GetConversionDelta()).ToString("0.#")% vs. perÃ­odo anterior
                            <span class="info-icon" title="ConversiÃ³n = Leads / Interacciones">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                            </span>
                        </span>
                    </div>
                </div>

                @* â”€â”€â”€ Bar Chart with Dual Y-Axis â”€â”€â”€ *@
                <div id="@ChartContainerId" class="analytics-chart" @onmouseleave="() => _hoveredPointIndex = -1">
                    
                    @* HTML Y-axis LEFT labels (never stretch) *@
                    <div class="chart-y-labels left">
                        @for (int i = 0; i <= 5; i++)
                        {
                            var value = i * IntStep;
                            var bottomPercent = i * 20; // 0%, 20%, 40%, 60%, 80%, 100%
                            <span class="y-label" style="bottom: @bottomPercent%;">@FormatAxisValue(value)</span>
                        }
                    </div>

                    @* HTML Y-axis RIGHT labels (never stretch) *@
                    <div class="chart-y-labels right">
                        @for (int i = 0; i <= 5; i++)
                        {
                            var value = i * LeadsStep;
                            var bottomPercent = i * 20;
                            <span class="y-label" style="bottom: @bottomPercent%;">@value</span>
                        }
                    </div>

                    @* SVG only contains bars and grid lines - NO TEXT *@
                    <svg viewBox="0 0 800 280" class="analytics-svg" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="interactionsBarGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#A78BFA" />
                                <stop offset="100%" stop-color="#8B5CF6" />
                            </linearGradient>
                            <linearGradient id="leadsBarGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stop-color="#5EEAD4" />
                                <stop offset="100%" stop-color="#2DD4BF" />
                            </linearGradient>
                        </defs>

                        @* Horizontal grid lines *@
                        @for (int i = 0; i <= 5; i++)
                        {
                            var y = 220 - i * 40;
                            <line x1="60" y1="@y" x2="740" y2="@y" class="chart-gridline" />
                        }

                        @* Bars *@
                        @{
                            var barCount = _chartData.Count;
                            var chartWidth = 660.0;
                            var groupWidth = barCount > 0 ? chartWidth / barCount : chartWidth;
                            var barW = Math.Min(38, Math.Max(18, groupWidth * 0.42));
                            var gap = 6.0;
                            var maxInt = GetDynamicMaxInteractions();
                            var leadsAxisMax = 10;
                        }
                        @for (int i = 0; i < _chartData.Count; i++)
                        {
                            var index = i;
                            var point = _chartData[i];
                            var gx = 70 + i * groupWidth + (groupWidth - (barW * 2 + gap)) / 2;

                            var intH = maxInt > 0 ? (point.Interactions * 200.0 / maxInt) : 0;
                            var leadH = leadsAxisMax > 0 ? (point.Leads * 200.0 / leadsAxisMax) : 0;

                            var intY = 220 - intH;
                            var leadY = 220 - leadH;

                            <rect x="@(gx - 5)" y="20" width="@(barW * 2 + gap + 10)" height="200"
                                  fill="transparent" @onmouseenter="() => _hoveredPointIndex = index" class="bar-hover-zone" />

                            <rect x="@gx" y="@intY.ToString("0.#")" width="@barW" height="@Math.Max(4, intH).ToString("0.#")"
                                  fill="url(#interactionsBarGradient)" rx="6" ry="6"
                                  class="chart-bar @(_hoveredPointIndex == i ? "hovered" : "")" />

                            <rect x="@(gx + barW + gap)" y="@leadY.ToString("0.#")" width="@barW" height="@Math.Max(4, leadH).ToString("0.#")"
                                  fill="url(#leadsBarGradient)" rx="6" ry="6"
                                  class="chart-bar @(_hoveredPointIndex == i ? "hovered" : "")" />
                        }

                        @* Hover highlight line *@
                        @if (_hoveredPointIndex >= 0 && _hoveredPointIndex < _chartData.Count)
                        {
                            var hx = 70 + _hoveredPointIndex * groupWidth + groupWidth / 2;
                            <line x1="@hx" y1="20" x2="@hx" y2="220" stroke="rgba(255,255,255,0.1)" stroke-width="1" stroke-dasharray="4,4" />
                        }
                    </svg>

                    @* HTML X-axis labels (never stretch) *@
                    <div class="chart-x-labels">
                        @for (int i = 0; i < _chartData.Count; i++)
                        {
                            var leftPercent = (70.0 + i * groupWidth + groupWidth / 2) / 800.0 * 100;
                            var dayLabel = _chartData[i].DayLabel;
                            <span class="x-label" style="left: @leftPercent.ToString("0.#")%;">@dayLabel</span>
                        }
                    </div>

                    @* Premium Tooltip (Weekday Aggregated) *@
                    @if (_hoveredPointIndex >= 0 && _hoveredPointIndex < _chartData.Count)
                    {
                        var point = _chartData[_hoveredPointIndex];
                        var conv = point.Interactions > 0 ? (decimal)point.Leads / point.Interactions * 100 : 0;
                        <div class="analytics-tooltip" style="left: @GetTooltipPosition(_hoveredPointIndex)%;">
                            <div class="tooltip-header">@point.DayName</div>
                            <div class="tooltip-subheader">Agrupado Â· @GetRangeLabel()</div>
                            <div class="tooltip-row">
                                <span class="tooltip-dot interactions"></span>
                                <span class="tooltip-label">@point.Interactions Interacciones</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-dot leads"></span>
                                <span class="tooltip-label">@point.Leads Leads</span>
                            </div>
                            <div class="tooltip-footer">
                                ConversiÃ³n: <strong>@conv.ToString("0.00")%</strong>
                                @if (point.OccurrenceCount > 0)
                                {
                                    <span class="tooltip-occurrences"> Â· @point.OccurrenceCount @(point.OccurrenceCount == 1 ? point.DayName.ToLower() : GetPluralDayName(point.DayName))</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                @* â”€â”€â”€ Chart Legend (al pie del widget, centrada) â”€â”€â”€ *@
                <div class="analytics-legend bottom-centered">
                    <div class="legend-item">
                        <span class="legend-dot interactions"></span>
                        <span>Interacciones</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot leads"></span>
                        <span>Leads</span>
                    </div>
                </div>

                @* â”€â”€â”€ Footer with Insights â”€â”€â”€ *@
                <div class="analytics-footer">
                    <div class="footer-insights">
                        Pico: <strong>@GetPeakDaySpanish()</strong> Â· MÃ­nimo: <strong>@GetLowestDaySpanish()</strong>
                    </div>
                </div>
            }
        </div>

        @* Top Locations *@
        <div class="panel locations-panel">
            <div class="panel-header">
                <h2 class="panel-title">Ubicaciones Principales</h2>
            </div>
            <div class="location-highlight">
                <span class="location-name">@(_topLocations?.TopLocation ?? "Cargando...")</span>
                <span class="location-delta @((_topLocations?.TopLocationDelta ?? 0) >= 0 ? "positive" : "negative")">
                    @FormatDelta(_topLocations?.TopLocationDelta ?? 0) interacciones
                    <span class="delta-arrow">@((_topLocations?.TopLocationDelta ?? 0) >= 0 ? "â†‘" : "â†“")</span> vs perÃ­odo anterior
                </span>
            </div>
            
            @* Premium Leaflet Map with Overlay *@
            <div class="map-container @(_mapExpanded ? "expanded" : "collapsed")">
                @* Top Location Pill (contextual overlay) *@
                @if (_topLocations?.HasData == true && _topLocations.TopLocation != "No data")
                {
                    <div class="map-top-pill">
                        <span class="pill-icon">ğŸ“</span>
                        <span class="pill-text">Principal: <strong>@_topLocations.TopLocation</strong></span>
                    </div>
                }
                
                @* Map Container *@
                <div id="locations-map" class="leaflet-map"></div>
                
                @* Subtle overlay for theme integration *@
                <div class="map-overlay"></div>
                
                @* Status indicators *@
                @if (_topLocations?.MapPoints?.Count == 0 || _topLocations?.HasData != true)
                {
                    <div class="map-placeholder">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>Sin datos de ubicaciÃ³n disponibles</span>
                    </div>
                }
                
                @if (_topLocations?.PendingGeoCount > 0)
                {
                    <div class="map-notice">
                        <span>ğŸŒ @_topLocations.PendingGeoCount ubicaciÃ³n(es) pendientes de geolocalizaciÃ³n</span>
                    </div>
                }
                
                @* Expand/Collapse Toggle *@
                <button class="map-toggle" @onclick="ToggleMapExpanded">
                    @(_mapExpanded ? "Contraer mapa" : "Expandir mapa")
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="@(_mapExpanded ? "rotated" : "")">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>

            @* Top Locations Section Header *@
            <div class="locations-section-header">
                <span class="section-title">Top ubicaciones</span>
                <a href="#" class="view-all-link">Ver todo ></a>
            </div>

            @* Location Table *@
            <div class="location-table">
                <div class="table-header-row">
                    <span class="col-location">UbicaciÃ³n</span>
                    <span class="col-stat">Interacciones</span>
                    <span class="col-stat">Leads</span>
                    <span class="col-stat">ConversiÃ³n</span>
                </div>
                @foreach (var loc in _topLocations?.Locations.Take(5) ?? new List<LocationData>())
                {
                    <div class="table-row">
                        <span class="col-location">@loc.Location</span>
                        <span class="col-stat">@loc.Interactions</span>
                        <span class="col-stat">@loc.Leads</span>
                        <span class="col-stat conversion">@(loc.ConversionRate.ToString("F1"))%</span>
                    </div>
                }
            </div>
            
            <div class="sort-controls">
                <span class="sort-label">Ordenar por:</span>
                <button class="sort-btn @(_locationSortBy == LocationSortBy.Conversion ? "active" : "")" 
                        @onclick="() => SetLocationSort(LocationSortBy.Conversion)">ConversiÃ³n</button>
                <button class="sort-btn @(_locationSortBy == LocationSortBy.Leads ? "active" : "")" 
                        @onclick="() => SetLocationSort(LocationSortBy.Leads)">Leads</button>
                <button class="sort-btn @(_locationSortBy == LocationSortBy.Interactions ? "active" : "")" 
                        @onclick="() => SetLocationSort(LocationSortBy.Interactions)">Interacciones</button>
            </div>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ROW 3: INSIGHTS + TOP LINKS + HIGH-INTENT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="insights-row">
        @* Insights Panel (LEFT) - NO High-Intent summary here *@
        <div class="panel insights-panel">
            <h2 class="section-title">Perspectivas</h2>
            <div class="panel-content">
                
                @* Top CTA *@
                <div class="insight-item">
                    <div class="insight-icon-wrapper @GetCtaBadgeClass(_insights?.TopCta)">
                        <IconRegistry Type="@(_insights?.HasTopCta == true ? _insights?.TopCta?.ToLowerInvariant() ?? "link" : "link")" Size="20" />
                    </div>
                    <div class="insight-content">
                        <span class="insight-label">@(_insights?.HasTopCta == true ? _insights?.TopCta : "N/A")</span>
                        <span class="insight-sublabel">CTA Principal</span>
                    </div>
                    <div class="insight-stats">
                        @if (_insights?.HasTopCta == true)
                        {
                            <span class="insight-value">@((_insights?.TopCtaConversion ?? 0).ToString("F1"))%</span>
                            <span class="insight-delta @((_insights?.TopCtaDelta ?? 0) >= 0 ? "positive" : "negative")">
                                @FormatDelta(_insights?.TopCtaDelta ?? 0) vs perÃ­odo
                            </span>
                        }
                        else
                        {
                            <span class="insight-value insight-na">â€”</span>
                            <span class="insight-sublabel">Sin clics de CTA aÃºn</span>
                        }
                    </div>
                </div>

                @* Median Time to Lead *@
                <div class="insight-item">
                    <div class="insight-icon time">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="insight-content">
                        <span class="insight-label">Tiempo Promedio a Lead</span>
                        @if (_insights?.HasMedianTime == true)
                        {
                            <span class="insight-sublabel">@((_insights?.MedianTimeDelta ?? 0) >= 0 ? "MÃ¡s lento" : "MÃ¡s rÃ¡pido") vs perÃ­odo</span>
                        }
                        else
                        {
                            <span class="insight-sublabel">Datos insuficientes</span>
                        }
                    </div>
                    <div class="insight-stats">
                        @if (_insights?.HasMedianTime == true)
                        {
                            <span class="insight-value">@(_insights?.MedianTimeToLeadMinutes ?? 0) min</span>
                            <span class="insight-delta @((_insights?.MedianTimeDelta ?? 0) <= 0 ? "positive" : "negative")">
                                @FormatDelta(Math.Abs(_insights?.MedianTimeDelta ?? 0)) vs perÃ­odo
                            </span>
                        }
                        else
                        {
                            <span class="insight-value insight-na">N/A</span>
                        }
                    </div>
                </div>

                @* Inactive Cards *@
                <div class="insight-item">
                    <div class="insight-icon inactive">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                        </svg>
                    </div>
                    <div class="insight-content">
                        <span class="insight-label">Tarjetas Inactivas: @(_insights?.InactiveCardsCount ?? 0)</span>
                        <span class="insight-sublabel">@((_insights?.InactiveCardsPercent ?? 0).ToString("F0"))% del total</span>
                    </div>
                    <div class="insight-stats">
                        <span class="insight-sublabel potential-loss">PÃ©rdida potencial: ~@(_insights?.PotentialLossInteractions ?? 0) interacciones</span>
                    </div>
                </div>
            </div>
        </div>

        @* Top Links Panel (CENTER) *@
        <div class="panel links-panel">
            <div class="panel-header">
                <h2 class="panel-title">Enlaces Principales</h2>
            </div>
            <div class="links-table">
                <div class="links-header">
                    <span class="col-link">Nombre del enlace</span>
                    <span class="col-clicks">Clics</span>
                    <span class="col-conversion">ConversiÃ³n</span>
                    <span class="col-trend">Tendencia</span>
                </div>
                @foreach (var link in _topLinks)
                {
                    <div class="link-row">
                        <div class="col-link">
                            <div class="link-icon-badge @GetLinkBadgeClass(link.LinkName)">
                                <IconRegistry Type="@link.LinkName.ToLowerInvariant()" Size="16" />
                            </div>
                            <span class="link-name">@link.LinkName</span>
                        </div>
                        <span class="col-clicks">@link.Clicks</span>
                        <div class="col-conversion">
                            <div class="conversion-bar">
                                <div class="bar-fill" style="width: @(Math.Min(100, link.ConversionRate))%"></div>
                            </div>
                            <span class="conversion-value">@(link.ConversionRate.ToString("F0"))%</span>
                        </div>
                        <span class="col-trend @(link.Trend >= 0 ? "positive" : "negative")">
                            @(link.Trend >= 0 ? "â–²" : "â–¼") @(Math.Abs(link.Trend).ToString("F0"))%
                        </span>
                    </div>
                }
            </div>

            <div class="links-actions">
                <button class="action-btn"><span class="action-icon">ğŸ“‚</span> Abrir lead</button>
                <button class="action-btn"><span class="action-icon">ğŸ‘¤</span> Asignar</button>
                <button class="action-btn"><span class="action-icon">âœ“</span> Marcar contactado</button>
                <button class="action-btn"><span class="action-icon">+</span> Crear tareas</button>
            </div>

            <div class="links-footer">
                <span class="sync-status">âŸ³ Â¡Pipeline sincronizado! Actualizado ahora</span>
                <button class="view-details-btn" @onclick="NavigateToLeads">Ver detalles</button>
            </div>
        </div>

        @* High-Intent Panel (RIGHT) - THE ONLY High-Intent location *@
        <div class="panel high-intent-panel">
            <div class="panel-header">
                <h2 class="panel-title">Alta IntenciÃ³n</h2>
                <div class="sort-dropdown">
                    <span>Ordenar por Interacciones</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
            
            <div class="high-intent-summary">
                <span class="hi-value">@(_highIntent?.TotalHighIntent ?? 0)</span>
                <div class="hi-label">
                    <span class="hi-text">Clientes</span>
                    <span class="hi-sublabel">alta intenciÃ³n en 24h</span>
                </div>
            </div>

            <div class="hi-breakdown">
                <div class="hi-item">
                    <div class="hi-icon-badge badge-contact">
                        <IconRegistry Type="contact_save" Size="16" />
                    </div>
                    <span class="hi-name">Contactos guardados</span>
                    <span class="hi-count positive">â–²@(_highIntent?.ContactsSaved ?? 0)</span>
                </div>
                <div class="hi-item">
                    <div class="hi-icon-badge badge-calendar">
                        <IconRegistry Type="calendar" Size="16" />
                    </div>
                    <span class="hi-name">Reuniones</span>
                    <span class="hi-count positive">â–²@(_highIntent?.MeetingsBooked ?? 0)</span>
                </div>
                <div class="hi-item">
                    <div class="hi-icon-badge badge-whatsapp">
                        <IconRegistry Type="whatsapp" Size="16" />
                    </div>
                    <span class="hi-name">Clics en WhatsApp</span>
                    <span class="hi-count">@(_highIntent?.WhatsAppClicks ?? 0)</span>
                </div>
                <div class="hi-item">
                    <div class="hi-icon-badge badge-call">
                        <IconRegistry Type="call" Size="16" />
                    </div>
                    <span class="hi-name">Clics en llamada</span>
                    <span class="hi-count">@(_highIntent?.CallClicks ?? 0)</span>
                </div>
            </div>

            <div class="recent-activity">
                <h4 class="activity-title">Actividad Reciente</h4>
                @foreach (var activity in _highIntent?.RecentActivities ?? new())
                {
                    <div class="activity-item @(activity.LeadId.HasValue ? "clickable" : "")" @onclick="() => NavigateToLead(activity.LeadId)">
                        <div class="activity-icon-wrapper @GetEventTypeBadgeClass(activity.EventType)">
                            <IconRegistry Type="@GetEventTypeIcon(activity.EventType)" Size="16" />
                        </div>
                        <div class="activity-content">
                            <span class="activity-name">@(activity.ContactName ?? "Contacto")</span>
                            <span class="activity-action">@activity.Description</span>
                        </div>
                        <span class="activity-time">@activity.TimeAgo</span>
                    </div>
                }
            </div>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOTTOM NAVIGATION (Mobile Only)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <nav class="mobile-bottom-nav">
        <a href="/dashboard" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Inicio</span>
        </a>
        <a href="/leads" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Leads</span>
        </a>
        <a href="/calendar" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>Agenda</span>
        </a>
        <a href="/quotes" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
            </svg>
            <span>Cotiz</span>
        </a>
        <a href="/settings/profile" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span>Perfil</span>
        </a>
    </nav>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATE RANGE PICKER MODAL (Personalizado)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    @if (_showCustomDatePicker)
    {
        <div class="date-picker-overlay" @onclick="CloseCustomDatePicker">
            <div class="date-picker-modal" @onclick:stopPropagation="true">
                <div class="date-picker-header">
                    <h3>Seleccionar rango personalizado</h3>
                    <button class="close-btn" @onclick="CloseCustomDatePicker">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="date-picker-body">
                    <div class="date-field">
                        <label>Desde</label>
                        <input type="date" @bind="_customStartDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="date-field">
                        <label>Hasta</label>
                        <input type="date" @bind="_customEndDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                    @if (_customDateError != null)
                    {
                        <div class="date-error">@_customDateError</div>
                    }
                </div>
                <div class="date-picker-footer">
                    <button class="btn-cancel" @onclick="CloseCustomDatePicker">Cancelar</button>
                    <button class="btn-accept" @onclick="ApplyCustomDateRange">Aceptar</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool _isLoading = true;
    private string _selectedDateRange = "15d";
    private bool _mapExpanded = false;
    private bool _mapInitialized = false;
    private System.Threading.Timer? _refreshTimer;
    private int _hoveredPointIndex = -1;
    private DateTime _lastDataUpdate = DateTime.UtcNow;

    // Widget state
    private enum WidgetState { Loading, Empty, Error, Ready }
    private WidgetState _widgetState = WidgetState.Loading;
    private bool _showRangeDropdown = false;
    private bool _showExportMenu = false;

    // Custom date range picker
    private bool _showCustomDatePicker = false;
    private DateTime _customStartDate = DateTime.Now.AddDays(-7);
    private DateTime _customEndDate = DateTime.Now;
    private string? _customDateError = null;
    private string? _customRangeLabel = null;

    // Data
    private DashboardKpis? _kpis;
    private List<WeekdayChartDataPoint> _chartData = new();
    private TopLocationsResult? _topLocations;
    private List<LinkPerformance> _topLinks = new();
    private InsightsData? _insights;
    private HighIntentData? _highIntent;

    // Filters
    private LocationSortBy _locationSortBy = LocationSortBy.Conversion;

    // Chart dynamic viewBox (for crisp text without distortion)
    private const string ChartContainerId = "analytics-chart-container";
    private double _chartContainerWidth = 800;
    private double _chartContainerHeight = 280;
    private DotNetObjectReference<Dashboard>? _chartResizeRef;
    private bool _chartResizeObserverInitialized = false;

    // Computed properties for dynamic viewBox scaling
    private double ChartContainerRatio => _chartContainerHeight > 0 ? _chartContainerWidth / _chartContainerHeight : 2.86;
    private double ViewBoxWidth => 800.0;
    // viewBox fijo 800x280, preserveAspectRatio='none' estira para llenar contenedor
    private double ViewBoxHeight => 280.0;
    // ScaleY para coordenadas internas (siempre 1.0 con viewBox fijo)
    private double ScaleY => 1.0;
    private double ChartTop => 20 * ScaleY;
    private double ChartBottom => 220 * ScaleY;
    private double PlotHeight => 200 * ScaleY;
    private double GridStep => 40 * ScaleY;
    private double LabelY => 225 * ScaleY;
    private double XLabelY => 250 * ScaleY;
    
    // TextScaleY: Factor inverso para corregir estiramiento de texto
    // viewBoxRatio=2.86, si containerRatio=1.26 (mobile), text se estira 2.27x
    // Este factor (containerRatio/viewBoxRatio) contraresta el estiramiento
    private double TextScaleY => ChartContainerRatio / (ViewBoxWidth / ViewBoxHeight);
    
    // Chart data computed values
    private int MaxInt => GetDynamicMaxInteractions();
    private int IntStep => MaxInt / 5;
    private int LeadsAxisMax => 10;
    private int LeadsStep => 2;
    private int BarCount => _chartData.Count;
    private double ChartWidth => 660.0;
    private double GroupWidth => BarCount > 0 ? ChartWidth / BarCount : ChartWidth;
    private double BarW => Math.Min(38, Math.Max(18, GroupWidth * 0.42));
    private double Gap => 6.0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        
        // Set up auto-refresh timer (every 30 seconds)
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadDashboardData();
                await UpdateMapMarkers();
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || (!_mapInitialized && _topLocations?.HasData == true))
        {
            await InitializeMap();
        }

        // Initialize chart ResizeObserver for dynamic viewBox
        if (firstRender && !_chartResizeObserverInitialized)
        {
            try
            {
                _chartResizeRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("chartResizeObserver.observe", ChartContainerId, _chartResizeRef);
                _chartResizeObserverInitialized = true;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Chart ResizeObserver init error: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Callback invoked by JS ResizeObserver when chart container dimensions change.
    /// Recalculates viewBox height to maintain aspect ratio and prevent text distortion.
    /// </summary>
    [JSInvokable]
    public async Task OnChartContainerResized(double width, double height)
    {
        if (width > 0 && height > 0 && (Math.Abs(_chartContainerWidth - width) > 1 || Math.Abs(_chartContainerHeight - height) > 1))
        {
            _chartContainerWidth = width;
            _chartContainerHeight = height;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task InitializeMap()
    {
        if (_topLocations == null) return;
        
        try
        {
            var centerLat = _topLocations.CenterLat ?? 13.6929;
            var centerLng = _topLocations.CenterLng ?? -89.2182;
            var zoom = _topLocations.DefaultZoom;

            var success = await JSRuntime.InvokeAsync<bool>(
                "DataTouchMap.init", 
                "locations-map", 
                centerLat, 
                centerLng, 
                zoom);

            if (success)
            {
                _mapInitialized = true;
                await UpdateMapMarkers();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Map init error: {ex.Message}");
        }
    }

    private async Task UpdateMapMarkers(bool preserveView = true)
    {
        if (!_mapInitialized || _topLocations?.MapPoints == null) return;

        try
        {
            var mapPointsData = _topLocations.MapPoints.Select(p => new
            {
                location = p.Location,
                latitude = p.Latitude,
                longitude = p.Longitude,
                weight = p.Weight,
                leads = p.Leads,
                conversionRate = p.ConversionRate,
                delta = p.Delta,
                isTopLocation = p.IsTopLocation
            }).ToArray();

            await JSRuntime.InvokeVoidAsync("DataTouchMap.updateMarkers", (object)mapPointsData, preserveView);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Map update error: {ex.Message}");
        }
    }

    private async Task ToggleMapExpanded()
    {
        _mapExpanded = !_mapExpanded;
        
        // Invalidate map size after toggle animation
        await Task.Delay(300);
        if (_mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("DataTouchMap.invalidateSize");
        }
    }

    private async Task LoadDashboardData()
    {
        _isLoading = true;
        _widgetState = WidgetState.Loading;
        StateHasChanged();

        try
        {
            var orgId = AuthService.GetCurrentOrganizationId();
            if (!orgId.HasValue)
            {
                Snackbar.Add("No se encontrÃ³ la organizaciÃ³n", Severity.Error);
                _widgetState = WidgetState.Error;
                return;
            }

            var dateRange = _selectedDateRange == "custom"
                ? DashboardService.GetCustomDateRange(_customStartDate, _customEndDate)
                : DashboardService.GetDateRangeFromOption(_selectedDateRange);

            // Load all data in parallel (chart now uses weekday aggregation)
            var kpisTask = DashboardService.GetDashboardKpisAsync(orgId.Value, dateRange);
            var chartTask = DashboardService.GetWeekdayAggregatedChartAsync(orgId.Value, dateRange);
            var locationsTask = DashboardService.GetTopLocationsAsync(orgId.Value, dateRange, _locationSortBy);
            var linksTask = DashboardService.GetTopLinksAsync(orgId.Value, dateRange);
            var insightsTask = DashboardService.GetInsightsAsync(orgId.Value, dateRange);
            var highIntentTask = DashboardService.GetHighIntentDataAsync(orgId.Value, dateRange);

            await Task.WhenAll(kpisTask, chartTask, locationsTask, linksTask, insightsTask, highIntentTask);

            _kpis = await kpisTask;
            _chartData = await chartTask;
            _topLocations = await locationsTask;
            _topLinks = await linksTask;
            _insights = await insightsTask;
            _highIntent = await highIntentTask;
            _lastDataUpdate = DateTime.UtcNow;

            // Determine widget state based on data
            if (_chartData == null || !_chartData.Any())
            {
                _widgetState = WidgetState.Empty;
            }
            else
            {
                _widgetState = WidgetState.Ready;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar dashboard: {ex.Message}", Severity.Error);
            _widgetState = WidgetState.Error;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnDateRangeChanged()
    {
        // Reset map interaction so it fits to new data
        if (_mapInitialized)
        {
            await JSRuntime.InvokeVoidAsync("DataTouchMap.resetInteraction");
        }
        
        await LoadDashboardData();
        
        // Update map with fresh fit (don't preserve view since data range changed)
        if (_mapInitialized)
        {
            await UpdateMapMarkers(preserveView: false);
        }
    }

    private async Task SetDateRange(string range)
    {
        if (_selectedDateRange == range) return;
        _selectedDateRange = range;
        await OnDateRangeChanged();
    }

    private DashboardService.DateRangeFilter GetCurrentDateRange()
    {
        return _selectedDateRange == "custom"
            ? DashboardService.GetCustomDateRange(_customStartDate, _customEndDate)
            : DashboardService.GetDateRangeFromOption(_selectedDateRange);
    }

    private async Task SetLocationSort(LocationSortBy sortBy)
    {
        if (_locationSortBy == sortBy) return;
        _locationSortBy = sortBy;

        var orgId = AuthService.GetCurrentOrganizationId();
        if (orgId.HasValue)
        {
            var dateRange = DashboardService.GetDateRangeFromOption(_selectedDateRange);
            _topLocations = await DashboardService.GetTopLocationsAsync(orgId.Value, dateRange, _locationSortBy);
            StateHasChanged();
        }
    }

    private void NavigateToLeads()
    {
        NavigationManager.NavigateTo("/leads");
    }

    private void NavigateToLead(Guid? leadId)
    {
        if (leadId.HasValue)
        {
            NavigationManager.NavigateTo($"/leads/{leadId}");
        }
    }

    #region Analytics Widget Helpers

    // Toggle dropdown menus
    private void ToggleRangeDropdown()
    {
        _showRangeDropdown = !_showRangeDropdown;
        _showExportMenu = false;
    }

    private void ToggleExportMenu()
    {
        _showExportMenu = !_showExportMenu;
        _showRangeDropdown = false;
    }

    private async Task SelectRange(string range)
    {
        _showRangeDropdown = false;
        if (_selectedDateRange == range) return;
        _selectedDateRange = range;
        await OnDateRangeChanged();
    }

    private void OpenCustomRange()
    {
        _showRangeDropdown = false;
        _customDateError = null;
        _showCustomDatePicker = true;
    }

    private void CloseCustomDatePicker()
    {
        _showCustomDatePicker = false;
        _customDateError = null;
    }

    private async Task ApplyCustomDateRange()
    {
        // ValidaciÃ³n: Hasta no puede ser menor que Desde
        if (_customEndDate < _customStartDate)
        {
            _customDateError = "La fecha 'Hasta' no puede ser anterior a 'Desde'";
            return;
        }

        // ValidaciÃ³n: No permitir fechas futuras
        if (_customEndDate > DateTime.Now || _customStartDate > DateTime.Now)
        {
            _customDateError = "No se permiten fechas futuras";
            return;
        }

        _customDateError = null;
        _selectedDateRange = "custom";
        _customRangeLabel = FormatCustomRangeLabel(_customStartDate, _customEndDate);
        _showCustomDatePicker = false;

        await OnDateRangeChanged();
    }

    private string FormatCustomRangeLabel(DateTime start, DateTime end)
    {
        var startStr = start.ToString("dd MMM", new System.Globalization.CultureInfo("es-ES"));
        var endStr = end.ToString("dd MMM", new System.Globalization.CultureInfo("es-ES"));
        return $"{startStr} â€“ {endStr}";
    }

    private string GetRangeLabel()
    {
        return _selectedDateRange switch
        {
            "today" => "Hoy",
            "7d" => "Ãšltimos 7 dÃ­as",
            "14d" => "Ãšltimos 14 dÃ­as",
            "15d" => "Ãšltimos 15 dÃ­as",
            "30d" => "Ãšltimos 30 dÃ­as",
            "90d" => "Ãšltimos 90 dÃ­as",
            "6m" => "Ãšltimos 6 meses",
            "12m" => "Ãšltimos 12 meses",
            "custom" => _customRangeLabel ?? "Personalizado",
            _ => "Ãšltimos 15 dÃ­as"
        };
    }

    private string GetLastUpdateTimeSpanish()
    {
        var diff = DateTime.UtcNow - _lastDataUpdate;
        if (diff.TotalMinutes < 1) return "hace un momento";
        if (diff.TotalMinutes < 60) return $"hace {(int)diff.TotalMinutes} min";
        return $"hace {(int)diff.TotalHours}h";
    }

    /// <summary>
    /// Returns the plural form of a weekday name in Spanish (lowercase).
    /// In Spanish, weekday names don't change for plural, just lowercase.
    /// Example: "Lunes" â†’ "lunes"
    /// </summary>
    private string GetPluralDayName(string dayName)
    {
        return dayName.ToLower();
    }

    // Dynamic Y-axis scales
    private int GetDynamicMaxInteractions()
    {
        if (!_chartData.Any()) return 10;
        var max = _chartData.Max(d => d.Interactions);
        if (max <= 10) return 10;
        if (max <= 20) return 20;
        if (max <= 50) return 50;
        if (max <= 100) return 100;
        if (max <= 200) return 200;
        if (max <= 500) return 500;
        if (max <= 1000) return 1000;
        if (max <= 2000) return 2000;
        if (max <= 5000) return 5000;
        if (max <= 10000) return 10000;
        if (max <= 20000) return 20000;
        if (max <= 50000) return 50000;
        return (int)Math.Ceiling(max / 10000.0) * 10000;
    }

    private int GetDynamicMaxLeads()
    {
        if (!_chartData.Any()) return 10;
        var max = _chartData.Max(d => d.Leads);
        if (max <= 10) return 10;
        if (max <= 20) return 20;
        if (max <= 50) return 50;
        if (max <= 100) return 100;
        if (max <= 200) return 200;
        if (max <= 500) return 500;
        if (max <= 1000) return 1000;
        if (max <= 2000) return 2000;
        return (int)Math.Ceiling(max / 1000.0) * 1000;
    }

    private string FormatAxisValue(int value)
    {
        // Never use abbreviations like "k" - always show normal numbers
        return value.ToString("N0");
    }

    private string FormatCompactNumber(int value)
    {
        // For KPI cards, use compact format like "45.2k"
        if (value >= 1000000) return $"{value / 1000000.0:F1}M";
        if (value >= 1000) return $"{value / 1000.0:F1}k";
        return value.ToString();
    }

    private string GetPeakDaySpanish()
    {
        if (!_chartData.Any()) return "N/A";
        var peak = _chartData.OrderByDescending(d => d.Interactions).First();
        return peak.DayName;
    }

    private string GetLowestDaySpanish()
    {
        if (!_chartData.Any()) return "N/A";
        var lowest = _chartData.OrderBy(d => d.Interactions).First();
        return lowest.DayName;
    }

    private double GetTooltipPosition(int index)
    {
        if (_chartData.Count <= 1) return 50;
        return 10 + (index * 80.0 / (_chartData.Count - 1));
    }

    // Export functions
    private async Task ExportToCsv()
    {
        _showExportMenu = false;
        try
        {
            var csv = "DÃ­a,Interacciones,Leads,ConversiÃ³n (%),Ocurrencias\n";
            foreach (var point in _chartData)
            {
                var conv = point.Interactions > 0 ? (decimal)point.Leads / point.Interactions * 100 : 0;
                csv += $"{point.DayName},{point.Interactions},{point.Leads},{conv:F2},{point.OccurrenceCount}\n";
            }

            var fileName = $"interacciones_leads_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, csv, "text/csv");
            Snackbar.Add("Archivo CSV descargado", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al exportar: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToXlsx()
    {
        _showExportMenu = false;
        // For XLSX we'd need a library like ClosedXML - for now, export as CSV
        await ExportToCsv();
        Snackbar.Add("ExportaciÃ³n XLSX prÃ³ximamente - se exportÃ³ como CSV", Severity.Info);
    }

    private async Task RetryLoadData()
    {
        _widgetState = WidgetState.Loading;
        StateHasChanged();
        await LoadDashboardData();
    }

    #endregion

    #region Chart Helpers

    // Dual Y-axis max values
    private int GetMaxInteractions() => _chartData.Any()
        ? Math.Max(10, (int)Math.Ceiling(_chartData.Max(d => d.Interactions) * 1.1 / 10) * 10)
        : 40;

    private int GetMaxLeads() => _chartData.Any() 
        ? Math.Max(5, (int)Math.Ceiling(_chartData.Max(d => d.Leads) * 1.1 / 5) * 5) 
        : 24;

    private double GetChartX(int index)
    {
        if (_chartData.Count <= 1) return 400;
        var xStep = 700.0 / (_chartData.Count - 1);
        return 50 + index * xStep;
    }

    private double GetChartYInteractions(int value)
    {
        var max = GetMaxInteractions();
        if (max == 0) return 200;
        return 200 - (value * 180.0 / max);
    }

    private double GetChartYLeads(int value)
    {
        var max = GetMaxLeads();
        if (max == 0) return 200;
        return 200 - (value * 180.0 / max);
    }

    private string GetInteractionsLinePath()
    {
        if (!_chartData.Any()) return "";
        return string.Join(" ", _chartData.Select((d, i) => $"{GetChartX(i):F0},{GetChartYInteractions(d.Interactions):F0}"));
    }

    private string GetLeadsLinePath()
    {
        if (!_chartData.Any()) return "";
        return string.Join(" ", _chartData.Select((d, i) => $"{GetChartX(i):F0},{GetChartYLeads(d.Leads):F0}"));
    }

    private string GetInteractionsAreaPath()
    {
        if (!_chartData.Any()) return "";
        var points = string.Join(" L ", _chartData.Select((d, i) => $"{GetChartX(i):F0},{GetChartYInteractions(d.Interactions):F0}"));
        return $"M {GetChartX(0):F0},200 L {points} L {GetChartX(_chartData.Count - 1):F0},200 Z";
    }

    private string GetLeadsAreaPath()
    {
        if (!_chartData.Any()) return "";
        var points = string.Join(" L ", _chartData.Select((d, i) => $"{GetChartX(i):F0},{GetChartYLeads(d.Leads):F0}"));
        return $"M {GetChartX(0):F0},200 L {points} L {GetChartX(_chartData.Count - 1):F0},200 Z";
    }

    private int GetIsoWeekNumber(DateTime date)
    {
        var cal = System.Globalization.CultureInfo.InvariantCulture.Calendar;
        return cal.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    }

    // Chart subtitle and update time
    private string GetChartSubtitle()
    {
        return _selectedDateRange switch
        {
            "7d" => "Last 7 days",
            "30d" => "Last 30 days",
            "90d" => "Last 90 days",
            _ => "Last 7 days"
        };
    }

    private string GetLastUpdateTime()
    {
        var diff = DateTime.UtcNow - _lastDataUpdate;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} min ago";
        return $"{(int)diff.TotalHours}h ago";
    }

    // KPI calculations
    private int GetTotalInteractions() => _chartData.Sum(d => d.Interactions);
    private int GetTotalLeads() => _chartData.Sum(d => d.Leads);
    
    private decimal GetConversionRate()
    {
        var interactions = GetTotalInteractions();
        if (interactions == 0) return 0;
        return (decimal)GetTotalLeads() / interactions * 100;
    }

    private decimal GetInteractionsDelta() => _kpis?.TotalInteractions.DeltaPercent ?? 0;
    private decimal GetLeadsDelta() => _kpis?.LeadsCaptured.DeltaPercent ?? 0;
    private decimal GetConversionDelta() => _kpis?.ConversionRate.DeltaPercent ?? 0;

    // Tooltip helpers
    private int GetTooltipLeft(int index)
    {
        // Calculate approximate position based on chart index
        var containerWidth = 700; // Approximate chart width
        var xPercent = _chartData.Count > 1 ? (double)index / (_chartData.Count - 1) : 0.5;
        var baseLeft = 50 + (int)(xPercent * containerWidth);
        
        // Adjust for edges
        if (index < _chartData.Count / 3) return baseLeft + 20;
        if (index > _chartData.Count * 2 / 3) return baseLeft - 140;
        return baseLeft - 60;
    }

    private string GetTooltipDate(DateTime date)
    {
        return date.ToString("ddd, MMM dd");
    }

    // Micro-insights
    private string GetPeakDay()
    {
        if (!_chartData.Any()) return "N/A";
        var peak = _chartData.OrderByDescending(d => d.Interactions).First();
        return peak.DayName;
    }

    private string GetLowestDay()
    {
        if (!_chartData.Any()) return "N/A";
        var lowest = _chartData.OrderBy(d => d.Interactions).First();
        return lowest.DayName;
    }

    // Bar Chart specific helpers
    private int GetBarChartMaxValue()
    {
        if (!_chartData.Any()) return 40;
        var maxInteractions = _chartData.Max(d => d.Interactions);
        var maxLeads = _chartData.Max(d => d.Leads);
        var max = Math.Max(maxInteractions, maxLeads);
        return Math.Max(10, (int)Math.Ceiling(max * 1.15 / 10) * 10);
    }

    private double GetBarGroupX(int index)
    {
        if (_chartData.Count == 0) return 400;
        var chartWidth = 680.0;
        var groupWidth = chartWidth / _chartData.Count;
        var barWidth = GetBarWidth();
        var totalBarWidth = barWidth * 2 + 4; // 2 bars + gap
        return 60 + (index * groupWidth) + (groupWidth - totalBarWidth) / 2;
    }

    private double GetBarWidth()
    {
        if (_chartData.Count == 0) return 16;
        var baseWidth = 680.0 / _chartData.Count / 3;
        return Math.Min(20, Math.Max(8, baseWidth));
    }

    private double GetBarHeight(int value)
    {
        var max = GetBarChartMaxValue();
        if (max == 0) return 0;
        return (value * 160.0 / max);
    }

    private int GetBarTooltipLeft(int index)
    {
        var groupX = GetBarGroupX(index);
        var barWidth = GetBarWidth();
        var centerX = (int)(groupX + barWidth + 2);
        
        // Adjust for edges
        if (index < _chartData.Count / 3) return centerX + 20;
        if (index > _chartData.Count * 2 / 3) return centerX - 140;
        return centerX - 60;
    }

    #endregion

    #region Formatting Helpers

    private string FormatNumber(decimal value)
    {
        return value >= 1000 ? $"{value / 1000:F1}K" : ((int)value).ToString();
    }

    private string FormatNumber(int value)
    {
        return value >= 1000 ? $"{value / 1000.0:F1}K" : value.ToString();
    }

    private string FormatDelta(decimal delta)
    {
        var sign = delta >= 0 ? "+" : "";
        return $"{sign}{delta:F1}%";
    }

    private string GetCtaBadgeClass(string? cta)
    {
        if (string.IsNullOrEmpty(cta)) return "badge-inactive";
        return cta.ToLower() switch
        {
            "whatsapp" => "badge-whatsapp",
            "email" or "gmail" => "badge-email",
            "linkedin" => "badge-linkedin",
            "call" or "phone" => "badge-call",
            "calendar" or "meeting" or "booking" => "badge-calendar",
            "instagram" => "badge-instagram",
            "facebook" => "badge-facebook",
            _ => "badge-default"
        };
    }

    private string GetLinkBadgeClass(string linkName)
    {
        return linkName.ToLower() switch
        {
            "whatsapp" => "badge-whatsapp",
            "email" or "gmail" => "badge-email",
            "linkedin" => "badge-linkedin",
            "call" or "phone" => "badge-call",
            "calendar" or "meeting" or "booking" => "badge-calendar",
            "instagram" => "badge-instagram",
            "facebook" => "badge-facebook",
            "twitter" or "x" => "badge-twitter",
            "youtube" => "badge-youtube",
            "portfolio" => "badge-portfolio",
            "website" or "web" => "badge-website",
            _ => "badge-default"
        };
    }

    private string GetEventTypeBadgeClass(string eventType)
    {
        return eventType.ToLower() switch
        {
            "contact_save" or "contact_saved" => "badge-contact",
            "form_submit" or "form_submitted" => "badge-form",
            "cta_click" => "badge-default",
            "page_view" or "card_open" => "badge-default",
            "qr_scan" => "badge-qr",
            "nfc_tap" => "badge-nfc",
            _ => "badge-default"
        };
    }

    private string GetEventTypeIcon(string eventType)
    {
        return eventType.ToLower() switch
        {
            "contact_save" or "contact_saved" => "contact_save",
            "form_submit" or "form_submitted" => "form_submit",
            "cta_click" => "link_click",
            "page_view" or "card_open" or "card_opened" => "page_view",
            "qr_scan" => "qr",
            "nfc_tap" => "nfc",
            _ => "link"
        };
    }

    private (int x, int y) GetLocationCoords(string location)
    {
        // Simple approximation for demo - in production use proper geocoding
        return location.ToLower() switch
        {
            var l when l.Contains("salvador") => (140, 95),
            var l when l.Contains("usa") || l.Contains("united") => (100, 65),
            var l when l.Contains("mexico") || l.Contains("mÃ©xico") => (110, 80),
            var l when l.Contains("spain") || l.Contains("espaÃ±a") => (200, 60),
            var l when l.Contains("argentina") => (145, 140),
            var l when l.Contains("colombia") => (135, 100),
            _ => (180, 90)
        };
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }

    #endregion

    #region Cleanup

    public async ValueTask DisposeAsync()
    {
        if (_refreshTimer != null)
        {
            await _refreshTimer.DisposeAsync();
        }

        // Cleanup chart ResizeObserver
        if (_chartResizeObserverInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("chartResizeObserver.unobserve", ChartContainerId);
            }
            catch { /* Ignore errors during disposal */ }
        }
        _chartResizeRef?.Dispose();
        
        if (_mapInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("DataTouchMap.destroy");
            }
            catch { /* Ignore errors during disposal */ }
        }
    }

    #endregion
}
