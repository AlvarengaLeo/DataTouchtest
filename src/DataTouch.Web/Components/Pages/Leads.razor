@page "/leads"
@attribute [Authorize]
@inject DataTouchDbContext DbContext
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Leads - DataTouch</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" /> Leads
</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudDatePicker @bind-Date="_dateFrom" Label="Desde" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudDatePicker @bind-Date="_dateTo" Label="Hasta" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudSelect T="string" @bind-Value="_statusFilter" Label="Estado" Variant="Variant.Outlined">
                <MudSelectItem Value="@("")">Todos</MudSelectItem>
                <MudSelectItem Value="@("New")">Nuevo</MudSelectItem>
                <MudSelectItem Value="@("Contacted")">Contactado</MudSelectItem>
                <MudSelectItem Value="@("Qualified")">Calificado</MudSelectItem>
                <MudSelectItem Value="@("Closed")">Cerrado</MudSelectItem>
                <MudSelectItem Value="@("Lost")">Perdido</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="3" Class="d-flex align-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadLeads" StartIcon="@Icons.Material.Filled.Search">
                Filtrar
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudTable Items="_leads" Hover="true" Striped="true" Elevation="2">
        <HeaderContent>
            <MudTh>Fecha</MudTh>
            <MudTh>Nombre</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Teléfono</MudTh>
            <MudTh>Tarjeta</MudTh>
            <MudTh>Fuente</MudTh>
            <MudTh>Estado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Fecha">@context.CreatedAt.ToString("dd/MM/yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Nombre">@context.FullName</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Teléfono">@context.Phone</MudTd>
            <MudTd DataLabel="Tarjeta">@context.Card?.FullName</MudTd>
            <MudTd DataLabel="Fuente">@GetSourceLabel(context.Source)</MudTd>
            <MudTd DataLabel="Estado">
                <MudChip T="string" Color="@GetStatusColor(context.Status)" Size="Size.Small">@GetStatusLabel(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="Acciones">
                <MudTooltip Text="Ver ficha del lead">
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" 
                               Href="@($"/leads/{context.Id}")" StartIcon="@Icons.Material.Filled.Visibility">
                        Ver
                    </MudButton>
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No hay leads registrados</MudText>
        </NoRecordsContent>
    </MudTable>
}

@code {
    private List<Lead> _leads = new();
    private bool _isLoading = true;
    private DateTime? _dateFrom;
    private DateTime? _dateTo;
    private string _statusFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadLeads();
    }

    private async Task LoadLeads()
    {
        _isLoading = true;
        var orgId = AuthService.GetCurrentOrganizationId();

        if (orgId.HasValue)
        {
            var query = DbContext.Leads
                .Include(l => l.Card)
                .Where(l => l.OrganizationId == orgId.Value)
                .AsQueryable();

            if (_dateFrom.HasValue)
                query = query.Where(l => l.CreatedAt >= _dateFrom.Value);

            if (_dateTo.HasValue)
            {
                var endDate = _dateTo.Value.AddDays(1);
                query = query.Where(l => l.CreatedAt <= endDate);
            }

            if (!string.IsNullOrEmpty(_statusFilter))
                query = query.Where(l => l.Status == _statusFilter);

            _leads = await query.OrderByDescending(l => l.CreatedAt).ToListAsync();
        }
        _isLoading = false;
    }

    private Color GetStatusColor(string status) => status switch
    {
        "New" => Color.Info,
        "Contacted" => Color.Warning,
        "Qualified" => Color.Secondary,
        "Closed" => Color.Success,
        "Lost" => Color.Default,
        _ => Color.Default
    };

    private string GetStatusLabel(string status) => status switch
    {
        "New" => "Nuevo",
        "Contacted" => "Contactado",
        "Qualified" => "Calificado",
        "Closed" => "Cerrado",
        "Lost" => "Perdido",
        _ => status
    };

    private string GetSourceLabel(string? source) => source switch
    {
        "CARD_CONTACT_FORM" => "Formulario",
        "MANUAL" => "Manual",
        _ => "Otro"
    };
}
