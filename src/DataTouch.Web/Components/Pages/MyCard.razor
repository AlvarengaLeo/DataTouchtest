@page "/cards/mine"
@attribute [Authorize]
@inject DataTouchDbContext DbContext
@inject AuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IWebHostEnvironment Environment
@inject IJSRuntime JSRuntime
@using System.Text.Json
@using System.IO
@using DataTouch.Web.Models

<PageTitle>Mi Tarjeta - DataTouch</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_card == null)
{
    <MudAlert Severity="Severity.Warning">No tienes una tarjeta asignada.</MudAlert>
}
else
{
    <div class="mycard-container">
        @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PAGE HEADER - PREMIUM ENTERPRISE STYLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
        <header class="page-header">
            <div class="header-content">
                <div class="header-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                </div>
                <div class="header-text">
                    <h1 class="header-title">Perfil PÃºblico</h1>
                    <p class="header-subtitle">Tu identidad digital profesional</p>
                </div>
            </div>
            @* Save Status Indicator *@
            <div class="save-status">
                @if (_isSaving)
                {
                    <div class="status-indicator status-saving">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                        <span>Guardando...</span>
                    </div>
                }
                else if (_hasUnsavedChanges)
                {
                    <div class="status-indicator status-unsaved">
                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                        <span>Cambios sin guardar</span>
                    </div>
                }
                else
                {
                    <div class="status-indicator status-saved">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                        <span>Guardado</span>
                        @if (_card.UpdatedAt.HasValue)
                        {
                            <span class="last-updated">Â· @FormatLastUpdated(_card.UpdatedAt.Value)</span>
                        }
                    </div>
                }
            </div>
        </header>

        <div class="editor-layout">
            @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               LEFT COLUMN: FORM EDITOR
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
            <main class="editor-main">

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   LEVEL 2 (COLLAPSIBLE): APARIENCIA
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <section class="section-card section-level-2 section-appearance">
                    <div class="section-header section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_appearanceSectionExpanded))">
                        <div class="section-icon icon-appearance">
                            <MudIcon Icon="@Icons.Material.Filled.Palette" Size="Size.Medium" />
                        </div>
                        <div class="section-header-text">
                            <h2 class="section-title">Apariencia</h2>
                            <p class="section-description">Personaliza el fondo y el estilo visual de tu tarjeta pÃºblica.</p>
                        </div>
                        <div class="appearance-chips-summary">
                            <span class="summary-chip">Fondo: @GetBackgroundSummary()</span>
                            <span class="summary-chip">Tarjeta: @GetCardSummary()</span>
                            <span class="summary-chip">Acciones: @GetButtonsSummary()</span>
                        </div>
                        <MudIcon Icon="@(_appearanceSectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Size="Size.Medium" 
                                 Class="section-collapse-icon" />
                    </div>
                    <MudCollapse Expanded="_appearanceSectionExpanded">
                        <div class="section-content appearance-content">
                            @* PRESETS RECOMENDADOS - CATEGORIZED *@
                            <div class="appearance-block appearance-presets-block">
                                <h3 class="appearance-block-title">Elige tu estilo</h3>
                                
                                @* DARK PRESETS *@
                                <div class="preset-category">
                                    <span class="preset-category-label">
                                        <MudIcon Icon="@Icons.Material.Filled.DarkMode" Size="Size.Small" />
                                        Oscuros
                                    </span>
                                    <div class="appearance-presets-grid">
                                        @foreach (var preset in _presets.Where(p => p.Category == "dark"))
                                        {
                                            <MudTooltip Text="@preset.Personality" Placement="Placement.Top" Arrow="true">
                                                <div class="appearance-preset-card @(preset.Id == _selectedPreset ? "selected" : "")" 
                                                     @onclick="() => ApplyPreset(preset.Id)">
                                                    <div class="preset-preview" style="background: @preset.BackgroundValue;">
                                                        <div class="preset-accent-dot" style="background: @preset.AccentColor;"></div>
                                                    </div>
                                                    <span class="preset-name">@preset.Name</span>
                                                    @if (preset.Id == _selectedPreset)
                                                    {
                                                        <span class="preset-check">
                                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                                        </span>
                                                    }
                                                </div>
                                            </MudTooltip>
                                        }
                                    </div>
                                </div>
                                
                                @* LIGHT PRESETS *@
                                <div class="preset-category">
                                    <span class="preset-category-label">
                                        <MudIcon Icon="@Icons.Material.Filled.LightMode" Size="Size.Small" />
                                        Claros
                                    </span>
                                    <div class="appearance-presets-grid">
                                        @foreach (var preset in _presets.Where(p => p.Category == "light"))
                                        {
                                            <MudTooltip Text="@preset.Personality" Placement="Placement.Top" Arrow="true">
                                                <div class="appearance-preset-card light @(preset.Id == _selectedPreset ? "selected" : "")" 
                                                     @onclick="() => ApplyPreset(preset.Id)">
                                                    <div class="preset-preview" style="background: @preset.BackgroundValue;">
                                                        <div class="preset-accent-dot" style="background: @preset.AccentColor;"></div>
                                                    </div>
                                                    <span class="preset-name">@preset.Name</span>
                                                    @if (preset.Id == _selectedPreset)
                                                    {
                                                        <span class="preset-check light">
                                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                                        </span>
                                                    }
                                                </div>
                                            </MudTooltip>
                                        }
                                    </div>
                                </div>
                            </div>

                            @* FONDO (SIMPLIFICADO: COLORES / IMAGEN) *@
                            <div class="appearance-options-simple">
                                <div class="appearance-block appearance-block-full">
                                    <h3 class="appearance-block-title">Fondo</h3>
                                    <div class="segment-selector segment-selector-centered">
                                        <button class="segment-btn @(_cardStyle.BackgroundType != "image" ? "active" : "")" 
                                                @onclick="SetBackgroundColores">
                                            <MudIcon Icon="@Icons.Material.Filled.Palette" Size="Size.Small" />
                                            Colores
                                        </button>
                                        <button class="segment-btn @(_cardStyle.BackgroundType == "image" ? "active" : "")" 
                                                @onclick="SetBackgroundImage">
                                            <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" />
                                            Imagen
                                        </button>
                                    </div>
                                    @if (_cardStyle.BackgroundType == "image")
                                    {
                                        <div class="image-upload-section">
                                            <MudFileUpload T="IBrowserFile" 
                                                           FilesChanged="UploadBackgroundImage" 
                                                           Accept="image/png,image/jpeg,image/webp"
                                                           Class="mt-3">
                                                <ActivatorContent>
                                                    <MudButton Variant="Variant.Outlined" 
                                                               Color="Color.Primary" 
                                                               StartIcon="@Icons.Material.Filled.Upload"
                                                               Size="Size.Small">
                                                        Subir imagen
                                                    </MudButton>
                                                </ActivatorContent>
                                            </MudFileUpload>
                                        </div>
                                    }
                                </div>
                            </div>

                            @* FOOTER CON RESTAURAR *@
                            <div class="appearance-footer">
                                <button class="reset-link" @onclick="ResetAppearanceToDefault">
                                    <MudIcon Icon="@Icons.Material.Filled.RestartAlt" Size="Size.Small" />
                                    <span>Restaurar</span>
                                </button>
                            </div>
                        </div>
                    </MudCollapse>
                </section>


                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   LEVEL 1: IDENTIDAD - Unified with Profile Photo (Collapsible)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <section class="section-card section-level-1 identity-unified">
                    <div class="section-header identity-header-with-avatar section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_identitySectionExpanded))">
                        @* Left: Icon + Title *@
                        <div class="section-header-left">
                            <div class="section-icon icon-identity">
                                <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Medium" />
                            </div>
                            <div class="section-header-text">
                                <h2 class="section-title">Identidad</h2>
                                <p class="section-description">@GetIdentitySummary()</p>
                            </div>
                        </div>
                        
                        @* Right: Avatar with Change Photo Button *@
                        <div class="identity-avatar-section" @onclick:stopPropagation="true">
                            <div class="identity-avatar-container">
                                <div class="identity-avatar-glow">
                                    @if (!string.IsNullOrEmpty(_card.ProfileImageUrl))
                                    {
                                        <div class="identity-avatar identity-avatar-image">
                                            <img src="@_card.ProfileImageUrl" alt="@_card.FullName" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="identity-avatar identity-avatar-initials">
                                            <span>@GetInitials(_card.FullName)</span>
                                        </div>
                                    }
                                </div>
                                @* Camera Icon Overlay *@
                                <MudFileUpload T="IBrowserFile" 
                                               FilesChanged="UploadFiles" 
                                               Accept="image/png,image/jpeg,image/webp"
                                               Class="avatar-camera-overlay">
                                    <ActivatorContent>
                                        <button class="camera-btn" title="Cambiar foto">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                                <circle cx="12" cy="13" r="4"/>
                                            </svg>
                                        </button>
                                    </ActivatorContent>
                                </MudFileUpload>
                            </div>
                            
                            @* Change/Upload Photo Button *@
                            <MudFileUpload T="IBrowserFile" 
                                           FilesChanged="UploadFiles" 
                                           Accept="image/png,image/jpeg,image/webp"
                                           Class="change-photo-upload">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               StartIcon="@Icons.Material.Filled.CameraAlt"
                                               Disabled="@_isUploading"
                                               Class="change-photo-btn"
                                               Size="Size.Small">
                                        @if (_isUploading)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" Class="mr-1" />
                                            <span>Subiendo...</span>
                                        }
                                        else
                                        {
                                            <span>@(string.IsNullOrEmpty(_card.ProfileImageUrl) ? "Subir foto" : "Cambiar foto")</span>
                                        }
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                        </div>
                        
                        @* Collapse icon *@
                        <MudIcon Icon="@(_identitySectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Class="section-collapse-icon" />
                    </div>
                    
                    <MudCollapse Expanded="_identitySectionExpanded">
                        <div class="section-content">
                        <div class="form-grid identity-form-grid">
                            <div class="form-row">
                                <MudTextField @bind-Value="_card.FullName" 
                                              Label="Nombre completo" 
                                              Variant="Variant.Outlined" 
                                              Required="true" 
                                              Immediate="true"
                                              @oninput="MarkUnsaved" />
                            </div>
                            <div class="form-row">
                                <MudTextField @bind-Value="_card.Title" 
                                              Label="Puesto o cargo" 
                                              Variant="Variant.Outlined" 
                                              Immediate="true"
                                              Placeholder="Ej: Director Comercial"
                                              @oninput="MarkUnsaved" />
                            </div>
                            <div class="form-row form-row-full">
                                <MudTextField @bind-Value="_card.CompanyName" 
                                              Label="Empresa" 
                                              Variant="Variant.Outlined" 
                                              Immediate="true"
                                              HelperText="Deja vacÃ­o para usar el nombre de tu organizaciÃ³n"
                                              @oninput="MarkUnsaved" />
                            </div>
                            <div class="form-row form-row-full">
                                <MudTextField @bind-Value="_card.Bio" 
                                              Label="BiografÃ­a" 
                                              Variant="Variant.Outlined" 
                                              Lines="3"
                                              Immediate="true"
                                              Counter="300" 
                                              MaxLength="300"
                                              HelperText="@GetBioFeedback()"
                                              @oninput="MarkUnsaved" />
                                <p class="bio-warning">
                                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                                    Este texto serÃ¡ visible pÃºblicamente
                                </p>
                            </div>
                        </div>
                        </div>
                    </MudCollapse>
                </section>

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   LEVEL 2: CONTACT INFORMATION (Collapsible)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <section class="section-card section-level-2">
                    <div class="section-header section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_contactSectionExpanded))">
                        <div class="section-icon icon-contact">
                            <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Medium" />
                        </div>
                        <div class="section-header-text">
                            <h2 class="section-title">InformaciÃ³n de contacto</h2>
                            <p class="section-description">@GetContactSummary()</p>
                        </div>
                        <MudIcon Icon="@(_contactSectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Class="section-collapse-icon" />
                    </div>
                    <MudCollapse Expanded="_contactSectionExpanded">
                        <div class="section-content">
                            @* Centered Header *@
                            <div class="contact-centered-header">
                                <div class="contact-header-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.AlternateEmail" Size="Size.Medium" />
                                </div>
                                <h2 class="contact-header-title">InformaciÃ³n de contacto</h2>
                                <p class="contact-header-subtitle">Email â€¢ TelÃ©fono â€¢ WhatsApp</p>
                            </div>

                            @* Email Row â€” tap to edit *@
                            @if (_editingContactField == "email")
                            {
                                <div class="contact-edit-inline">
                                    <MudTextField @bind-Value="_card.Email"
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Email"
                                                  Immediate="true"
                                                  @oninput="MarkUnsaved" />
                                    <button class="social-edit-btn social-edit-save" @onclick="StopEditContact">Listo</button>
                                </div>
                            }
                            else
                            {
                                <div class="ios-row contact-email-row" @onclick="EditEmail">
                                    <div class="contact-email-icon">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" />
                                    </div>
                                    <span class="ios-row-primary">@(string.IsNullOrEmpty(_card.Email) ? "Agregar email" : _card.Email)</span>
                                    <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                </div>
                            }

                            @* TelÃ©fonos subsection label *@
                            <div class="contact-subsection-title">TelÃ©fonos</div>

                            @* Phone Card *@
                            @if (_editingContactField == "phone")
                            {
                                <div class="contact-edit-inline">
                                    <div class="contact-edit-label">TelÃ©fono</div>
                                    <div class="form-row phone-row">
                                        <MudSelect T="string"
                                                   @bind-Value="_card.PhoneCountryCode"
                                                   Label="CÃ³digo"
                                                   Variant="Variant.Outlined"
                                                   Class="country-select"
                                                   AnchorOrigin="Origin.BottomCenter">
                                            @foreach (var country in _countries)
                                            {
                                                <MudSelectItem Value="@country.Code">
                                                    <div class="country-option">
                                                        <span class="country-flag">@country.Flag</span>
                                                        <span class="country-code">@country.Code</span>
                                                    </div>
                                                </MudSelectItem>
                                            }
                                        </MudSelect>
                                        <MudTextField @bind-Value="_card.Phone"
                                                      Label="NÃºmero"
                                                      Variant="Variant.Outlined"
                                                      MaxLength="@GetPhoneMaxLength()"
                                                      Immediate="true"
                                                      Class="phone-input"
                                                      @oninput="MarkUnsaved" />
                                    </div>
                                    <button class="social-edit-btn social-edit-save" @onclick="StopEditContact">Listo</button>
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(_card.Phone))
                            {
                                <div class="contact-phone-card" @onclick="EditPhone">
                                    <span class="phone-card-flag">@(GetCountryForCode(_card.PhoneCountryCode)?.Flag ?? "ğŸ“")</span>
                                    <div class="phone-card-info">
                                        <span class="phone-card-code">@GetCountryShortName(_card.PhoneCountryCode) @(_card.PhoneCountryCode ?? "")</span>
                                        <span class="phone-card-number">@_card.Phone</span>
                                    </div>
                                    <div class="phone-card-actions" @onclick:stopPropagation="true">
                                        <a class="phone-quick-action phone-quick-call"
                                           href="@GetPhoneTelUrl()" title="Llamar">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                        </a>
                                        <a class="phone-quick-action phone-quick-wa"
                                           href="@GetWhatsAppUrl()" target="_blank" title="WhatsApp">
                                            <MudIcon Icon="@Icons.Custom.Brands.WhatsApp" Size="Size.Small" />
                                        </a>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="contact-phone-empty" @onclick="EditPhone">
                                    + Agregar telÃ©fono
                                </div>
                            }

                            @* WhatsApp Card *@
                            @if (_editingContactField == "whatsapp")
                            {
                                <div class="contact-edit-inline">
                                    <div class="contact-edit-label">WhatsApp</div>
                                    <div class="form-row phone-row">
                                        <MudSelect T="string"
                                                   @bind-Value="_card.WhatsAppCountryCode"
                                                   Label="CÃ³digo"
                                                   Variant="Variant.Outlined"
                                                   Class="country-select"
                                                   AnchorOrigin="Origin.BottomCenter">
                                            @foreach (var country in _countries)
                                            {
                                                <MudSelectItem Value="@country.Code">
                                                    <div class="country-option">
                                                        <span class="country-flag">@country.Flag</span>
                                                        <span class="country-code">@country.Code</span>
                                                    </div>
                                                </MudSelectItem>
                                            }
                                        </MudSelect>
                                        <MudTextField @bind-Value="_card.WhatsAppNumber"
                                                      Label="NÃºmero"
                                                      Variant="Variant.Outlined"
                                                      MaxLength="@GetWhatsAppMaxLength()"
                                                      Immediate="true"
                                                      Class="phone-input"
                                                      @oninput="MarkUnsaved" />
                                    </div>
                                    <button class="social-edit-btn social-edit-save" @onclick="StopEditContact">Listo</button>
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(_card.WhatsAppNumber))
                            {
                                <div class="contact-phone-card" @onclick="EditWhatsApp">
                                    <span class="phone-card-flag">@(GetCountryForCode(_card.WhatsAppCountryCode)?.Flag ?? "ğŸ“")</span>
                                    <div class="phone-card-info">
                                        <span class="phone-card-code">@GetCountryShortName(_card.WhatsAppCountryCode) @(_card.WhatsAppCountryCode ?? "")</span>
                                        <span class="phone-card-number">@_card.WhatsAppNumber</span>
                                    </div>
                                    <div class="phone-card-actions" @onclick:stopPropagation="true">
                                        <a class="phone-quick-action phone-quick-call"
                                           href="@GetWhatsAppTelUrl()" title="Llamar">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                        </a>
                                        <a class="phone-quick-action phone-quick-wa"
                                           href="@GetWhatsAppUrl()" target="_blank" title="WhatsApp">
                                            <MudIcon Icon="@Icons.Custom.Brands.WhatsApp" Size="Size.Small" />
                                        </a>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="contact-phone-empty" @onclick="EditWhatsApp">
                                    + Agregar WhatsApp
                                </div>
                            }
                        </div>
                    </MudCollapse>
                </section>

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   LEVEL 2 (COLLAPSIBLE): ACTION BUTTONS
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <section class="section-card section-level-2">
                    <div class="section-header section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_actionButtonsSectionExpanded))">
                        <div class="section-icon icon-cta">
                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Medium" />
                        </div>
                        <div class="section-header-text">
                            <h2 class="section-title">Botones de acciÃ³n</h2>
                            <p class="section-description">
                                @{
                                    var activeButtons = CountActiveButtons();
                                    <span>@activeButtons botones activos</span>
                                }
                            </p>
                        </div>
                        <MudIcon Icon="@(_actionButtonsSectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                 Size="Size.Medium" 
                                 Class="section-collapse-icon" />
                    </div>
                    <MudCollapse Expanded="_actionButtonsSectionExpanded">
                        <div class="section-content">
                            <div class="action-toggle-list">
                                <div class="action-toggle-row">
                                    <div class="action-icon action-icon-save">
                                        <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Size="Size.Small" />
                                    </div>
                                    <span class="action-label">Guardar Contacto</span>
                                    <MudSwitch T="bool" @bind-Value="_card.ShowSaveContact" Color="Color.Primary" />
                                </div>
                                <div class="action-toggle-row">
                                    <div class="action-icon action-icon-whatsapp">
                                        <MudIcon Icon="@Icons.Custom.Brands.WhatsApp" Size="Size.Small" />
                                    </div>
                                    <span class="action-label">WhatsApp</span>
                                    <MudSwitch T="bool" @bind-Value="_card.ShowWhatsApp" Color="Color.Success" />
                                </div>
                                <div class="action-toggle-row">
                                    <div class="action-icon action-icon-call">
                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                    </div>
                                    <span class="action-label">Llamar</span>
                                    <MudSwitch T="bool" @bind-Value="_card.ShowCall" Color="Color.Info" />
                                </div>
                                <div class="action-toggle-row">
                                    <div class="action-icon action-icon-email">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" />
                                    </div>
                                    <span class="action-label">Email</span>
                                    <MudSwitch T="bool" @bind-Value="_card.ShowEmail" Color="Color.Warning" />
                                </div>
                            </div>
                        </div>
                    </MudCollapse>
                </section>

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   LEVEL 3 (COLLAPSIBLE): SOCIAL PROFILES
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <section class="section-card section-level-3">
                    <div class="section-header section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_socialSectionExpanded))">
                        <div class="section-icon icon-social">
                            <MudIcon Icon="@Icons.Material.Filled.Share" Size="Size.Medium" />
                        </div>
                        <div class="section-header-text">
                            <h2 class="section-title">Perfiles sociales</h2>
                            <p class="section-description">
                                @if (HasAnySocialLink())
                                {
                                    <span>@CountSocialLinks() perfiles configurados</span>
                                }
                                else
                                {
                                    <span class="text-muted">Sin configurar</span>
                                }
                            </p>
                        </div>
                        <div class="section-collapse-icon">
                            <MudIcon Icon="@(_socialSectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" />
                        </div>
                    </div>
                    <MudCollapse Expanded="_socialSectionExpanded">
                        <div class="section-content">
                            <div class="ios-rows-list">
                                @* LinkedIn *@
                                @if (_editingSocialField == "LinkedIn")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.LinkedIn"
                                                      Label="LinkedIn"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditLinkedIn">
                                        <div class="ios-icon-badge badge-linkedin">
                                            <MudIcon Icon="@Icons.Custom.Brands.LinkedIn" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">LinkedIn</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.LinkedIn) ? "Agregar" : _socialLinks.LinkedIn)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }

                                @* Instagram *@
                                @if (_editingSocialField == "Instagram")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.Instagram"
                                                      Label="Instagram"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditInstagram">
                                        <div class="ios-icon-badge badge-instagram">
                                            <MudIcon Icon="@Icons.Custom.Brands.Instagram" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">Instagram</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.Instagram) ? "Agregar" : _socialLinks.Instagram)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }

                                @* Facebook *@
                                @if (_editingSocialField == "Facebook")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.Facebook"
                                                      Label="Facebook"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditFacebook">
                                        <div class="ios-icon-badge badge-facebook">
                                            <MudIcon Icon="@Icons.Custom.Brands.Facebook" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">Facebook</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.Facebook) ? "Agregar" : _socialLinks.Facebook)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }

                                @* YouTube *@
                                @if (_editingSocialField == "YouTube")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.YouTube"
                                                      Label="YouTube"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditYouTube">
                                        <div class="ios-icon-badge badge-youtube">
                                            <MudIcon Icon="@Icons.Custom.Brands.YouTube" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">YouTube</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.YouTube) ? "Agregar" : _socialLinks.YouTube)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }

                                @* Twitter / X *@
                                @if (_editingSocialField == "Twitter")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.Twitter"
                                                      Label="Twitter / X"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditTwitter">
                                        <div class="ios-icon-badge badge-twitter">
                                            <MudIcon Icon="@Icons.Custom.Brands.Twitter" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">Twitter / X</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.Twitter) ? "Agregar" : _socialLinks.Twitter)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }

                                @* Website *@
                                @if (_editingSocialField == "Website")
                                {
                                    <div class="social-row-editing">
                                        <MudTextField @bind-Value="_socialLinks.Website"
                                                      Label="PÃ¡gina Web"
                                                      Variant="Variant.Outlined"
                                                      Immediate="true"
                                                      @oninput="MarkUnsaved" />
                                        <button class="social-edit-btn social-edit-save" @onclick="StopEditSocial">Listo</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="ios-row" @onclick="EditWebsite">
                                        <div class="ios-icon-badge badge-website">
                                            <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" />
                                        </div>
                                        <div class="ios-row-info">
                                            <div class="ios-row-primary">PÃ¡gina Web</div>
                                            <div class="ios-row-secondary">@(string.IsNullOrEmpty(_socialLinks.Website) ? "Agregar" : _socialLinks.Website)</div>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="ios-row-chevron" />
                                    </div>
                                }
                            </div>
                        </div>
                    </MudCollapse>
                </section>

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   PORTFOLIO GALLERY (CONDITIONAL - Only for Portfolio Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isPortfolioTemplate)
                {
                    <section class="section-card section-level-1 section-portfolio">
                        <div class="section-header section-header-collapsible" @onclick="() => ToggleMobileAccordion(nameof(_gallerySectionExpanded))">
                            <div class="section-icon icon-gallery">
                                <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Medium" />
                            </div>
                            <div class="section-header-text">
                                <h2 class="section-title">GalerÃ­a de Proyectos</h2>
                                <p class="section-description">Fotos @_galleryImages.Count â€¢ Videos @_portfolioGallery.Videos.Count</p>
                            </div>
                            <MudIcon Icon="@(_gallerySectionExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                     Class="section-collapse-icon" />
                        </div>
                        <MudCollapse Expanded="_gallerySectionExpanded">
                        <div class="section-content">
                            @* Content toggles *@
                            <div class="gallery-toggles">
                                <span class="gallery-toggles-label">Contenido de galerÃ­a</span>
                                <div class="gallery-toggles-row">
                                    <MudSwitch T="bool" Value="_portfolioGallery.EnablePhotos"
                                               ValueChanged="OnPhotosToggleChanged"
                                               Color="Color.Primary" Label="Fotos" />
                                    <MudSwitch T="bool" Value="_portfolioGallery.EnableVideos"
                                               ValueChanged="OnVideosToggleChanged"
                                               Color="Color.Primary" Label="Videos" />
                                </div>
                                <span class="gallery-toggles-hint">Activa solo lo que quieras mostrar en tu tarjeta.</span>
                            </div>

                            <div class="gallery-columns">
                                @* â”€â”€ PHOTOS COLUMN â”€â”€ *@
                                @if (_portfolioGallery.EnablePhotos)
                                {
                                    <div class="gallery-column">
                                        <h3 class="gallery-column-title">
                                            <MudIcon Icon="@Icons.Material.Filled.Photo" Size="Size.Small" /> Fotos
                                            <span class="gallery-column-count">@_galleryImages.Count/10</span>
                                        </h3>
                                        <div class="gallery-upload-area">
                                            <MudFileUpload T="IBrowserFile" 
                                                           FilesChanged="UploadGalleryImage" 
                                                           Accept="image/png,image/jpeg,image/webp"
                                                           Disabled="@(_galleryImages.Count >= 10 || _isUploadingGallery)">
                                                <ActivatorContent>
                                                    <div class="gallery-dropzone @(_galleryImages.Count >= 10 ? "disabled" : "")">
                                                        @if (_isUploadingGallery)
                                                        {
                                                            <MudProgressCircular Size="Size.Medium" Indeterminate="true" Color="Color.Primary" />
                                                            <span>Subiendo...</span>
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.AddPhotoAlternate" Size="Size.Large" />
                                                            <span>@(_galleryImages.Count >= 10 ? "LÃ­mite alcanzado" : "Agregar foto")</span>
                                                        }
                                                    </div>
                                                </ActivatorContent>
                                            </MudFileUpload>
                                        </div>
                                        @if (_galleryImages.Any())
                                        {
                                            <div class="gallery-editor-grid">
                                                @foreach (var (image, index) in _galleryImages.OrderBy(i => i.Order).Select((img, idx) => (img, idx)))
                                                {
                                                    <div class="gallery-editor-item">
                                                        <img src="@image.Url" alt="@(image.Title ?? $"Foto {index + 1}")" />
                                                        <div class="gallery-item-overlay">
                                                            <button class="gallery-item-btn" @onclick="() => MoveGalleryImage(image, -1)" 
                                                                    disabled="@(index == 0)" title="Mover arriba">
                                                                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                                                            </button>
                                                            <button class="gallery-item-btn gallery-item-delete" @onclick="() => RemoveGalleryImage(image)" title="Eliminar">
                                                                <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                                            </button>
                                                            <button class="gallery-item-btn" @onclick="() => MoveGalleryImage(image, 1)" 
                                                                    disabled="@(index == _galleryImages.Count - 1)" title="Mover abajo">
                                                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                                            </button>
                                                        </div>
                                                        <div class="gallery-item-title">
                                                            <MudTextField @bind-Value="image.Title" 
                                                                          Placeholder="TÃ­tulo (opcional)" 
                                                                          Variant="Variant.Text"
                                                                          Margin="Margin.Dense"
                                                                          @oninput="MarkUnsaved" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="gallery-empty-state">
                                                <MudIcon Icon="@Icons.Material.Filled.Collections" Size="Size.Large" />
                                                <p>AÃºn no hay fotos</p>
                                            </div>
                                        }
                                    </div>
                                }

                                @* â”€â”€ VIDEOS COLUMN â”€â”€ *@
                                @if (_portfolioGallery.EnableVideos)
                                {
                                    <div class="gallery-column">
                                        <h3 class="gallery-column-title">
                                            <MudIcon Icon="@Icons.Material.Filled.Videocam" Size="Size.Small" /> Videos
                                            <span class="gallery-column-count">@_portfolioGallery.Videos.Count/10</span>
                                        </h3>
                                        <div class="gallery-upload-area">
                                            <MudFileUpload T="IBrowserFile" 
                                                           FilesChanged="UploadGalleryVideo" 
                                                           Accept="video/mp4,video/webm,video/quicktime"
                                                           Disabled="@(_portfolioGallery.Videos.Count >= 10 || _isUploadingVideo)">
                                                <ActivatorContent>
                                                    <div class="gallery-dropzone @(_portfolioGallery.Videos.Count >= 10 ? "disabled" : "")">
                                                        @if (_isUploadingVideo)
                                                        {
                                                            <MudProgressCircular Size="Size.Medium" Indeterminate="true" Color="Color.Primary" />
                                                            <span>Subiendo...</span>
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.VideoCall" Size="Size.Large" />
                                                            <span>@(_portfolioGallery.Videos.Count >= 10 ? "LÃ­mite alcanzado" : "Agregar video")</span>
                                                        }
                                                    </div>
                                                </ActivatorContent>
                                            </MudFileUpload>
                                        </div>
                                        @if (_portfolioGallery.Videos.Any())
                                        {
                                            <div class="gallery-editor-grid">
                                                @foreach (var (video, index) in _portfolioGallery.Videos.OrderBy(v => v.Order).Select((v, idx) => (v, idx)))
                                                {
                                                    <div class="gallery-editor-item gallery-editor-item--video">
                                                        @if (!string.IsNullOrEmpty(video.ThumbnailUrl))
                                                        {
                                                            <img src="@video.ThumbnailUrl" alt="@(video.Title ?? $"Video {index + 1}")" />
                                                        }
                                                        else if (!string.IsNullOrEmpty(video.Url) && video.Url != "#")
                                                        {
                                                            <video src="@video.Url" muted preload="metadata" class="gallery-video-preview"></video>
                                                        }
                                                        else
                                                        {
                                                            <div class="gallery-video-thumb">
                                                                <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Large" />
                                                            </div>
                                                        }
                                                        <div class="gallery-video-play-badge">
                                                            <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" />
                                                        </div>
                                                        <div class="gallery-item-overlay">
                                                            <button class="gallery-item-btn" @onclick="() => MoveGalleryVideo(video, -1)" 
                                                                    disabled="@(index == 0)" title="Mover arriba">
                                                                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                                                            </button>
                                                            <button class="gallery-item-btn gallery-item-delete" @onclick="() => RemoveGalleryVideo(video)" title="Eliminar">
                                                                <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" />
                                                            </button>
                                                            <button class="gallery-item-btn" @onclick="() => MoveGalleryVideo(video, 1)" 
                                                                    disabled="@(index == _portfolioGallery.Videos.Count - 1)" title="Mover abajo">
                                                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                                            </button>
                                                        </div>
                                                        <div class="gallery-item-title">
                                                            <MudTextField @bind-Value="video.Title" 
                                                                          Placeholder="TÃ­tulo (opcional)" 
                                                                          Variant="Variant.Text"
                                                                          Margin="Margin.Dense"
                                                                          @oninput="MarkUnsaved" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="gallery-empty-state">
                                                <MudIcon Icon="@Icons.Material.Filled.VideoLibrary" Size="Size.Large" />
                                                <p>AÃºn no hay videos</p>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        </MudCollapse>
                    </section>
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   SERVICES (CONDITIONAL - Only for Services Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isServicesTemplate || _isAppointmentsTemplate)
                {
                    @* SERVICES EDITOR - With integrated CTA indicator *@
                    <section class="section-card section-level-1 section-services">
                        <div class="section-header">
                            <div class="section-icon icon-services">
                                <MudIcon Icon="@Icons.Material.Filled.Handyman" Size="Size.Medium" />
                            </div>
                            <div class="section-header-text">
                                <h2 class="section-title">Mis Servicios</h2>
                                <p class="section-description">Configura los servicios que ofreces (mÃ¡ximo 10)</p>
                            </div>
                        </div>
                        
                        @* Compact CTA Status Indicator - Only for services-quotes template (appointments always = booking) *@
                        @if (_services.Any() && !_isAppointmentsTemplate)
                        {
                            <div class="cta-status-bar">
                                <div class="cta-status-left">
                                    <span class="cta-label">CTA principal:</span>
                                    @if (IsGoalSelectorVisible)
                                    {
                                        @* Mixed types: Show compact selector *@
                                        <div class="cta-selector-compact">
                                            <button class="cta-chip @(GetEffectivePrimaryGoal() == "booking" ? "cta-chip-active" : "")"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="@(() => SetPrimaryGoal("booking"))">
                                                ğŸ“… Reservar
                                            </button>
                                            <button class="cta-chip @(GetEffectivePrimaryGoal() == "quote" ? "cta-chip-active" : "")"
                                                    @onclick:stopPropagation="true"
                                                    @onclick="@(() => SetPrimaryGoal("quote"))">
                                                ğŸ“ Cotizar
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        @* Homogeneous types: Show auto badge *@
                                        <span class="cta-auto-badge">
                                            @(GetEffectivePrimaryGoal() == "booking" ? "ğŸ“… Reservar Cita" : "ğŸ“ Solicitar CotizaciÃ³n")
                                            <span class="cta-auto-tag">auto</span>
                                        </span>
                                    }
                                </div>
                            </div>
                        }
                        
                        @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           HORARIO DE ATENCIÃ“N (GLOBAL) â€” only for appointments template
                           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
                        @if (_isAppointmentsTemplate)
                        {
                            <div class="schedule-editor">
                                    <div class="schedule-editor-body">
                                        @* Preset chips *@
                                        <div class="schedule-presets">
                                            @{ var presetMonFri = "mon-fri"; var presetMonSat = "mon-sat"; }
                                            <button class="schedule-preset-chip @(_schedulePreset == presetMonFri ? "preset-active" : "")"
                                                    @onclick="@(() => ApplySchedulePreset(presetMonFri))">Lun â€“ Vie</button>
                                            <button class="schedule-preset-chip @(_schedulePreset == presetMonSat ? "preset-active" : "")"
                                                    @onclick="@(() => ApplySchedulePreset(presetMonSat))">Lun â€“ SÃ¡b</button>
                                        </div>

                                        @* Day toggles *@
                                        <div class="schedule-day-toggles">
                                            @foreach (var day in _scheduleDays)
                                            {
                                                var isActive = _globalScheduleActiveDays.Contains(day.Value);
                                                <button class="schedule-day-chip @(isActive ? "day-active" : "")"
                                                        @onclick="() => ToggleScheduleDay(day.Value)">
                                                    @day.Label
                                                </button>
                                            }
                                        </div>

                                        @* Time range *@
                                        <div class="schedule-time-row">
                                            <MudTimePicker Label="Desde" @bind-Time="_globalWorkStart"
                                                           Variant="Variant.Outlined" Margin="Margin.Dense"
                                                           AmPm="true" />
                                            <MudTimePicker Label="Hasta" @bind-Time="_globalWorkEnd"
                                                           Variant="Variant.Outlined" Margin="Margin.Dense"
                                                           AmPm="true" />
                                        </div>
                                        @if (_globalWorkEnd.HasValue && _globalWorkStart.HasValue && _globalWorkEnd <= _globalWorkStart)
                                        {
                                            <p class="schedule-validation-msg">"Hasta" debe ser mayor que "Desde".</p>
                                        }

                                        @* Break toggle *@
                                        <div class="schedule-break-toggle">
                                            <MudSwitch @bind-Value="_hasBreak" Color="Color.Primary" Size="Size.Small" Label="Agregar descanso" />
                                        </div>
                                        @if (_hasBreak)
                                        {
                                            <div class="schedule-time-row">
                                                <MudTimePicker Label="Descanso desde" @bind-Time="_globalBreakStart"
                                                               Variant="Variant.Outlined" Margin="Margin.Dense"
                                                               AmPm="true" />
                                                <MudTimePicker Label="Descanso hasta" @bind-Time="_globalBreakEnd"
                                                               Variant="Variant.Outlined" Margin="Margin.Dense"
                                                               AmPm="true" />
                                            </div>
                                            @if (_globalBreakEnd.HasValue && _globalBreakStart.HasValue && _globalBreakEnd <= _globalBreakStart)
                                            {
                                                <p class="schedule-validation-msg">"Descanso hasta" debe ser mayor que "Descanso desde".</p>
                                            }
                                        }

                                        @* Timezone (read-only) *@
                                        <div class="schedule-timezone">
                                            <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                                            <span>@(_bookingSettings?.TimeZoneId ?? "America/El_Salvador")</span>
                                        </div>

                                        @* Exceptions (blocked dates) *@
                                        <div class="schedule-exceptions">
                                            <div class="schedule-exceptions-header">
                                                <span class="schedule-exceptions-title">Fechas no laborables</span>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small"
                                                           StartIcon="@Icons.Material.Filled.Add"
                                                           OnClick="AddScheduleException">Agregar</MudButton>
                                            </div>
                                            @if (_availabilityExceptions.Any())
                                            {
                                                <div class="schedule-exceptions-list">
                                                    @foreach (var ex in _availabilityExceptions.OrderBy(e => e.ExceptionDate))
                                                    {
                                                        <div class="schedule-exception-item">
                                                            <span>@ex.ExceptionDate.ToString("dd MMM yyyy")</span>
                                                            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small"
                                                                           OnClick="() => RemoveScheduleException(ex)" />
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <p class="schedule-exceptions-empty">Sin fechas bloqueadas</p>
                                            }
                                        </div>
                                    </div>
                            </div>

                            @* â”€â”€ Block Date Modal â”€â”€ *@
                            @if (_showBlockDateModal)
                            {
                                <MudOverlay Visible="true" DarkBackground="true" ZIndex="1300"
                                            OnClick="CancelBlockDate">
                                    <div class="block-date-modal" @onclick:stopPropagation="true">
                                        <div class="block-date-modal-header">
                                            <h3 class="block-date-modal-title">Bloquear fecha</h3>
                                            <p class="block-date-modal-subtitle">Evita reservas en una fecha especÃ­fica.</p>
                                        </div>
                                        <div class="block-date-modal-body">
                                            <MudDatePicker Label="Fecha a bloquear"
                                                           @bind-Date="_blockDateSelection"
                                                           MinDate="DateTime.Today"
                                                           Variant="Variant.Outlined"
                                                           Margin="Margin.Dense"
                                                           DateFormat="dd MMM yyyy"
                                                           Placeholder="Selecciona una fecha" />
                                            @if (_blockDateSelection != null && _availabilityExceptions.Any(e => e.ExceptionDate == DateOnly.FromDateTime(_blockDateSelection.Value)))
                                            {
                                                <p class="schedule-validation-msg">Esta fecha ya estÃ¡ bloqueada.</p>
                                            }
                                        </div>
                                        <div class="block-date-modal-footer">
                                            <MudButton Variant="Variant.Text" Color="Color.Default"
                                                       OnClick="CancelBlockDate">Cancelar</MudButton>
                                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                                       Disabled="@(!IsBlockDateValid())"
                                                       OnClick="ConfirmBlockDate">Bloquear</MudButton>
                                        </div>
                                    </div>
                                </MudOverlay>
                            }
                        }

                            <div class="section-content">
                                @* Add Service Button *@
                                <div class="services-add-area">
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="AddNewService"
                                               Disabled="@(_services.Count >= 10)"
                                               Size="Size.Small">
                                        Agregar servicio
                                    </MudButton>
                                    <span class="services-count">@_services.Count / 10</span>
                                </div>

                                @* Services List *@
                                @if (_services.Any())
                                {
                                    <div class="services-editor-list">
                                        @foreach (var (service, index) in _services.OrderBy(s => s.DisplayOrder).Select((s, i) => (s, i)))
                                        {
                                            <div class="service-editor-card @(service.IsActive ? "" : "service-inactive")">
                                                @* â”€â”€ Enterprise Service Header â”€â”€ *@
                                                <div class="service-card-header" @onclick="() => ToggleServiceBody(service.Id)">
                                                    <div class="service-header-left">
                                                        <span class="service-name-preview">@(string.IsNullOrEmpty(service.Name) ? "Nuevo servicio" : service.Name)</span>
                                                        <div class="service-header-chips">
                                                            @if (service.DurationMinutes > 0)
                                                            {
                                                                <span class="svc-chip svc-chip-duration">@FormatDuration(service.DurationMinutes)</span>
                                                            }
                                                            @if (service.PriceFrom.HasValue && service.PriceFrom > 0)
                                                            {
                                                                <span class="svc-chip svc-chip-price">$@service.PriceFrom</span>
                                                            }
                                                            @if (!string.IsNullOrEmpty(service.Modality))
                                                            {
                                                                <span class="svc-chip svc-chip-modality">@GetModalityLabel(service.Modality)</span>
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="service-header-right">
                                                        <MudSwitch @bind-Value="service.IsActive" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Small"
                                                                   @onclick:stopPropagation="true"
                                                                   title="@(service.IsActive ? "Activo" : "Inactivo")" />
                                                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                                            <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="() => DuplicateService(service)">Duplicar</MudMenuItem>
                                                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="() => RemoveService(service)" Class="mud-error-text">Eliminar</MudMenuItem>
                                                        </MudMenu>
                                                        <MudIcon Icon="@(IsServiceBodyExpanded(service.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" Class="svc-expand-icon" />
                                                    </div>
                                                </div>

                                                @* â”€â”€ Collapsible Body â”€â”€ *@
                                                <MudCollapse Expanded="IsServiceBodyExpanded(service.Id)">
                                                    <div class="service-card-body">
                                                        @* Conversion Type Selector â€” hidden for appointments (always booking) *@
                                                        @if (!_isAppointmentsTemplate)
                                                        {
                                                            <div class="service-conversion-type">
                                                                <label class="conversion-label">Este servicio se ofrece como:</label>
                                                                <div class="conversion-options">
                                                                    <div class="conversion-option @(service.ConversionType == "booking" ? "conversion-active" : "")"
                                                                         @onclick="@(() => SetServiceConversionType(service, "booking"))">
                                                                        <span class="conversion-icon">ğŸ“…</span>
                                                                        <span class="conversion-text">Cita</span>
                                                                    </div>
                                                                    <div class="conversion-option @(service.ConversionType == "quote" ? "conversion-active" : "")"
                                                                         @onclick="@(() => SetServiceConversionType(service, "quote"))">
                                                                        <span class="conversion-icon">ğŸ“</span>
                                                                        <span class="conversion-text">CotizaciÃ³n</span>
                                                                    </div>
                                                                    <div class="conversion-option @(service.ConversionType == "both" ? "conversion-active" : "")"
                                                                         @onclick="@(() => SetServiceConversionType(service, "both"))">
                                                                        <span class="conversion-icon">âœ…</span>
                                                                        <span class="conversion-text">Ambos</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }

                                                        @* Basic Fields *@
                                                        <div class="service-basic-fields">
                                                            <MudTextField @bind-Value="service.Name" 
                                                                          Label="Nombre del servicio" 
                                                                          Variant="Variant.Outlined"
                                                                          Required="true"
                                                                          Margin="Margin.Dense"
                                                                          @oninput="MarkUnsaved" />
                                                            <div class="service-row">
                                                                <MudSelect @bind-Value="service.DurationMinutes"
                                                                           Label="DuraciÃ³n"
                                                                           Variant="Variant.Outlined"
                                                                           Margin="Margin.Dense"
                                                                           @oninput="MarkUnsaved">
                                                                    <MudSelectItem Value="@(15)">15 min</MudSelectItem>
                                                                    <MudSelectItem Value="@(30)">30 min</MudSelectItem>
                                                                    <MudSelectItem Value="@(45)">45 min</MudSelectItem>
                                                                    <MudSelectItem Value="@(60)">1 hora</MudSelectItem>
                                                                    <MudSelectItem Value="@(90)">1 h 30 min</MudSelectItem>
                                                                    <MudSelectItem Value="@(120)">2 horas</MudSelectItem>
                                                                </MudSelect>
                                                                <MudNumericField @bind-Value="service.PriceFrom" 
                                                                                 Label="Precio desde $" 
                                                                                 Variant="Variant.Outlined"
                                                                                 Min="0"
                                                                                 Margin="Margin.Dense"
                                                                                 @oninput="MarkUnsaved" />
                                                            </div>
                                                            <MudTextField @bind-Value="service.Description" 
                                                                          Label="DescripciÃ³n (opcional)" 
                                                                          Variant="Variant.Outlined"
                                                                          Lines="2"
                                                                          Margin="Margin.Dense"
                                                                          @oninput="MarkUnsaved" />
                                                        </div>

                                                        @* Booking Config - Only if booking or both *@
                                                        @if (service.ConversionType == "booking" || service.ConversionType == "both")
                                                        {
                                                            <div class="service-config-panel">
                                                                <div class="config-panel-header" @onclick="() => ToggleServiceBookingConfig(service.Id)">
                                                                    <span class="config-panel-title">âš™ï¸ ConfiguraciÃ³n de Agenda</span>
                                                                    <MudIcon Icon="@(IsServiceBookingConfigExpanded(service.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" />
                                                                </div>
                                                                @if (IsServiceBookingConfigExpanded(service.Id))
                                                                {
                                                                    <div class="config-panel-content">
                                                                        @if (_isAppointmentsTemplate)
                                                                        {
                                                                            <div class="schedule-override-toggle">
                                                                                <MudSwitch @bind-Value="service.UseGlobalSchedule"
                                                                                           Color="Color.Primary" Size="Size.Small"
                                                                                           Label="Usar horario global" />
                                                                                @if (!service.UseGlobalSchedule)
                                                                                {
                                                                                    <p class="schedule-override-hint">Este servicio usa un horario personalizado (configurable en Disponibilidad).</p>
                                                                                }
                                                                            </div>
                                                                        }
                                                                        <div class="config-row">
                                                                            <MudSelect @bind-Value="service.Modality" Label="Modalidad" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                                                <MudSelectItem Value="@("presencial")">Presencial</MudSelectItem>
                                                                                <MudSelectItem Value="@("online")">Online</MudSelectItem>
                                                                                <MudSelectItem Value="@("domicilio")">A domicilio</MudSelectItem>
                                                                            </MudSelect>
                                                                            <MudSelect @bind-Value="service.MinNoticeMinutes" Label="AnticipaciÃ³n mÃ­nima" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                                                <MudSelectItem Value="@((int?)60)">1 hora</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)180)">3 horas</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)1440)">24 horas</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)2880)">48 horas</MudSelectItem>
                                                                            </MudSelect>
                                                                        </div>
                                                                        <div class="config-row">
                                                                            <MudSelect @bind-Value="service.BufferBeforeMinutes" Label="Buffer antes" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                                                <MudSelectItem Value="@((int?)0)">0 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)5)">5 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)10)">10 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)15)">15 min</MudSelectItem>
                                                                            </MudSelect>
                                                                            <MudSelect @bind-Value="service.BufferAfterMinutes" Label="Buffer despuÃ©s" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                                                <MudSelectItem Value="@((int?)0)">0 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)5)">5 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)10)">10 min</MudSelectItem>
                                                                                <MudSelectItem Value="@((int?)15)">15 min</MudSelectItem>
                                                                            </MudSelect>
                                                                        </div>
                                                                        <MudSelect @bind-Value="service.MaxBookingsPerDay" Label="LÃ­mite de citas por dÃ­a" Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true">
                                                                            <MudSelectItem Value="@((int?)0)">Ilimitado</MudSelectItem>
                                                                            <MudSelectItem Value="@((int?)3)">3 citas</MudSelectItem>
                                                                            <MudSelectItem Value="@((int?)5)">5 citas</MudSelectItem>
                                                                            <MudSelectItem Value="@((int?)10)">10 citas</MudSelectItem>
                                                                        </MudSelect>
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                    </div>
                                                </MudCollapse>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="services-empty-state">
                                        <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Large" />
                                        <p>AÃºn no tienes servicios configurados</p>
                                        <span>Agrega servicios para que tus clientes puedan reservar o solicitar cotizaciÃ³n</span>
                                    </div>
                                }
                            </div>
                    </section>
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   QUOTE REQUEST (CONDITIONAL - Only for Quote Request Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isQuoteRequestTemplate)
                {
                    <section class="section-card section-level-1 section-quotes">
                        <div class="section-header">
                            <div class="section-icon icon-quotes">
                                <MudIcon Icon="@Icons.Material.Filled.RequestQuote" Size="Size.Medium" />
                            </div>
                            <div class="section-header-text">
                                <h2 class="section-title">Cotizaciones</h2>
                                <p class="section-description">Configura el formulario de solicitud de cotizaciÃ³n</p>
                            </div>
                        </div>
                        <div class="section-content">
                            @* A) Copy del bloque *@
                            <div class="edit-group">
                                <label class="edit-label">TÃ­tulo del bloque</label>
                                <MudTextField @bind-Value="_quoteSettings.BlockTitle" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" @oninput="MarkUnsaved" />
                            </div>
                            <div class="edit-group">
                                <label class="edit-label">SubtÃ­tulo</label>
                                <MudTextField @bind-Value="_quoteSettings.BlockSubtitle" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" @oninput="MarkUnsaved" />
                            </div>
                            <div class="edit-group">
                                <MudSwitch @bind-Value="_quoteSettings.ShowLegalText" Color="Color.Primary" Label="Mostrar texto legal" />
                                @if (_quoteSettings.ShowLegalText)
                                {
                                    <MudTextField @bind-Value="_quoteSettings.LegalText" Variant="Variant.Outlined"
                                                  Margin="Margin.Dense" Placeholder="La cotizaciÃ³n puede variar segÃºn alcance."
                                                  @oninput="MarkUnsaved" />
                                }
                            </div>

                            @* B) ConfiguraciÃ³n de campos *@
                            <MudDivider Class="my-3" />
                            <label class="edit-label">Campos del formulario</label>
                            <div class="form-fields-config">
                                <MudSwitch @bind-Value="_quoteSettings.EmailRequired" Color="Color.Primary" Label="Email requerido" />
                                <MudSwitch @bind-Value="_quoteSettings.PhoneRequired" Color="Color.Primary" Label="TelÃ©fono requerido" />
                                <MudSwitch @bind-Value="_quoteSettings.ShowBudgetField" Color="Color.Primary" Label="Presupuesto aproximado" />
                                <MudSwitch @bind-Value="_quoteSettings.ShowDeadlineField" Color="Color.Primary" Label="Â¿Para cuÃ¡ndo lo necesitas?" />
                                <MudSwitch @bind-Value="_quoteSettings.ShowPreferredContactField" Color="Color.Primary" Label="Preferencia de contacto" />
                            </div>

                            @* C) ConfirmaciÃ³n *@
                            <MudDivider Class="my-3" />
                            <div class="edit-group">
                                <label class="edit-label">Mensaje de Ã©xito</label>
                                <MudTextField @bind-Value="_quoteSettings.SuccessMessage" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" @oninput="MarkUnsaved" />
                            </div>
                        </div>
                    </section>
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   RESERVATIONS (CONDITIONAL - Only for Reservations Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isReservationsTemplate)
                {
                    <section class="section-card section-level-1 section-quotes">
                        <div class="section-header">
                            <div class="section-icon icon-quotes">
                                <MudIcon Icon="@Icons.Material.Filled.Hotel" Size="Size.Medium" />
                            </div>
                            <div class="section-header-text">
                                <h2 class="section-title">Reservas</h2>
                                <p class="section-description">Configura el bloque de reservas y polÃ­ticas</p>
                            </div>
                        </div>
                        <div class="section-content">

                            @* â”€â”€ A) ENCABEZADO â”€â”€ *@
                            <MudGrid Spacing="2">
                                <MudItem xs="12" md="8">
                                    <div class="edit-group">
                                        <label class="edit-label">TÃ­tulo del bloque</label>
                                        <MudTextField @bind-Value="_reservationSettings.BlockTitle" Variant="Variant.Outlined"
                                                      Margin="Margin.Dense" @oninput="MarkUnsaved" />
                                    </div>
                                    <div class="edit-group" style="margin-top:8px;">
                                        <label class="edit-label">SubtÃ­tulo</label>
                                        <MudTextField @bind-Value="_reservationSettings.BlockSubtitle" Variant="Variant.Outlined"
                                                      Margin="Margin.Dense" @oninput="MarkUnsaved" />
                                    </div>
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <div class="edit-group">
                                        <MudTextField @bind-Value="_reservationSettings.ConfirmationTimeText" Label="Tiempo de confirmaciÃ³n"
                                                      Variant="Variant.Outlined" Margin="Margin.Dense" @oninput="MarkUnsaved" />
                                    </div>
                                    <div class="edit-group" style="margin-top:8px;">
                                        <MudTextField @bind-Value="_reservationSettings.SuccessMessage" Label="Mensaje de Ã©xito"
                                                      Variant="Variant.Outlined" Margin="Margin.Dense" @oninput="MarkUnsaved" />
                                    </div>
                                </MudItem>
                            </MudGrid>

                            @* â”€â”€ B) RESTRICCIONES â”€â”€ *@
                            <label class="edit-label" style="margin-top:16px; margin-bottom:4px; display:block;">Restricciones</label>
                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_reservationSettings.MinNights" Label="Noches mÃ­nimas"
                                                     Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" Max="30" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_reservationSettings.MinAdvanceDays" Label="DÃ­as de anticipaciÃ³n"
                                                     Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="90" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudNumericField @bind-Value="_reservationSettings.MaxGuests" Label="HuÃ©spedes mÃ¡ximos"
                                                     Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" Max="50" />
                                </MudItem>
                                <MudItem xs="12" sm="6" Class="d-flex align-center">
                                    <MudSwitch @bind-Value="_reservationSettings.SeparateChildCount" Color="Color.Primary" Label="Separar adultos y niÃ±os" />
                                </MudItem>
                            </MudGrid>

                            @* â”€â”€ C) CHECK-IN / CHECK-OUT â”€â”€ *@
                            <label class="edit-label" style="margin-top:16px; margin-bottom:4px; display:block;">Check-in / Check-out</label>
                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="6">
                                    <MudTimePicker Label="Check-in" AmPm="true"
                                                   Time="_reservationSettings.CheckInTime"
                                                   TimeChanged="OnCheckInTimeChanged"
                                                   Variant="Variant.Outlined" Margin="Margin.Dense"
                                                   Adornment="Adornment.End"
                                                   AdornmentIcon="@Icons.Material.Filled.Schedule"
                                                   Editable="false" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTimePicker Label="Check-out" AmPm="true"
                                                   Time="_reservationSettings.CheckOutTime"
                                                   TimeChanged="OnCheckOutTimeChanged"
                                                   Variant="Variant.Outlined" Margin="Margin.Dense"
                                                   Adornment="Adornment.End"
                                                   AdornmentIcon="@Icons.Material.Filled.Schedule"
                                                   Editable="false" />
                                </MudItem>
                            </MudGrid>
                            @if (_reservationCheckOutError != null)
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2" NoIcon="false">
                                    @_reservationCheckOutError
                                </MudAlert>
                            }

                            @* â”€â”€ D) CAMPOS DEL FORMULARIO â”€â”€ *@
                            <label class="edit-label" style="margin-top:16px; margin-bottom:4px; display:block;">Campos del formulario</label>
                            <MudGrid Spacing="2">
                                <MudItem xs="12" sm="6" Class="d-flex align-center">
                                    <MudSwitch @bind-Value="_reservationSettings.EmailRequired" Color="Color.Primary" Label="Email requerido" />
                                </MudItem>
                                <MudItem xs="12" sm="6" Class="d-flex align-center">
                                    <MudSwitch @bind-Value="_reservationSettings.PhoneRequired" Color="Color.Primary" Label="TelÃ©fono requerido" />
                                </MudItem>
                            </MudGrid>

                            @* â”€â”€ E) POLÃTICAS â”€â”€ *@
                            <label class="edit-label" style="margin-top:16px; margin-bottom:4px; display:block;">PolÃ­ticas</label>
                            <MudSwitch @bind-Value="_reservationSettings.ShowPolicies" Color="Color.Primary" Label="Mostrar polÃ­ticas" />
                            @if (_reservationSettings.ShowPolicies)
                            {
                                <MudTextField @bind-Value="_reservationSettings.PoliciesText" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" Lines="3" Placeholder="CancelaciÃ³n gratuita hasta 48h antes..."
                                              Class="mt-2" @oninput="MarkUnsaved" />
                            }

                        </div>
                    </section>
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   SAVE BUTTON - PREMIUM CTA
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <div class="save-section">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="SaveCard" 
                               Size="Size.Large"
                               StartIcon="@(_isSaving ? null : Icons.Material.Filled.Save)"
                               Disabled="_isSaving"
                               Class="save-btn-main">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" Class="mr-2" />
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>Guardar cambios</span>
                        }
                    </MudButton>
                </div>
            </main>

            @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               MOBILE BOTTOM BAR (hidden on desktop, fixed on â‰¤600px)
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
            <div class="mobile-bottom-bar @(_mobilePreviewOpen ? "mobile-bar-hidden" : "")">
                <button class="mobile-save-btn @(!_hasUnsavedChanges && !_isSaving ? "mobile-save-btn-idle" : "")" @onclick="SaveCard" disabled="@(_isSaving || !_hasUnsavedChanges)">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" Style="width:16px;height:16px;" />
                        <span>GUARDANDO...</span>
                    }
                    else
                    {
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        <span>GUARDAR CAMBIOS</span>
                    }
                </button>
                <button class="mobile-preview-btn-bottom" @onclick="ToggleMobilePreview">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>

            @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
               RIGHT COLUMN: PREMIUM IPHONE-STYLE LIVE PREVIEW (STICKY)
               â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
            <aside class="preview-sidebar">
                <div class="preview-sticky">
                    @* Premium Preview Card Container with Glow *@
                    <div class="preview-panel">
                        @* Panel Header *@
                        <div class="preview-panel-header">
                            <div class="preview-panel-icon">
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                            </div>
                            <div class="preview-panel-text">
                                <h2 class="preview-panel-title">Vista previa</h2>
                                <p class="preview-panel-subtitle">Live Preview â€” @(string.IsNullOrEmpty(_card.FullName) ? "Sin nombre" : _card.FullName)</p>
                            </div>
                        </div>

                        @* iPhone Device Frame *@
                        <div class="iphone-frame">
                            @* Dynamic Island *@
                            <div class="dynamic-island"></div>
                            
                            @* Phone Screen with Internal Scroll *@
                            <div class="iphone-screen">
                                @* Card Header Gradient *@
                                <div class="phone-card-header">
                                    @* Status bar icons *@
                                    <div class="status-bar">
                                        <span class="status-time">9:41</span>
                                        <div class="status-icons">
                                            <MudIcon Icon="@Icons.Material.Filled.SignalCellularAlt" Size="Size.Small" />
                                            <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small" />
                                            <MudIcon Icon="@Icons.Material.Filled.BatteryFull" Size="Size.Small" />
                                        </div>
                                    </div>
                                </div>

                                @* Scrollable Content Area *@
                                <div class="phone-card-content @GetBackgroundContrastClass()" style="@GetPreviewBackgroundStyle()">
                                    @* Avatar Section *@
                                    <div class="phone-avatar-section">
                                        @if (!string.IsNullOrEmpty(_card.ProfileImageUrl))
                                        {
                                            <div class="phone-avatar phone-avatar-image avatar-size-@_cardStyle.AvatarSize.ToLower() @(_cardStyle.AvatarGlow ? "avatar-glow" : "")">
                                                <img src="@_card.ProfileImageUrl" alt="@_card.FullName" />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="phone-avatar phone-avatar-initials avatar-size-@_cardStyle.AvatarSize.ToLower() @(_cardStyle.AvatarGlow ? "avatar-glow" : "")">
                                                <span>@GetInitials(_card.FullName)</span>
                                            </div>
                                        }
                                    </div>

                                    @* Identity Info *@
                                    <h3 class="phone-name">@(string.IsNullOrEmpty(_card.FullName) ? "Tu Nombre" : _card.FullName)</h3>
                                    <p class="phone-title">@(string.IsNullOrEmpty(_card.Title) ? "â€”" : _card.Title)</p>
                                    <p class="phone-company">@GetDisplayCompanyName()</p>

                                    @* Bio *@
                                    @if (!string.IsNullOrEmpty(_card.Bio))
                                    {
                                        <p class="phone-bio">@_card.Bio</p>
                                    }
                                    else
                                    {
                                        <p class="phone-bio phone-bio-placeholder">Tu biografÃ­a aparecerÃ¡ aquÃ­...</p>
                                    }

                                    @* Social Icons â€” Shared Component *@
                                    <SocialLinksRow
                                        LinkedIn="@_socialLinks?.LinkedIn"
                                        Instagram="@_socialLinks?.Instagram"
                                        Facebook="@_socialLinks?.Facebook"
                                        YouTube="@_socialLinks?.YouTube"
                                        Twitter="@_socialLinks?.Twitter"
                                        Website="@_socialLinks?.Website"
                                        Compact="true"
                                        IsPreview="true" />

                                    @* Status Chips *@
                                    <div class="phone-status-chips">
                                        <span class="phone-chip">
                                            <span class="chip-dot"></span> Disponible
                                        </span>
                                        <span class="phone-chip">
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                            Responde &lt; 1h
                                        </span>
                                        <span class="phone-chip">
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                            El Salvador
                                        </span>
                                    </div>

                                    @* Portfolio Gallery Preview (conditional) â€” Shared Component *@
                                    @if (_isPortfolioTemplate)
                                    {
                                        <PortfolioGalleryBlock
                                            Photos="@_portfolioGallery.Photos"
                                            Videos="@_portfolioGallery.Videos"
                                            EnablePhotos="@_portfolioGallery.EnablePhotos"
                                            EnableVideos="@_portfolioGallery.EnableVideos"
                                            Compact="true" />
                                    }

                                    @* Quote Request Block - BEFORE CTAs to match PublicCard layout *@
                                    @if (_isQuoteRequestTemplate)
                                    {
                                        <QuoteRequestBlock
                                            Compact="true"
                                            Title="@_quoteSettings.BlockTitle"
                                            Subtitle="@_quoteSettings.BlockSubtitle"
                                            CtaLabel="@_quoteSettings.BlockTitle"
                                            ShowLegalText="@_quoteSettings.ShowLegalText"
                                            LegalText="@_quoteSettings.LegalText" />
                                    }

                                    @* Appointment Booking Block - BEFORE CTAs to match PublicCard layout *@
                                    @if (_isAppointmentsTemplate)
                                    {
                                        @if (_services.Any())
                                        {
                                            <AppointmentBookingBlock
                                                Compact="true"
                                                Services="@_services.Select(s => new AppointmentBookingBlock.ServiceDisplayItem { Name = s.Name, DurationMinutes = s.DurationMinutes, Price = s.PriceFrom }).ToList()" />
                                        }
                                        else
                                        {
                                            @* Mock services fallback â€” same as TemplateLibrary preview *@
                                            <AppointmentBookingBlock
                                                Compact="true"
                                                Services="@_mockAppointmentServices" />
                                            <p style="text-align:center; font-size:0.5rem; color:var(--dt-text-muted, rgba(255,255,255,0.35)); margin:-8px 0 8px;">Configura tus servicios en la secciÃ³n de arriba</p>
                                        }
                                    }

                                    @* Reservation Booking Block - BEFORE CTAs to match PublicCard layout *@
                                    @if (_isReservationsTemplate)
                                    {
                                        <ReservationBookingBlock
                                            Compact="true"
                                            Title="@_reservationSettings.BlockTitle"
                                            Subtitle="@_reservationSettings.BlockSubtitle"
                                            MaxGuests="@_reservationSettings.MaxGuests"
                                            ConfirmationText="@_reservationSettings.ConfirmationTimeText"
                                            PoliciesLabel="@(_reservationSettings.ShowPolicies ? "PolÃ­ticas" : null)" />
                                    }

                                    @* CTA Buttons *@
                                    @if (true)
                                    {
                                        @* CTA Buttons - Matching Public Card *@
                                        <div class="phone-cta-container btn-shape-@_cardStyle.ButtonShape btn-style-@_cardStyle.ButtonStyle">
                                            @* Primary CTA: Guardar Contacto (Full Width) *@
                                            @if (_card.ShowSaveContact)
                                            {
                                                <button class="phone-cta-primary"
                                                        style="border-radius: @GetButtonRadius();">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                                        <circle cx="8.5" cy="7" r="4"/>
                                                        <line x1="20" y1="8" x2="20" y2="14"/>
                                                        <line x1="23" y1="11" x2="17" y2="11"/>
                                                    </svg>
                                                    <span>Guardar Contacto</span>
                                                </button>
                                            }

                                            @* Secondary Row: WhatsApp, Llamar, Email - Outline Style *@
                                            <div class="phone-cta-secondary-row">
                                                @* WhatsApp - Show disabled if toggle ON but no number *@
                                                @if (_card.ShowWhatsApp)
                                                {
                                                    @if (!string.IsNullOrEmpty(_card.WhatsAppNumber))
                                                    {
                                                        <button class="phone-cta-outline cta-whatsapp-outline"
                                                                style="border-radius: @GetButtonRadius();">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                                            </svg>
                                                            WhatsApp
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <button class="phone-cta-outline cta-whatsapp-outline phone-cta-disabled"
                                                                style="border-radius: @GetButtonRadius();"
                                                                title="Agrega un nÃºmero de WhatsApp para habilitar">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                                            </svg>
                                                            WhatsApp
                                                        </button>
                                                    }
                                                }
                                                @* Llamar - Show disabled if toggle ON but no phone *@
                                                @if (_card.ShowCall)
                                                {
                                                    @if (!string.IsNullOrEmpty(_card.Phone))
                                                    {
                                                        <button class="phone-cta-outline cta-llamar-outline"
                                                                style="border-radius: @GetButtonRadius();">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                                        </svg>
                                                        Llamar
                                                    </button>
                                                    }
                                                    else
                                                    {
                                                        <button class="phone-cta-outline cta-llamar-outline phone-cta-disabled"
                                                                style="border-radius: @GetButtonRadius();"
                                                                title="Agrega un nÃºmero de telÃ©fono para habilitar">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                                        </svg>
                                                        Llamar
                                                    </button>
                                                    }
                                                }
                                                @* Email - Show disabled if toggle ON but no email *@
                                                @if (_card.ShowEmail)
                                                {
                                                    @if (!string.IsNullOrEmpty(_card.Email))
                                                    {
                                                        <button class="phone-cta-outline cta-email-outline"
                                                                style="border-radius: @GetButtonRadius();">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                                                <polyline points="22,6 12,13 2,6"/>
                                                            </svg>
                                                            Email
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <button class="phone-cta-outline cta-email-outline phone-cta-disabled"
                                                                style="border-radius: @GetButtonRadius();"
                                                                title="Agrega un correo electrÃ³nico para habilitar">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                                                <polyline points="22,6 12,13 2,6"/>
                                                            </svg>
                                                            Email
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    }
                                    @* TEMPLATE-SPECIFIC CONTENT *@
                                    @if (_isServicesTemplate)
                                    {
                                        @* Services Template Preview Section *@
                                        <div class="phone-services-section">
                                            <h4 class="phone-services-title">MIS SERVICIOS</h4>
                                            <div class="phone-services-list">
                                                @if (_services.Any())
                                                {
                                                    @foreach (var service in _services.Take(3))
                                                    {
                                                        <div class="phone-service-card">
                                                            <div class="phone-service-icon">
                                                                <span>@GetServiceEmoji(service.Name)</span>
                                                            </div>
                                                            <div class="phone-service-info">
                                                                <span class="phone-service-name">@service.Name</span>
                                                                <span class="phone-service-meta">
                                                                    @service.DurationMinutes min Â· Desde $@service.PriceFrom
                                                                </span>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="phone-service-card">
                                                        <div class="phone-service-icon">ğŸ’¼</div>
                                                        <div class="phone-service-info">
                                                            <span class="phone-service-name">ConsultorÃ­a Empresarial</span>
                                                            <span class="phone-service-meta">60 min Â· Desde $50</span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            
                                            @* Booking CTAs - Smart display based on GetEffectivePrimaryGoal *@
                                            <div class="phone-booking-ctas">
                                                @{
                                                    var effectiveGoal = GetEffectivePrimaryGoal();
                                                    var hasBooking = HasBookingServices();
                                                    var hasQuote = HasQuoteServices();
                                                }
                                                @if (effectiveGoal == "booking" && hasBooking)
                                                {
                                                    <button class="phone-cta-booking">
                                                        ğŸ“… Reservar Cita
                                                    </button>
                                                    @if (hasQuote)
                                                    {
                                                        <span class="phone-cta-secondary">o solicitar cotizaciÃ³n</span>
                                                    }
                                                }
                                                else if (effectiveGoal == "quote" && hasQuote)
                                                {
                                                    <button class="phone-cta-booking">
                                                        ğŸ“ Solicitar CotizaciÃ³n
                                                    </button>
                                                    @if (hasBooking)
                                                    {
                                                        <span class="phone-cta-secondary">o reservar cita</span>
                                                    }
                                                }
                                                else if (hasBooking)
                                                {
                                                    <button class="phone-cta-booking">
                                                        ğŸ“… Reservar Cita
                                                    </button>
                                                }
                                                else if (hasQuote)
                                                {
                                                    <button class="phone-cta-booking">
                                                        ğŸ“ Solicitar CotizaciÃ³n
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else if (_isQuoteRequestTemplate)
                                    {
                                        @* Quote Request: no lead form â€” quote block already rendered above CTAs *@
                                    }
                                    else if (_isAppointmentsTemplate)
                                    {
                                        @* Appointments: no lead form â€” booking block already rendered above CTAs *@
                                    }
                                    else if (_isReservationsTemplate)
                                    {
                                        @* Reservations: no lead form â€” reservation booking block already rendered above CTAs *@
                                    }
                                    else
                                    {
                                        @* Lead Form Preview Section (Default/Professional template) *@
                                        <div class="phone-lead-form-section">
                                            <div class="phone-lead-header">
                                                <h4 class="phone-lead-title">Â¿Quieres que te contacte?</h4>
                                                <p class="phone-lead-subtitle">DÃ©jame tus datos y te respondo pronto</p>
                                            </div>
                                            
                                            <div class="phone-lead-form">
                                                @* Nombre *@
                                                <div class="phone-form-field">
                                                    <label class="phone-field-label">
                                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                                        Nombre completo <span class="required-mark">*</span>
                                                    </label>
                                                    <div class="phone-input-mock">Juan PÃ©rez</div>
                                                </div>
                                                
                                                @* Email *@
                                                <div class="phone-form-field">
                                                    <label class="phone-field-label">
                                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" />
                                                        Correo electrÃ³nico <span class="required-mark">*</span>
                                                    </label>
                                                    <div class="phone-input-mock">tu@email.com</div>
                                                </div>
                                                
                                                @* TelÃ©fono *@
                                                <div class="phone-form-field">
                                                    <label class="phone-field-label">
                                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                                        TelÃ©fono <span class="required-mark">*</span>
                                                    </label>
                                                    <div class="phone-input-row">
                                                        <div class="phone-country-mock">ğŸ‡¸ğŸ‡» +503</div>
                                                        <div class="phone-input-mock phone-input-number">7000 0000</div>
                                                    </div>
                                                </div>
                                                
                                                @* Mensaje *@
                                                <div class="phone-form-field">
                                                    <label class="phone-field-label">
                                                        <MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Small" />
                                                        Mensaje <span class="optional-mark">(opcional)</span>
                                                    </label>
                                                    <div class="phone-textarea-mock">Â¿En quÃ© puedo ayudarte?</div>
                                                </div>
                                                
                                                @* Submit Button *@
                                                <button class="phone-submit-btn">
                                                    <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                                                    <span>Enviar mensaje</span>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    @* URL Section OUTSIDE Phone - Interactive *@
                    <div class="preview-url-section">
                        <div class="preview-url-input" @onclick="CopyPublicUrl" title="Copiar URL">
                            <span class="preview-url-text">@_publicUrl</span>
                            <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small" Class="copy-icon" />
                        </div>
                        <a href="@_publicUrl" target="_blank" class="preview-url-cta">
                            <span>â†’</span> VER TARJETA PÃšBLICA
                        </a>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE PREVIEW OVERLAY (full-screen, hidden on desktop)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    @if (_mobilePreviewOpen)
    {
        <div class="mobile-preview-overlay" @onclick="CloseMobilePreview">
            <div class="mobile-preview-content" @onclick:stopPropagation="true">
                @* Overlay Header *@
                <div class="mobile-overlay-header">
                    <span class="mobile-overlay-title">VISTA PREVIA</span>
                    <button class="mobile-overlay-close" @onclick="CloseMobilePreview" aria-label="Cerrar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                @* Overlay Body â€” Reuses SAME phone preview as desktop *@
                <div class="mobile-overlay-body">
                    <div class="iphone-frame">
                        <div class="dynamic-island"></div>
                        <div class="iphone-screen">
                            <div class="phone-card-header">
                                <div class="status-bar">
                                    <span class="status-time">9:41</span>
                                    <div class="status-icons">
                                        <MudIcon Icon="@Icons.Material.Filled.SignalCellularAlt" Size="Size.Small" />
                                        <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small" />
                                        <MudIcon Icon="@Icons.Material.Filled.BatteryFull" Size="Size.Small" />
                                    </div>
                                </div>
                            </div>
                            <div class="phone-card-content @GetBackgroundContrastClass()" style="@GetPreviewBackgroundStyle()">
                                @* Avatar Section *@
                                <div class="phone-avatar-section">
                                    @if (!string.IsNullOrEmpty(_card.ProfileImageUrl))
                                    {
                                        <div class="phone-avatar phone-avatar-image avatar-size-@_cardStyle.AvatarSize.ToLower() @(_cardStyle.AvatarGlow ? "avatar-glow" : "")">
                                            <img src="@_card.ProfileImageUrl" alt="@_card.FullName" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="phone-avatar phone-avatar-initials avatar-size-@_cardStyle.AvatarSize.ToLower() @(_cardStyle.AvatarGlow ? "avatar-glow" : "")">
                                            <span>@GetInitials(_card.FullName)</span>
                                        </div>
                                    }
                                </div>

                                @* Identity Info *@
                                <h3 class="phone-name">@(string.IsNullOrEmpty(_card.FullName) ? "Tu Nombre" : _card.FullName)</h3>
                                <p class="phone-title">@(string.IsNullOrEmpty(_card.Title) ? "â€”" : _card.Title)</p>
                                <p class="phone-company">@GetDisplayCompanyName()</p>

                                @* Bio *@
                                @if (!string.IsNullOrEmpty(_card.Bio))
                                {
                                    <p class="phone-bio">@_card.Bio</p>
                                }
                                else
                                {
                                    <p class="phone-bio phone-bio-placeholder">Tu biografÃ­a aparecerÃ¡ aquÃ­...</p>
                                }

                                @* Social Icons â€” Shared Component *@
                                <SocialLinksRow
                                    LinkedIn="@_socialLinks?.LinkedIn"
                                    Instagram="@_socialLinks?.Instagram"
                                    Facebook="@_socialLinks?.Facebook"
                                    YouTube="@_socialLinks?.YouTube"
                                    Twitter="@_socialLinks?.Twitter"
                                    Website="@_socialLinks?.Website"
                                    Compact="true"
                                    IsPreview="true" />

                                @* Status Chips *@
                                <div class="phone-status-chips">
                                    <span class="phone-chip">
                                        <span class="chip-dot"></span> Disponible
                                    </span>
                                    <span class="phone-chip">
                                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        Responde &lt; 1h
                                    </span>
                                    <span class="phone-chip">
                                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                        El Salvador
                                    </span>
                                </div>

                                @* Portfolio Gallery Preview (conditional) â€” Shared Component *@
                                @if (_isPortfolioTemplate)
                                {
                                    <PortfolioGalleryBlock
                                        Photos="@_portfolioGallery.Photos"
                                        Videos="@_portfolioGallery.Videos"
                                        EnablePhotos="@_portfolioGallery.EnablePhotos"
                                        EnableVideos="@_portfolioGallery.EnableVideos"
                                        Compact="true" />
                                }

                                @* Quote Request Block *@
                                @if (_isQuoteRequestTemplate)
                                {
                                    <QuoteRequestBlock
                                        Compact="true"
                                        Title="@_quoteSettings.BlockTitle"
                                        Subtitle="@_quoteSettings.BlockSubtitle"
                                        CtaLabel="@_quoteSettings.BlockTitle"
                                        ShowLegalText="@_quoteSettings.ShowLegalText"
                                        LegalText="@_quoteSettings.LegalText" />
                                }

                                @* Appointment Booking Block *@
                                @if (_isAppointmentsTemplate)
                                {
                                    @if (_services.Any())
                                    {
                                        <AppointmentBookingBlock
                                            Compact="true"
                                            Services="@_services.Select(s => new AppointmentBookingBlock.ServiceDisplayItem { Name = s.Name, DurationMinutes = s.DurationMinutes, Price = s.PriceFrom }).ToList()" />
                                    }
                                    else
                                    {
                                        <AppointmentBookingBlock
                                            Compact="true"
                                            Services="@_mockAppointmentServices" />
                                    }
                                }

                                @* Reservation Booking Block *@
                                @if (_isReservationsTemplate)
                                {
                                    <ReservationBookingBlock
                                        Compact="true"
                                        Title="@_reservationSettings.BlockTitle"
                                        Subtitle="@_reservationSettings.BlockSubtitle"
                                        MaxGuests="@_reservationSettings.MaxGuests"
                                        ConfirmationText="@_reservationSettings.ConfirmationTimeText"
                                        PoliciesLabel="@(_reservationSettings.ShowPolicies ? "PolÃ­ticas" : null)" />
                                }

                                @* CTA Buttons *@
                                <div class="phone-cta-container btn-shape-@_cardStyle.ButtonShape btn-style-@_cardStyle.ButtonStyle">
                                    @if (_card.ShowSaveContact)
                                    {
                                        <button class="phone-cta-primary" style="border-radius: @GetButtonRadius();">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                                <circle cx="8.5" cy="7" r="4"/>
                                                <line x1="20" y1="8" x2="20" y2="14"/>
                                                <line x1="23" y1="11" x2="17" y2="11"/>
                                            </svg>
                                            <span>Guardar Contacto</span>
                                        </button>
                                    }
                                    <div class="phone-cta-secondary-row">
                                        @if (_card.ShowWhatsApp && !string.IsNullOrEmpty(_card.WhatsAppNumber))
                                        {
                                            <button class="phone-cta-outline cta-whatsapp-outline" style="border-radius: @GetButtonRadius();">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                                WhatsApp
                                            </button>
                                        }
                                        @if (_card.ShowCall && !string.IsNullOrEmpty(_card.Phone))
                                        {
                                            <button class="phone-cta-outline cta-llamar-outline" style="border-radius: @GetButtonRadius();">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                                Llamar
                                            </button>
                                        }
                                        @if (_card.ShowEmail && !string.IsNullOrEmpty(_card.Email))
                                        {
                                            <button class="phone-cta-outline cta-email-outline" style="border-radius: @GetButtonRadius();">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                                Email
                                            </button>
                                        }
                                    </div>
                                </div>

                                @* Template-specific content *@
                                @if (_isServicesTemplate)
                                {
                                    <div class="phone-services-section">
                                        <h4 class="phone-services-title">MIS SERVICIOS</h4>
                                        <div class="phone-services-list">
                                            @if (_services.Any())
                                            {
                                                @foreach (var service in _services.Take(3))
                                                {
                                                    <div class="phone-service-card">
                                                        <div class="phone-service-icon"><span>@GetServiceEmoji(service.Name)</span></div>
                                                        <div class="phone-service-info">
                                                            <span class="phone-service-name">@service.Name</span>
                                                            <span class="phone-service-meta">@service.DurationMinutes min Â· Desde $@service.PriceFrom</span>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="phone-service-card">
                                                    <div class="phone-service-icon">ğŸ’¼</div>
                                                    <div class="phone-service-info">
                                                        <span class="phone-service-name">ConsultorÃ­a Empresarial</span>
                                                        <span class="phone-service-meta">60 min Â· Desde $50</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        <div class="phone-booking-ctas">
                                            @{
                                                var effectiveGoal = GetEffectivePrimaryGoal();
                                                var hasBooking = HasBookingServices();
                                                var hasQuote = HasQuoteServices();
                                            }
                                            @if (effectiveGoal == "booking" && hasBooking)
                                            {
                                                <button class="phone-cta-booking">ğŸ“… Reservar Cita</button>
                                                @if (hasQuote) { <span class="phone-cta-secondary">o solicitar cotizaciÃ³n</span> }
                                            }
                                            else if (effectiveGoal == "quote" && hasQuote)
                                            {
                                                <button class="phone-cta-booking">ğŸ“ Solicitar CotizaciÃ³n</button>
                                                @if (hasBooking) { <span class="phone-cta-secondary">o reservar cita</span> }
                                            }
                                            else if (hasBooking)
                                            {
                                                <button class="phone-cta-booking">ğŸ“… Reservar Cita</button>
                                            }
                                            else if (hasQuote)
                                            {
                                                <button class="phone-cta-booking">ğŸ“ Solicitar CotizaciÃ³n</button>
                                            }
                                        </div>
                                    </div>
                                }
                                else if (_isQuoteRequestTemplate) { }
                                else if (_isAppointmentsTemplate) { }
                                else if (_isReservationsTemplate) { }
                                else
                                {
                                    @* Lead Form Preview (Default template) *@
                                    <div class="phone-lead-form-section">
                                        <div class="phone-lead-header">
                                            <h4 class="phone-lead-title">Â¿Quieres que te contacte?</h4>
                                            <p class="phone-lead-subtitle">DÃ©jame tus datos y te respondo pronto</p>
                                        </div>
                                        <div class="phone-lead-form">
                                            <div class="phone-form-field">
                                                <label class="phone-field-label"><MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> Nombre completo <span class="required-mark">*</span></label>
                                                <div class="phone-input-mock">Juan PÃ©rez</div>
                                            </div>
                                            <div class="phone-form-field">
                                                <label class="phone-field-label"><MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> Correo electrÃ³nico <span class="required-mark">*</span></label>
                                                <div class="phone-input-mock">tu@email.com</div>
                                            </div>
                                            <div class="phone-form-field">
                                                <label class="phone-field-label"><MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" /> TelÃ©fono <span class="required-mark">*</span></label>
                                                <div class="phone-input-row">
                                                    <div class="phone-country-mock">ğŸ‡¸ğŸ‡» +503</div>
                                                    <div class="phone-input-mock phone-input-number">7000 0000</div>
                                                </div>
                                            </div>
                                            <div class="phone-form-field">
                                                <label class="phone-field-label"><MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Small" /> Mensaje <span class="optional-mark">(opcional)</span></label>
                                                <div class="phone-textarea-mock">Â¿En quÃ© puedo ayudarte?</div>
                                            </div>
                                            <button class="phone-submit-btn">
                                                <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                                                <span>Enviar mensaje</span>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                </div>

                @* Overlay Footer â€” actions + save *@
                <div class="mobile-overlay-footer">
                    <div class="mobile-overlay-actions-row">
                        <a href="@_publicUrl" target="_blank" class="mobile-overlay-link">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                            VER TARJETA PÃšBLICA
                        </a>
                        <button class="mobile-overlay-copy" @onclick="CopyUrl">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            COPIAR LINK
                        </button>
                    </div>
                    <button class="mobile-overlay-save-btn @(!_hasUnsavedChanges && !_isSaving ? "mobile-save-btn-idle" : "")" @onclick="SaveCard" disabled="@(_isSaving || !_hasUnsavedChanges)">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" Style="width:16px;height:16px;" />
                            <span>GUARDANDO...</span>
                        }
                        else
                        {
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            <span>GUARDAR CAMBIOS</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
}

<style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MYCARD - PREMIUM ENTERPRISE REDESIGN
       Dark Mate + Tech Premium Visual Identity
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .mycard-container {
        max-width: 1432px;
        width: 100%;
        margin: 0 auto;
        padding: 17px 24px 40px;
        box-sizing: border-box;
        background: transparent;
        overflow-x: hidden;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PAGE HEADER
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: var(--dt-surface-1, #111827);
        border-radius: var(--dt-radius-xl, 16px);
        border: 1px solid var(--dt-border-default, #233044);
        margin-bottom: 24px;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .header-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--dt-primary-500, #6366F1), var(--dt-primary-600, #4F46E5));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .header-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dt-text-primary, #E5E7EB);
        margin: 0 0 4px 0;
    }

    .header-subtitle {
        font-size: 0.875rem;
        color: var(--dt-text-secondary, #9CA3AF);
        margin: 0;
    }

    /* Save Status */
    .save-status {
        display: flex;
        align-items: center;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: var(--dt-radius-full, 9999px);
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .status-saving {
        background: var(--dt-info-bg, rgba(37, 99, 235, 0.1));
        color: var(--dt-info, #2563EB);
        border: 1px solid var(--dt-info-border, rgba(37, 99, 235, 0.3));
    }

    .status-unsaved {
        background: var(--dt-warning-bg, rgba(217, 119, 6, 0.1));
        color: var(--dt-warning, #D97706);
        border: 1px solid var(--dt-warning-border, rgba(217, 119, 6, 0.3));
    }

    .status-saved {
        background: var(--dt-success-bg, rgba(22, 163, 74, 0.1));
        color: var(--dt-success, #16A34A);
        border: 1px solid var(--dt-success-border, rgba(22, 163, 74, 0.3));
    }

    .last-updated {
        color: var(--dt-text-muted, #6B7280);
        font-weight: 400;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       EDITOR LAYOUT (Two Columns)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .editor-layout {
        display: grid;
        grid-template-columns: 1fr minmax(380px, 460px);
        gap: 24px;
        align-items: start;
        width: 100%;
        box-sizing: border-box;
    }

    @@media (max-width: 1024px) {
        .editor-layout {
            grid-template-columns: 1fr;
        }
        .preview-sidebar {
            order: -1;
        }
    }

    .editor-main {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SECTION CARDS
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-card {
        background: var(--dt-surface-1, #111827);
        border-radius: var(--dt-radius-xl, 16px);
        border: 1px solid var(--dt-border-default, #233044);
        overflow: hidden;
        transition: border-color var(--dt-transition-normal, 250ms ease);
    }

    .section-card:hover {
        border-color: var(--dt-border-strong, #2E3E57);
    }

    /* Level 1 - Dominant */
    .section-level-1 {
        padding: 24px;
    }

    .section-level-1 .section-icon {
        width: 48px;
        height: 48px;
    }

    /* Level 2 - Secondary */
    .section-level-2 {
        padding: 20px;
    }

    .section-level-2 .section-icon {
        width: 40px;
        height: 40px;
    }

    /* Level 3 - Minimal */
    .section-level-3 {
        padding: 16px 20px;
    }

    .section-level-3 .section-icon {
        width: 36px;
        height: 36px;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    /* Unified Identity Header with Avatar on Right */
    .identity-header-with-avatar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: nowrap;
    }
    
    .section-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
        flex: 1;
        min-width: 0;
    }
    
    .identity-avatar-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        margin-right: 12px;
    }
    
    .identity-avatar-container {
        position: relative;
    }
    
    .identity-avatar-glow {
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(135deg, var(--dt-primary-500, #8B5CF6), var(--dt-primary-400, #A78BFA));
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.35);
    }
    
    .identity-avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .identity-avatar-image {
        background: #1F2937;
    }
    
    .identity-avatar-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .identity-avatar-initials {
        background: linear-gradient(135deg, var(--dt-primary-500, #8B5CF6), var(--dt-primary-600, #7C3AED));
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .avatar-camera-overlay {
        position: absolute;
        bottom: -4px;
        right: -4px;
    }
    
    .camera-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(30, 41, 59, 0.95);
        border: 2px solid var(--dt-primary-500, #8B5CF6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 150ms ease;
    }
    
    .camera-btn:hover {
        background: var(--dt-primary-600, #7C3AED);
        transform: scale(1.1);
    }
    
    .change-photo-upload {
        display: block;
    }
    
    .change-photo-btn {
        font-size: 0.75rem !important;
        padding: 6px 12px !important;
        border-radius: 16px !important;
    }

    .section-header-collapsible {
        cursor: pointer;
        margin-bottom: 0;
        padding: 4px 0;
        border-radius: var(--dt-radius-md, 8px);
        transition: background var(--dt-transition-fast, 150ms ease);
    }

    .section-header-collapsible:hover {
        background: var(--dt-hover-surface, #17243A);
    }

    .section-icon {
        border-radius: var(--dt-radius-lg, 12px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .icon-identity { background: linear-gradient(135deg, var(--dt-primary-500), var(--dt-primary-600)); }
    .icon-photo { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .icon-contact { background: linear-gradient(135deg, #14B8A6, #0D9488); }
    .icon-cta { background: linear-gradient(135deg, #F87171, #DC2626); }
    .icon-social { background: linear-gradient(135deg, #A78BFA, #7C3AED); }
    .icon-preview { background: linear-gradient(135deg, #60A5FA, #2563EB); }

    .section-header-text {
        flex: 1;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dt-text-primary, #E5E7EB);
        margin: 0 0 2px 0;
    }

    .section-description {
        font-size: 0.8125rem;
        color: var(--dt-text-secondary, #9CA3AF);
        margin: 0;
    }

    .section-collapse-icon {
        color: var(--dt-text-muted, #6B7280);
        transition: transform var(--dt-transition-fast, 150ms ease);
    }

    .section-content {
        padding-top: 4px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       FORM GRID
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    @@media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-row-full {
        grid-column: 1 / -1;
    }

    .bio-warning {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: var(--dt-text-muted, #6B7280);
        margin-top: 8px;
    }

    /* Contact Group (wraps phone rows with label) */
    .contact-group {
        grid-column: 1 / -1;
    }

    .contact-group-label {
        display: none; /* Hidden on desktop, shown on mobile */
    }

    /* Phone Row */
    .phone-row {
        display: flex;
        gap: 12px;
        grid-column: 1 / -1;
    }

    .country-select {
        width: 120px;
        flex-shrink: 0;
    }

    .phone-input {
        flex: 1;
    }

    .country-option {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .country-flag {
        font-size: 1.125rem;
    }

    .country-code {
        font-size: 0.875rem;
        color: var(--dt-text-secondary);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PROFILE PHOTO CARD - PREMIUM REDESIGN (Matches Mockup)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-photo-card {
        background: linear-gradient(135deg, 
            rgba(17, 24, 39, 0.95) 0%, 
            rgba(30, 41, 59, 0.85) 50%, 
            rgba(17, 24, 39, 0.95) 100%);
        border: 1px solid rgba(99, 102, 241, 0.15);
        border-radius: 20px;
        padding: 32px 40px;
        box-shadow: 
            0 4px 30px rgba(0, 0, 0, 0.3),
            0 0 60px rgba(99, 102, 241, 0.05);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .profile-photo-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(99, 102, 241, 0.03) 0%, 
            transparent 50%, 
            rgba(139, 92, 246, 0.02) 100%);
        pointer-events: none;
    }

    .profile-photo-layout {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 48px;
        position: relative;
        z-index: 1;
    }

    @@media (max-width: 640px) {
        .profile-photo-card {
            padding: 24px;
        }
        .profile-photo-layout {
            flex-direction: column;
            gap: 32px;
            text-align: center;
        }
    }

    /* Left Column: Text + Button */
    .profile-photo-info {
        flex: 1;
        min-width: 0;
    }

    .profile-photo-title {
        font-size: 1.375rem;
        font-weight: 600;
        color: #F3F4F6;
        margin: 0 0 8px 0;
        letter-spacing: -0.01em;
    }

    .profile-photo-subtitle {
        font-size: 0.9375rem;
        color: #9CA3AF;
        margin: 0 0 24px 0;
        line-height: 1.5;
    }

    .profile-upload-wrapper {
        display: inline-block;
    }

    .profile-upload-btn {
        padding: 12px 28px !important;
        border-radius: 12px !important;
        font-size: 0.9375rem !important;
        font-weight: 600 !important;
        text-transform: none !important;
        letter-spacing: 0 !important;
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35) !important;
        transition: all 0.2s ease !important;
    }

    .profile-upload-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.45) !important;
    }

    .profile-upload-btn:disabled {
        opacity: 0.7;
    }

    /* Right Column: Avatar with Glow */
    .profile-photo-avatar-container {
        flex-shrink: 0;
    }

    @@media (max-width: 640px) {
        .profile-photo-avatar-container {
            order: -1;
        }
    }

    .profile-avatar-glow {
        position: relative;
        display: inline-block;
    }

    .profile-avatar-glow::before {
        content: '';
        position: absolute;
        inset: -8px;
        border-radius: 50%;
        background: linear-gradient(135deg, 
            rgba(99, 102, 241, 0.4) 0%, 
            rgba(139, 92, 246, 0.3) 50%, 
            rgba(99, 102, 241, 0.2) 100%);
        filter: blur(16px);
        opacity: 0.6;
        z-index: -1;
    }

    .profile-avatar-glow::after {
        content: '';
        position: absolute;
        inset: -3px;
        border-radius: 50%;
        background: linear-gradient(135deg, 
            rgba(99, 102, 241, 0.5) 0%, 
            rgba(139, 92, 246, 0.4) 100%);
        opacity: 0.8;
        z-index: 0;
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
        border: 3px solid rgba(30, 41, 59, 0.8);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .profile-avatar-image {
        overflow: hidden;
    }

    .profile-avatar-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-avatar-initials {
        background: linear-gradient(135deg, #6366F1 0%, #7C3AED 100%);
    }

    .profile-avatar-initials span {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    /* Delete Photo Button */
    .profile-photo-avatar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    .delete-photo-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: #F87171;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .delete-photo-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.5);
        color: #EF4444;
        transform: translateY(-1px);
    }

    .delete-photo-btn svg {
        flex-shrink: 0;
    }

    /* Metadata Footer */
    .profile-photo-meta {
        font-size: 0.8125rem;
        color: #6B7280;
        margin: 24px 0 0 0;
        position: relative;
        z-index: 1;
    }

    @@media (max-width: 640px) {
        .profile-photo-meta {
            text-align: center;
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       iOS SETTINGS-STYLE SHARED FOUNDATION
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ios-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        min-height: 52px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        cursor: pointer;
        transition: background var(--dt-transition-fast, 150ms ease);
    }

    .ios-row:hover {
        background: var(--dt-hover-surface, #17243A);
    }

    .ios-row + .ios-row {
        margin-top: 8px;
    }

    .ios-icon-badge {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
        font-size: 1.125rem;
    }

    .ios-row-info {
        flex: 1;
        min-width: 0;
    }

    .ios-row-primary {
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--dt-text-primary, #E5E7EB);
        line-height: 1.3;
    }

    .ios-row-secondary {
        font-size: 0.8125rem;
        color: var(--dt-text-secondary, #9CA3AF);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .ios-row-chevron {
        color: var(--dt-text-muted, #6B7280);
        flex-shrink: 0;
        font-size: 1.25rem;
        opacity: 0.5;
    }

    .ios-rows-list {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .ios-rows-list .ios-row + .ios-row {
        margin-top: 6px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ACTION BUTTONS (iOS Toggle Rows)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .action-toggle-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .action-toggle-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 10px 16px;
        min-height: 56px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        transition: background var(--dt-transition-fast, 150ms ease);
    }

    .action-toggle-row:hover {
        background: var(--dt-hover-surface, #17243A);
    }

    .action-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .action-icon-save { background: linear-gradient(135deg, var(--dt-primary-500, #8B5CF6), var(--dt-primary-600, #7C3AED)); }
    .action-icon-whatsapp { background: linear-gradient(135deg, #25D366, #128C7E); }
    .action-icon-call { background: linear-gradient(135deg, #3B82F6, #2563EB); }
    .action-icon-email { background: linear-gradient(135deg, #F59E0B, #D97706); }

    .action-label {
        flex: 1;
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--dt-text-primary, #E5E7EB);
    }

    .action-toggle-row .mud-switch {
        margin-left: auto;
        flex-shrink: 0;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SOCIAL PROFILES (Display Rows + Inline Edit)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge-linkedin { background: linear-gradient(135deg, #0A66C2, #004182); }
    .badge-instagram { background: linear-gradient(135deg, #E4405F, #C13584); }
    .badge-facebook { background: linear-gradient(135deg, #1877F2, #0D5DC7); }
    .badge-youtube { background: linear-gradient(135deg, #FF0000, #CC0000); }
    .badge-twitter { background: linear-gradient(135deg, #1DA1F2, #0D8DDB); }
    .badge-website { background: linear-gradient(135deg, #6366F1, #4F46E5); }

    .social-row-editing {
        padding: 10px 16px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        border: 1px solid var(--dt-primary-500, #8B5CF6);
    }

    .social-row-editing + .ios-row,
    .ios-row + .social-row-editing {
        margin-top: 6px;
    }

    .social-edit-btn {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 150ms ease;
    }

    .social-edit-save {
        background: var(--dt-primary-500, #8B5CF6);
        color: white;
    }

    .social-edit-save:hover {
        background: var(--dt-primary-600, #7C3AED);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CONTACT INFO (Centered Header + Email Row + Phone Cards)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .contact-centered-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 8px 0 20px;
    }

    .contact-header-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        background: linear-gradient(135deg, #14B8A6, #0D9488);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-bottom: 14px;
        font-size: 1.5rem;
    }

    .contact-header-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dt-text-primary, #E5E7EB);
        margin: 0 0 4px;
    }

    .contact-header-subtitle {
        font-size: 0.875rem;
        color: var(--dt-text-secondary, #9CA3AF);
        margin: 0;
    }

    .contact-email-row {
        margin-bottom: 16px;
    }

    .contact-email-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--dt-surface-3, #1E293B);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dt-text-secondary, #9CA3AF);
        flex-shrink: 0;
    }

    .contact-subsection-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--dt-text-secondary, #9CA3AF);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 4px 0 10px 4px;
    }

    .contact-phone-card {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        min-height: 72px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        cursor: pointer;
        transition: background var(--dt-transition-fast, 150ms ease);
    }

    .contact-phone-card:hover {
        background: var(--dt-hover-surface, #17243A);
    }

    .contact-phone-card + .contact-phone-card {
        margin-top: 10px;
    }

    .phone-card-flag {
        font-size: 1.75rem;
        flex-shrink: 0;
        line-height: 1;
    }

    .phone-card-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .phone-card-code {
        font-size: 0.8125rem;
        color: var(--dt-text-secondary, #9CA3AF);
        line-height: 1.3;
    }

    .phone-card-number {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dt-text-primary, #E5E7EB);
        line-height: 1.3;
    }

    .phone-card-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    .phone-quick-action {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 150ms ease;
        text-decoration: none;
    }

    .phone-quick-call {
        background: transparent;
        color: var(--dt-text-secondary, #9CA3AF);
    }

    .phone-quick-call:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #3B82F6;
    }

    .phone-quick-wa {
        background: #25D366;
        color: white;
        border-radius: 50%;
    }

    .phone-quick-wa:hover {
        background: #1DA855;
    }

    .contact-edit-inline {
        padding: 12px 16px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        border: 1px solid var(--dt-primary-500, #8B5CF6);
        margin-bottom: 8px;
    }

    .contact-edit-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--dt-text-secondary, #9CA3AF);
        margin-bottom: 8px;
    }

    .contact-edit-actions {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        justify-content: flex-end;
    }

    .contact-phone-empty {
        font-size: 0.8125rem;
        color: var(--dt-text-muted, #6B7280);
        padding: 12px 16px;
        text-align: center;
        border: 1px dashed var(--dt-border-default, #233044);
        border-radius: var(--dt-radius-lg, 12px);
        cursor: pointer;
    }

    /* Legacy toggle styles kept for desktop compatibility */
    .toggle-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .toggle-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--dt-surface-2, #162234);
        border-radius: var(--dt-radius-lg, 12px);
        cursor: pointer;
        transition: background var(--dt-transition-fast, 150ms ease);
    }

    .toggle-item:hover {
        background: var(--dt-hover-surface, #17243A);
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        color: var(--dt-text-primary, #E5E7EB);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       APPEARANCE SECTION STYLES
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .icon-appearance {
        background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
    }

    .appearance-chips-summary {
        display: flex;
        gap: 8px;
        margin-left: auto;
        margin-right: 12px;
    }

    .summary-chip {
        background: rgba(99, 102, 241, 0.15);
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: #A5B4FC;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 500;
        white-space: nowrap;
    }

    @@media (max-width: 768px) {
        .appearance-chips-summary {
            display: none;
        }
    }

    .appearance-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .appearance-block {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .appearance-block-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--dt-text-secondary, #9CA3AF);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
    }

    /* Presets Grid */
    .appearance-presets-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
    }

    @@media (max-width: 900px) {
        .appearance-presets-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (max-width: 500px) {
        .appearance-presets-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .appearance-preset-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: var(--dt-surface-2, #162234);
        border: 2px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .appearance-preset-card:hover {
        background: var(--dt-hover-surface, #17243A);
        border-color: rgba(99, 102, 241, 0.3);
    }

    .appearance-preset-card.selected {
        border-color: #6366F1;
        background: rgba(99, 102, 241, 0.1);
    }

    .preset-preview {
        width: 100%;
        height: 50px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .preset-name {
        font-size: 0.75rem;
        color: var(--dt-text-secondary, #9CA3AF);
        text-align: center;
    }

    .preset-check {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 20px;
        height: 20px;
        background: #6366F1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .preset-check.light {
        background: #475569;
    }
    
    /* Preset Categories */
    .appearance-presets-block {
        gap: 20px;
    }
    
    .preset-category {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .preset-category-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--dt-text-muted, #6B7280);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .preset-category-label .mud-icon-root {
        font-size: 1rem;
    }
    
    /* Accent Dot on Preview */
    .preset-preview {
        position: relative;
    }
    
    .preset-accent-dot {
        position: absolute;
        bottom: 6px;
        right: 6px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, 0.3);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Light Theme Preset Cards */
    .appearance-preset-card.light {
        background: var(--dt-surface-light, #F1F5F9);
        border-color: rgba(0, 0, 0, 0.1);
    }
    
    .appearance-preset-card.light:hover {
        background: var(--dt-surface-light-hover, #E2E8F0);
        border-color: rgba(71, 85, 105, 0.3);
    }
    
    .appearance-preset-card.light.selected {
        border-color: #475569;
        background: rgba(71, 85, 105, 0.1);
    }
    
    .appearance-preset-card.light .preset-name {
        color: #374151;
    }

    /* Options Row */
    .appearance-options-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }
    
    /* Simplified Options (Single centered block) */
    .appearance-options-simple {
        display: flex;
        justify-content: center;
        width: 100%;
    }
    
    .appearance-block-full {
        width: 100%;
        max-width: 320px;
    }
    
    .segment-selector-centered {
        justify-content: center;
    }
    
    .segment-selector-centered .segment-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .image-upload-section {
        margin-top: 12px;
        display: flex;
        justify-content: center;
    }

    @@media (max-width: 640px) {
        .appearance-options-row {
            grid-template-columns: 1fr;
        }
        
        .appearance-block-full {
            max-width: 100%;
        }
    }

    /* Segment Selector */
    .segment-selector {
        display: flex;
        background: var(--dt-surface-2, #162234);
        border-radius: 10px;
        padding: 4px;
        gap: 4px;
    }

    .segment-btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        background: transparent;
        color: var(--dt-text-secondary, #9CA3AF);
        font-size: 0.8125rem;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .segment-btn:hover {
        color: var(--dt-text-primary, #E5E7EB);
    }

    .segment-btn.active {
        background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    /* Intensity Slider */
    .intensity-slider {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }

    .slider-label {
        font-size: 0.75rem;
        color: var(--dt-text-muted, #6B7280);
        min-width: 70px;
    }

    /* Footer */
    .appearance-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    .advanced-toggle-link,
    .reset-link {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: var(--dt-text-muted, #6B7280);
        font-size: 0.8125rem;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .advanced-toggle-link:hover {
        color: #A5B4FC;
        background: rgba(99, 102, 241, 0.1);
    }

    .reset-link:hover {
        color: #F87171;
        background: rgba(239, 68, 68, 0.1);
    }

    /* Advanced Options */
    .advanced-options {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding-top: 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .advanced-options > .advanced-block {
        flex: 1 1 200px;
        min-width: 180px;
        max-width: 280px;
    }

    @@media (max-width: 1100px) {
        .advanced-options > .advanced-block {
            flex: 1 1 220px;
            max-width: none;
        }
    }

    @@media (max-width: 700px) {
        .advanced-options {
            flex-direction: column;
        }
        .advanced-options > .advanced-block {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }

    .advanced-block {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        background: var(--dt-surface-2, #162234);
        border-radius: 12px;
    }

    .advanced-block-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--dt-text-muted, #6B7280);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
    }

    .advanced-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .control-row > span {
        font-size: 0.8125rem;
        color: var(--dt-text-secondary, #9CA3AF);
    }

    .radio-group {
        display: flex;
        gap: 4px;
    }

    .radio-btn {
        padding: 6px 12px;
        border: 1px solid rgba(99, 102, 241, 0.2);
        background: transparent;
        color: var(--dt-text-muted, #6B7280);
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .radio-btn:hover {
        border-color: rgba(99, 102, 241, 0.4);
        color: var(--dt-text-secondary, #9CA3AF);
    }

    .radio-btn.active {
        background: #6366F1;
        border-color: #6366F1;
        color: white;
    }
    
    /* Toggle de Independencia */
    .control-row-toggle {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        margin-bottom: 8px;
    }
    
    .control-row-toggle > .toggle-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .control-row-toggle .toggle-hint {
        font-size: 0.7rem;
        color: var(--dt-text-muted, #6B7280);
        font-weight: 400;
    }
    
    .control-row-inherited {
        justify-content: center;
        padding: 8px 0;
    }
    
    .inherited-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: var(--dt-text-muted, #6B7280);
        font-style: italic;
    }
    
    /* Color Picker Swatches */
    .color-picker-row {
        display: flex;
        gap: 6px;
    }
    
    .color-swatch {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .color-swatch:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .color-swatch.selected {
        border-color: #6366F1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SAVE SECTION
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .save-section {
        display: flex;
        justify-content: flex-end;
        padding: 8px 0;
    }

    .save-btn-main {
        padding: 14px 40px !important;
        font-size: 0.9375rem !important;
        font-weight: 600 !important;
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4) !important;
        transition: all var(--dt-transition-normal, 250ms ease) !important;
    }

    .save-btn-main:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5) !important;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PREMIUM IPHONE-STYLE PREVIEW SIDEBAR
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    
    /* CSS Variables for Phone Dimensions - Target: 409x717 (Pro Max ratio ~1.75) */
    .preview-sidebar {
        --phone-width: clamp(280px, 90%, 380px);
        --phone-height: clamp(560px, 85vh, 720px);
        --phone-radius: 48px;
        --screen-radius: 40px;
        --panel-min-height: clamp(640px, 70vh, 780px);
        position: relative;
        max-width: 100%;
        overflow: hidden;
    }

    .preview-sticky {
        position: sticky;
        top: 80px;
    }

    /* Premium Panel Container with Glow */
    .preview-panel {
        background: linear-gradient(145deg, #0D1321 0%, #1A1F2E 50%, #151B28 100%);
        border-radius: 24px;
        padding: 24px;
        border: 1px solid rgba(99, 102, 241, 0.15);
        box-shadow: 
            0 0 40px rgba(99, 102, 241, 0.08),
            0 0 80px rgba(139, 92, 246, 0.05),
            0 20px 60px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
        min-height: var(--panel-min-height);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    .preview-panel::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.06) 0%, transparent 50%);
        pointer-events: none;
    }

    /* Panel Header */
    .preview-panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        flex-shrink: 0;
    }

    .preview-panel-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
        border: 1px solid rgba(99, 102, 241, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #A78BFA;
    }

    .preview-panel-text {
        flex: 1;
        min-width: 0;
    }

    .preview-panel-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #F3F4F6;
        margin: 0;
        letter-spacing: -0.01em;
    }

    .preview-panel-subtitle {
        font-size: 0.75rem;
        color: #6B7280;
        margin: 2px 0 0 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* iPhone Device Frame - PRO MAX Size */
    .iphone-frame {
        position: relative;
        width: var(--phone-width);
        max-width: 100%;
        height: var(--phone-height);
        margin: 0 auto;
        background: linear-gradient(145deg, #1C1C1E 0%, #2C2C2E 50%, #1C1C1E 100%);
        border-radius: var(--phone-radius);
        padding: 14px;
        box-sizing: border-box;
        box-shadow: 
            inset 0 0 0 1px rgba(255, 255, 255, 0.1),
            0 0 0 1px rgba(0, 0, 0, 0.5),
            0 30px 60px rgba(0, 0, 0, 0.5),
            0 15px 30px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
    }

    .iphone-frame::before {
        content: '';
        position: absolute;
        top: 0;
        left: 20%;
        right: 20%;
        height: 3px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        border-radius: 0 0 10px 10px;
    }

    /* Dynamic Island */
    .dynamic-island {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 32px;
        background: #000000;
        border-radius: 20px;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* iPhone Screen */
    .iphone-screen {
        background: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
        border-radius: var(--screen-radius);
        overflow: hidden;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Status Bar */
    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 22px 18px 16px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.75rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .status-time {
        font-weight: 600;
    }

    .status-icons {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .status-icons .mud-icon-root {
        font-size: 14px !important;
    }

    /* Card Header Gradient */
    .phone-card-header {
        background: linear-gradient(135deg, 
            rgba(132, 250, 176, 0.8) 0%, 
            rgba(143, 211, 244, 0.8) 25%,
            rgba(167, 139, 250, 0.6) 50%,
            rgba(251, 194, 235, 0.8) 75%,
            rgba(143, 211, 244, 0.6) 100%);
        position: relative;
        flex-shrink: 0;
    }

    .phone-card-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, transparent, var(--dt-bg-fade, #0F172A));
    }

    /* Scrollable Phone Content - FLEXIBLE HEIGHT */
    .phone-card-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 14px 8px 28px;
        text-align: center;
        scrollbar-width: none;
        -ms-overflow-style: none;
        overscroll-behavior: contain;
    }

    .phone-card-content::-webkit-scrollbar {
        display: none;
    }

    /* Phone Avatar - ENLARGED for visual anchor */
    .phone-avatar-section {
        margin-top: 0px;
        margin-bottom: 20px;
        position: relative;
        z-index: 5;
    }

    .phone-avatar {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 5px solid var(--dt-surface-card-border, #1E293B);
        box-shadow: 
            0 0 0 3px var(--dt-accent-soft, rgba(99, 102, 241, 0.35)),
            0 0 30px var(--dt-accent-soft, rgba(99, 102, 241, 0.15)),
            0 12px 32px rgba(0, 0, 0, 0.5);
        overflow: hidden;
    }

    .phone-avatar-image {
        position: relative;
    }

    .phone-avatar-image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .phone-avatar-initials {
        background: var(--dt-accent-primary, var(--dt-accent-gradient, linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)));
    }

    .phone-avatar-initials span {
        font-size: 2.75rem;
        font-weight: 700;
        color: var(--dt-text-on-accent, white);
        text-transform: uppercase;
    }
    
    /* Avatar Dynamic Sizes */
    .phone-avatar.avatar-size-s {
        width: 90px;
        height: 90px;
    }
    .phone-avatar.avatar-size-s span {
        font-size: 2rem;
    }
    
    .phone-avatar.avatar-size-m {
        width: 130px;
        height: 130px;
    }
    .phone-avatar.avatar-size-m span {
        font-size: 2.75rem;
    }
    
    .phone-avatar.avatar-size-l {
        width: 160px;
        height: 160px;
    }
    .phone-avatar.avatar-size-l span {
        font-size: 3.5rem;
    }
    
    /* Avatar Glow Effect */
    .phone-avatar.avatar-glow {
        box-shadow: 
            0 0 0 3px var(--dt-accent-soft, rgba(99, 102, 241, 0.35)),
            0 0 30px var(--dt-accent-soft, rgba(99, 102, 241, 0.25)),
            0 0 60px var(--dt-accent-soft, rgba(139, 92, 246, 0.15)),
            0 12px 32px rgba(0, 0, 0, 0.5);
    }
    
    .phone-avatar:not(.avatar-glow) {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    /* Phone Identity - Uses ThemeTokens CSS variables for light/dark theme support */
    .phone-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dt-text-primary, #FFFFFF);
        margin: 0 0 4px 0;
        letter-spacing: -0.02em;
    }

    .phone-title {
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--dt-accent-primary, #A78BFA);
        margin: 0 0 4px 0;
    }

    .phone-company {
        font-size: 0.8125rem;
        color: var(--dt-text-secondary, #9CA3AF);
        margin: 0 0 16px 0;
    }

    /* Phone Bio */
    .phone-bio {
        font-size: 0.8125rem;
        color: var(--dt-text-muted, #D1D5DB);
        line-height: 1.6;
        margin: 0 0 20px 0;
        text-align: center;
    }

    .phone-bio-placeholder {
        color: var(--dt-text-muted, #6B7280);
        font-style: italic;
        opacity: 0.7;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Phone CTA Buttons - REDESIGNED LAYOUT
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .phone-cta-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
        width: 100%;
    }

    /* Primary CTA: Guardar Contacto (Full Width) */
    .phone-cta-primary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        padding: 14px 20px;
        border-radius: 14px;
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--dt-button-primary-text, white);
        background: var(--dt-button-primary-bg, linear-gradient(135deg, #6366F1 0%, #4F46E5 100%));
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 16px var(--dt-accent-soft, rgba(99, 102, 241, 0.35));
    }

    .phone-cta-primary .mud-icon-root {
        font-size: 20px !important;
    }

    .phone-cta-primary:hover {
        background: var(--dt-button-primary-hover, linear-gradient(135deg, #818CF8 0%, #6366F1 100%));
        transform: translateY(-2px);
        box-shadow: 0 6px 20px var(--dt-accent-soft, rgba(99, 102, 241, 0.45));
    }

    /* Secondary Row: WhatsApp, Llamar, Email */
    .phone-cta-secondary-row {
        display: flex;
        justify-content: center;
        gap: 8px;
        width: 100%;
    }

    .phone-cta-secondary-row:empty {
        display: none;
    }

    .phone-cta-secondary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        flex: 1;
        min-width: 0;
        max-width: 120px;
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        white-space: nowrap;
    }

    .phone-cta-secondary .mud-icon-root {
        font-size: 16px !important;
        flex-shrink: 0;
    }

    .phone-cta-secondary span {
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .phone-cta-secondary:hover {
        transform: translateY(-2px);
    }

    /* WhatsApp - Green Brand */
    .cta-whatsapp {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    }

    .cta-whatsapp:hover {
        background: linear-gradient(135deg, #4AE384 0%, #25D366 100%);
        box-shadow: 0 4px 14px rgba(37, 211, 102, 0.35);
    }

    /* Llamar - Violet/Indigo */
    .cta-llamar {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    }

    .cta-llamar:hover {
        background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%);
        box-shadow: 0 4px 14px rgba(139, 92, 246, 0.35);
    }

    /* Email - Orange */
    .cta-email {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    }

    .cta-email:hover {
        background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
        box-shadow: 0 4px 14px rgba(245, 158, 11, 0.35);
    }

    /* Outline Buttons for Preview */
    .phone-cta-outline {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        flex: 1;
        min-width: 0;
        max-width: 120px;
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        background: transparent;
        border: 1.5px solid;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .phone-cta-outline:hover {
        transform: translateY(-2px);
    }

    /* WhatsApp Outline - Green */
    .cta-whatsapp-outline {
        border-color: #25D366;
        color: #25D366;
    }

    .cta-whatsapp-outline:hover {
        background: rgba(37, 211, 102, 0.1);
        box-shadow: 0 3px 10px rgba(37, 211, 102, 0.2);
    }

    /* Llamar Outline - Violet */
    .cta-llamar-outline {
        border-color: #8B5CF6;
        color: #8B5CF6;
    }

    .cta-llamar-outline:hover {
        background: rgba(139, 92, 246, 0.1);
        box-shadow: 0 3px 10px rgba(139, 92, 246, 0.2);
    }

    /* Email Outline - Orange */
    .cta-email-outline {
        border-color: #F59E0B;
        color: #F59E0B;
    }

    .cta-email-outline:hover {
        background: rgba(245, 158, 11, 0.1);
        box-shadow: 0 3px 10px rgba(245, 158, 11, 0.2);
    }
    
    /* Button Shape Dynamic - Applied via .btn-shape-* */
    .btn-shape-pill .phone-cta-primary,
    .btn-shape-pill .phone-cta-outline {
        border-radius: 50px;
    }
    
    .btn-shape-rounded .phone-cta-primary,
    .btn-shape-rounded .phone-cta-outline {
        border-radius: 14px;
    }
    
    .btn-shape-square .phone-cta-primary,
    .btn-shape-square .phone-cta-outline {
        border-radius: 6px;
    }
    
    /* Button Style Dynamic - Applied via .btn-style-* */
    .btn-style-outline .phone-cta-primary {
        background: transparent;
        border: 2px solid #6366F1;
        color: #A5B4FC;
        box-shadow: none;
    }
    
    .btn-style-outline .phone-cta-primary:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: #818CF8;
        transform: translateY(-2px);
    }

    /* DISABLED Buttons in Preview - Show but faded */
    .phone-cta-disabled {
        opacity: 0.4;
        cursor: not-allowed;
        filter: grayscale(0.6);
        transition: none;
    }

    .phone-cta-disabled:hover {
        transform: none;
        box-shadow: none;
    }

    .phone-cta-outline.phone-cta-disabled {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.3);
    }

    .cta-whatsapp-outline.phone-cta-disabled {
        border-color: rgba(37, 211, 102, 0.3);
        color: rgba(37, 211, 102, 0.4);
    }

    .cta-llamar-outline.phone-cta-disabled {
        border-color: rgba(139, 92, 246, 0.3);
        color: rgba(139, 92, 246, 0.4);
    }

    .cta-email-outline.phone-cta-disabled {
        border-color: rgba(245, 158, 11, 0.3);
        color: rgba(245, 158, 11, 0.4);
    }

    /* Status Chips */
    .phone-status-chips {
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }

    .phone-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        white-space: nowrap;
    }

    .chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #22C55E;
        box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
    }

    /* CTA Outline Buttons - Matching Public Card */
    .phone-cta-outline {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        flex: 1;
        padding: 10px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        background: transparent;
        border: 2px solid;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .cta-whatsapp-outline {
        border-color: #25D366;
        color: #25D366;
    }

    .cta-whatsapp-outline:hover {
        background: rgba(37, 211, 102, 0.1);
    }

    .cta-llamar-outline {
        border-color: #8B5CF6;
        color: #A78BFA;
    }

    .cta-llamar-outline:hover {
        background: rgba(139, 92, 246, 0.1);
    }

    .cta-email-outline {
        border-color: #F59E0B;
        color: #FBBF24;
    }

    .cta-email-outline:hover {
        background: rgba(245, 158, 11, 0.1);
    }

    /* Phone Social Icons */
    .phone-social-row {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .phone-social-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9CA3AF;
        transition: all 0.2s ease;
    }

    .phone-social-icon:hover {
        background: var(--dt-accent-soft, rgba(99, 102, 241, 0.2));
        color: var(--dt-accent-primary, #A78BFA);
        border-color: var(--dt-accent-primary, rgba(99, 102, 241, 0.3));
    }

    /* Phone URL Section */
    .phone-url-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .phone-url-input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px 14px;
        margin-bottom: 12px;
    }

    .phone-url-text {
        font-size: 0.75rem;
        color: #9CA3AF;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .phone-url-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 0.8125rem;
        font-weight: 600;
        color: #A78BFA;
        text-decoration: none;
        padding: 8px;
        transition: all 0.2s ease;
    }

    .phone-url-cta:hover {
        color: #C4B5FD;
    }

    .phone-url-cta span {
        font-size: 1rem;
    }

    /* Preview URL Section - OUTSIDE Phone */
    .preview-url-section {
        margin-top: 20px;
        padding: 0 8px;
    }

    .preview-url-input {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 12px;
        padding: 12px 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .preview-url-input:hover {
        border-color: rgba(99, 102, 241, 0.4);
        background: rgba(17, 24, 39, 0.95);
    }

    .preview-url-text {
        font-size: 0.8rem;
        color: #9CA3AF;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

    .preview-url-input .copy-icon {
        color: #6366F1;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .preview-url-input:hover .copy-icon {
        opacity: 1;
    }

    .preview-url-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #A78BFA;
        text-decoration: none;
        padding: 12px 16px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .preview-url-cta:hover {
        color: #C4B5FD;
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        transform: translateY(-1px);
    }

    .preview-url-cta span {
        font-size: 1.1rem;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Phone Lead Form Section - Preview
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .phone-lead-form-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .phone-lead-header {
        text-align: center;
        margin-bottom: 16px;
    }
    
    .phone-lead-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin: 0 0 4px 0;
    }
    
    .phone-lead-subtitle {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.5);
        margin: 0;
    }
    
    .phone-lead-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .phone-form-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .phone-field-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.65rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .phone-field-label .mud-icon-root {
        font-size: 12px !important;
        color: rgba(255, 255, 255, 0.4);
    }
    
    .required-mark {
        color: #F87171;
    }
    
    .optional-mark {
        color: rgba(255, 255, 255, 0.35);
        font-weight: 400;
    }
    
    .phone-input-mock {
        background: var(--dt-surface-input, rgba(25, 18, 45, 0.85));
        border: 1px solid var(--dt-surface-input-border, rgba(139, 92, 246, 0.3));
        border-radius: var(--dt-input-radius, 8px);
        padding: 8px 10px;
        font-size: 0.75rem;
        color: var(--dt-text-primary, #FFFFFF);
        font-weight: 500;
        text-align: left;
    }
    
    .phone-input-row {
        display: flex;
        gap: 6px;
    }
    
    .phone-country-mock {
        background: var(--dt-surface-input, rgba(25, 18, 45, 0.85));
        border: 1px solid var(--dt-surface-input-border, rgba(139, 92, 246, 0.3));
        border-radius: var(--dt-input-radius, 8px);
        padding: 8px 10px;
        font-size: 0.7rem;
        color: var(--dt-text-primary, #FFFFFF);
        font-weight: 500;
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .phone-input-number {
        flex: 1;
    }
    
    .phone-textarea-mock {
        background: var(--dt-surface-input, rgba(25, 18, 45, 0.85));
        border: 1px solid var(--dt-surface-input-border, rgba(139, 92, 246, 0.3));
        border-radius: var(--dt-input-radius, 8px);
        padding: 8px 10px;
        font-size: 0.75rem;
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.4));
        font-weight: 400;
        min-height: 40px;
        text-align: left;
    }
    
    .phone-submit-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px;
        margin-top: 4px;
        background: var(--dt-button-primary-bg, linear-gradient(135deg, #14B8A6 0%, #0D9488 100%));
        color: var(--dt-button-primary-text, #fff);
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        border-radius: var(--dt-button-radius, 10px);
        cursor: pointer;
        box-shadow: 0 3px 12px var(--dt-accent-soft, rgba(20, 184, 166, 0.35));
    }
    
    .phone-submit-btn .mud-icon-root {
        font-size: 14px !important;
    }
    
    .phone-submit-btn:hover {
        background: linear-gradient(135deg, #2DD4BF 0%, #14B8A6 100%);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       UTILITY CLASSES
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .text-muted {
        color: var(--dt-text-muted, #6B7280);
        font-style: italic;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PORTFOLIO GALLERY EDITOR
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-portfolio {
        border-color: var(--dt-primary-500, #8B5CF6);
        border-width: 2px;
    }
    
    .icon-gallery {
        background: linear-gradient(135deg, #8B5CF6, #EC4899) !important;
    }
    
    .gallery-upload-area {
        margin-bottom: 20px;
    }
    
    .gallery-dropzone {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 32px;
        background: rgba(139, 92, 246, 0.08);
        border: 2px dashed rgba(139, 92, 246, 0.3);
        border-radius: 16px;
        cursor: pointer;
        transition: all 200ms ease;
        color: var(--dt-text-secondary, #9CA3AF);
    }
    
    .gallery-dropzone:hover:not(.disabled) {
        background: rgba(139, 92, 246, 0.15);
        border-color: var(--dt-primary-500, #8B5CF6);
        color: var(--dt-primary-400, #A78BFA);
    }
    
    .gallery-dropzone.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .gallery-editor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 16px;
    }
    
    .gallery-editor-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: var(--dt-surface-2, #1F2937);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .gallery-editor-item img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        display: block;
    }
    
    .gallery-item-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 8px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        opacity: 0;
        transition: opacity 200ms ease;
    }
    
    .gallery-editor-item:hover .gallery-item-overlay {
        opacity: 1;
    }
    
    .gallery-item-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 150ms ease;
    }
    
    .gallery-item-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .gallery-item-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .gallery-item-delete:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.8);
    }
    
    .gallery-item-title {
        padding: 8px;
        background: var(--dt-surface-2, #1F2937);
    }
    
    .gallery-item-title .mud-input-root {
        font-size: 0.75rem !important;
    }
    
    .gallery-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--dt-text-muted, #6B7280);
        text-align: center;
    }
    
    .gallery-empty-state p {
        margin: 12px 0 4px;
        font-size: 0.95rem;
        color: var(--dt-text-secondary, #9CA3AF);
    }
    
    .gallery-empty-state span {
        font-size: 0.8rem;
    }

    /* Gallery Toggles */
    .gallery-toggles {
        margin-bottom: 16px;
        padding: 12px 16px;
        background: rgba(139, 92, 246, 0.06);
        border-radius: 12px;
        border: 1px solid rgba(139, 92, 246, 0.12);
    }
    .gallery-toggles-label {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
    }
    .gallery-toggles-row {
        display: flex;
        gap: 1.5rem;
        margin: 4px 0;
    }
    .gallery-toggles-hint {
        font-size: 0.72rem;
        color: var(--mud-palette-text-secondary);
    }

    /* Gallery Two-Column Layout */
    .gallery-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    @@media (max-width: 768px) {
        .gallery-columns {
            grid-template-columns: 1fr;
        }
    }
    .gallery-column {
        min-width: 0;
    }
    .gallery-column-title {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        margin: 0 0 10px;
    }
    .gallery-column-count {
        margin-left: auto;
        font-size: 0.72rem;
        font-weight: 400;
        color: var(--mud-palette-text-secondary);
    }

    /* Video thumbnail placeholder */
    .gallery-video-thumb {
        width: 100%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--dt-surface-2, #1F2937);
        color: var(--mud-palette-text-secondary);
    }
    .gallery-editor-item--video {
        position: relative;
    }
    .gallery-video-preview {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        display: block;
        background: var(--dt-surface-2, #1F2937);
    }
    .gallery-video-play-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 1;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTO-CONTRAST SYSTEM
       Dynamic text colors based on surface luminance
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* === MODO OSCURO (texto claro sobre fondo oscuro) === */
    .contrast-dark {
        --surface-text-primary: #FFFFFF;
        --surface-text-secondary: rgba(255, 255, 255, 0.75);
        --surface-text-muted: rgba(255, 255, 255, 0.5);
        --surface-input-bg: rgba(255, 255, 255, 0.08);
        --surface-input-border: rgba(255, 255, 255, 0.2);
        --surface-input-text: #FFFFFF;
        --surface-input-placeholder: rgba(255, 255, 255, 0.5);
        --surface-icon: rgba(255, 255, 255, 0.85);
        --surface-chip-bg: rgba(255, 255, 255, 0.1);
        --surface-chip-text: rgba(255, 255, 255, 0.8);
        --surface-chip-border: rgba(255, 255, 255, 0.15);
        --surface-label-text: rgba(255, 255, 255, 0.85);
    }
    
    /* === MODO CLARO (texto oscuro sobre fondo claro) === */
    .contrast-light {
        --surface-text-primary: #1A1A2E;
        --surface-text-secondary: rgba(26, 26, 46, 0.75);
        --surface-text-muted: rgba(26, 26, 46, 0.5);
        --surface-input-bg: rgba(0, 0, 0, 0.06);
        --surface-input-border: rgba(0, 0, 0, 0.2);
        --surface-input-text: #1A1A2E;
        --surface-input-placeholder: rgba(0, 0, 0, 0.45);
        --surface-icon: rgba(26, 26, 46, 0.85);
        --surface-chip-bg: rgba(0, 0, 0, 0.08);
        --surface-chip-text: rgba(26, 26, 46, 0.8);
        --surface-chip-border: rgba(0, 0, 0, 0.15);
        --surface-label-text: rgba(26, 26, 46, 0.85);
    }
    
    /* Apply contrast variables to phone preview elements */
    .phone-card-content.contrast-dark .phone-name,
    .phone-card-content.contrast-light .phone-name {
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-title,
    .phone-card-content.contrast-dark .phone-company,
    .phone-card-content.contrast-light .phone-title,
    .phone-card-content.contrast-light .phone-company {
        color: var(--dt-text-secondary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-bio,
    .phone-card-content.contrast-light .phone-bio {
        color: var(--dt-text-secondary) !important;
    }
    
    /* Status chips */
    .phone-card-content.contrast-dark .phone-chip,
    .phone-card-content.contrast-light .phone-chip {
        background: var(--dt-surface-chip) !important;
        color: var(--dt-text-secondary) !important;
        border-color: var(--dt-surface-chip-border) !important;
    }
    
    /* Form section in preview */
    .phone-card-content.contrast-dark .phone-form-title,
    .phone-card-content.contrast-light .phone-form-title {
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-form-subtitle,
    .phone-card-content.contrast-light .phone-form-subtitle {
        color: var(--dt-text-muted) !important;
    }
    
    /* Inputs in preview */
    .phone-card-content.contrast-dark .phone-input,
    .phone-card-content.contrast-light .phone-input {
        background: var(--dt-surface-input) !important;
        border-color: var(--dt-surface-input-border) !important;
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-input::placeholder,
    .phone-card-content.contrast-light .phone-input::placeholder {
        color: var(--dt-text-muted) !important;
    }
    
    /* Icons */
    .phone-card-content.contrast-dark .mud-icon-root,
    .phone-card-content.contrast-light .mud-icon-root {
        color: var(--dt-text-secondary) !important;
    }
    
    /* Social icons - contrast aware (now uses shared SocialLinksRow) */
    .phone-card-content.contrast-dark .social-link-icon,
    .phone-card-content.contrast-light .social-link-icon {
        background: var(--dt-surface-chip) !important;
        color: var(--dt-text-secondary) !important;
        border-color: var(--dt-surface-chip-border) !important;
    }
    
    /* Avatar ring - contrast aware */
    .phone-card-content.contrast-dark .phone-avatar,
    .phone-card-content.contrast-light .phone-avatar {
        border-color: var(--dt-surface-card-border, rgba(255,255,255,0.25)) !important;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LEAD FORM SECTION - Contrast-aware styling for light/dark themes
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Form titles */
    .phone-card-content.contrast-dark .phone-lead-title,
    .phone-card-content.contrast-light .phone-lead-title {
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-lead-subtitle,
    .phone-card-content.contrast-light .phone-lead-subtitle {
        color: var(--dt-text-muted) !important;
    }
    
    /* Form field labels */
    .phone-card-content.contrast-dark .phone-field-label,
    .phone-card-content.contrast-light .phone-field-label {
        color: var(--dt-text-secondary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-field-label .mud-icon-root,
    .phone-card-content.contrast-light .phone-field-label .mud-icon-root {
        color: var(--dt-text-muted) !important;
    }
    
    /* Optional mark in form */
    .phone-card-content.contrast-dark .optional-mark,
    .phone-card-content.contrast-light .optional-mark {
        color: var(--dt-text-muted) !important;
    }
    
    /* Form inputs - mock elements */
    .phone-card-content.contrast-dark .phone-input-mock,
    .phone-card-content.contrast-light .phone-input-mock {
        background: var(--dt-surface-input) !important;
        border-color: var(--dt-surface-input-border) !important;
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-country-mock,
    .phone-card-content.contrast-light .phone-country-mock {
        background: var(--dt-surface-input) !important;
        border-color: var(--dt-surface-input-border) !important;
        color: var(--dt-text-primary) !important;
    }
    
    .phone-card-content.contrast-dark .phone-textarea-mock,
    .phone-card-content.contrast-light .phone-textarea-mock {
        background: var(--dt-surface-input) !important;
        border-color: var(--dt-surface-input-border) !important;
        color: var(--dt-text-primary) !important;
    }
    
    /* Submit button text */
    .phone-card-content.contrast-light .phone-submit-btn span {
        color: var(--dt-text-primary) !important;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SERVICES TEMPLATE PREVIEW - Services List and Booking CTAs
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .phone-services-section {
        margin-top: 16px;
        padding: 0 12px;
    }
    
    .phone-services-title {
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 10px;
        text-transform: uppercase;
    }
    
    .phone-services-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .phone-service-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--dt-accent-soft, rgba(99, 102, 241, 0.2));
        border-radius: 10px;
        transition: all 150ms ease;
    }
    
    .phone-service-card:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(99, 102, 241, 0.35);
    }
    
    .phone-service-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: var(--dt-accent-soft, rgba(99, 102, 241, 0.15));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    
    .phone-service-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
        min-width: 0;
    }
    
    .phone-service-name {
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .phone-service-meta {
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--dt-accent-primary, #A78BFA);
    }
    
    .phone-booking-ctas {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 16px;
    }
    
    .phone-cta-booking {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 12px 16px;
        border: none;
        border-radius: var(--dt-button-radius, 14px);
        background: var(--dt-accent-primary, #6366F1);
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 150ms ease;
    }
    
    .phone-cta-booking:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }
    
    .phone-cta-quote {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        background: transparent;
        border: 1px solid;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 150ms ease;
    }
    
    .phone-cta-quote:hover {
        background: rgba(99, 102, 241, 0.1);
    }
    
    /* Contrast-aware Services styles */
    .phone-card-content.contrast-light .phone-services-title {
        color: rgba(26, 26, 46, 0.6);
    }
    
    .phone-card-content.contrast-light .phone-service-card {
        background: rgba(0, 0, 0, 0.03);
        border-color: rgba(99, 102, 241, 0.3);
    }
    
    .phone-card-content.contrast-light .phone-service-name {
        color: rgba(26, 26, 46, 0.9);
    }
    
    .phone-card-content.contrast-light .phone-cta-booking {
        color: white;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUOTE REQUEST TEMPLATE PREVIEW â€” Now rendered by shared QuoteRequestBlock.razor
       (styles live in the component; no duplicates here)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUOTE REQUEST EDITOR SECTION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .section-quotes .section-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .icon-quotes {
        background: linear-gradient(135deg, #F59E0B, #EF4444);
    }

    .form-fields-config {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 12px;
        background: var(--mud-palette-surface);
        border-radius: 8px;
        border: 1px solid var(--mud-palette-lines-default);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SERVICES MODULE PREMIUM STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Goal Selector */
    .section-goal .icon-goal { background: linear-gradient(135deg, #F59E0B, #D97706); }
    
    .goal-selector {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .goal-option {
        flex: 1;
        min-width: 200px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--mud-palette-surface);
        border: 2px solid var(--mud-palette-lines-default);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .goal-option:hover {
        border-color: var(--mud-palette-primary);
        background: var(--mud-palette-background-gray);
    }
    
    .goal-option.goal-active {
        border-color: var(--mud-palette-primary);
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
    }
    
    .goal-icon {
        font-size: 1.75rem;
        flex-shrink: 0;
    }
    
    .goal-text {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .goal-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--mud-palette-text-primary);
    }
    
    .goal-desc {
        font-size: 0.8rem;
        color: var(--mud-palette-text-secondary);
    }
    
    .goal-check {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }
    
    .goal-hint {
        margin-top: 0.75rem;
        font-size: 0.8rem;
        color: var(--mud-palette-text-secondary);
        text-align: center;
    }
    
    /* Auto-config Banner */
    .auto-config-banner {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .auto-config-icon {
        font-size: 1rem;
    }
    
    .auto-config-text {
        font-size: 0.85rem;
        color: var(--mud-palette-text-primary);
    }
    
    .auto-config-hint {
        color: var(--mud-palette-text-secondary);
        font-size: 0.8rem;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COMPACT CTA STATUS BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .cta-status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: rgba(var(--mud-palette-primary-rgb), 0.08);
        border-bottom: 1px solid rgba(var(--mud-palette-primary-rgb), 0.15);
    }
    
    .cta-status-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .cta-label {
        font-size: 0.8rem;
        color: var(--mud-palette-text-secondary);
        font-weight: 500;
    }
    
    .cta-selector-compact {
        display: flex;
        gap: 0.5rem;
    }
    
    .cta-chip {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.75rem;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        color: var(--mud-palette-text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .cta-chip:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--mud-palette-primary);
    }
    
    .cta-chip.cta-chip-active {
        background: var(--mud-palette-primary);
        border-color: var(--mud-palette-primary);
        color: white;
    }
    
    .cta-auto-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.75rem;
        background: rgba(var(--mud-palette-primary-rgb), 0.15);
        border-radius: 20px;
        color: var(--mud-palette-text-primary);
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .cta-auto-tag {
        padding: 0.15rem 0.4rem;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
    }
    
    /* Phone CTA Secondary Link */
    .phone-cta-secondary {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
        text-align: center;
        margin-top: 0.5rem;
        text-decoration: underline;
        cursor: pointer;
    }
    
    /* Services Count */
    .services-add-area {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .services-count {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
    }
    
    /* Service Card Premium (Enterprise) */
    .service-editor-card {
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-lines-default);
        border-radius: 12px;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
        overflow: hidden;
    }
    
    .service-editor-card.service-inactive {
        opacity: 0.55;
        background: var(--mud-palette-background-gray);
    }
    
    .service-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.15s;
    }
    .service-card-header:hover { background: rgba(255,255,255,0.03); }
    
    .service-header-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
    }
    
    .service-name-preview {
        color: var(--mud-palette-text-primary);
        font-weight: 600;
        font-size: 0.9rem;
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .service-header-chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    .svc-chip {
        display: inline-flex; align-items: center;
        padding: 2px 8px; border-radius: 10px;
        font-size: 0.7rem; font-weight: 500;
        background: rgba(255,255,255,0.06);
        color: var(--mud-palette-text-secondary);
        white-space: nowrap;
    }
    .svc-chip-duration { background: rgba(var(--mud-palette-primary-rgb), 0.12); color: var(--mud-palette-primary); }
    .svc-chip-price { background: rgba(76,175,80,0.12); color: #66bb6a; }
    .svc-chip-modality { background: rgba(255,255,255,0.06); }
    .svc-expand-icon { color: var(--mud-palette-text-secondary); }
    
    .service-header-right {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        flex-shrink: 0;
    }

    .service-card-body {
        padding: 0 1rem 1rem;
    }
    
    /* Conversion Type Selector */
    .service-conversion-type {
        margin-bottom: 1rem;
    }
    
    .conversion-label {
        display: block;
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .conversion-options {
        display: flex;
        gap: 0.5rem;
    }
    
    .conversion-option {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.6rem 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--mud-palette-text-secondary);
    }
    
    .conversion-option:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--mud-palette-primary);
        color: var(--mud-palette-text-primary);
    }
    
    .conversion-option.conversion-active {
        background: var(--mud-palette-primary);
        border-color: var(--mud-palette-primary);
        color: white;
    }
    
    .conversion-icon {
        font-size: 0.9rem;
    }
    
    .conversion-text {
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    /* Service Basic Fields */
    .service-basic-fields {
        margin-bottom: 0.5rem;
    }
    
    .service-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin: 0.5rem 0;
    }
    
    /* Config Panels */
    .service-config-panel {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin-top: 0.75rem;
        overflow: hidden;
    }
    
    .config-panel-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
        background: rgba(255, 255, 255, 0.03);
    }
    
    .config-panel-header:hover {
        background: rgba(255, 255, 255, 0.06);
    }
    
    .config-panel-icon {
        font-size: 1rem;
    }
    
    .config-panel-title {
        flex: 1;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--mud-palette-text-primary);
    }
    
    .config-panel-content {
        padding: 1rem;
        background: rgba(0, 0, 0, 0.15);
    }
    
    .config-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .config-sublabel {
        display: block;
        font-size: 0.8rem;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 0.5rem;
    }
    
    /* Quote Fields List */
    .quote-fields-list {
        margin-bottom: 1rem;
    }
    
    .quote-fields-list .mud-checkbox {
        margin: 0.25rem 0;
    }
    
    /* Services Empty State */
    .services-empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--mud-palette-text-secondary);
    }
    
    .services-empty-state p {
        margin: 0.75rem 0 0.25rem;
        font-weight: 500;
    }
    
    .services-empty-state span {
        font-size: 0.85rem;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCHEDULE EDITOR (Appointments template)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .schedule-editor {
        margin: 0.75rem 1rem;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(0,0,0,0.12);
    }
    .schedule-editor-body { padding: 1rem; }

    .schedule-presets {
        display: flex; gap: 0.5rem; margin-bottom: 0.75rem;
    }
    .schedule-preset-chip {
        padding: 6px 14px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.12);
        background: transparent; color: var(--mud-palette-text-secondary);
        font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
    }
    .schedule-preset-chip:hover { border-color: var(--mud-palette-primary); color: var(--mud-palette-text-primary); }
    .schedule-preset-chip.preset-active {
        background: var(--mud-palette-primary); border-color: var(--mud-palette-primary);
        color: white; font-weight: 600;
    }

    .schedule-day-toggles {
        display: flex; gap: 6px; margin-bottom: 0.75rem; flex-wrap: wrap;
    }
    .schedule-day-chip {
        width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.12);
        background: transparent; color: var(--mud-palette-text-secondary);
        font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
        display: flex; align-items: center; justify-content: center;
    }
    .schedule-day-chip:hover { border-color: var(--mud-palette-primary); }
    .schedule-day-chip.day-active {
        background: var(--mud-palette-primary); border-color: var(--mud-palette-primary); color: white;
    }

    .schedule-time-row {
        display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;
    }
    .schedule-validation-msg {
        font-size: 0.78rem; color: var(--mud-palette-error); margin: 0 0 0.5rem;
    }
    .schedule-break-toggle { margin: 0.25rem 0 0.5rem; }

    .schedule-timezone {
        display: flex; align-items: center; gap: 0.4rem;
        font-size: 0.78rem; color: var(--mud-palette-text-secondary);
        margin: 0.5rem 0;
    }

    .schedule-exceptions { margin-top: 0.75rem; }
    .schedule-exceptions-header {
        display: flex; align-items: center; justify-content: space-between;
    }
    .schedule-exceptions-title {
        font-size: 0.85rem; font-weight: 600;
    }
    .schedule-exceptions-list {
        display: flex; flex-direction: column; gap: 4px; margin-top: 0.5rem;
    }
    .schedule-exception-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 4px 8px; border-radius: 6px;
        background: rgba(255,255,255,0.04); font-size: 0.82rem;
    }
    .schedule-exceptions-empty {
        font-size: 0.78rem; color: var(--mud-palette-text-secondary);
        margin: 0.25rem 0;
    }

    /* Block Date Modal */
    .block-date-modal {
        background: var(--mud-palette-surface);
        border-radius: 12px;
        padding: 1.5rem;
        width: 340px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .block-date-modal-header { margin-bottom: 1rem; }
    .block-date-modal-title {
        font-size: 1.1rem; font-weight: 600; margin: 0;
        color: var(--mud-palette-text-primary);
    }
    .block-date-modal-subtitle {
        font-size: 0.82rem; margin: 0.25rem 0 0;
        color: var(--mud-palette-text-secondary);
    }
    .block-date-modal-body { margin-bottom: 1.25rem; }
    .block-date-modal-footer {
        display: flex; justify-content: flex-end; gap: 0.5rem;
    }

    /* Schedule Override Toggle (per-service) */
    .schedule-override-toggle {
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .schedule-override-hint {
        font-size: 0.76rem; color: var(--mud-palette-text-secondary);
        margin: 0.25rem 0 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE-ONLY ELEMENTS â€” Hidden by default (desktop)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .mobile-bottom-bar,
    .mobile-preview-overlay {
        display: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE RESPONSIVE â€” â‰¤ 600px
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @@media (max-width: 600px) {

        /* â”€â”€ Hide desktop elements â”€â”€ */
        .page-header {
            display: none !important;
        }
        .preview-sidebar {
            display: none !important;
        }
        .save-section {
            display: none !important;
        }

        /* â”€â”€ Container adjustments â”€â”€ */
        .mycard-container {
            padding: 0 0 80px 0;
        }

        .editor-layout {
            grid-template-columns: 1fr !important;
            gap: 12px;
            padding: 0 8px;
        }

        .editor-main {
            gap: 12px;
        }

        /* â”€â”€ Reduce section padding for mobile â”€â”€ */
        .section-level-1 { padding: 12px !important; }
        .section-level-2 { padding: 12px !important; }
        .section-level-3 { padding: 10px 12px !important; }
        .section-header { padding: 12px 8px; margin-bottom: 12px; }
        .section-content { padding: 8px 4px; }

        .mobile-bar-hidden {
            display: none !important;
        }

        /* â”€â”€ MOBILE BOTTOM BAR (fixed) â”€â”€ */
        .mobile-bottom-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed;
            bottom: 64px;
            left: 0;
            right: 0;
            z-index: 1100;
            padding: 12px 16px;
            background: var(--dt-surface-1, #111827);
            border-top: 1px solid var(--dt-border-default, #233044);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: transform 200ms ease, opacity 200ms ease;
        }

        .mobile-save-btn-idle {
            opacity: 0.5;
            background: var(--dt-surface-2, #162234) !important;
        }

        .mobile-save-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            min-height: 48px;
            border-radius: var(--dt-radius-lg, 12px);
            border: none;
            background: var(--dt-accent-primary, #8B5CF6);
            color: #fff;
            font-size: 0.8125rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            cursor: pointer;
            transition: background 150ms ease, opacity 150ms ease;
        }

        .mobile-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mobile-save-btn:active:not(:disabled) {
            background: var(--dt-accent-secondary, #7C3AED);
        }

        .mobile-preview-btn-bottom {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: var(--dt-radius-lg, 12px);
            border: 1px solid var(--dt-border-default, #233044);
            background: var(--dt-surface-2, #162234);
            color: var(--dt-text-primary, #E5E7EB);
            cursor: pointer;
            transition: background 150ms ease;
        }

        .mobile-preview-btn-bottom:active {
            background: var(--dt-accent-primary, #8B5CF6);
            color: #fff;
        }

        /* â”€â”€ MOBILE PREVIEW OVERLAY â”€â”€ */
        .mobile-preview-overlay {
            display: flex;
            flex-direction: column;
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            animation: mobileOverlayFadeIn 200ms ease;
        }

        @@keyframes mobileOverlayFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .mobile-preview-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            max-height: calc(100dvh - 64px);
            overflow: hidden;
        }

        .mobile-overlay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--dt-surface-1, #111827);
            border-bottom: 1px solid var(--dt-border-default, #233044);
            flex-shrink: 0;
        }

        .mobile-overlay-title {
            font-size: 0.8125rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            color: var(--dt-text-primary, #E5E7EB);
        }

        .mobile-overlay-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            min-width: 44px;
            min-height: 44px;
            border-radius: var(--dt-radius-md, 8px);
            border: 1px solid var(--dt-border-default, #233044);
            background: var(--dt-surface-2, #162234);
            color: var(--dt-text-primary, #E5E7EB);
            cursor: pointer;
            transition: background 150ms ease;
        }

        .mobile-overlay-close:active {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        .mobile-overlay-body {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 8px 12px;
        }

        .mobile-overlay-body .iphone-frame {
            --phone-radius: 44px;
            --screen-radius: 36px;
            width: min(92vw, 400px);
            max-width: 400px;
            height: auto;
            overflow: hidden;
            flex-shrink: 0;
        }

        .mobile-overlay-footer {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 16px 20px;
            flex-shrink: 0;
        }

        .mobile-overlay-actions-row {
            display: flex;
            gap: 8px;
        }

        .mobile-overlay-save-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            min-height: 44px;
            border-radius: var(--dt-radius-lg, 12px);
            border: none;
            background: var(--dt-accent-primary, #8B5CF6);
            color: #fff;
            font-size: 0.8125rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            cursor: pointer;
            transition: background 150ms ease, opacity 150ms ease;
        }

        .mobile-overlay-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mobile-overlay-save-btn:active:not(:disabled) {
            background: var(--dt-accent-secondary, #7C3AED);
        }

        .mobile-overlay-link {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 16px;
            min-height: 44px;
            border-radius: var(--dt-radius-lg, 12px);
            border: 1px solid var(--dt-accent-primary, #8B5CF6);
            background: transparent;
            color: var(--dt-accent-primary, #8B5CF6);
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-decoration: none;
            cursor: pointer;
            transition: background 150ms ease;
        }

        .mobile-overlay-link:active {
            background: rgba(139, 92, 246, 0.15);
        }

        .mobile-overlay-copy {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px 16px;
            min-height: 44px;
            border-radius: var(--dt-radius-lg, 12px);
            border: none;
            background: var(--dt-accent-primary, #8B5CF6);
            color: #fff;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: background 150ms ease;
        }

        .mobile-overlay-copy:active {
            background: var(--dt-accent-secondary, #7C3AED);
        }

        /* â”€â”€ Section card mobile tweaks â”€â”€ */
        .section-card {
            border-radius: var(--dt-radius-lg, 12px);
        }

        .section-header {
            padding: 14px 12px;
        }

        .section-content {
            padding: 12px;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .section-title {
            font-size: 0.875rem;
        }

        .section-description {
            font-size: 0.75rem;
        }

        /* â”€â”€ Form grid â€” single column on mobile â”€â”€ */
        .form-grid {
            grid-template-columns: 1fr !important;
        }

        .form-row {
            grid-column: span 1 !important;
        }

        /* â”€â”€ Appearance presets â€” horizontal scroll â”€â”€ */
        .appearance-presets-grid {
            display: flex !important;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            gap: 8px;
            padding-bottom: 8px;
        }

        .appearance-presets-grid > * {
            scroll-snap-align: start;
            flex-shrink: 0;
        }

        /* â”€â”€ Identity avatar â€” keep on right side on mobile â”€â”€ */
        .identity-header-with-avatar {
            flex-wrap: nowrap;
        }

        .identity-avatar-section {
            flex-shrink: 0;
            margin-top: 8px;
        }

        .identity-avatar-section .mud-avatar {
            width: 56px !important;
            height: 56px !important;
        }

        .change-photo-upload {
            display: none;
        }

        /* â”€â”€ Toggle grid â€” 1 column on mobile for readability â”€â”€ */
        .toggle-grid {
            grid-template-columns: 1fr !important;
            gap: 8px;
        }

        .toggle-item {
            padding: 10px 12px;
            min-height: 44px;
        }

        .toggle-label span {
            font-size: 0.85rem;
        }

        /* â”€â”€ Gallery columns â€” stacked â”€â”€ */
        .gallery-columns {
            flex-direction: column !important;
        }

        .gallery-column {
            width: 100% !important;
        }

        .gallery-upload-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           CONTACT INFO â€” iOS-style on mobile
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .contact-centered-header {
            display: none;
        }

        .contact-edit-inline .phone-row {
            display: grid !important;
            grid-template-columns: 100px 1fr !important;
            gap: 8px;
        }

        .contact-edit-inline .phone-row > * {
            min-width: 0 !important;
            width: 100% !important;
        }

        .contact-edit-inline .phone-row .mud-input-label {
            font-size: 0.75rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* â”€â”€ Social profiles â€” iOS rows compact on mobile â”€â”€ */
        .ios-rows-list .ios-row {
            padding: 12px 14px;
            min-height: 48px;
        }

        .ios-icon-badge {
            width: 32px;
            height: 32px;
            border-radius: 7px;
        }

        .social-row-editing {
            padding: 10px 12px;
        }

        .section-level-3 .form-row {
            margin-bottom: 0;
        }

        .section-level-3 .mud-input-control {
            font-size: 0.85rem;
        }

        /* Truncate long URLs in social inputs */
        .section-level-3 .mud-input-slot,
        .section-level-3 input {
            text-overflow: ellipsis !important;
            overflow: hidden !important;
            white-space: nowrap !important;
        }

        /* â”€â”€ Scroll lock when overlay is open â”€â”€ */
        body:has(.mobile-preview-overlay) {
            overflow: hidden !important;
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXTRA-SMALL MOBILE â€” â‰¤ 359px (stack phone fields)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @@media (max-width: 359px) {
        .phone-row {
            grid-template-columns: 1fr !important;
        }
    }
</style>

@code {
    private Card? _card;
    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _hasUnsavedChanges = false;
    private bool _mobilePreviewOpen = false;
    private bool _gallerySectionExpanded = true;
    private bool _initCompleted = false;
    private bool _pendingDbSave = false;
    private readonly SemaphoreSlim _dbGate = new(1, 1);
    private string _publicUrl = "";
    private bool _identitySectionExpanded = true;  // Only this open by default
    private bool _contactSectionExpanded = false;
    private bool _socialSectionExpanded = false;
    private bool _actionButtonsSectionExpanded = false;  // Closed by default
    private bool _isUploading = false;
    private string? _editingSocialField;
    private string? _editingContactField;
    
    // Appearance Section
    private bool _appearanceSectionExpanded = false;
    private bool _advancedModeExpanded = false;
    private CardStyleModel _cardStyle = new() { ButtonShape = PresetRegistry.Default.Tokens.ButtonShape };
    private ThemeTokens _themeTokens = PresetRegistry.Default.Tokens;
    private string _selectedPreset = "premium-dark";
    
    // Portfolio Gallery
    private bool _isPortfolioTemplate = false;
    private List<GalleryImageModel> _galleryImages = new();
    private bool _isUploadingGallery = false;
    private DataTouch.Web.Models.PortfolioGalleryModel _portfolioGallery = new();
    private bool _isUploadingVideo = false;
    
    // Services Template
    private bool _isServicesTemplate = false;
    private List<DataTouch.Domain.Entities.Service> _services = new();
    private bool _servicesSectionExpanded = false;  // Collapsed by default

    // Quote Request Template
    private bool _isQuoteRequestTemplate = false;

    // Appointments Template
    private bool _isAppointmentsTemplate = false;

    // Reservations Template
    private bool _isReservationsTemplate = false;
    private DataTouch.Web.Models.ReservationSettingsModel _reservationSettings = new();
    private string? _reservationCheckOutError;
    private static readonly List<AppointmentBookingBlock.ServiceDisplayItem> _mockAppointmentServices = new()
    {
        new() { Name = "Consulta General", DurationMinutes = 60, Price = 50 },
        new() { Name = "AsesorÃ­a Premium", DurationMinutes = 90, Price = 85 }
    };
    
    // Schedule Editor State (appointments template)
    private bool _scheduleExpanded = true;
    private string _schedulePreset = "mon-fri";
    private List<AvailabilityRule> _availabilityRules = new();
    private List<AvailabilityException> _availabilityExceptions = new();
    private BookingSettings? _bookingSettings;
    private HashSet<int> _globalScheduleActiveDays = new() { 1, 2, 3, 4, 5 }; // Mon-Fri default
    private TimeSpan? _globalWorkStart = TimeSpan.FromHours(9);
    private TimeSpan? _globalWorkEnd = TimeSpan.FromHours(17);
    private bool _hasBreak = false;
    private TimeSpan? _globalBreakStart = TimeSpan.FromHours(13);
    private TimeSpan? _globalBreakEnd = TimeSpan.FromHours(14);
    private bool _showBlockDateModal = false;
    private DateTime? _blockDateSelection = null;
    private static readonly List<(int Value, string Label)> _scheduleDays = new()
    {
        (1, "Lu"), (2, "Ma"), (3, "Mi"), (4, "Ju"), (5, "Vi"), (6, "SÃ¡"), (0, "Do")
    };
    
    private DataTouch.Web.Models.QuoteSettingsModel _quoteSettings = new();
    
    // ViewModels for JSON fields
    private SocialLinksModel _socialLinks = new();
    // Note: _websiteLinks kept for data preservation but not shown in UI
    private List<WebsiteLinkModel> _websiteLinks = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var email = AuthService.GetCurrentEmail();
            if (!string.IsNullOrEmpty(email))
            {
                await _dbGate.WaitAsync();
                try
                {
                    _card = await DbContext.Cards
                        .Include(c => c.Organization)
                        .FirstOrDefaultAsync(c => c.Email == email);

                    if (_card != null)
                    {
                        var baseUrl = Navigation.BaseUri.TrimEnd('/');
                        _publicUrl = $"{baseUrl}/p/{_card.Organization?.Slug}/{_card.Slug}";
                        
                        // Set default country codes if empty
                        if (string.IsNullOrEmpty(_card.PhoneCountryCode)) _card.PhoneCountryCode = "+52";
                        if (string.IsNullOrEmpty(_card.WhatsAppCountryCode)) _card.WhatsAppCountryCode = "+52";

                        // Deserialize JSON fields (no longer does fire-and-forget DB calls)
                        DeserializeJsonFields();
                        
                        // Flush any pending DB save from DeserializeJsonFields
                        if (_pendingDbSave)
                        {
                            await DbContext.SaveChangesAsync();
                            _pendingDbSave = false;
                        }
                        
                        // Expand social section if has any links
                        _socialSectionExpanded = HasAnySocialLink();
                        
                        // Load services if services template
                        _services = await DbContext.Services
                            .Where(s => s.CardId == _card.Id)
                            .OrderBy(s => s.DisplayOrder)
                            .ToListAsync();
                        
                        // Load schedule data for appointments template
                        if (_isAppointmentsTemplate)
                        {
                            _availabilityRules = await DbContext.AvailabilityRules
                                .Where(r => r.CardId == _card.Id && r.ServiceId == null)
                                .ToListAsync();
                            _availabilityExceptions = await DbContext.AvailabilityExceptions
                                .Where(e => e.CardId == _card.Id)
                                .ToListAsync();
                            _bookingSettings = await DbContext.Set<BookingSettings>()
                                .FirstOrDefaultAsync(s => s.CardId == _card.Id);
                            SyncScheduleStateFromRules();
                        }
                    }
                }
                finally
                {
                    _dbGate.Release();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar tarjeta: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            _initCompleted = true;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Guard: don't run DB ops before OnInitializedAsync completes
        if (!_initCompleted) return;
        
        // Handle query parameter changes (e.g., from TemplateLibrary navigation)
        await HandleTemplateQueryParam();
    }

    private async Task HandleTemplateQueryParam()
    {
        if (_card == null) return;
        
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var templateParam = query["template"];
        
        if (!string.IsNullOrEmpty(templateParam) && _card.TemplateType != templateParam)
        {
            // Apply new template
            _card.TemplateType = templateParam;
            _card.UpdatedAt = DateTime.UtcNow;
            
            // Update flags
            _isPortfolioTemplate = templateParam == "portfolio-creative";
            _isServicesTemplate = templateParam == "services-quotes";
            _isQuoteRequestTemplate = templateParam == "quote-request";
            _isAppointmentsTemplate = templateParam == "appointments";
            _isReservationsTemplate = templateParam == "reservations-range";

            // Apply appearance from query param (e.g. ?appearance=sky-light)
            var appearanceParam = query["appearance"];
            if (!string.IsNullOrEmpty(appearanceParam))
            {
                ApplyPreset(appearanceParam);
            }
            else if (_isServicesTemplate)
            {
                ApplyPreset("emerald-night");
            }
            else if (_isQuoteRequestTemplate)
            {
                ApplyPreset("sky-light");
            }
            else if (_isAppointmentsTemplate)
            {
                ApplyPreset("mint-breeze");
            }
            else if (_isReservationsTemplate)
            {
                ApplyPreset("soft-cream");
            }
            
            await _dbGate.WaitAsync();
            try
            {
                // Persist change
                await DbContext.SaveChangesAsync();
                
                // Reload services if needed
                _services = await DbContext.Services
                    .Where(s => s.CardId == _card.Id)
                    .OrderBy(s => s.DisplayOrder)
                    .ToListAsync();
                
                // Clear gallery if switching away from portfolio
                if (!_isPortfolioTemplate && _galleryImages.Any())
                {
                    _galleryImages.Clear();
                    _card.GalleryImagesJson = null;
                    await DbContext.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al aplicar template: {ex.Message}", Severity.Error);
            }
            finally
            {
                _dbGate.Release();
            }
            
            StateHasChanged();
        }
    }

    private void DeserializeJsonFields()
    {
        // Social Links
        if (!string.IsNullOrEmpty(_card?.SocialLinksJson))
        {
            try
            {
                _socialLinks = JsonSerializer.Deserialize<SocialLinksModel>(_card.SocialLinksJson) ?? new();
            }
            catch { _socialLinks = new(); }
        }

        // Website Links (preserved for data integrity, not shown in UI)
        if (!string.IsNullOrEmpty(_card?.WebsiteLinksJson))
        {
            try
            {
                _websiteLinks = JsonSerializer.Deserialize<List<WebsiteLinkModel>>(_card.WebsiteLinksJson) ?? new();
            }
            catch { _websiteLinks = new(); }
        }
        
        // Portfolio Gallery (new model with photos + videos)
        if (!string.IsNullOrEmpty(_card?.PortfolioGalleryJson))
        {
            try
            {
                _portfolioGallery = JsonSerializer.Deserialize<DataTouch.Web.Models.PortfolioGalleryModel>(_card.PortfolioGalleryJson) ?? new();
            }
            catch { _portfolioGallery = new(); }
        }
        // Legacy migration: if no PortfolioGalleryJson but has GalleryImagesJson, migrate photos
        else if (!string.IsNullOrEmpty(_card?.GalleryImagesJson))
        {
            try
            {
                var legacyImages = JsonSerializer.Deserialize<List<GalleryImageModel>>(_card.GalleryImagesJson) ?? new();
                _portfolioGallery = new DataTouch.Web.Models.PortfolioGalleryModel
                {
                    EnablePhotos = true,
                    EnableVideos = false,
                    Photos = legacyImages.Select(img => new DataTouch.Web.Models.GalleryItemModel
                    {
                        Url = img.Url,
                        Title = img.Title,
                        Description = img.Description,
                        Order = img.Order
                    }).ToList()
                };
            }
            catch { _portfolioGallery = new(); }
        }
        // Sync legacy _galleryImages from portfolio model for backward compat
        _galleryImages = _portfolioGallery.Photos.Select(p => new GalleryImageModel
        {
            Url = p.Url, Title = p.Title, Description = p.Description, Order = p.Order
        }).ToList();
        
        // Appearance Style
        if (!string.IsNullOrEmpty(_card?.AppearanceStyleJson))
        {
            try
            {
                _cardStyle = JsonSerializer.Deserialize<CardStyleModel>(_card.AppearanceStyleJson) ?? new();
                // Sync selected preset from stored PresetId
                if (!string.IsNullOrEmpty(_cardStyle.PresetId))
                {
                    _selectedPreset = _cardStyle.PresetId;
                }
            }
            catch { _cardStyle = new(); }
        }
        
        // Quote Settings
        if (!string.IsNullOrEmpty(_card?.QuoteSettingsJson))
        {
            try
            {
                _quoteSettings = JsonSerializer.Deserialize<DataTouch.Web.Models.QuoteSettingsModel>(_card.QuoteSettingsJson) ?? new();
            }
            catch { _quoteSettings = new(); }
        }

        // Reservation Settings
        if (!string.IsNullOrEmpty(_card?.ReservationSettingsJson))
        {
            try
            {
                _reservationSettings = JsonSerializer.Deserialize<DataTouch.Web.Models.ReservationSettingsModel>(_card.ReservationSettingsJson) ?? new();
                _reservationSettings.MigrateFromLegacy();
            }
            catch { _reservationSettings = new(); }
        }

        // Check template type: query param takes priority, else read from saved card
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var templateParam = query["template"];

        // Determine effective template: query param > card.TemplateType > "default"
        string effectiveTemplate;
        if (!string.IsNullOrEmpty(templateParam))
        {
            // Query param takes priority - use it immediately AND persist
            effectiveTemplate = templateParam;
            if (_card != null && _card.TemplateType != templateParam)
            {
                _card.TemplateType = templateParam;
                _card.UpdatedAt = DateTime.UtcNow;
                _pendingDbSave = true; // Will be flushed by caller after DeserializeJsonFields returns
            }
        }
        else
        {
            // No query param - read from saved card
            effectiveTemplate = !string.IsNullOrEmpty(_card?.TemplateType) ? _card.TemplateType : "default";
        }

        // Set template flags based on effective template
        _isPortfolioTemplate = effectiveTemplate == "portfolio-creative";
        _isServicesTemplate = effectiveTemplate == "services-quotes";
        _isQuoteRequestTemplate = effectiveTemplate == "quote-request";
        _isAppointmentsTemplate = effectiveTemplate == "appointments";
        _isReservationsTemplate = effectiveTemplate == "reservations-range";

        // Apply Emerald Night theme for Services template
        if (_isServicesTemplate)
        {
            var emeraldPreset = PresetRegistry.GetById("emerald-night");
            if (emeraldPreset != null)
            {
                _themeTokens = emeraldPreset.Tokens;
                _selectedPreset = "emerald-night";
            }
        }
        
        // Apply Sky Light theme for Quote Request template
        if (_isQuoteRequestTemplate)
        {
            var skyPreset = PresetRegistry.GetById("sky-light");
            if (skyPreset != null)
            {
                _themeTokens = skyPreset.Tokens;
                _selectedPreset = "sky-light";
                _cardStyle.BackgroundIsDark = false;
                _cardStyle.CardIsDark = false;
            }
        }
        
        // Apply Mint Breeze theme for Appointments template
        if (_isAppointmentsTemplate)
        {
            var mintPreset = PresetRegistry.GetById("mint-breeze");
            if (mintPreset != null)
            {
                _themeTokens = mintPreset.Tokens;
                _selectedPreset = "mint-breeze";
                _cardStyle.BackgroundIsDark = false;
                _cardStyle.CardIsDark = false;
            }
        }
        
        // Apply Soft Cream theme for Reservations template
        if (_isReservationsTemplate)
        {
            var creamPreset = PresetRegistry.GetById("soft-cream");
            if (creamPreset != null)
            {
                _themeTokens = creamPreset.Tokens;
                _selectedPreset = "soft-cream";
                _cardStyle.BackgroundIsDark = false;
                _cardStyle.CardIsDark = false;
            }
        }
        
        // Clear gallery images when switching away from portfolio template
        if (!_isPortfolioTemplate && _galleryImages.Any())
        {
            _galleryImages.Clear();
            if (_card != null)
            {
                _card.GalleryImagesJson = null;
                _card.UpdatedAt = DateTime.UtcNow;
                _pendingDbSave = true; // Will be flushed by caller after DeserializeJsonFields returns
            }
        }
    }

    private async Task SaveCard()
    {
        if (_card == null) return;
        
        _isSaving = true;
        StateHasChanged();

        try
        {
            // Serialize ViewModels to JSON
            if (_socialLinks.HasAnyLink())
            {
                _card.SocialLinksJson = JsonSerializer.Serialize(_socialLinks);
            }
            else
            {
                _card.SocialLinksJson = null;
            }

            // Preserve website links data (not removed from backend)
            var validLinks = _websiteLinks.Where(l => !string.IsNullOrEmpty(l.Title) && !string.IsNullOrEmpty(l.Url)).ToList();
            if (validLinks.Any())
            {
                _card.WebsiteLinksJson = JsonSerializer.Serialize(validLinks);
            }
            else
            {
                _card.WebsiteLinksJson = null;
            }
            
            // Sync _galleryImages into _portfolioGallery.Photos before serializing
            _portfolioGallery.Photos = _galleryImages.Select(img => new DataTouch.Web.Models.GalleryItemModel
            {
                Url = img.Url, Title = img.Title, Description = img.Description, Order = img.Order
            }).ToList();

            // Serialize Portfolio Gallery (new model)
            _card.PortfolioGalleryJson = JsonSerializer.Serialize(_portfolioGallery);

            // Serialize legacy GalleryImagesJson for backward compat
            if (_galleryImages.Any())
            {
                _card.GalleryImagesJson = JsonSerializer.Serialize(_galleryImages.OrderBy(i => i.Order).ToList());
            }
            else
            {
                _card.GalleryImagesJson = null;
            }
            
            // Serialize Appearance Style
            _card.AppearanceStyleJson = JsonSerializer.Serialize(_cardStyle);

            // Serialize Quote Settings â€” always persist to avoid data loss on template switch
            _card.QuoteSettingsJson = JsonSerializer.Serialize(_quoteSettings);

            // Serialize Reservation Settings â€” sync display strings from TimeSpan before persisting
            _reservationSettings.SyncDisplayStrings();
            _card.ReservationSettingsJson = JsonSerializer.Serialize(_reservationSettings);

            // Save TemplateType based on current state
            if (_isQuoteRequestTemplate)
                _card.TemplateType = "quote-request";
            else if (_isServicesTemplate)
                _card.TemplateType = "services-quotes";
            else if (_isPortfolioTemplate)
                _card.TemplateType = "portfolio-creative";
            else if (_isAppointmentsTemplate)
                _card.TemplateType = "appointments";
            else if (_isReservationsTemplate)
                _card.TemplateType = "reservations-range";
            // Otherwise keep current value (could be default or other)

            // Build availability rules from schedule editor state
            if (_isAppointmentsTemplate)
            {
                BuildRulesFromScheduleState();
            }

            _card.UpdatedAt = DateTime.UtcNow;
            
            await _dbGate.WaitAsync();
            try
            {
                await DbContext.SaveChangesAsync();
            }
            finally
            {
                _dbGate.Release();
            }
            
            _hasUnsavedChanges = false;
            Snackbar.Add("Cambios guardados correctamente", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void OnCheckInTimeChanged(TimeSpan? newTime)
    {
        _reservationSettings.CheckInTime = newTime;
        // Auto-suggest check-out if not yet set
        if (newTime.HasValue && !_reservationSettings.CheckOutTime.HasValue)
        {
            // Default: check-in + 20h (e.g. 3PM check-in â†’ 11AM check-out next day concept)
            var suggested = new TimeSpan(11, 0, 0); // 11:00 AM is standard check-out
            _reservationSettings.CheckOutTime = suggested;
        }
        _reservationSettings.SyncDisplayStrings();
        ValidateCheckOutTime();
        MarkUnsaved();
    }

    private void OnCheckOutTimeChanged(TimeSpan? newTime)
    {
        _reservationSettings.CheckOutTime = newTime;
        _reservationSettings.SyncDisplayStrings();
        ValidateCheckOutTime();
        MarkUnsaved();
    }

    private void ValidateCheckOutTime()
    {
        _reservationCheckOutError = null;
        if (_reservationSettings.CheckInTime.HasValue && _reservationSettings.CheckOutTime.HasValue)
        {
            if (_reservationSettings.CheckOutTime.Value >= _reservationSettings.CheckInTime.Value)
            {
                _reservationCheckOutError = "El check-out debe ser anterior al check-in (el huÃ©sped sale antes de que entre el siguiente).";
            }
        }
    }

    private void MarkUnsaved()
    {
        _hasUnsavedChanges = true;
        StateHasChanged(); // Always trigger re-render for preview updates
    }

    private async Task CopyUrl()
    {
        Snackbar.Add("URL copiada al portapapeles", Severity.Info);
    }

    private void ToggleSocialSection()
    {
        _socialSectionExpanded = !_socialSectionExpanded;
    }

    private void ToggleMobilePreview()
    {
        _mobilePreviewOpen = !_mobilePreviewOpen;
    }

    private void CloseMobilePreview()
    {
        _mobilePreviewOpen = false;
    }

    private int CountActiveButtons()
    {
        if (_card == null) return 0;
        int count = 0;
        if (_card.ShowSaveContact) count++;
        if (_card.ShowWhatsApp) count++;
        if (_card.ShowCall) count++;
        if (_card.ShowEmail) count++;
        return count;
    }

    private string GetDisplayCompanyName()
    {
        if (!string.IsNullOrEmpty(_card?.CompanyName))
            return _card.CompanyName;
        return _card?.Organization?.Name ?? "Mi Empresa";
    }

    private bool HasAnySocialLink()
    {
        return !string.IsNullOrEmpty(_socialLinks.LinkedIn) ||
               !string.IsNullOrEmpty(_socialLinks.Instagram) ||
               !string.IsNullOrEmpty(_socialLinks.YouTube) ||
               !string.IsNullOrEmpty(_socialLinks.Twitter);
    }

    private int CountSocialLinks()
    {
        int count = 0;
        if (!string.IsNullOrEmpty(_socialLinks.LinkedIn)) count++;
        if (!string.IsNullOrEmpty(_socialLinks.Instagram)) count++;
        if (!string.IsNullOrEmpty(_socialLinks.Facebook)) count++;
        if (!string.IsNullOrEmpty(_socialLinks.YouTube)) count++;
        if (!string.IsNullOrEmpty(_socialLinks.Twitter)) count++;
        if (!string.IsNullOrEmpty(_socialLinks.Website)) count++;
        return count;
    }

    private void ToggleActionButtonsSection()
    {
        _actionButtonsSectionExpanded = !_actionButtonsSectionExpanded;
    }

    /// <summary>
    /// Accordion: opens the target section and closes all others.
    /// On desktop, this still functions as a normal toggle since sections are independent.
    /// </summary>
    private void ToggleMobileAccordion(string sectionName)
    {
        // Toggle the target section
        bool newValue;
        switch (sectionName)
        {
            case nameof(_appearanceSectionExpanded):
                _appearanceSectionExpanded = !_appearanceSectionExpanded;
                newValue = _appearanceSectionExpanded;
                break;
            case nameof(_identitySectionExpanded):
                _identitySectionExpanded = !_identitySectionExpanded;
                newValue = _identitySectionExpanded;
                break;
            case nameof(_contactSectionExpanded):
                _contactSectionExpanded = !_contactSectionExpanded;
                newValue = _contactSectionExpanded;
                break;
            case nameof(_actionButtonsSectionExpanded):
                _actionButtonsSectionExpanded = !_actionButtonsSectionExpanded;
                newValue = _actionButtonsSectionExpanded;
                break;
            case nameof(_socialSectionExpanded):
                _socialSectionExpanded = !_socialSectionExpanded;
                newValue = _socialSectionExpanded;
                break;
            case nameof(_gallerySectionExpanded):
                _gallerySectionExpanded = !_gallerySectionExpanded;
                newValue = _gallerySectionExpanded;
                break;
            default:
                return;
        }

        // If opened, close all others (accordion behavior)
        if (newValue)
        {
            if (sectionName != nameof(_appearanceSectionExpanded)) _appearanceSectionExpanded = false;
            if (sectionName != nameof(_identitySectionExpanded)) _identitySectionExpanded = false;
            if (sectionName != nameof(_contactSectionExpanded)) _contactSectionExpanded = false;
            if (sectionName != nameof(_actionButtonsSectionExpanded)) _actionButtonsSectionExpanded = false;
            if (sectionName != nameof(_socialSectionExpanded)) _socialSectionExpanded = false;
            if (sectionName != nameof(_gallerySectionExpanded)) _gallerySectionExpanded = false;
        }
    }

    private string GetIdentitySummary()
    {
        if (_card == null) return "CÃ³mo te verÃ¡n en tu tarjeta pÃºblica";
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(_card.FullName)) parts.Add(_card.FullName);
        if (!string.IsNullOrEmpty(_card.Title)) parts.Add(_card.Title);
        var company = GetDisplayCompanyName();
        if (!string.IsNullOrEmpty(company) && company != "Mi Empresa") parts.Add(company);
        return parts.Count > 0 ? string.Join(" â€¢ ", parts) : "CÃ³mo te verÃ¡n en tu tarjeta pÃºblica";
    }

    private string GetContactSummary()
    {
        if (_card == null) return "CÃ³mo te pueden contactar";
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(_card.Email)) parts.Add("Email");
        if (!string.IsNullOrEmpty(_card.Phone)) parts.Add("TelÃ©fono");
        if (!string.IsNullOrEmpty(_card.WhatsAppNumber)) parts.Add("WhatsApp");
        return parts.Count > 0 ? string.Join(" â€¢ ", parts) : "CÃ³mo te pueden contactar";
    }
    private void ToggleAdvancedMode() => _advancedModeExpanded = !_advancedModeExpanded;

    private void ApplyPreset(string presetId)
    {
        var preset = _presets.FirstOrDefault(p => p.Id == presetId);
        if (preset == null) return;
        
        _selectedPreset = presetId;
        _cardStyle.PresetId = presetId;
        _cardStyle.BackgroundType = preset.BackgroundType;
        _cardStyle.BackgroundValue = preset.BackgroundValue;
        _cardStyle.CardContainerStyle = preset.CardStyle;
        _cardStyle.ButtonShape = preset.ButtonShape;
        _cardStyle.ButtonStyle = preset.ButtonStyle;
        _cardStyle.BackgroundIsDark = preset.BackgroundIsDark;
        _cardStyle.CardIsDark = preset.CardIsDark;
        _cardStyle.AccentColor = preset.AccentColor;
        
        // Load ThemeTokens from PresetRegistry for consistent styling
        var registryPreset = PresetRegistry.GetById(presetId);
        if (registryPreset != null)
        {
            _themeTokens = registryPreset.Tokens;
            // Sync ButtonShape from ThemeTokens to ensure GetButtonRadius() uses correct value
            _cardStyle.ButtonShape = _themeTokens.ButtonShape;
        }
        
        MarkUnsaved();
    }

    private void ResetAppearanceToDefault()
    {
        _cardStyle = new CardStyleModel();
        _selectedPreset = "premium-dark";
        MarkUnsaved();
    }

    private string GetBackgroundSummary() => _cardStyle.BackgroundType switch
    {
        "gradient" => "Gradiente",
        "solid" => "SÃ³lido",
        "image" => "Imagen",
        _ => "Gradiente"
    };

    private string GetCardSummary() => _cardStyle.CardContainerStyle switch
    {
        "glass" => "Glass",
        "solid" => "Solid",
        "elevated" => "Elevated",
        _ => "Glass"
    };

    private string GetButtonsSummary() => _cardStyle.ButtonShape switch
    {
        "pill" => "Pill",
        "rounded" => "Rounded",
        "square" => "Square",
        _ => "Rounded"
    };

    private string GetPreviewBackgroundStyle()
    {
        // Include all theme CSS variables for consistent styling on light/dark themes
        var cssVariables = ThemeHelper.GenerateCssVariables(_themeTokens);
        return $"background: {_themeTokens.BgValue}; {cssVariables}";
    }
    
    // Border-radius helpers for button shape consistency
    private string GetButtonRadius() => _cardStyle.ButtonShape switch
    {
        "pill" => "50px",
        "square" => "6px",
        _ => "14px" // rounded (default)
    };
    
    private string GetInputRadius() => _cardStyle.ButtonShape switch
    {
        "pill" => "20px",
        "square" => "4px",
        _ => "8px" // rounded
    };
    
    // Get card/container background style when independent
    private string GetCardBackgroundStyle()
    {
        if (_cardStyle.CardLinkedToBackground)
        {
            // Linked mode - return empty, CSS handles it
            return "";
        }
        // Independent mode - apply custom background
        return $"background: {_cardStyle.CardBackgroundColor} !important;";
    }

    // Specific methods for appearance onclick handlers
    // Background Type
    private void SetBackgroundGradient() { _cardStyle.BackgroundType = "gradient"; MarkUnsaved(); }
    private void SetBackgroundSolid() { _cardStyle.BackgroundType = "solid"; MarkUnsaved(); }
    private void SetBackgroundImage() { _cardStyle.BackgroundType = "image"; MarkUnsaved(); }
    
    // Colores = restores the preset's default background type (gradient or solid)
    private void SetBackgroundColores() 
    { 
        // Get the current preset and restore its background type
        var preset = PresetRegistry.GetById(_selectedPreset);
        if (preset != null)
        {
            _cardStyle.BackgroundType = preset.Tokens.BgType;
            _cardStyle.BackgroundValue = preset.Tokens.BgValue;
        }
        else
        {
            // Fallback to gradient if no preset found
            _cardStyle.BackgroundType = "gradient";
        }
        MarkUnsaved(); 
    }
    
    // Card Style
    private void SetCardStyleGlass() { _cardStyle.CardContainerStyle = "glass"; MarkUnsaved(); }
    private void SetCardStyleSolid() { _cardStyle.CardContainerStyle = "solid"; MarkUnsaved(); }
    private void SetCardStyleElevated() { _cardStyle.CardContainerStyle = "elevated"; MarkUnsaved(); }
    
    private void OnGlassIntensityChanged(int value) { _cardStyle.GlassIntensity = value; MarkUnsaved(); }
    
    // Border Radius
    private void SetBorderRadiusSmall() { _cardStyle.BorderRadius = "small"; MarkUnsaved(); }
    private void SetBorderRadiusMedium() { _cardStyle.BorderRadius = "medium"; MarkUnsaved(); }
    private void SetBorderRadiusLarge() { _cardStyle.BorderRadius = "large"; MarkUnsaved(); }
    
    // Shadow Style
    private void SetShadowSoft() { _cardStyle.ShadowStyle = "soft"; MarkUnsaved(); }
    private void SetShadowMedium() { _cardStyle.ShadowStyle = "medium"; MarkUnsaved(); }
    private void SetShadowStrong() { _cardStyle.ShadowStyle = "strong"; MarkUnsaved(); }
    
    // Avatar Size
    private void SetAvatarSizeS() { _cardStyle.AvatarSize = "S"; MarkUnsaved(); }
    private void SetAvatarSizeM() { _cardStyle.AvatarSize = "M"; MarkUnsaved(); }
    private void SetAvatarSizeL() { _cardStyle.AvatarSize = "L"; MarkUnsaved(); }
    
    // Button Shape
    private void SetButtonShapePill() { _cardStyle.ButtonShape = "pill"; MarkUnsaved(); }
    private void SetButtonShapeRounded() { _cardStyle.ButtonShape = "rounded"; MarkUnsaved(); }
    private void SetButtonShapeSquare() { _cardStyle.ButtonShape = "square"; MarkUnsaved(); }
    
    // Button Style
    private void SetButtonStyleFilled() { _cardStyle.ButtonStyle = "filled"; MarkUnsaved(); }
    private void SetButtonStyleOutline() { _cardStyle.ButtonStyle = "outline"; MarkUnsaved(); }
    
    // Contrast Mode
    private void SetContrastAuto() { _cardStyle.ContrastMode = "auto"; MarkUnsaved(); }
    private void SetContrastLight() { _cardStyle.ContrastMode = "force-light"; MarkUnsaved(); }
    private void SetContrastDark() { _cardStyle.ContrastMode = "force-dark"; MarkUnsaved(); }
    
    // Card Independence Toggle
    private void ToggleCardLinked() 
    { 
        _cardStyle.CardLinkedToBackground = !_cardStyle.CardLinkedToBackground; 
        MarkUnsaved(); 
    }
    
    private void SetCardBackgroundColor(string color) 
    { 
        _cardStyle.CardBackgroundColor = color;
        // Determine if color is dark for contrast
        _cardStyle.CardIsDarkOverride = IsHexColorDark(color);
        MarkUnsaved(); 
    }
    
    // Simple luminance check for hex colors
    private bool IsHexColorDark(string hex)
    {
        if (string.IsNullOrEmpty(hex)) return true;
        hex = hex.TrimStart('#');
        if (hex.Length < 6) return true;
        try
        {
            int r = Convert.ToInt32(hex.Substring(0, 2), 16);
            int g = Convert.ToInt32(hex.Substring(2, 2), 16);
            int b = Convert.ToInt32(hex.Substring(4, 2), 16);
            // Relative luminance formula
            double luminance = (0.299 * r + 0.587 * g + 0.114 * b);
            return luminance < 140; // Below threshold = dark
        }
        catch { return true; }
    }
    
    // Get contrast class for background surface
    private string GetBackgroundContrastClass()
    {
        if (_cardStyle.ContrastMode == "force-light") return "contrast-light";
        if (_cardStyle.ContrastMode == "force-dark") return "contrast-dark";
        // Auto mode - use preset's luminance value
        return _cardStyle.BackgroundIsDark ? "contrast-dark" : "contrast-light";
    }
    
    // Get contrast class for card surface
    private string GetCardContrastClass()
    {
        if (_cardStyle.ContrastMode == "force-light") return "contrast-light";
        if (_cardStyle.ContrastMode == "force-dark") return "contrast-dark";
        
        // If card is independent, use its own luminance
        if (!_cardStyle.CardLinkedToBackground)
        {
            return _cardStyle.CardIsDarkOverride ? "contrast-dark" : "contrast-light";
        }
        
        // Linked mode - follow background or use preset's card luminance
        return _cardStyle.CardIsDark ? "contrast-dark" : "contrast-light";
    }
    
    // Get contrast class for form (follows card contrast)
    private string GetFormContrastClass() => GetCardContrastClass();

    private async Task UploadBackgroundImage(IBrowserFile file)
    {
        if (file == null) return;

        try 
        {
            var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "backgrounds");
            Directory.CreateDirectory(uploadsPath);
            
            var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
            var filePath = Path.Combine(uploadsPath, fileName);
            
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var fileStream = new FileStream(filePath, FileMode.Create);
            await stream.CopyToAsync(fileStream);
            
            _cardStyle.BackgroundImageUrl = $"/uploads/backgrounds/{fileName}";
            MarkUnsaved();
            Snackbar.Add("Imagen de fondo actualizada", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al subir: {ex.Message}", Severity.Error);
        }
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private string FormatLastUpdated(DateTime updatedAt)
    {
        var local = updatedAt.ToLocalTime();
        var diff = DateTime.Now - local;
        
        if (diff.TotalMinutes < 1) return "hace un momento";
        if (diff.TotalMinutes < 60) return $"hace {(int)diff.TotalMinutes} min";
        if (diff.TotalHours < 24) return $"hace {(int)diff.TotalHours} h";
        if (diff.TotalDays < 7) return $"hace {(int)diff.TotalDays} dÃ­as";
        return local.ToString("dd/MM/yyyy HH:mm");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VIEW MODELS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private class SocialLinksModel
    {
        public string? LinkedIn { get; set; }
        public string? Instagram { get; set; }
        public string? Facebook { get; set; }
        public string? YouTube { get; set; }
        public string? Twitter { get; set; }
        public string? Website { get; set; }

        public bool HasAnyLink()
        {
            return !string.IsNullOrEmpty(LinkedIn) ||
                   !string.IsNullOrEmpty(Instagram) ||
                   !string.IsNullOrEmpty(Facebook) ||
                   !string.IsNullOrEmpty(YouTube) ||
                   !string.IsNullOrEmpty(Twitter) ||
                   !string.IsNullOrEmpty(Website);
        }
    }

    private class WebsiteLinkModel
    {
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }

    // CardStyleModel is now shared: see Models/CardStyleModel.cs

    private record AppearancePreset(
        string Id, 
        string Name, 
        string Category, // "dark" or "light"
        string Personality, // Target audience description
        string BackgroundType, 
        string BackgroundValue, 
        string CardStyle, 
        string ButtonShape, 
        string ButtonStyle, 
        bool BackgroundIsDark, 
        bool CardIsDark,
        string AccentColor // Primary accent for this preset
    );
    
    private static readonly List<AppearancePreset> _presets = new()
    {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DARK PRESETS (8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        new("premium-dark", "Premium Dark", "dark", "Ejecutivos, consultores",
            "gradient", "linear-gradient(135deg, #0F0A1E 0%, #1E1B4B 50%, #0F0A1E 100%)", 
            "glass", "pill", "filled", true, true, "#7C3AED"),
        
        new("midnight-blue", "Midnight Blue", "dark", "Tech, startups",
            "gradient", "linear-gradient(135deg, #0c1445 0%, #1a237e 50%, #0d1b3e 100%)", 
            "glass", "pill", "filled", true, true, "#00B4D8"),
        
        new("charcoal-gold", "Charcoal Gold", "dark", "Lujo, finanzas",
            "solid", "#1C1C1C", 
            "solid", "pill", "filled", true, true, "#D4AF37"),
        
        new("emerald-night", "Emerald Night", "dark", "Eco, wellness",
            "gradient", "linear-gradient(135deg, #0D1F17 0%, #134E3A 50%, #0D1F17 100%)", 
            "glass", "pill", "filled", true, true, "#10B981"),
        
        new("rose-noir", "Rose Noir", "dark", "Creative, beauty",
            "gradient", "linear-gradient(135deg, #1A0A14 0%, #3D1A2A 50%, #1A0A14 100%)", 
            "glass", "pill", "filled", true, true, "#F472B6"),
        
        new("high-contrast", "High Contrast", "dark", "Accesibilidad",
            "solid", "#000000", 
            "solid", "pill", "filled", true, true, "#FFFFFF"),
        
        new("obsidian", "Obsidian", "dark", "Minimal, tech",
            "solid", "#0A0A0A", 
            "glass", "pill", "outline", true, true, "#64748B"),
        
        new("aurora", "Aurora", "dark", "Creative, events",
            "gradient", "linear-gradient(135deg, #0F172A 0%, #1E3A5F 25%, #3B1E5F 50%, #5F1E3A 75%, #0F172A 100%)", 
            "glass", "pill", "filled", true, true, "#EC4899"),
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LIGHT PRESETS (8)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        new("minimal-white", "Minimal White", "light", "Clean, corporate",
            "solid", "#F8FAFC", 
            "elevated", "pill", "outline", false, false, "#475569"),
        
        new("soft-cream", "Soft Cream", "light", "Warmth, hospitality",
            "solid", "#FFFBEB", 
            "elevated", "pill", "filled", false, false, "#D97706"),
        
        new("sky-light", "Sky Light", "light", "Fresh, modern",
            "gradient", "linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 50%, #E0F2FE 100%)", 
            "elevated", "pill", "filled", false, false, "#0284C7"),
        
        new("mint-breeze", "Mint Breeze", "light", "Health, wellness",
            "solid", "#ECFDF5", 
            "elevated", "pill", "filled", false, false, "#059669"),
        
        new("pearl-gray", "Pearl Gray", "light", "Elegant, professional",
            "solid", "#F1F5F9", 
            "elevated", "pill", "filled", false, false, "#64748B"),
        
        new("rose-blush", "Rose Blush", "light", "Gentle, welcoming",
            "solid", "#FFF1F2", 
            "elevated", "pill", "filled", false, false, "#E11D48"),
        
        new("ocean-mist", "Ocean Mist", "light", "Calm, trustworthy",
            "gradient", "linear-gradient(135deg, #F0FDFA 0%, #CCFBF1 50%, #F0FDFA 100%)", 
            "elevated", "pill", "filled", false, false, "#14B8A6"),
        
        new("lavender-cloud", "Lavender Cloud", "light", "Creative, serene",
            "solid", "#FAF5FF", 
            "elevated", "pill", "filled", false, false, "#9333EA")
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHOTO UPLOAD LOGIC (Single Flow with Loading State)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private async Task UploadFiles(IBrowserFile file)
    {
        if (_card == null || _isUploading) return;

        _isUploading = true;
        StateHasChanged();

        try 
        {
            // Validation: Max size 5MB
            if (file.Size > 5 * 1024 * 1024)
            {
                Snackbar.Add("Imagen muy pesada. MÃ¡ximo 5 MB permitido.", Severity.Error);
                return;
            }

            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".webp" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add("Formato no soportado. Usa JPG, PNG o WebP.", Severity.Error);
                return;
            }

            // FIX: Handle null WebRootPath in production (Railway)
            var webRootPath = Environment.WebRootPath;
            if (string.IsNullOrEmpty(webRootPath))
            {
                // Fallback to application's base directory
                webRootPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            }
            
            var uploadsFolder = Path.Combine(webRootPath, "uploads");
            if (!Directory.Exists(uploadsFolder)) 
                Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{extension}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using (var stream = file.OpenReadStream(5 * 1024 * 1024))
            using (var fs = new FileStream(filePath, FileMode.Create))
            {
                await stream.CopyToAsync(fs);
            }

            // FIX: Update card and save immediately to DB
            _card.ProfileImageUrl = $"/uploads/{fileName}";
            _card.UpdatedAt = DateTime.UtcNow;
            await _dbGate.WaitAsync();
            try
            {
                await DbContext.SaveChangesAsync();
            }
            finally
            {
                _dbGate.Release();
            }
            
            MarkUnsaved();
            Snackbar.Add("Foto actualizada y guardada", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al subir: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUploading = false;
            StateHasChanged();
        }
    }

    private void RemovePhoto()
    {
        if (_card != null) 
        {
            _card.ProfileImageUrl = null;
            MarkUnsaved();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COUNTRIES DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private record CountryCode(string Name, string Code, string Flag, int DigitLength);
    private List<CountryCode> _countries = new()
    {
        new("El Salvador", "+503", "ğŸ‡¸ğŸ‡»", 8),
        new("MÃ©xico", "+52", "ğŸ‡²ğŸ‡½", 10),
        new("Estados Unidos", "+1", "ğŸ‡ºğŸ‡¸", 10),
        new("Argentina", "+54", "ğŸ‡¦ğŸ‡·", 10),
        new("Colombia", "+57", "ğŸ‡¨ğŸ‡´", 10),
        new("EspaÃ±a", "+34", "ğŸ‡ªğŸ‡¸", 9),
        new("PerÃº", "+51", "ğŸ‡µğŸ‡ª", 9),
        new("Chile", "+56", "ğŸ‡¨ğŸ‡±", 9),
        new("Guatemala", "+502", "ğŸ‡¬ğŸ‡¹", 8),
        new("Costa Rica", "+506", "ğŸ‡¨ğŸ‡·", 8)
    };

    private int GetPhoneMaxLength() => _countries.FirstOrDefault(c => c.Code == _card?.PhoneCountryCode)?.DigitLength ?? 15;
    private int GetWhatsAppMaxLength() => _countries.FirstOrDefault(c => c.Code == _card?.WhatsAppCountryCode)?.DigitLength ?? 15;

    private CountryCode? GetCountryForCode(string? code) => _countries.FirstOrDefault(c => c.Code == code);

    private string GetWhatsAppUrl()
    {
        var code = _card?.WhatsAppCountryCode?.TrimStart('+') ?? "";
        var number = _card?.WhatsAppNumber ?? "";
        return "https://wa.me/" + code + number;
    }

    private string GetCountryShortName(string? code)
    {
        if (code == "+503") return "SV";
        if (code == "+52") return "MX";
        if (code == "+1") return "US";
        if (code == "+54") return "AR";
        if (code == "+57") return "CO";
        if (code == "+34") return "ES";
        if (code == "+51") return "PE";
        if (code == "+56") return "CL";
        if (code == "+502") return "GT";
        if (code == "+506") return "CR";
        return "";
    }

    private void StartEditSocial(string field) { _editingSocialField = field; StateHasChanged(); }
    private void StopEditSocial() { _editingSocialField = null; MarkUnsaved(); StateHasChanged(); }
    private void EditLinkedIn() => StartEditSocial("LinkedIn");
    private void EditInstagram() => StartEditSocial("Instagram");
    private void EditFacebook() => StartEditSocial("Facebook");
    private void EditYouTube() => StartEditSocial("YouTube");
    private void EditTwitter() => StartEditSocial("Twitter");
    private void EditWebsite() => StartEditSocial("Website");

    private string GetSocialValue(string field)
    {
        if (field == "LinkedIn") return _socialLinks?.LinkedIn ?? "";
        if (field == "Instagram") return _socialLinks?.Instagram ?? "";
        if (field == "Facebook") return _socialLinks?.Facebook ?? "";
        if (field == "YouTube") return _socialLinks?.YouTube ?? "";
        if (field == "Twitter") return _socialLinks?.Twitter ?? "";
        if (field == "Website") return _socialLinks?.Website ?? "";
        return "";
    }
    private void StartEditContact(string field) { _editingContactField = field; StateHasChanged(); }
    private void StopEditContact() { _editingContactField = null; MarkUnsaved(); StateHasChanged(); }
    private void EditEmail() => StartEditContact("email");
    private void EditPhone() => StartEditContact("phone");
    private void EditWhatsApp() => StartEditContact("whatsapp");
    private string GetPhoneTelUrl() => "tel:" + (_card?.PhoneCountryCode ?? "") + (_card?.Phone ?? "");
    private string GetWhatsAppTelUrl() => "tel:" + (_card?.WhatsAppCountryCode ?? "") + (_card?.WhatsAppNumber ?? "");

    private string GetBioFeedback()
    {
        var length = _card?.Bio?.Length ?? 0;
        if (length == 0) return "Describe brevemente tu rol o especialidad";
        if (length <= 150) return $"Longitud ideal ({length}/300)";
        if (length <= 250) return $"Considera acortar ({length}/300)";
        return $"Muy largo ({length}/300)";
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GALLERY IMAGE MODEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private class GalleryImageModel
    {
        public string Url { get; set; } = "";
        public string? Title { get; set; }
        public string? Description { get; set; }
        public int Order { get; set; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GALLERY UPLOAD & MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private async Task UploadGalleryImage(IBrowserFile file)
    {
        if (_card == null || _isUploadingGallery || _galleryImages.Count >= 10) return;

        _isUploadingGallery = true;
        StateHasChanged();

        try
        {
            // Validation: Max size 5MB
            if (file.Size > 5 * 1024 * 1024)
            {
                Snackbar.Add("Imagen muy pesada. MÃ¡ximo 5 MB permitido.", Severity.Error);
                return;
            }

            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".webp" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add("Formato no soportado. Usa JPG, PNG o WebP.", Severity.Error);
                return;
            }

            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads", "gallery");
            if (!Directory.Exists(uploadsFolder)) Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{extension}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using (var stream = file.OpenReadStream(5 * 1024 * 1024))
            using (var fs = new FileStream(filePath, FileMode.Create))
            {
                await stream.CopyToAsync(fs);
            }

            var newImage = new GalleryImageModel
            {
                Url = $"/uploads/gallery/{fileName}",
                Order = _galleryImages.Count
            };
            _galleryImages.Add(newImage);
            
            MarkUnsaved();
            Snackbar.Add("Imagen agregada a la galerÃ­a", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al subir: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUploadingGallery = false;
            StateHasChanged();
        }
    }

    private void RemoveGalleryImage(GalleryImageModel image)
    {
        _galleryImages.Remove(image);
        // Reorder remaining images
        var ordered = _galleryImages.OrderBy(i => i.Order).ToList();
        for (int i = 0; i < ordered.Count; i++)
        {
            ordered[i].Order = i;
        }
        MarkUnsaved();
        StateHasChanged();
    }

    private void MoveGalleryImage(GalleryImageModel image, int direction)
    {
        var ordered = _galleryImages.OrderBy(i => i.Order).ToList();
        var currentIndex = ordered.IndexOf(image);
        var newIndex = currentIndex + direction;
        
        if (newIndex < 0 || newIndex >= ordered.Count) return;
        
        // Swap orders
        var other = ordered[newIndex];
        var tempOrder = image.Order;
        image.Order = other.Order;
        other.Order = tempOrder;
        
        MarkUnsaved();
        StateHasChanged();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GALLERY TOGGLES & VIDEO MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private void OnPhotosToggleChanged(bool value)
    {
        if (!value && !_portfolioGallery.EnableVideos)
        {
            Snackbar.Add("Debes tener al menos una secciÃ³n activa.", Severity.Warning);
            return;
        }
        _portfolioGallery.EnablePhotos = value;
        MarkUnsaved();
    }

    private void OnVideosToggleChanged(bool value)
    {
        if (!value && !_portfolioGallery.EnablePhotos)
        {
            Snackbar.Add("Debes tener al menos una secciÃ³n activa.", Severity.Warning);
            return;
        }
        _portfolioGallery.EnableVideos = value;
        MarkUnsaved();
    }

    private async Task UploadGalleryVideo(IBrowserFile file)
    {
        if (_card == null || _isUploadingVideo || _portfolioGallery.Videos.Count >= 10) return;

        _isUploadingVideo = true;
        StateHasChanged();

        try
        {
            if (file.Size > 200 * 1024 * 1024)
            {
                Snackbar.Add("Video muy pesado. MÃ¡ximo 200 MB permitido. Intenta comprimir el archivo.", Severity.Error);
                return;
            }

            var allowedExtensions = new[] { ".mp4", ".webm", ".mov" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add("Formato no soportado. Usa MP4, WebM o MOV.", Severity.Error);
                return;
            }

            var uploadsFolder = Path.Combine(Environment.WebRootPath, "uploads", "gallery");
            if (!Directory.Exists(uploadsFolder)) Directory.CreateDirectory(uploadsFolder);

            var fileName = $"{Guid.NewGuid()}{extension}";
            var filePath = Path.Combine(uploadsFolder, fileName);

            using (var stream = file.OpenReadStream(200 * 1024 * 1024))
            using (var fs = new FileStream(filePath, FileMode.Create))
            {
                await stream.CopyToAsync(fs);
            }

            _portfolioGallery.Videos.Add(new DataTouch.Web.Models.GalleryItemModel
            {
                Url = $"/uploads/gallery/{fileName}",
                Order = _portfolioGallery.Videos.Count
            });

            MarkUnsaved();
            Snackbar.Add("Video agregado a la galerÃ­a", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al subir video: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isUploadingVideo = false;
            StateHasChanged();
        }
    }

    private void RemoveGalleryVideo(DataTouch.Web.Models.GalleryItemModel video)
    {
        _portfolioGallery.Videos.Remove(video);
        var ordered = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
        for (int i = 0; i < ordered.Count; i++) ordered[i].Order = i;
        MarkUnsaved();
        StateHasChanged();
    }

    private void MoveGalleryVideo(DataTouch.Web.Models.GalleryItemModel video, int direction)
    {
        var ordered = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
        var currentIndex = ordered.IndexOf(video);
        var newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= ordered.Count) return;
        var other = ordered[newIndex];
        var tempOrder = video.Order;
        video.Order = other.Order;
        other.Order = tempOrder;
        MarkUnsaved();
        StateHasChanged();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SERVICES MANAGEMENT (for services template)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private async Task LoadServicesAsync()
    {
        if (_card == null) return;
        await _dbGate.WaitAsync();
        try
        {
            _services = await DbContext.Services
                .Where(s => s.CardId == _card.Id)
                .OrderBy(s => s.DisplayOrder)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar servicios: {ex.Message}", Severity.Error);
        }
        finally
        {
            _dbGate.Release();
        }
    }

    private void AddNewService()
    {
        if (_card == null || _services.Count >= 10) return;
        
        var newService = new DataTouch.Domain.Entities.Service
        {
            Id = Guid.NewGuid(),
            CardId = _card.Id,
            OrganizationId = _card.OrganizationId,
            Name = "Nuevo servicio",
            DurationMinutes = 60,
            ConversionType = _isAppointmentsTemplate ? "booking" : "booking",
            UseGlobalSchedule = true,
            DisplayOrder = _services.Count,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };
        
        _services.Add(newService);
        DbContext.Services.Add(newService);
        MarkUnsaved();
        StateHasChanged();
    }

    private void RemoveService(DataTouch.Domain.Entities.Service service)
    {
        _services.Remove(service);
        DbContext.Services.Remove(service);
        
        // Reorder remaining services
        var ordered = _services.OrderBy(s => s.DisplayOrder).ToList();
        for (int i = 0; i < ordered.Count; i++)
        {
            ordered[i].DisplayOrder = i;
        }
        
        MarkUnsaved();
        StateHasChanged();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SCHEDULE EDITOR METHODS (appointments template)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private async Task LoadScheduleDataAsync()
    {
        if (_card == null) return;
        await _dbGate.WaitAsync();
        try
        {
            _availabilityRules = await DbContext.AvailabilityRules
                .Where(r => r.CardId == _card.Id && r.ServiceId == null)
                .ToListAsync();
            _availabilityExceptions = await DbContext.AvailabilityExceptions
                .Where(e => e.CardId == _card.Id)
                .ToListAsync();
            _bookingSettings = await DbContext.Set<BookingSettings>()
                .FirstOrDefaultAsync(s => s.CardId == _card.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar horario: {ex.Message}", Severity.Error);
        }
        finally
        {
            _dbGate.Release();
        }

        SyncScheduleStateFromRules();
    }

    private void SyncScheduleStateFromRules()
    {
        if (_availabilityRules.Any())
        {
            _globalScheduleActiveDays = _availabilityRules
                .Where(r => r.IsActive)
                .Select(r => r.DayOfWeek)
                .ToHashSet();

            var firstRule = _availabilityRules.FirstOrDefault(r => r.IsActive);
            if (firstRule != null)
            {
                _globalWorkStart = firstRule.StartTime;
                _globalWorkEnd = firstRule.EndTime;
                _hasBreak = firstRule.BreakStartTime.HasValue && firstRule.BreakEndTime.HasValue;
                if (_hasBreak)
                {
                    _globalBreakStart = firstRule.BreakStartTime;
                    _globalBreakEnd = firstRule.BreakEndTime;
                }
            }

            // Detect preset
            var activeDaysSorted = _globalScheduleActiveDays.OrderBy(d => d).ToList();
            if (activeDaysSorted.SequenceEqual(new[] { 1, 2, 3, 4, 5 }))
                _schedulePreset = "mon-fri";
            else if (activeDaysSorted.SequenceEqual(new[] { 1, 2, 3, 4, 5, 6 }))
                _schedulePreset = "mon-sat";
            else
                _schedulePreset = "custom";
        }
    }

    private void ApplySchedulePreset(string preset)
    {
        _schedulePreset = preset;
        _globalScheduleActiveDays = preset switch
        {
            "mon-fri" => new HashSet<int> { 1, 2, 3, 4, 5 },
            "mon-sat" => new HashSet<int> { 1, 2, 3, 4, 5, 6 },
            _ => _globalScheduleActiveDays
        };
        MarkUnsaved();
        StateHasChanged();
    }

    private void ToggleScheduleDay(int dayOfWeek)
    {
        if (_globalScheduleActiveDays.Contains(dayOfWeek))
            _globalScheduleActiveDays.Remove(dayOfWeek);
        else
            _globalScheduleActiveDays.Add(dayOfWeek);

        _schedulePreset = "custom";
        var sorted = _globalScheduleActiveDays.OrderBy(d => d).ToList();
        if (sorted.SequenceEqual(new[] { 1, 2, 3, 4, 5 })) _schedulePreset = "mon-fri";
        else if (sorted.SequenceEqual(new[] { 1, 2, 3, 4, 5, 6 })) _schedulePreset = "mon-sat";

        MarkUnsaved();
        StateHasChanged();
    }

    private void AddScheduleException()
    {
        _blockDateSelection = null;
        _showBlockDateModal = true;
        StateHasChanged();
    }

    private void CancelBlockDate()
    {
        _showBlockDateModal = false;
        StateHasChanged();
    }

    private void ConfirmBlockDate()
    {
        if (_card == null || !IsBlockDateValid()) return;
        var selectedDate = DateOnly.FromDateTime(_blockDateSelection!.Value);
        var newEx = new AvailabilityException
        {
            Id = Guid.NewGuid(),
            CardId = _card.Id,
            ExceptionDate = selectedDate,
            ExceptionType = AvailabilityExceptionType.Blocked
        };
        _availabilityExceptions.Add(newEx);
        DbContext.AvailabilityExceptions.Add(newEx);
        _showBlockDateModal = false;
        MarkUnsaved();
        StateHasChanged();
    }

    private bool IsBlockDateValid()
    {
        if (_blockDateSelection == null) return false;
        if (_blockDateSelection.Value.Date < DateTime.Today) return false;
        var candidate = DateOnly.FromDateTime(_blockDateSelection.Value);
        return !_availabilityExceptions.Any(e => e.ExceptionDate == candidate);
    }

    private void RemoveScheduleException(AvailabilityException ex)
    {
        _availabilityExceptions.Remove(ex);
        DbContext.AvailabilityExceptions.Remove(ex);
        MarkUnsaved();
        StateHasChanged();
    }

    private void BuildRulesFromScheduleState()
    {
        if (_card == null) return;

        // Remove old global rules from context
        foreach (var old in _availabilityRules.ToList())
        {
            DbContext.AvailabilityRules.Remove(old);
        }
        _availabilityRules.Clear();

        // Create new rules from UI state
        foreach (var dayValue in new[] { 0, 1, 2, 3, 4, 5, 6 })
        {
            var isActive = _globalScheduleActiveDays.Contains(dayValue);
            var rule = new AvailabilityRule
            {
                Id = Guid.NewGuid(),
                CardId = _card.Id,
                DayOfWeek = dayValue,
                StartTime = _globalWorkStart ?? TimeSpan.FromHours(9),
                EndTime = _globalWorkEnd ?? TimeSpan.FromHours(17),
                BreakStartTime = _hasBreak ? _globalBreakStart : null,
                BreakEndTime = _hasBreak ? _globalBreakEnd : null,
                ServiceId = null,
                IsActive = isActive
            };
            _availabilityRules.Add(rule);
            DbContext.AvailabilityRules.Add(rule);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SERVICES MODULE HELPER METHODS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private void SetPrimaryGoal(string goal)
    {
        if (_card != null)
        {
            _card.PrimaryCardGoal = goal;
            MarkUnsaved();
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// Determines if Goal selector should be visible.
    /// Only shows when there's a real mix of conversion types.
    /// </summary>
    private bool IsGoalSelectorVisible => HasMixedTypes();
    
    /// <summary>
    /// Checks if services have mixed conversion types (booking + quote).
    /// Returns true if selector should be shown.
    /// </summary>
    private bool HasMixedTypes()
    {
        var activeServices = _services.Where(s => s.IsActive).ToList();
        if (!activeServices.Any()) return false;
        
        var types = activeServices.Select(s => s.ConversionType ?? "booking").Distinct().ToList();
        
        // If any service is "both", we have mixed types
        if (types.Contains("both")) return true;
        
        // If we have both "booking" and "quote", it's mixed
        return types.Contains("booking") && types.Contains("quote");
    }
    
    /// <summary>
    /// Gets the effective primary goal, auto-detecting when all services are same type.
    /// Falls back to user-defined PrimaryCardGoal when mixed.
    /// </summary>
    private string GetEffectivePrimaryGoal()
    {
        var activeServices = _services.Where(s => s.IsActive).ToList();
        
        // No services = default to booking
        if (!activeServices.Any()) return "booking";
        
        var types = activeServices.Select(s => s.ConversionType ?? "booking").Distinct().ToList();
        
        // All same type = auto-detect
        if (types.Count == 1 && types[0] != "both")
        {
            return types[0]; // "booking" or "quote"
        }
        
        // Mixed types = use user preference, default to booking
        return _card?.PrimaryCardGoal ?? "booking";
    }
    
    /// <summary>
    /// Checks if any active service supports booking (Cita).
    /// </summary>
    private bool HasBookingServices()
    {
        return _services.Any(s => s.IsActive && (s.ConversionType == "booking" || s.ConversionType == "both"));
    }
    
    /// <summary>
    /// Checks if any active service supports quotes (CotizaciÃ³n).
    /// </summary>
    private bool HasQuoteServices()
    {
        return _services.Any(s => s.IsActive && (s.ConversionType == "quote" || s.ConversionType == "both"));
    }
    
    private void DuplicateService(DataTouch.Domain.Entities.Service originalService)
    {
        if (_services.Count >= 10) return;
        
        var newService = new DataTouch.Domain.Entities.Service
        {
            Id = Guid.NewGuid(),
            CardId = _card!.Id,
            OrganizationId = _card.OrganizationId,
            Name = $"{originalService.Name} (copia)",
            Description = originalService.Description,
            DurationMinutes = originalService.DurationMinutes,
            PriceFrom = originalService.PriceFrom,
            ConversionType = originalService.ConversionType,
            Modality = originalService.Modality,
            BufferBeforeMinutes = originalService.BufferBeforeMinutes,
            BufferAfterMinutes = originalService.BufferAfterMinutes,
            MinNoticeMinutes = originalService.MinNoticeMinutes,
            MaxBookingsPerDay = originalService.MaxBookingsPerDay,
            QuoteFormConfigJson = originalService.QuoteFormConfigJson,
            DisplayOrder = _services.Count,
            IsActive = true,
            CreatedAt = DateTime.UtcNow
        };
        
        _services.Add(newService);
        DbContext.Services.Add(newService);
        MarkUnsaved();
        Snackbar.Add("Servicio duplicado", Severity.Success);
        StateHasChanged();
    }
    
    private void SetServiceConversionType(DataTouch.Domain.Entities.Service service, string conversionType)
    {
        service.ConversionType = conversionType;
        MarkUnsaved();
        StateHasChanged();
    }
    
    // Service card body expansion state
    private HashSet<Guid> _expandedServiceBodies = new();
    
    private void ToggleServiceBody(Guid serviceId)
    {
        if (_expandedServiceBodies.Contains(serviceId))
            _expandedServiceBodies.Remove(serviceId);
        else
            _expandedServiceBodies.Add(serviceId);
    }
    
    private bool IsServiceBodyExpanded(Guid serviceId) => _expandedServiceBodies.Contains(serviceId);

    private static string FormatDuration(int minutes)
    {
        if (minutes == 60) return "1 hora";
        if (minutes > 60) return $"{minutes / 60} h {(minutes % 60 > 0 ? $"{minutes % 60} min" : "")}";
        return $"{minutes} min";
    }

    private static string GetModalityLabel(string? modality)
    {
        if (modality == "presencial") return "Presencial";
        if (modality == "online") return "Online";
        if (modality == "domicilio") return "A domicilio";
        return "";
    }

    // Service config panel expansion state
    private HashSet<Guid> _expandedBookingConfigs = new();
    private HashSet<Guid> _expandedQuoteConfigs = new();
    
    private void ToggleServiceBookingConfig(Guid serviceId)
    {
        if (_expandedBookingConfigs.Contains(serviceId))
            _expandedBookingConfigs.Remove(serviceId);
        else
            _expandedBookingConfigs.Add(serviceId);
    }
    
    private bool IsServiceBookingConfigExpanded(Guid serviceId) => _expandedBookingConfigs.Contains(serviceId);
    
    private void ToggleServiceQuoteConfig(Guid serviceId)
    {
        if (_expandedQuoteConfigs.Contains(serviceId))
            _expandedQuoteConfigs.Remove(serviceId);
        else
            _expandedQuoteConfigs.Add(serviceId);
    }
    
    private bool IsServiceQuoteConfigExpanded(Guid serviceId) => _expandedQuoteConfigs.Contains(serviceId);
    
    // QuoteFormConfig helpers
    private Dictionary<Guid, QuoteFormConfig> _quoteConfigCache = new();
    
    private QuoteFormConfig GetQuoteConfig(DataTouch.Domain.Entities.Service service)
    {
        if (_quoteConfigCache.TryGetValue(service.Id, out var cached))
            return cached;
        
        QuoteFormConfig config;
        if (!string.IsNullOrEmpty(service.QuoteFormConfigJson))
        {
            try
            {
                config = System.Text.Json.JsonSerializer.Deserialize<QuoteFormConfig>(service.QuoteFormConfigJson) ?? new();
            }
            catch { config = new(); }
        }
        else
        {
            config = new();
        }
        
        _quoteConfigCache[service.Id] = config;
        return config;
    }
    
    private void UpdateQuoteConfig(DataTouch.Domain.Entities.Service service, QuoteFormConfig config)
    {
        _quoteConfigCache[service.Id] = config;
        service.QuoteFormConfigJson = System.Text.Json.JsonSerializer.Serialize(config);
        MarkUnsaved();
    }


    private async Task CopyPublicUrl()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _publicUrl);
            Snackbar.Add("URL copiada al portapapeles", Severity.Success);
        }
        catch
        {
            Snackbar.Add("No se pudo copiar la URL", Severity.Error);
        }
    }

    // Helper to get emoji for service preview
    private string GetServiceEmoji(string serviceName)
    {
        var name = serviceName?.ToLower() ?? "";
        return name switch
        {
            var n when n.Contains("consult") => "ğŸ’¼",
            var n when n.Contains("anÃ¡lisis") || n.Contains("analisis") => "ğŸ“Š",
            var n when n.Contains("planific") || n.Contains("estrateg") => "ğŸ¯",
            var n when n.Contains("diseÃ±o") || n.Contains("design") => "ğŸ¨",
            var n when n.Contains("desarrollo") || n.Contains("dev") => "ğŸ’»",
            var n when n.Contains("market") => "ğŸ“ˆ",
            var n when n.Contains("foto") || n.Contains("photo") => "ğŸ“·",
            var n when n.Contains("video") => "ğŸ¬",
            var n when n.Contains("web") => "ğŸŒ",
            var n when n.Contains("social") => "ğŸ“±",
            var n when n.Contains("capacit") || n.Contains("train") => "ğŸ“š",
            var n when n.Contains("audit") => "ğŸ”",
            var n when n.Contains("legal") => "âš–ï¸",
            var n when n.Contains("contab") || n.Contains("financ") => "ğŸ’°",
            _ => "âœ¨"
        };
    }
}
