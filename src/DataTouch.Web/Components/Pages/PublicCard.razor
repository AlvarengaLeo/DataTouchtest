@page "/p/{OrgSlug}/{CardSlug}"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@layout EmptyLayout
@inject DataTouchDbContext DbContext
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject DataTouch.Web.Services.CardAnalyticsService AnalyticsService
@inject DataTouch.Web.Services.QuoteService QuoteService
@inject DataTouch.Web.Services.AppointmentService AppointmentService
@inject DataTouch.Web.Services.ReservationService ReservationService
@inject ILogger<PublicCard> Logger
@implements IDisposable
@using DataTouch.Web.Models
@using DataTouch.Web.Components.Shared

<MudThemeProvider IsDarkMode="@_themeTokens.BgIsDark" Theme="@_theme" />

<PageTitle>@(_card?.FullName ?? "Tarjeta") - DataTouch</PageTitle>

@if (_isLoading)
{
    <div class="loading-container">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    </div>
}
else if (_card == null || _organization == null)
{
    <div class="error-container">
        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
        <MudText Typo="Typo.h5" Class="mt-4 text-white">Tarjeta no encontrada</MudText>
        <MudText Typo="Typo.body1" Class="text-white-70">La tarjeta que buscas no existe o estÃ¡ desactivada.</MudText>
    </div>
}
else
{
    @* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LANDING PÃšBLICA - ESTRUCTURA EN 3 BLOQUES
       Fondo continuo en gradient, sin cortes blancos
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
    <div class="landing-wrapper @GetBackgroundContrastClass()" style="@GetDynamicBackgroundStyle(); @GetThemeCssVariables()">
        
        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           BLOQUE 1: HERO / PERFIL
           Card principal con foto, nombre, puesto, bio y links
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        <div class="profile-card @GetCardContrastClass()" style="@GetCardBackgroundStyle()">
            <div class="card-header-gradient"></div>
            <div class="card-content">
                @* Avatar *@
                <div class="avatar-container">
                    @if (!string.IsNullOrEmpty(_card.ProfileImageUrl))
                    {
                        <MudAvatar Class="profile-avatar">
                            <MudImage Src="@_card.ProfileImageUrl" Alt="@_card.FullName" />
                        </MudAvatar>
                    }
                    else
                    {
                        @* Custom avatar div - bypasses MudBlazor internal styles *@
                        <div class="profile-avatar profile-avatar-initials">
                            @_card.FullName?.FirstOrDefault()
                        </div>
                    }
                </div>

                @* Info principal *@
                <MudText Typo="Typo.h5" Class="profile-name">@_card.FullName</MudText>
                <MudText Typo="Typo.subtitle1" Class="profile-title">@_card.Title</MudText>
                <div class="profile-location">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
                    <span>@GetDisplayCompanyName()</span>
                </div>

                @if (!string.IsNullOrEmpty(_card.Bio))
                {
                    <MudText Typo="Typo.body2" Class="profile-bio">@_card.Bio</MudText>
                }

                @* Links y Redes Sociales â€” Shared Component *@
                <SocialLinksRow
                    LinkedIn="@_socialLinks?.LinkedIn"
                    Instagram="@_socialLinks?.Instagram"
                    Facebook="@_socialLinks?.Facebook"
                    YouTube="@_socialLinks?.YouTube"
                    Twitter="@_socialLinks?.Twitter"
                    Website="@_socialLinks?.Website" />

                @* Status Chips *@
                <div class="status-chips">
                        <span class="status-chip">
                            <span class="chip-dot"></span>
                            Disponible
                        </span>
                        <span class="status-chip">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                            Responde &lt; 1h
                        </span>
                        <span class="status-chip">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" />
                            El Salvador
                        </span>
                    </div>

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   PORTFOLIO GALLERY (Conditional) â€” Shared Component
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <PortfolioGalleryBlock
                    Photos="@_portfolioGallery.Photos"
                    Videos="@_portfolioGallery.Videos"
                    EnablePhotos="@_portfolioGallery.EnablePhotos"
                    EnableVideos="@_portfolioGallery.EnableVideos"
                    OnPhotoClick="OnGalleryPhotoClick"
                    OnVideoClick="OnGalleryVideoClick" />

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   SERVICES SECTION (Services Template) - Matches TemplateLibrary Preview
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isServicesTemplate && _services.Any())
                {
                    <div class="services-template-section">
                        <h3 class="services-section-title">MIS SERVICIOS</h3>
                        <div class="services-cards-list">
                            @{ var serviceIcons = new[] { "ğŸ’¼", "ğŸ“Š", "ğŸ¯", "ğŸ› ï¸", "ğŸ’¡" }; }
                            @foreach (var (service, index) in _services.Select((s, i) => (s, i)))
                            {
                                <div class="service-card-item">
                                    <div class="service-card-icon" style="background: @GetServiceIconColor(index)">
                                        @serviceIcons[index % serviceIcons.Length]
                                    </div>
                                    <div class="service-card-content">
                                        <span class="service-card-name">@service.Name</span>
                                        <span class="service-card-meta">
                                            @service.DurationMinutes min â€¢ Desde $@(service.PriceFrom?.ToString("N0") ?? "--")
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        @* Booking and Quote CTAs - Smart display based on service types *@
                        <div class="services-cta-section">
                            @{
                                // Determine effective goal (auto-detect or user preference)
                                var types = _services.Where(s => s.IsActive).Select(s => s.ConversionType ?? "booking").Distinct().ToList();
                                var hasBooking = _services.Any(s => s.IsActive && (s.ConversionType == "booking" || s.ConversionType == "both"));
                                var hasQuote = _services.Any(s => s.IsActive && (s.ConversionType == "quote" || s.ConversionType == "both"));
                                
                                // Auto-detect if all same type, otherwise use card preference
                                var effectiveGoal = "booking";
                                if (types.Count == 1 && types[0] != "both")
                                {
                                    effectiveGoal = types[0];
                                }
                                else
                                {
                                    effectiveGoal = _card.PrimaryCardGoal ?? "booking";
                                }
                            }
                            
                            @if (effectiveGoal == "booking" && hasBooking)
                            {
                                <a href="@GetBookingUrl()" class="btn-booking-primary">
                                    ğŸ“… Reservar Cita
                                </a>
                                @if (hasQuote)
                                {
                                    <button class="btn-quote-link" @onclick="OpenQuoteModal">
                                        o solicitar cotizaciÃ³n
                                    </button>
                                }
                            }
                            else if (effectiveGoal == "quote" && hasQuote)
                            {
                                <button class="btn-booking-primary" @onclick="OpenQuoteModal">
                                    ğŸ“ Solicitar CotizaciÃ³n
                                </button>
                                @if (hasBooking)
                                {
                                    <a href="@GetBookingUrl()" class="btn-quote-link">
                                        o reservar cita
                                    </a>
                                }
                            }
                            else if (hasBooking)
                            {
                                <a href="@GetBookingUrl()" class="btn-booking-primary">
                                    ğŸ“… Reservar Cita
                                </a>
                            }
                            else if (hasQuote)
                            {
                                <button class="btn-booking-primary" @onclick="OpenQuoteModal">
                                    ğŸ“ Solicitar CotizaciÃ³n
                                </button>
                            }
                        </div>
                        
                        @* Contact Info Footer *@
                        <div class="services-contact-footer">
                            @if (!string.IsNullOrEmpty(_card.Email))
                            {
                                <a href="mailto:@_card.Email" class="contact-item">
                                    âœ‰ï¸ @_card.Email
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(_card.Phone))
                            {
                                <a href="tel:@GetFullPhoneForLink()" class="contact-item">
                                    ğŸ“ @_card.PhoneCountryCode @_card.Phone
                                </a>
                            }
                        </div>
                    </div>
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   QUOTE REQUEST BLOCK (Quote Request Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isQuoteRequestTemplate)
                {
                    <QuoteRequestBlock
                        Title="@_quoteSettings.BlockTitle"
                        Subtitle="@_quoteSettings.BlockSubtitle"
                        CtaLabel="@_quoteSettings.BlockTitle"
                        ShowLegalText="@_quoteSettings.ShowLegalText"
                        LegalText="@_quoteSettings.LegalText"
                        OnCtaClick="OpenPublicQuoteModal" />
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   APPOINTMENT BOOKING BLOCK (Appointments Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isAppointmentsTemplate)
                {
                    <AppointmentBookingBlock
                        Services="@_services.Select(s => new AppointmentBookingBlock.ServiceDisplayItem { Name = s.Name, DurationMinutes = s.DurationMinutes, Price = s.PriceFrom }).ToList()"
                        OnBookClick="OpenSchedulerModal" />
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   RESERVATION BOOKING BLOCK (Reservations Template)
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                @if (_isReservationsTemplate)
                {
                    <ReservationBookingBlock
                        Title="@_reservationSettings.BlockTitle"
                        Subtitle="@_reservationSettings.BlockSubtitle"
                        MaxGuests="@_reservationSettings.MaxGuests"
                        ConfirmationText="@_reservationSettings.ConfirmationTimeText"
                        PoliciesLabel="@(_reservationSettings.ShowPolicies ? "PolÃ­ticas" : null)"
                        OnReserveClick="OpenReservationModal"
                        OnFromClick="OpenReservationModal"
                        OnToClick="OpenReservationModal" />
                }

                @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   BLOQUE 2: CTAs / ACCIONES RÃPIDAS - Hide for services template
                   Integrados DENTRO de la card, no como secciÃ³n aparte
                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
                <div class="cta-section">
                        @* BotÃ³n primario: Guardar contacto - respetar flag *@
                        @if (_card.ShowSaveContact)
                        {
                            <MudButton Variant="Variant.Filled" FullWidth="true" 
                                       Class="btn-primary-cta" OnClick="@DownloadVCard"
                                       StartIcon="@Icons.Material.Filled.PersonAdd">
                                Guardar Contacto
                            </MudButton>
                        }

                        @* Fila de botones secundarios - respetar flags *@
                        <div class="cta-row">
                            @if (_card.ShowWhatsApp && !string.IsNullOrEmpty(_card.WhatsAppNumber))
                            {
                                <MudButton Variant="Variant.Filled" Class="btn-whatsapp"
                                           Href="@($"https://wa.me/{GetFullWhatsAppForLink()}")"
                                           Target="_blank" StartIcon="@Icons.Custom.Brands.WhatsApp">
                                    WhatsApp
                                </MudButton>
                            }
                            @if (_card.ShowCall && !string.IsNullOrEmpty(_card.Phone))
                            {
                                <MudButton Variant="Variant.Filled" Class="btn-call"
                                           Href="@($"tel:{GetFullPhoneForLink()}")"
                                           StartIcon="@Icons.Material.Filled.Phone">
                                    Llamar
                                </MudButton>
                            }
                            @if (_card.ShowEmail && !string.IsNullOrEmpty(_card.Email))
                            {
                                <MudButton Variant="Variant.Filled" Class="btn-email"
                                           Href="@($"mailto:{_card.Email}")"
                                           StartIcon="@Icons.Material.Filled.Email">
                                    Email
                                </MudButton>
                            }
                        </div>
                    </div>
            </div>
        </div>

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           BLOQUE 3: FORMULARIO DE LEAD PREMIUM (Hidden for quote-request template)
           DiseÃ±o enterprise-grade con validaciÃ³n avanzada de telÃ©fono
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (!_isQuoteRequestTemplate && !_isAppointmentsTemplate && !_isReservationsTemplate)
        {
        <div class="lead-form-card @GetCardContrastClass() @(_showSuccess ? "success-state" : "")" style="@GetCardBackgroundStyle()">
            @if (_showSuccess)
            {
                @* Success Overlay Animation *@
                <div class="success-overlay">
                    <div class="success-icon-container">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Class="success-icon" />
                    </div>
                    <MudText Typo="Typo.h6" Class="success-title">Â¡Gracias por contactarme!</MudText>
                    <MudText Typo="Typo.body2" Class="success-message">
                        Me pondrÃ© en contacto contigo muy pronto.
                    </MudText>
                    <MudButton Variant="Variant.Text" Class="success-btn" OnClick="@ResetForm">
                        Enviar otro mensaje
                    </MudButton>
                </div>
            }
            else
            {
                <div class="form-header">
                    <div class="form-header-icon">
                        <MudIcon Icon="@Icons.Material.Filled.MailOutline" Size="Size.Medium" />
                    </div>
                    <div>
                        <MudText Typo="Typo.h6" Class="form-title">Â¿Quieres que te contacte?</MudText>
                        <MudText Typo="Typo.caption" Class="form-subtitle">DÃ©jame tus datos y te respondo pronto</MudText>
                    </div>
                </div>
                
                <EditForm Model="_contactForm" OnValidSubmit="SubmitContact" class="premium-form">
                    <DataAnnotationsValidator />
                    
                    @* Nombre Completo *@
                    <div class="compact-field">
                        <label class="compact-label">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="label-icon" />
                            Nombre completo <span class="required">*</span>
                        </label>
                        <div class="native-input-wrapper">
                            <input type="text"
                                   class="native-text-input @(IsNameValid ? "is-valid" : "") @(!string.IsNullOrEmpty(_nameError) ? "has-error" : "")"
                                   value="@_contactForm.FullName"
                                   placeholder="Juan PÃ©rez"
                                   @oninput="@(e => _contactForm.FullName = e.Value?.ToString() ?? "")"
                                   autocomplete="name" />
                            @if (IsNameValid)
                            {
                                <div class="input-adornment valid">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                </div>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_nameError))
                        {
                            <span class="field-error">@_nameError</span>
                        }
                    </div>
                    
                    @* Email *@
                    <div class="compact-field">
                        <label class="compact-label">
                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="label-icon" />
                            Correo electrÃ³nico <span class="required">*</span>
                        </label>
                        <div class="native-input-wrapper">
                            <input type="email"
                                   class="native-text-input @(IsEmailValid ? "is-valid" : "") @(!string.IsNullOrEmpty(_emailError) ? "has-error" : "")"
                                   value="@_contactForm.Email"
                                   placeholder="tu@email.com"
                                   @oninput="@(e => _contactForm.Email = e.Value?.ToString() ?? "")"
                                   autocomplete="email" />
                            @if (IsEmailValid)
                            {
                                <div class="input-adornment valid">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                </div>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_emailError))
                        {
                            <span class="field-error">@_emailError</span>
                        }
                    </div>
                    
                    @* TelÃ©fono con selector de paÃ­s *@
                    <CountryPhoneInput @bind-Value="_contactForm.Phone"
                                       @bind-CountryCode="_contactForm.PhoneCountryCode"
                                       @bind-E164Value="_contactForm.PhoneE164"
                                       Required="true"
                                       IsValidChanged="@(valid => _isPhoneValid = valid)" />
                    
                    @* Mensaje Opcional *@
                    <div class="compact-field">
                        <label class="compact-label">
                            <MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Small" Class="label-icon" />
                            Mensaje <span class="optional">(opcional)</span>
                        </label>
                        <div class="native-input-wrapper">
                            <textarea class="native-textarea-input"
                                      placeholder="Â¿En quÃ© puedo ayudarte?"
                                      rows="2"
                                      @oninput="@(e => _contactForm.Message = e.Value?.ToString() ?? "")">@_contactForm.Message</textarea>
                        </div>
                    </div>
                    
                    @* Submit Button with States *@
                    <button type="submit" 
                            class="premium-submit-btn @GetSubmitButtonClass()" 
                            disabled="@(!CanSubmit)">
                        @if (_isSubmitting)
                        {
                            <span class="btn-spinner"></span>
                            <span>Enviando...</span>
                        }
                        else if (_submitError)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Size="Size.Small" />
                            <span>Error, intenta de nuevo</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" />
                            <span>Enviar mensaje</span>
                        }
                    </button>
                    
                    @if (_submitError)
                    {
                        <div class="submit-error-hint">
                            <MudText Typo="Typo.caption" Color="Color.Error">
                                OcurriÃ³ un problema. Por favor, verifica tus datos e intenta nuevamente.
                            </MudText>
                        </div>
                    }
                </EditForm>
            }
        </div>
        } @* End !_isQuoteRequestTemplate lead form *@

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           APPOINTMENT BOOKING MODAL (Appointments Template)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (_isAppointmentsTemplate && _card != null)
        {
            <PublicAppointmentModal
                @bind-IsOpen="_appointmentModalOpen"
                CardId="_card.Id"
                Services="_services"
                WhatsAppNumber="@(_card.WhatsAppCountryCode + _card.WhatsAppNumber)" />
        }

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           RESERVATION MODAL (Reservations Template)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (_isReservationsTemplate && _card != null)
        {
            <PublicReservationModal
                @bind-IsOpen="_reservationModalOpen"
                Settings="_reservationSettings"
                CardId="_card.Id"
                OrganizationId="_card.OrganizationId"
                BlockedDates="_reservationBlockedDates"
                OnMonthChanged="LoadBlockedDatesForMonth"
                WhatsAppUrl="@(!string.IsNullOrEmpty(_card.WhatsAppNumber) ? $"https://wa.me/{_card.WhatsAppCountryCode}{_card.WhatsAppNumber}" : null)" />
        }

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           LIGHTBOX MODAL (Gallery Image)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (_lightboxOpen && _selectedImage != null)
        {
            <div class="lightbox-overlay" @onclick="CloseLightbox">
                <button class="lightbox-close" @onclick="CloseLightbox">Ã—</button>
                <div class="lightbox-content" @onclick:stopPropagation="true">
                    <img src="@_selectedImage.Url" alt="@(_selectedImage.Title ?? "Image")" />
                    @if (!string.IsNullOrEmpty(_selectedImage.Title) || !string.IsNullOrEmpty(_selectedImage.Description))
                    {
                        <div class="lightbox-caption">
                            @if (!string.IsNullOrEmpty(_selectedImage.Title))
                            {
                                <h3>@_selectedImage.Title</h3>
                            }
                            @if (!string.IsNullOrEmpty(_selectedImage.Description))
                            {
                                <p>@_selectedImage.Description</p>
                            }
                        </div>
                    }
                    @if (_galleryImages.Count > 1)
                    {
                        <button class="lightbox-nav lightbox-prev" @onclick="PrevImage" @onclick:stopPropagation="true">â€¹</button>
                        <button class="lightbox-nav lightbox-next" @onclick="NextImage" @onclick:stopPropagation="true">â€º</button>
                    }
                </div>
            </div>
        }

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           VIDEO LIGHTBOX MODAL (Gallery Video)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (_videoLightboxOpen && _selectedVideo != null)
        {
            <div class="lightbox-overlay" @onclick="CloseVideoLightbox">
                <button class="lightbox-close" @onclick="CloseVideoLightbox">Ã—</button>
                <div class="lightbox-content lightbox-content--video" @onclick:stopPropagation="true">
                    @if (_videoPlayError)
                    {
                        <div class="lightbox-video-error">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10" />
                                <line x1="15" y1="9" x2="9" y2="15" />
                                <line x1="9" y1="9" x2="15" y2="15" />
                            </svg>
                            <p>No se pudo reproducir el video. Intenta de nuevo.</p>
                        </div>
                    }
                    else
                    {
                        <video @key="_selectedVideo.Url"
                               id="lightbox-video-player"
                               src="@_selectedVideo.Url"
                               poster="@(_selectedVideo.ThumbnailUrl ?? "")"
                               controls
                               autoplay
                               playsinline
                               preload="auto"
                               class="lightbox-video">
                        </video>
                    }
                    @if (!string.IsNullOrEmpty(_selectedVideo.Title))
                    {
                        <div class="lightbox-caption">
                            <h3>@_selectedVideo.Title</h3>
                        </div>
                    }
                    @{
                        var videoList = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
                    }
                    @if (videoList.Count > 1)
                    {
                        <button class="lightbox-nav lightbox-prev"
                                @onclick="PrevVideo" @onclick:stopPropagation="true"
                                disabled="@(_selectedVideoIndex <= 0)">â€¹</button>
                        <button class="lightbox-nav lightbox-next"
                                @onclick="NextVideo" @onclick:stopPropagation="true"
                                disabled="@(_selectedVideoIndex >= videoList.Count - 1)">â€º</button>
                    }
                </div>
            </div>
        }

        @* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           INLINE QUOTE REQUEST MODAL â€” Enterprise UX
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
        @if (_quoteModalOpen)
        {
            <div class="quote-modal-overlay" @onclick="CloseQuoteModal">
                <div class="quote-modal-content" @onclick:stopPropagation="true">
                    @* Header *@
                    <div class="quote-modal-header">
                        <div class="quote-modal-header-left">
                            <MudIcon Icon="@Icons.Material.Filled.RequestQuote" Size="Size.Small" Style="color: var(--mud-palette-primary); opacity: 0.85;" />
                            <div>
                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600; line-height: 1.3;">Solicitar cotizaciÃ³n</MudText>
                                <MudText Typo="Typo.caption" Class="qm-text-muted" Style="line-height: 1.3;">Describe tu necesidad y te responderÃ© con una propuesta.</MudText>
                            </div>
                        </div>
                        <button class="quote-modal-close" @onclick="CloseQuoteModal">&times;</button>
                    </div>

                    @* Body *@
                    <div class="quote-modal-body">
                        @if (_quoteSubmitting)
                        {
                            <div class="quote-modal-state">
                                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                                <MudText Typo="Typo.body1" Class="mt-3 qm-text-secondary">Enviando tu solicitud...</MudText>
                            </div>
                        }
                        else if (_quoteSuccess)
                        {
                            <div class="quote-modal-state quote-success-state">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Style="font-size: 3rem;" />
                                <MudText Typo="Typo.h6" Class="mt-4" Style="font-weight: 600;">@_quoteSettings.SuccessMessage</MudText>
                                @if (!string.IsNullOrEmpty(_quoteRequestNumber))
                                {
                                    <span class="quote-ref-pill">@_quoteRequestNumber</span>
                                }
                                <div class="quote-success-actions">
                                    @if (!string.IsNullOrEmpty(_card?.WhatsAppNumber) && _qPreferredContact == "WhatsApp")
                                    {
                                        <MudButton Variant="Variant.Filled" Color="Color.Success"
                                                   StartIcon="@Icons.Custom.Brands.WhatsApp"
                                                   Href="@($"https://wa.me/{GetFullWhatsAppForLink()}?text=Hola, acabo de enviar una solicitud de cotizaciÃ³n ({_quoteRequestNumber}).")"
                                                   Target="_blank"
                                                   Style="text-transform: none; font-weight: 500;">
                                            Abrir WhatsApp
                                        </MudButton>
                                        <MudButton Variant="Variant.Text" OnClick="CloseQuoteModal" Class="qm-btn-ghost"
                                                   Style="text-transform: none;">
                                            Cerrar
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CloseQuoteModal"
                                                   Style="text-transform: none; font-weight: 500;">
                                            Cerrar
                                        </MudButton>
                                    }
                                </div>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(_quoteError))
                        {
                            <div class="quote-modal-state">
                                <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error" Style="font-size: 2.5rem;" />
                                <MudText Typo="Typo.body1" Class="mt-3">@_quoteError</MudText>
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="ClearQuoteError"
                                           Style="text-transform: none;">
                                    Intentar de nuevo
                                </MudButton>
                            </div>
                        }
                        else
                        {
                            @* â”€â”€ Section 1: Contacto â”€â”€ *@
                            <div class="quote-subcard">
                                <span class="quote-section-label">Contacto</span>

                                <MudTextField @bind-Value="_qFullName"
                                              Label="Nombre"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              OnFocus="TrackQuoteFormStart"
                                              Class="mb-3" />

                                <MudTextField @bind-Value="_qEmail"
                                              Label="Email"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              InputType="InputType.Email"
                                              Class="mb-3" />

                                <div class="mb-2">
                                    <CountryPhoneInput @bind-Value="_qPhone"
                                                       @bind-CountryCode="_qPhoneCountryCode"
                                                       @bind-E164Value="_qPhoneE164"
                                                       Required="false"
                                                       @bind-IsValid="_qPhoneValid" />
                                </div>

                                <MudText Typo="Typo.caption" Class="qm-text-muted" Style="margin-top: 4px;">
                                    Necesitamos un email o telÃ©fono para contactarte.
                                </MudText>
                            </div>

                            @* â”€â”€ Section 2: Tu solicitud â”€â”€ *@
                            <div class="quote-subcard">
                                <span class="quote-section-label">Tu solicitud</span>

                                <MudTextField @bind-Value="_qDetails"
                                              Label="Detalles"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Lines="4"
                                              Placeholder="Incluye alcance, cantidad, ubicaciÃ³n y cualquier requisito clave." />
                            </div>

                            @if (_quoteSettings.ShowBudgetField || _quoteSettings.ShowDeadlineField || _quoteSettings.ShowPreferredContactField)
                            {
                                @* â”€â”€ Section 3: Contexto (opcional) â”€â”€ *@
                                <div class="quote-subcard">
                                    <span class="quote-section-label">Contexto <span style="font-weight: 400; opacity: 0.5;">(opcional)</span></span>

                                    @if (_quoteSettings.ShowBudgetField)
                                    {
                                        <MudSelect T="string" @bind-Value="_qBudget"
                                                   Label="Presupuesto (opcional)"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   Class="mb-3">
                                            <MudSelectItem T="string" Value="@("")">Sin especificar</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("A convenir")">A convenir</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("$1â€“$500")">$1â€“$500</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("$500â€“$2,000")">$500â€“$2,000</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("$2,000â€“$5,000")">$2,000â€“$5,000</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("$5,000â€“$10,000")">$5,000â€“$10,000</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("$10,000+")">$10,000+</MudSelectItem>
                                        </MudSelect>
                                    }

                                    @if (_quoteSettings.ShowDeadlineField)
                                    {
                                        <MudSelect T="string" @bind-Value="_qDeadline"
                                                   Label="Plazo (opcional)"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   Class="mb-3">
                                            <MudSelectItem T="string" Value="@("")">Sin especificar</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("Lo antes posible")">Lo antes posible</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("Esta semana")">Esta semana</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("2 semanas")">2 semanas</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("1 mes")">1 mes</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("Sin prisa")">Sin prisa</MudSelectItem>
                                        </MudSelect>
                                    }

                                    @if (_quoteSettings.ShowPreferredContactField)
                                    {
                                        <MudSelect T="string" @bind-Value="_qPreferredContact"
                                                   Label="Canal (opcional)"
                                                   Variant="Variant.Outlined"
                                                   Margin="Margin.Dense"
                                                   Class="mb-3">
                                            <MudSelectItem T="string" Value="@("")">Sin preferencia</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("WhatsApp")">WhatsApp</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("Llamada")">Llamada</MudSelectItem>
                                            <MudSelectItem T="string" Value="@("Email")">Email</MudSelectItem>
                                        </MudSelect>
                                    }
                                </div>
                            }

                            @if (_quoteSettings.ShowLegalText && !string.IsNullOrEmpty(_quoteSettings.LegalText))
                            {
                                <MudText Typo="Typo.caption" Class="qm-text-muted" Style="font-style: italic; margin-top: 2px; padding: 0 4px;">
                                    @_quoteSettings.LegalText
                                </MudText>
                            }

                            <div class="quote-modal-actions">
                                <MudButton OnClick="CloseQuoteModal" Variant="Variant.Text" Class="qm-btn-ghost"
                                           Style="text-transform: none; font-weight: 400;">
                                    Cerrar
                                </MudButton>
                                <MudButton OnClick="SubmitQuoteRequest" Variant="Variant.Filled" Color="Color.Primary"
                                           Disabled="@(!QuoteCanSubmit)"
                                           StartIcon="@Icons.Material.Filled.Send"
                                           Style="text-transform: none; font-weight: 500; letter-spacing: 0.01em;">
                                    Enviar solicitud
                                </MudButton>
                            </div>
                            @if (!QuoteCanSubmit)
                            {
                                <MudText Typo="Typo.caption" Class="qm-text-muted" Style="text-align: right; margin-top: 6px;">
                                    Completa nombre, solicitud y un medio de contacto.
                                </MudText>
                            }
                        }
                    </div>
                </div>
            </div>
        }

        @* Footer mÃ­nimo *@
        <div class="footer-minimal">
            <MudText Typo="Typo.caption">Powered by <strong>DataTouch</strong></MudText>
        </div>
    </div>
}

<style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ESTILOS GLOBALES - GRADIENT CONTINUO SIN CORTES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* FORCE THEME-AWARE TEXT IN ALL MUDBLAZOR INPUTS */
    .landing-wrapper .mud-input-slot,
    .landing-wrapper .mud-input > input,
    .landing-wrapper .mud-input-text > input,
    .landing-wrapper .mud-input textarea,
    .landing-wrapper input.mud-input-slot,
    .landing-wrapper textarea.mud-input-slot,
    .landing-wrapper .mud-input-control input,
    .landing-wrapper .mud-input-control textarea,
    .lead-form-card .mud-input-slot,
    .lead-form-card .mud-input > input,
    .lead-form-card .mud-input textarea,
    .lead-form-card input,
    .lead-form-card textarea,
    .landing-wrapper .mud-input-root input,
    .landing-wrapper .mud-input-root textarea,
    .landing-wrapper .mud-input-root .mud-input-slot,
    .landing-wrapper .mud-input-root-outlined input,
    .landing-wrapper .mud-input-root-outlined textarea,
    .premium-form .mud-input-root input,
    .premium-form .mud-input-root textarea,
    .premium-form .mud-input-slot,
    .compact-input .mud-input-root input,
    .compact-input .mud-input-root textarea {
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        caret-color: var(--dt-accent-primary, #A78BFA) !important;
        opacity: 1 !important;
    }
    
    /* OVERRIDE MUDBLAZOR CSS VARIABLES - contrast aware */
    .landing-wrapper,
    .lead-form-card,
    .premium-form {
        --mud-palette-text-primary: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        --mud-palette-text-secondary: var(--surface-text-secondary, var(--dt-text-secondary, #FFFFFF)) !important;
        --mud-palette-action-default: var(--surface-icon, var(--dt-text-secondary, #FFFFFF)) !important;
    }
    
    /* ULTRA-SPECIFIC MUDBLAZOR INPUT TEXT COLOR OVERRIDE */
    .landing-wrapper .mud-input,
    .landing-wrapper .mud-input-text,
    .landing-wrapper .mud-input-root,
    .landing-wrapper .mud-input-root-text,
    .landing-wrapper .mud-input-root-outlined,
    .landing-wrapper .mud-input-underline,
    .lead-form-card .mud-input,
    .lead-form-card .mud-input-text,
    .lead-form-card .mud-input-root,
    .lead-form-card .mud-input-root-text,
    .lead-form-card .mud-input-root-outlined,
    .premium-form .mud-input,
    .premium-form .mud-input-text,
    .premium-form .mud-input-root {
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        --mud-palette-text-primary: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
    }
    
    /* Target the actual input and textarea elements INSIDE MudBlazor components */
    .landing-wrapper .mud-input-control input.mud-input-slot,
    .landing-wrapper .mud-input-control textarea.mud-input-slot,
    .landing-wrapper .mud-input-root input.mud-input-slot,
    .landing-wrapper .mud-input-root textarea.mud-input-slot,
    .landing-wrapper .mud-input-control .mud-input > input,
    .landing-wrapper .mud-input-control .mud-input > textarea,
    .lead-form-card .mud-input-control input.mud-input-slot,
    .lead-form-card .mud-input-control textarea.mud-input-slot,
    .lead-form-card .mud-input-root input.mud-input-slot,
    .lead-form-card .mud-input-root textarea.mud-input-slot,
    .premium-form .mud-input-control input.mud-input-slot,
    .premium-form .mud-input-control textarea.mud-input-slot,
    .compact-input input.mud-input-slot,
    .compact-input textarea.mud-input-slot {
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        caret-color: var(--dt-accent-primary, #A78BFA) !important;
        opacity: 1 !important;
    }
    
    /* Specific override for MudTextField and MudSelect */
    .landing-wrapper .mud-input-slot.mud-input-root-text,
    .landing-wrapper input.mud-input-slot.mud-input-root-text,
    .landing-wrapper textarea.mud-input-slot.mud-input-root-text,
    .lead-form-card input.mud-input-slot,
    .lead-form-card textarea.mud-input-slot,
    .premium-form input.mud-input-slot,
    .premium-form textarea.mud-input-slot {
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
    }
    
    /* Fix for autofill styles that override text color */
    .landing-wrapper input:-webkit-autofill,
    .landing-wrapper input:-webkit-autofill:hover,
    .landing-wrapper input:-webkit-autofill:focus,
    .landing-wrapper input:-webkit-autofill:active,
    .lead-form-card input:-webkit-autofill,
    .lead-form-card input:-webkit-autofill:hover,
    .lead-form-card input:-webkit-autofill:focus,
    .lead-form-card input:-webkit-autofill:active,
    .premium-form input:-webkit-autofill,
    .premium-form input:-webkit-autofill:hover,
    .premium-form input:-webkit-autofill:focus,
    .premium-form input:-webkit-autofill:active {
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-box-shadow: 0 0 0 1000px var(--surface-input-bg, var(--dt-modal-surface, rgba(25, 18, 45, 0.95))) inset !important;
        box-shadow: 0 0 0 1000px var(--surface-input-bg, var(--dt-modal-surface, rgba(25, 18, 45, 0.95))) inset !important;
        transition: background-color 5000s ease-in-out 0s !important;
        caret-color: var(--dt-accent-primary, #A78BFA) !important;
    }
    
    /* Force country selector text to white */
    .landing-wrapper .mud-select .mud-input-slot,
    .landing-wrapper .mud-select-input,
    .lead-form-card .mud-select .mud-input-slot,
    .lead-form-card .mud-select-input,
    .country-selector-wrapper .mud-select-input,
    .country-selector-wrapper .mud-input-slot {
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CRITICAL FIX: MudBlazor fieldset overlay covering input text
       The .mud-input-outlined-border fieldset has a dark background that dims the text.
       We need to either make it transparent OR raise the input z-index above it.
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Solution 1: Make fieldset background transparent so it doesn't dim the text */
    .landing-wrapper .mud-input-outlined-border,
    .lead-form-card .mud-input-outlined-border,
    .premium-form .mud-input-outlined-border,
    .compact-input .mud-input-outlined-border {
        background: transparent !important;
        background-color: transparent !important;
    }
    
    /* Solution 2: Raise input z-index above fieldset */
    .landing-wrapper .mud-input-slot,
    .landing-wrapper .mud-input-root,
    .landing-wrapper input.mud-input-slot,
    .landing-wrapper textarea.mud-input-slot,
    .lead-form-card .mud-input-slot,
    .lead-form-card .mud-input-root,
    .lead-form-card input.mud-input-slot,
    .lead-form-card textarea.mud-input-slot,
    .premium-form .mud-input-slot,
    .premium-form input.mud-input-slot,
    .premium-form textarea.mud-input-slot,
    .compact-input .mud-input-slot,
    .compact-input input.mud-input-slot,
    .compact-input textarea.mud-input-slot {
        position: relative !important;
        z-index: 10 !important;
        color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
        -webkit-text-fill-color: var(--surface-input-text, var(--dt-text-primary, #FFFFFF)) !important;
    }
    
    /* Ensure the fieldset stays behind the input */
    .landing-wrapper .mud-input-outlined fieldset,
    .lead-form-card .mud-input-outlined fieldset,
    .premium-form .mud-input-outlined fieldset,
    .compact-input .mud-input-outlined fieldset {
        z-index: 1 !important;
    }
    
    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
    }

    .loading-container, .error-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(180deg, #0d0a1a 0%, #1a1035 40%, #2d1b4e 70%, #1a1035 100%);
    }

    .text-white { color: #fff !important; }
    .text-white-70 { color: rgba(255,255,255,0.7) !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WRAPPER PRINCIPAL - FONDO GRADIENT OSCURO PREMIUM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .landing-wrapper {
        min-height: 100vh;
        background: linear-gradient(180deg, #0d0a1a 0%, #1a1035 30%, #2d1b4e 60%, #1a1035 100%);
        padding: 32px 16px 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        position: relative;
        overflow: hidden;
    }

    /* Aurora glow effect at bottom (dark themes only) */
    .landing-wrapper.contrast-dark::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: radial-gradient(ellipse at center bottom, rgba(168, 85, 247, 0.15) 0%, transparent 60%),
                    radial-gradient(ellipse at 30% 90%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
        pointer-events: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLOQUE 1: PROFILE CARD (HERO) - GLASSMORPHISM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .profile-card {
        width: 100%;
        max-width: 420px;
        background: var(--dt-surface-card);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 28px;
        border: 1px solid var(--dt-surface-card-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                    inset 0 0 80px var(--dt-accent-soft);
        position: relative;
        z-index: 1;
        overflow: visible;
    }

    .card-header-gradient {
        display: none; /* Remove the old header - mockup has no header gradient */
    }

    .card-content {
        padding: 40px 28px 28px;
        text-align: center;
    }

    /* Avatar with Glow Ring - HERO SIZE - RESPONSIVE MOBILE/TABLET */
    .avatar-container {
        margin-top: 0;
        margin-bottom: 24px;
        position: relative;
        display: flex;
        justify-content: center;
        overflow: visible;
    }

    .profile-avatar {
        width: 200px !important;
        height: 200px !important;
        font-size: 4.5rem !important;
        background: var(--dt-accent-gradient) !important;
        border: 6px solid rgba(255, 255, 255, 0.25) !important;
        box-shadow: 0 0 0 8px var(--dt-accent-soft),
                    0 0 80px var(--dt-accent-soft),
                    0 16px 40px rgba(0, 0, 0, 0.35) !important;
        color: white !important;
        overflow: hidden !important;
    }

    .profile-avatar .mud-avatar-img,
    .profile-avatar img,
    .profile-avatar .mud-image {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        object-position: center center !important;
        border-radius: 50% !important;
    }
    
    /* Avatar initials fill - uses theme tokens instead of MudBlazor Color.Primary */
    /* Double class for specificity over .profile-avatar gradient */
    .profile-avatar.profile-avatar-initials {
        background: var(--dt-accent-primary) !important;
        color: var(--dt-text-on-accent, #FFFFFF) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 50% !important;
        font-size: 2.5rem;
        font-weight: 700;
    }

    /* Info - White text for dark theme */
    .profile-name {
        font-weight: 700 !important;
        font-size: 2rem !important;
        color: var(--dt-text-primary, #FFFFFF) !important;
        margin-bottom: 8px !important;
        letter-spacing: -0.02em;
    }

    .profile-title {
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.7)) !important;
        font-size: 1.125rem !important;
        font-weight: 400 !important;
        margin-bottom: 10px !important;
    }

    .profile-location {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.6));
        font-size: 0.875rem;
        margin: 0 0 16px;
    }

    .profile-location .mud-icon-root {
        font-size: 1rem !important;
        opacity: 0.7;
    }

    .profile-bio {
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.85)) !important;
        font-size: 0.9375rem !important;
        line-height: 1.6 !important;
        max-width: 340px;
        margin: 0 auto 20px;
        text-align: center;
    }

    /* Redes sociales - fila compacta */
    .social-row {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 20px;
    }

    .social-icon {
        background: var(--dt-surface-chip, rgba(255, 255, 255, 0.1)) !important;
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.8)) !important;
        transition: all 0.2s ease !important;
        border-radius: 12px !important;
    }

    .social-icon:hover {
        background: var(--dt-accent-soft) !important;
        color: var(--dt-text-primary) !important;
        transform: scale(1.05);
    }

    /* Status Chips */
    .status-chips {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: clamp(4px, 1.5vw, 8px);
        flex-wrap: nowrap;
        margin-bottom: 20px;
        width: 100%;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: clamp(3px, 1vw, 6px);
        padding: clamp(4px, 1.5vw, 6px) clamp(6px, 2vw, 12px);
        background: var(--dt-surface-chip, rgba(255, 255, 255, 0.08));
        border-radius: 20px;
        font-size: clamp(0.65rem, 2vw, 0.75rem);
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.75));
        border: 1px solid var(--dt-surface-chip-border, rgba(255, 255, 255, 0.1));
        white-space: nowrap;
        flex-shrink: 1;
        flex-grow: 0;
    }

    .status-chip .mud-icon-root {
        font-size: clamp(0.75rem, 2.5vw, 0.875rem) !important;
        opacity: 0.7;
        flex-shrink: 0;
    }

    .chip-dot {
        width: clamp(6px, 2vw, 8px);
        height: clamp(6px, 2vw, 8px);
        border-radius: 50%;
        background: #22C55E;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        flex-shrink: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLOQUE 2: CTAs - INTEGRADOS EN LA CARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cta-section {
        border-top: none;
        padding-top: 8px;
        margin-top: 0;
    }

    .btn-primary-cta {
        background: var(--dt-button-primary-bg) !important;
        color: var(--dt-button-primary-text) !important;
        font-weight: 600 !important;
        text-transform: none !important;
        border-radius: 28px !important;
        padding: 10px 17px !important;
        font-size: 1rem !important;
        margin-bottom: 15px !important;
        box-shadow: 0 4px 20px var(--dt-accent-soft) !important;
        letter-spacing: 0.01em;
    }
    
    .btn-primary-cta.mud-width-full {
        width: 73%;
    }

    .btn-primary-cta:hover {
        background: var(--dt-button-primary-hover) !important;
        box-shadow: 0 6px 28px var(--dt-accent-soft) !important;
        transform: translateY(-2px);
    }

    .cta-row {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: nowrap;
    }

    .cta-row .mud-button-root {
        flex: 1;
        min-width: 95px;
        max-width: 120px;
        border-radius: 25px !important;
        text-transform: none !important;
        font-weight: 500 !important;
        padding: 6px 19px !important;
        font-size: 0.875rem !important;
    }

    /* WhatsApp - Outlined Green */
    .btn-whatsapp {
        background: transparent !important;
        border: 2px solid #25D366 !important;
        color: #25D366 !important;
        transition: all 0.2s ease !important;
    }

    .btn-whatsapp:hover {
        background: rgba(37, 211, 102, 0.15) !important;
        border-color: #2EE575 !important;
    }

    .btn-whatsapp .mud-icon-root {
        color: #25D366 !important;
    }

    /* Llamar - Neutral Theme (uses theme tokens) */
    .btn-call {
        background: transparent !important;
        border: 2px solid var(--dt-button-secondary-border) !important;
        color: var(--dt-text-secondary) !important;
        transition: all 0.2s ease !important;
    }

    .btn-call:hover {
        background: var(--dt-state-hover-overlay) !important;
        border-color: var(--dt-accent-primary) !important;
        color: var(--dt-accent-primary) !important;
    }

    .btn-call .mud-icon-root {
        color: var(--dt-text-secondary) !important;
    }
    
    .btn-call:hover .mud-icon-root {
        color: var(--dt-accent-primary) !important;
    }

    /* Email - Outlined Orange */
    .btn-email {
        background: transparent !important;
        border: 2px solid #F59E0B !important;
        color: #FBBF24 !important;
        transition: all 0.2s ease !important;
    }

    .btn-email:hover {
        background: rgba(245, 158, 11, 0.15) !important;
        border-color: #FBBF24 !important;
    }

    .btn-email .mud-icon-root {
        color: #FBBF24 !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INLINE QUOTE REQUEST MODAL â€” Enterprise (Theme-aware)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .quote-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--dt-modal-overlay, rgba(0, 0, 0, 0.7));
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 16px;
        backdrop-filter: blur(4px);
        animation: qm-fade-in 0.2s ease;
    }

    @@keyframes qm-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .quote-modal-content {
        background: var(--dt-modal-surface, #1e1b2e);
        border: 1px solid var(--dt-modal-border, rgba(255, 255, 255, 0.08));
        border-radius: 16px;
        width: 100%;
        max-width: 480px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
        animation: qm-slide-up 0.25s ease;
        backdrop-filter: blur(20px);
        color: var(--dt-text-primary, #FFFFFF);
    }

    @@keyframes qm-slide-up {
        from { transform: translateY(24px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .quote-modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 20px 24px 14px;
        border-bottom: 1px solid var(--dt-modal-divider, rgba(255, 255, 255, 0.06));
    }

    .quote-modal-header-left {
        display: flex;
        align-items: flex-start;
        gap: 0.65rem;
        padding-top: 2px;
    }

    .quote-modal-close {
        background: var(--dt-modal-close-bg, rgba(255, 255, 255, 0.05));
        border: none;
        color: var(--dt-modal-close-color, rgba(255, 255, 255, 0.4));
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .quote-modal-close:hover {
        background: var(--dt-modal-close-hover-bg, rgba(255, 255, 255, 0.12));
        color: var(--dt-modal-close-hover-color, rgba(255, 255, 255, 0.8));
    }

    .quote-modal-body {
        padding: 16px 24px 24px;
    }

    .quote-modal-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        text-align: center;
        min-height: 200px;
    }

    .quote-success-state {
        padding: 2.5rem 1.5rem;
    }

    .quote-ref-pill {
        display: inline-block;
        margin-top: 10px;
        padding: 4px 14px;
        background: var(--dt-modal-surface2, rgba(255, 255, 255, 0.06));
        border: 1px solid var(--dt-modal-border, rgba(255, 255, 255, 0.08));
        border-radius: 20px;
        font-size: 0.8rem;
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.55));
        font-weight: 500;
        letter-spacing: 0.02em;
    }

    .quote-success-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* â”€â”€ Subcard sections â”€â”€ */
    .quote-subcard {
        background: var(--dt-modal-surface2, rgba(255, 255, 255, 0.035));
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 10px;
    }

    .quote-section-label {
        display: block;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.35));
        margin-bottom: 14px;
    }

    .quote-modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 18px;
        padding-top: 14px;
        border-top: 1px solid var(--dt-modal-divider, rgba(255, 255, 255, 0.05));
    }

    /* Fix select label clipping inside subcards */
    .quote-subcard .mud-input-label {
        padding: 0 4px;
        background: var(--dt-modal-input-label-bg, rgba(30, 27, 46, 0.95));
    }

    /* Cap dropdown popover height */
    .quote-modal-body .mud-popover {
        max-height: 240px !important;
        overflow-y: auto !important;
    }

    /* â”€â”€ Theme-aware text utility classes for modal â”€â”€ */
    .qm-text-primary { color: var(--dt-text-primary) !important; }
    .qm-text-secondary { color: var(--dt-text-secondary) !important; }
    .qm-text-muted { color: var(--dt-text-muted) !important; }
    .qm-btn-ghost { color: var(--dt-text-muted) !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIGHTBOX MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    }
    
    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        color: white;
        font-size: 1.75rem;
        cursor: pointer;
        transition: background 0.2s;
        z-index: 10000;
    }
    
    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 80vh;
    }
    
    .lightbox-content img {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 16px;
        object-fit: contain;
    }

    .lightbox-content--video {
        width: 90vw;
        max-width: 800px;
    }

    .lightbox-video {
        width: 100%;
        max-height: 70vh;
        border-radius: 16px;
        background: #000;
        display: block;
    }

    .lightbox-video-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 48px 24px;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
        min-height: 200px;
    }

    .lightbox-video-error p {
        margin: 0;
        font-size: 0.95rem;
    }

    .lightbox-nav:disabled {
        opacity: 0.25;
        cursor: default;
        pointer-events: none;
    }
    
    .lightbox-caption {
        text-align: center;
        padding: 16px;
        color: white;
    }
    
    .lightbox-caption h3 {
        margin: 0 0 8px;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .lightbox-caption p {
        margin: 0;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 52px;
        height: 52px;
        border: none;
        background: rgba(139, 92, 246, 0.3);
        border-radius: 50%;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .lightbox-nav:hover {
        background: rgba(139, 92, 246, 0.5);
    }
    
    .lightbox-prev { left: 20px; }
    .lightbox-next { right: 20px; }
    
    @@media (max-width: 600px) {
        .lightbox-prev { left: 10px; }
        .lightbox-next { right: 10px; }
        .lightbox-nav { width: 44px; height: 44px; font-size: 1.5rem; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLOQUE 3: FORMULARIO DE LEAD - DARK THEME INTEGRATED
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .lead-form-card {
        width: 100%;
        max-width: 420px;
        background: transparent;
        padding: 24px 0 0;
        position: relative;
        margin-top: 19px;
    }
    
    .lead-form-card.success-state {
        background: #15873f;
        border-radius: 20px;
        padding: 24px;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    /* Form Header */
    .form-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        padding-bottom: 0;
        border-bottom: none;
        color: var(--dt-text-primary, rgba(255, 255, 255, 0.9));
    }
    
    .form-header-icon {
        display: none;
    }
    
    .form-header .mud-icon-root {
        font-size: 1rem !important;
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.7)) !important;
    }

    .form-title {
        color: var(--dt-text-primary, rgba(255, 255, 255, 0.95)) !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
        margin: 0 !important;
        line-height: 1.2 !important;
    }
    
    .form-subtitle {
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.5)) !important;
        font-size: 0.8rem !important;
        margin-bottom: 16px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COMPACT PREMIUM FORM FIELDS - Dense but elegant
       Target: 42px inputs, 12px gaps, consistent density
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .premium-form {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    
    .compact-field {
        margin-bottom: 14px;
    }
    
    .compact-label {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.7));
        line-height: 1.2;
    }
    
    .compact-label .label-icon {
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.5));
        font-size: 0.9rem !important;
        width: 16px !important;
        height: 16px !important;
    }
    
    .compact-label .required {
        color: #F87171;
        margin-left: 1px;
    }
    
    .compact-label .optional {
        color: var(--surface-text-muted, rgba(255, 255, 255, 0.4));
        font-weight: 400;
        font-size: 0.75rem;
    }
    
    /* Dark Theme Input Styling - Premium Form Fields */
    .compact-input .mud-input-outlined-border {
        border-radius: 12px !important;
        border: 1.5px solid var(--dt-surface-input-border) !important;
        background: var(--dt-surface-input) !important;
        transition: all 0.2s ease !important;
    }
    
    .compact-input:hover .mud-input-outlined-border {
        border-color: var(--dt-accent-soft) !important;
        background: var(--dt-surface-input) !important;
    }
    
    .compact-input:focus-within .mud-input-outlined-border {
        border-color: var(--dt-surface-input-focus) !important;
        box-shadow: 0 0 0 3px var(--dt-focus-ring) !important;
        background: var(--dt-surface-input) !important;
    }
    
    .compact-input .mud-input-root {
        height: 46px !important;
        min-height: 46px !important;
    }
    
    .compact-input .mud-input-slot {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        font-size: 0.9375rem !important;
        font-weight: 500 !important;
        letter-spacing: 0.2px !important;
        color: var(--surface-input-text, #FFFFFF) !important;
    }
    
    .compact-input .mud-input-root-outlined .mud-input-slot {
        padding: 10px 14px !important;
    }
    
    .compact-input .mud-input-adornment-end {
        color: #22C55E !important;
        margin-right: 6px !important;
    }
    
    .compact-input .mud-input-adornment-end .mud-icon-root {
        font-size: 1.1rem !important;
    }

    /* Force pure white text in ALL form inputs */
    .premium-form input,
    .premium-form textarea,
    .premium-form .mud-input-slot,
    .premium-form .mud-input input,
    .premium-form .mud-input textarea,
    .compact-input input,
    .compact-input textarea,
    .compact-input .mud-input-slot,
    .compact-input .mud-input-slot input,
    .compact-input .mud-input-slot textarea,
    .lead-form-card input,
    .lead-form-card textarea,
    .lead-form-card .mud-input-slot {
        color: var(--dt-text-primary) !important;
        -webkit-text-fill-color: var(--dt-text-primary) !important;
        caret-color: var(--dt-accent-primary) !important;
        opacity: 1 !important;
    }

    .premium-form input::placeholder,
    .premium-form textarea::placeholder,
    .compact-input input::placeholder,
    .compact-input textarea::placeholder,
    .lead-form-card input::placeholder,
    .lead-form-card textarea::placeholder {
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.4)) !important;
        -webkit-text-fill-color: var(--dt-text-muted, rgba(255, 255, 255, 0.4)) !important;
        font-weight: 400 !important;
        opacity: 1 !important;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTOFILL OVERRIDES - Maintain theme colors when browser autofill is active
       Chrome/Safari use :-webkit-autofill, Firefox uses :autofill
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Chrome/Safari Autofill - use box-shadow to override UA background */
    .native-text-input:-webkit-autofill,
    .native-text-input:-webkit-autofill:hover,
    .native-text-input:-webkit-autofill:focus,
    .native-textarea-input:-webkit-autofill,
    .native-textarea-input:-webkit-autofill:hover,
    .native-textarea-input:-webkit-autofill:focus,
    .premium-form input:-webkit-autofill,
    .premium-form input:-webkit-autofill:hover,
    .premium-form input:-webkit-autofill:focus,
    .lead-form-card input:-webkit-autofill,
    .lead-form-card input:-webkit-autofill:hover,
    .lead-form-card input:-webkit-autofill:focus {
        /* Override browser autofill background with theme surface */
        -webkit-box-shadow: 0 0 0 1000px var(--dt-surface-input) inset !important;
        box-shadow: 0 0 0 1000px var(--dt-surface-input) inset !important;
        -webkit-text-fill-color: var(--dt-text-primary) !important;
        color: var(--dt-text-primary) !important;
        caret-color: var(--dt-accent-primary) !important;
        border-color: var(--dt-surface-input-border) !important;
        transition: background-color 5000s ease-in-out 0s !important;
    }
    
    /* Firefox Autofill */
    .native-text-input:autofill,
    .native-text-input:autofill:hover,
    .native-text-input:autofill:focus,
    .native-textarea-input:autofill,
    .native-textarea-input:autofill:hover,
    .native-textarea-input:autofill:focus,
    .premium-form input:autofill,
    .premium-form input:autofill:hover,
    .premium-form input:autofill:focus,
    .lead-form-card input:autofill,
    .lead-form-card input:autofill:hover,
    .lead-form-card input:autofill:focus {
        background-color: var(--dt-surface-input) !important;
        color: var(--dt-text-primary) !important;
        -webkit-text-fill-color: var(--dt-text-primary) !important;
        caret-color: var(--dt-accent-primary) !important;
        border-color: var(--dt-surface-input-border) !important;
    }
    
    /* Compact Textarea - 2 lines, ~60px */
    .compact-input.compact-textarea .mud-input-root {
        height: auto !important;
        min-height: 56px !important;
    }
    
    .compact-input.compact-textarea .mud-input-slot {
        padding: 10px 12px !important;
    }
    
    /* Override MudBlazor default margins in dense mode */
    .compact-input.mud-input-control {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }
    
    .compact-input .mud-input-helper-text {
        font-size: 0.7rem !important;
        margin-top: 2px !important;
        min-height: 16px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NATIVE TEXT INPUTS - Same style as phone-number-input
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .native-input-wrapper {
        position: relative;
        width: 100%;
    }
    
    .native-text-input,
    .native-textarea-input {
        width: 100%;
        height: 46px;
        padding: 0 38px 0 14px;
        font-size: 0.9375rem;
        font-weight: 500;
        letter-spacing: 0.3px;
        font-family: Inter, "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--dt-text-primary);
        -webkit-text-fill-color: var(--dt-text-primary);
        background: var(--dt-surface-input);
        border: 1.5px solid var(--dt-surface-input-border);
        border-radius: 12px;
        outline: none;
        transition: all 0.2s ease;
        caret-color: var(--dt-accent-primary);
        box-sizing: border-box;
    }
    
    .native-textarea-input {
        height: auto;
        min-height: 70px;
        padding: 12px 14px;
        resize: vertical;
        line-height: 1.4;
    }
    
    .native-text-input::placeholder,
    .native-textarea-input::placeholder {
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.4));
        -webkit-text-fill-color: var(--dt-text-muted, rgba(255, 255, 255, 0.4));
        font-weight: 400;
        letter-spacing: 0;
    }
    
    .native-text-input:hover,
    .native-textarea-input:hover {
        border-color: var(--dt-accent-soft);
        background: var(--dt-surface-input);
    }
    
    .native-text-input:focus,
    .native-textarea-input:focus {
        border-color: var(--dt-surface-input-focus);
        background: var(--dt-surface-input);
        box-shadow: 0 0 0 3px var(--dt-focus-ring);
    }
    
    /* Valid State */
    .native-text-input.is-valid {
        border-color: rgba(34, 197, 94, 0.5);
    }
    
    .native-text-input.is-valid:focus {
        border-color: #22C55E;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }
    
    /* Error State */
    .native-text-input.has-error {
        border-color: rgba(248, 113, 113, 0.6);
    }
    
    .native-text-input.has-error:focus {
        border-color: #F87171;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
    }
    
    /* Input Adornment (checkmark icon) */
    .input-adornment {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        pointer-events: none;
    }
    
    .input-adornment .mud-icon-root {
        font-size: 1.1rem !important;
    }
    
    .input-adornment.valid {
        color: #22C55E;
    }
    
    .input-adornment.error {
        color: #F87171;
    }
    
    /* Field Error Message */
    .field-error {
        display: block;
        font-size: 0.75rem;
        color: #F87171;
        font-weight: 500;
        margin-top: 4px;
        padding-left: 2px;
    }
    
    /* Submit Button - Uses accent color */
    .premium-submit-btn {
        width: 100%;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: var(--dt-button-primary-bg);
        color: var(--dt-button-primary-text);
        font-size: 0.9375rem;
        font-weight: 600;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 4px 16px var(--dt-accent-soft);
        margin-top: 8px;
    }
    
    .premium-submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        background: var(--dt-button-primary-hover);
        box-shadow: 0 6px 24px var(--dt-accent-soft);
    }
    
    .premium-submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }
    
    .premium-submit-btn.disabled,
    .premium-submit-btn:disabled {
        background: rgba(75, 85, 99, 0.5);
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.4));
        cursor: not-allowed;
        box-shadow: none;
        opacity: var(--dt-state-disabled-opacity);
    }
    
    .premium-submit-btn.loading {
        background: var(--dt-button-primary-bg);
        cursor: wait;
    }
    
    .premium-submit-btn.error {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }
    
    /* Button Spinner */
    .btn-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .submit-error-hint {
        text-align: center;
        margin-top: 12px;
    }
    
    /* Success Overlay */
    .success-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 32px 16px;
        animation: fadeIn 0.4s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .success-icon-container {
        width: 80px;
        height: 80px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @@keyframes popIn {
        0% { transform: scale(0); }
        80% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .success-icon {
        color: #fff !important;
        font-size: 2.5rem !important;
    }
    
    .success-title {
        color: #fff !important;
        font-weight: 700 !important;
        margin-bottom: 8px !important;
    }
    
    .success-message {
        color: rgba(255,255,255,0.9) !important;
        margin-bottom: 24px !important;
    }
    
    .success-btn {
        color: #fff !important;
        font-weight: 500 !important;
        text-transform: none !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
        border-radius: 8px !important;
        padding: 8px 16px !important;
    }
    
    .success-btn:hover {
        background: rgba(255,255,255,0.15) !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOOTER MÃNIMO
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .footer-minimal {
        text-align: center;
        color: var(--dt-text-muted, rgba(255, 255, 255, 0.4));
        padding-top: 24px;
        font-size: 0.8rem;
    }

    .footer-minimal strong {
        color: var(--dt-text-secondary, rgba(255, 255, 255, 0.6));
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE - MOBILE FIRST
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @@media (max-width: 480px) {
        .landing-wrapper {
            padding: 16px 12px 32px;
            gap: 20px;
        }

        .profile-card, .lead-form-card {
            border-radius: 20px;
        }

        .card-header-gradient {
            height: 70px;
        }

        .avatar-container {
            margin-top: -40px;
        }

        .profile-avatar {
            width: 80px !important;
            height: 80px !important;
        }

        .card-content {
            padding: 0 16px 20px;
        }

        .cta-row .mud-button-root {
            min-width: 90px;
            font-size: 0.8rem !important;
            padding: 8px 10px !important;
        }

        .lead-form-card {
            padding: 20px 16px;
        }
    }

    /* Desktop - Cards mÃ¡s anchas */
    @@media (min-width: 768px) {
        .landing-wrapper {
            padding: 40px 24px 60px;
        }

        .profile-card, .lead-form-card {
            max-width: 440px;
        }

        .cta-row .mud-button-root {
            min-width: 120px;
        }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AUTO-CONTRAST SYSTEM
       Dynamic text colors based on surface luminance
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* === MODO OSCURO (texto claro sobre fondo oscuro) === */
    .contrast-dark {
        --surface-text-primary: #FFFFFF;
        --surface-text-secondary: rgba(255, 255, 255, 0.75);
        --surface-text-muted: rgba(255, 255, 255, 0.5);
        --surface-input-bg: rgba(255, 255, 255, 0.08);
        --surface-input-border: rgba(255, 255, 255, 0.2);
        --surface-input-text: #FFFFFF;
        --surface-input-placeholder: rgba(255, 255, 255, 0.5);
        --surface-icon: rgba(255, 255, 255, 0.85);
        --surface-chip-bg: rgba(255, 255, 255, 0.1);
        --surface-chip-text: rgba(255, 255, 255, 0.8);
        --surface-chip-border: rgba(255, 255, 255, 0.15);
        --surface-label-text: rgba(255, 255, 255, 0.85);
    }
    
    /* === MODO CLARO (texto oscuro sobre fondo claro) === */
    .contrast-light {
        --surface-text-primary: #1A1A2E;
        --surface-text-secondary: rgba(26, 26, 46, 0.75);
        --surface-text-muted: rgba(26, 26, 46, 0.5);
        --surface-input-bg: rgba(0, 0, 0, 0.06);
        --surface-input-border: rgba(0, 0, 0, 0.25);
        --surface-input-text: #1A1A2E;
        --surface-input-placeholder: rgba(0, 0, 0, 0.45);
        --surface-icon: rgba(26, 26, 46, 0.85);
        --surface-chip-bg: rgba(0, 0, 0, 0.08);
        --surface-chip-text: rgba(26, 26, 46, 0.8);
        --surface-chip-border: rgba(0, 0, 0, 0.15);
        --surface-label-text: rgba(26, 26, 46, 0.85);
    }
    
    /* Profile card text - contrast aware */
    .profile-card.contrast-dark .profile-name,
    .profile-card.contrast-light .profile-name {
        color: var(--surface-text-primary) !important;
    }
    
    .profile-card.contrast-dark .profile-title,
    .profile-card.contrast-dark .profile-bio,
    .profile-card.contrast-light .profile-title,
    .profile-card.contrast-light .profile-bio {
        color: var(--surface-text-secondary) !important;
    }
    
    .profile-card.contrast-dark .profile-location,
    .profile-card.contrast-light .profile-location {
        color: var(--surface-text-muted) !important;
    }
    
    /* Status chips - contrast aware */
    .profile-card.contrast-dark .status-chip,
    .profile-card.contrast-light .status-chip {
        background: var(--surface-chip-bg) !important;
        color: var(--surface-chip-text) !important;
        border-color: var(--surface-chip-border) !important;
    }
    
    /* Form header - contrast aware */
    .lead-form-card.contrast-dark .form-title,
    .lead-form-card.contrast-light .form-title {
        color: var(--surface-text-primary) !important;
    }
    
    .lead-form-card.contrast-dark .form-subtitle,
    .lead-form-card.contrast-light .form-subtitle {
        color: var(--surface-text-muted) !important;
    }
    
    /* Labels - contrast aware */
    .lead-form-card.contrast-dark .compact-label,
    .lead-form-card.contrast-light .compact-label {
        color: var(--surface-label-text) !important;
    }
    
    .lead-form-card.contrast-dark .label-icon,
    .lead-form-card.contrast-light .label-icon {
        color: var(--surface-icon) !important;
    }
    
    /* Native inputs - contrast aware */
    .lead-form-card.contrast-dark .native-text-input,
    .lead-form-card.contrast-dark .native-textarea-input,
    .lead-form-card.contrast-light .native-text-input,
    .lead-form-card.contrast-light .native-textarea-input {
        background: var(--surface-input-bg) !important;
        border-color: var(--surface-input-border) !important;
        color: var(--surface-input-text) !important;
        -webkit-text-fill-color: var(--surface-input-text) !important;
    }
    
    .lead-form-card.contrast-dark .native-text-input::placeholder,
    .lead-form-card.contrast-dark .native-textarea-input::placeholder,
    .lead-form-card.contrast-light .native-text-input::placeholder,
    .lead-form-card.contrast-light .native-textarea-input::placeholder {
        color: var(--surface-input-placeholder) !important;
        -webkit-text-fill-color: var(--surface-input-placeholder) !important;
    }
    
    /* MudBlazor inputs in form - contrast aware */
    .lead-form-card.contrast-dark .mud-input-slot,
    .lead-form-card.contrast-dark .mud-input > input,
    .lead-form-card.contrast-dark .mud-select-input,
    .lead-form-card.contrast-light .mud-input-slot,
    .lead-form-card.contrast-light .mud-input > input,
    .lead-form-card.contrast-light .mud-select-input {
        color: var(--surface-input-text) !important;
        -webkit-text-fill-color: var(--surface-input-text) !important;
    }
    
    /* Icons in inputs - contrast aware */
    .lead-form-card.contrast-dark .input-adornment .mud-icon-root,
    .lead-form-card.contrast-light .input-adornment .mud-icon-root {
        color: var(--surface-icon) !important;
    }
    
    /* Social icons - contrast aware */
    .profile-card.contrast-dark .social-icon,
    .profile-card.contrast-light .social-icon {
        color: var(--surface-icon) !important;
    }
    
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COUNTRY PHONE INPUT - Contrast aware styling for light themes
       Forces proper text/placeholder colors on phone number field
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Phone number input text - contrast aware */
    .lead-form-card.contrast-dark .phone-number-input,
    .lead-form-card.contrast-light .phone-number-input {
        color: var(--surface-input-text) !important;
        -webkit-text-fill-color: var(--surface-input-text) !important;
    }
    
    /* Phone number placeholder - contrast aware */
    .lead-form-card.contrast-dark .phone-number-input::placeholder,
    .lead-form-card.contrast-light .phone-number-input::placeholder {
        color: var(--surface-input-placeholder) !important;
        -webkit-text-fill-color: var(--surface-input-placeholder) !important;
        opacity: 1 !important;
    }
    
    /* Phone label - contrast aware */
    .lead-form-card.contrast-dark .phone-input-label,
    .lead-form-card.contrast-light .phone-input-label {
        color: var(--surface-label-text) !important;
    }
    
    .lead-form-card.contrast-dark .phone-input-label .label-icon,
    .lead-form-card.contrast-light .phone-input-label .label-icon {
        color: var(--surface-text-muted) !important;
    }
    
    /* Country selector text - contrast aware */
    .lead-form-card.contrast-dark .country-selector-wrapper .mud-input-slot,
    .lead-form-card.contrast-dark .country-selector-wrapper .mud-select-input,
    .lead-form-card.contrast-light .country-selector-wrapper .mud-input-slot,
    .lead-form-card.contrast-light .country-selector-wrapper .mud-select-input {
        color: var(--surface-input-text) !important;
        -webkit-text-fill-color: var(--surface-input-text) !important;
    }
    
    /* Country dial code - contrast aware */
    .lead-form-card.contrast-dark .country-dial,
    .lead-form-card.contrast-light .country-dial {
        color: var(--surface-input-text) !important;
    }
    
    /* Phone hints and counters - contrast aware */
    .lead-form-card.contrast-dark .digit-counter,
    .lead-form-card.contrast-dark .example-hint,
    .lead-form-card.contrast-light .digit-counter,
    .lead-form-card.contrast-light .example-hint {
        color: var(--surface-text-muted) !important;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SERVICES TEMPLATE - Matches TemplateLibrary Preview
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUOTE REQUEST BLOCK â€” Now rendered by shared QuoteRequestBlock.razor
       (styles live in the component; no duplicates here)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SERVICES TEMPLATE SECTION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .services-template-section {
        margin: 24px 0 20px;
        width: 100%;
    }
    
    .services-template-section .services-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--dt-text-muted, rgba(255,255,255,0.5));
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 12px;
    }
    
    .services-cards-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .service-card-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: var(--dt-modal-surface2, rgba(255,255,255,0.04));
        border: 1px solid var(--dt-modal-border, rgba(255,255,255,0.08));
        border-radius: 12px;
        transition: all 0.2s ease;
    }
    
    .service-card-item:hover {
        background: var(--dt-surface-chip, rgba(255,255,255,0.08));
        border-color: var(--dt-accent-primary, rgba(20,184,166,0.3));
    }
    
    .service-card-icon {
        width: 42px;
        height: 42px;
        min-width: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .service-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .service-card-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--dt-text-primary, #ffffff);
    }
    
    .service-card-meta {
        font-size: 0.8rem;
        color: var(--dt-text-muted, rgba(255,255,255,0.6));
    }
    
    /* Services Template CTAs */
    .services-cta-section {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .btn-booking-primary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 14px 20px;
        background: linear-gradient(135deg, #14B8A6, #0891B2);
        border: none;
        border-radius: 12px;
        color: #ffffff;
        font-size: 0.95rem;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.25s ease;
    }
    
    .btn-booking-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(20,184,166,0.4);
    }
    
    .btn-quote-outlined {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 14px 20px;
        background: transparent;
        border: 1px solid rgba(20,184,166,0.5);
        border-radius: 12px;
        color: #14B8A6;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
    }
    
    .btn-quote-outlined:hover {
        background: rgba(20,184,166,0.1);
        border-color: #14B8A6;
    }
    
    .btn-quote-link {
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 12px;
        padding: 8px;
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.6);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: underline;
        text-underline-offset: 3px;
        transition: color 0.2s ease;
    }
    
    .btn-quote-link:hover {
        color: #14B8A6;
    }
    
    a.btn-quote-link {
        text-decoration: underline;
    }
    
    /* Services Contact Footer */
    .services-contact-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid rgba(255,255,255,0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .services-contact-footer .contact-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        text-decoration: none;
        transition: color 0.2s ease;
    }
    
    .services-contact-footer .contact-item:hover {
        color: #14B8A6;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE MOBILE/TABLET - AVATAR PREMIUM LAYOUT
       Rango: 320px - 768px (Mobile First Approach)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Avatar responsive con clamp() para escalado suave */
    @@media (max-width: 768px) {
        .card-content {
            padding-top: clamp(18px, 3vw, 22px);
        }
        
        .avatar-container {
            margin-top: clamp(8px, 2vw, 16px);
            margin-bottom: clamp(12px, 2.5vw, 16px);
        }
        
        .profile-avatar {
            width: clamp(150px, 40vw, 200px) !important;
            height: clamp(150px, 40vw, 200px) !important;
            font-size: clamp(3rem, 8.5vw, 4.5rem) !important;
            border-width: clamp(6px, 2.2vw, 10px) !important;
            box-shadow: 0 0 0 clamp(6px, 2vw, 10px) var(--dt-accent-soft),
                        0 0 clamp(50px, 12vw, 80px) var(--dt-accent-soft),
                        0 10px 32px rgba(0, 0, 0, 0.35) !important;
        }
        
        .profile-name {
            font-size: clamp(1.5rem, 6vw, 2rem) !important;
            margin-bottom: 8px !important;
        }
        
        .profile-title {
            font-size: clamp(1rem, 3.5vw, 1.25rem) !important;
            margin-bottom: 10px !important;
        }
        
        .profile-bio {
            font-size: clamp(0.8125rem, 2.2vw, 0.9375rem) !important;
            margin-bottom: clamp(12px, 2.5vw, 16px) !important;
            /* Clamp lines for mobile */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .status-chips {
            margin-bottom: clamp(14px, 3vw, 18px);
        }
    }
    
    /* XS: 320px - 374px (mÃ³vil mÃ¡s angosto) */
    @@media (max-width: 374px) {
        .card-content {
            padding: 18px 14px 20px;
        }
        
        .profile-bio {
            -webkit-line-clamp: 2;
        }
        
        .status-chips {
            gap: 4px;
        }
        
        .status-chip {
            font-size: 0.6rem;
            padding: 3px 6px;
            gap: 3px;
        }
        
        .status-chip .mud-icon-root {
            font-size: 0.7rem !important;
        }
        
        .chip-dot {
            width: 5px;
            height: 5px;
        }
    }
    
    /* SM: 375px - 479px (mÃ³vil estÃ¡ndar) */
    @@media (min-width: 375px) and (max-width: 479px) {
        .card-content {
            padding: 20px 18px 24px;
        }
        
        .profile-bio {
            -webkit-line-clamp: 2;
        }
    }
    
    /* MD/TABLET: 480px - 768px */
    @@media (min-width: 480px) and (max-width: 768px) {
        .card-content {
            padding: 22px 24px 28px;
        }
        
        .profile-bio {
            -webkit-line-clamp: 3;
            max-width: 380px;
        }
    }
</style>

@code {
    [Parameter] public string OrgSlug { get; set; } = "";
    [Parameter] public string CardSlug { get; set; } = "";

    private Card? _card;
    private Organization? _organization;
    private bool _isLoading = true;
    private bool _isSubmitting = false;
    private bool _showSuccess = false;
    private bool _submitError = false;
    private bool _isPhoneValid = false;
    private ContactFormModel _contactForm = new();
    
    // Field validation errors
    private string? _nameError = null;
    private string? _emailError = null;
    
    // Computed properties for validation
    private bool IsNameValid => !string.IsNullOrWhiteSpace(_contactForm.FullName) && _contactForm.FullName.Length >= 2;
    private bool IsEmailValid => !string.IsNullOrWhiteSpace(_contactForm.Email) && 
                                  System.Text.RegularExpressions.Regex.IsMatch(_contactForm.Email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$");
    private bool CanSubmit => !_isSubmitting && IsNameValid && IsEmailValid && _isPhoneValid;
    
    // Deserialized JSON fields
    private SocialLinksModel? _socialLinks;
    private List<WebsiteLinkModel> _websiteLinks = new();
    
    // Gallery (Portfolio Template)
    private List<GalleryImageModel> _galleryImages = new();
    private DataTouch.Web.Models.PortfolioGalleryModel _portfolioGallery = new();
    private bool _lightboxOpen = false;
    private GalleryImageModel? _selectedImage;
    private int _selectedIndex = 0;
    
    // Video Lightbox
    private bool _videoLightboxOpen = false;
    private DataTouch.Web.Models.GalleryItemModel? _selectedVideo;
    private int _selectedVideoIndex = 0;
    private bool _videoPlayError = false;
    private DotNetObjectReference<PublicCard>? _lightboxDotNetRef;
    
    // Services (Services Template)
    private List<DataTouch.Domain.Entities.Service> _services = new();
    private bool _isServicesTemplate = false;

    // Quote Request Template
    private bool _isQuoteRequestTemplate = false;
    private QuoteSettingsModel _quoteSettings = new();

    // Appointments Template
    private bool _isAppointmentsTemplate = false;
    private bool _appointmentModalOpen = false;

    // Reservations Template
    private bool _isReservationsTemplate = false;
    private bool _reservationModalOpen = false;
    private ReservationSettingsModel _reservationSettings = new();
    private HashSet<DateTime> _reservationBlockedDates = new();

    // Quote Request Inline Modal state
    private bool _quoteModalOpen = false;
    private bool _quoteSubmitting = false;
    private bool _quoteSuccess = false;
    private string? _quoteError;
    private string? _quoteRequestNumber;
    private string _qFullName = "";
    private string _qEmail = "";
    private string _qPhone = "";
    private string _qPhoneCountryCode = "SV";
    private string? _qPhoneE164;
    private bool _qPhoneValid = false;
    private string _qDetails = "";
    private string _qBudget = "";
    private string _qDeadline = "";
    private string _qPreferredContact = "";
    private string _qIdempotencyKey = Guid.NewGuid().ToString();
    private bool _qFormStartTracked = false;
    
    // Appearance Style
    private CardStyleModel _cardStyle = new();
    private ThemeTokens _themeTokens = PresetRegistry.Default.Tokens;

    private MudTheme _theme = new();

    private static bool IsValidHexColor(string? v) =>
        !string.IsNullOrEmpty(v) && v.StartsWith("#") && (v.Length == 4 || v.Length == 7 || v.Length == 9);

    private void BuildMudTheme()
    {
        var t = _themeTokens;
        var dark = new PaletteDark();
        var light = new PaletteLight();

        // Only set properties with valid hex values â€” MudBlazor crashes on rgba()/named colors
        if (IsValidHexColor(t.AccentPrimary)) { dark.Primary = t.AccentPrimary; light.Primary = t.AccentPrimary; }
        if (IsValidHexColor(t.TextPrimary))   { dark.TextPrimary = t.TextPrimary; light.TextPrimary = t.TextPrimary; dark.ActionDefault = t.TextPrimary; light.ActionDefault = t.TextPrimary; }
        if (IsValidHexColor(t.TextOnAccent))  { dark.TextPrimary = dark.TextPrimary; } // no-op, just guarding

        dark.Background = "#0d0a1a";
        dark.Surface = "#19122d";
        light.Background = t.BgValue.StartsWith("linear") ? "#F8FAFC" : (IsValidHexColor(t.BgValue) ? t.BgValue : "#F8FAFC");
        light.Surface = "#FFFFFF";

        _theme = new MudTheme { PaletteDark = dark, PaletteLight = light };
    }

    private class ContactFormModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El nombre es requerido")]
        public string FullName { get; set; } = "";
        
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "El email es requerido")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Email no vÃ¡lido")]
        public string Email { get; set; } = "";
        
        public string Phone { get; set; } = "";
        public string PhoneCountryCode { get; set; } = "SV";
        public string? PhoneE164 { get; set; }
        
        public string? Message { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        _organization = await DbContext.Organizations
            .FirstOrDefaultAsync(o => o.Slug == OrgSlug && o.IsActive);

        if (_organization != null)
        {
            _card = await DbContext.Cards
                .Include(c => c.User)
                .FirstOrDefaultAsync(c => c.OrganizationId == _organization.Id && c.Slug == CardSlug && c.IsActive);
            
            if (_card != null)
            {
                DeserializeJsonFields();
                
                // Detect template type
                _isServicesTemplate = _card.TemplateType == "services-quotes";
                _isQuoteRequestTemplate = _card.TemplateType == "quote-request";
                _isAppointmentsTemplate = _card.TemplateType == "appointments";
                _isReservationsTemplate = _card.TemplateType == "reservations-range";

                // Parse quote settings for quote-request template
                if (_isQuoteRequestTemplate && !string.IsNullOrEmpty(_card.QuoteSettingsJson))
                {
                    try { _quoteSettings = System.Text.Json.JsonSerializer.Deserialize<QuoteSettingsModel>(_card.QuoteSettingsJson) ?? new(); }
                    catch { _quoteSettings = new(); }
                }

                // Parse reservation settings for reservations-range template
                if (_isReservationsTemplate && !string.IsNullOrEmpty(_card.ReservationSettingsJson))
                {
                    try { _reservationSettings = System.Text.Json.JsonSerializer.Deserialize<ReservationSettingsModel>(_card.ReservationSettingsJson) ?? new(); }
                    catch { _reservationSettings = new(); }
                }
                
                // Load services for services template
                _services = await DbContext.Services
                    .Where(s => s.CardId == _card.Id && s.IsActive)
                    .OrderBy(s => s.DisplayOrder)
                    .ToListAsync();
            }
        }
        _isLoading = false;
    }
    
    private void DeserializeJsonFields()
    {
        // Social Links
        if (!string.IsNullOrEmpty(_card?.SocialLinksJson))
        {
            try
            {
                _socialLinks = System.Text.Json.JsonSerializer.Deserialize<SocialLinksModel>(_card.SocialLinksJson);
            }
            catch { _socialLinks = null; }
        }

        // Website Links
        if (!string.IsNullOrEmpty(_card?.WebsiteLinksJson))
        {
            try
            {
                _websiteLinks = System.Text.Json.JsonSerializer.Deserialize<List<WebsiteLinkModel>>(_card.WebsiteLinksJson) ?? new();
            }
            catch { _websiteLinks = new(); }
        }
        
        // Portfolio Gallery (new model with photos + videos)
        if (!string.IsNullOrEmpty(_card?.PortfolioGalleryJson))
        {
            try
            {
                _portfolioGallery = System.Text.Json.JsonSerializer.Deserialize<DataTouch.Web.Models.PortfolioGalleryModel>(_card.PortfolioGalleryJson) ?? new();
            }
            catch { _portfolioGallery = new(); }
        }
        // Legacy migration: if no PortfolioGalleryJson but has GalleryImagesJson
        else if (!string.IsNullOrEmpty(_card?.GalleryImagesJson))
        {
            try
            {
                var legacyImages = System.Text.Json.JsonSerializer.Deserialize<List<GalleryImageModel>>(_card.GalleryImagesJson) ?? new();
                _portfolioGallery = new DataTouch.Web.Models.PortfolioGalleryModel
                {
                    EnablePhotos = true,
                    EnableVideos = false,
                    Photos = legacyImages.Select(img => new DataTouch.Web.Models.GalleryItemModel
                    {
                        Url = img.Url, Title = img.Title, Description = img.Description, Order = img.Order
                    }).ToList()
                };
            }
            catch { _portfolioGallery = new(); }
        }
        // Sync legacy _galleryImages for lightbox compat
        _galleryImages = _portfolioGallery.Photos.Select(p => new GalleryImageModel
        {
            Url = p.Url, Title = p.Title, Description = p.Description, Order = p.Order
        }).ToList();
        
        // Appearance Style
        if (!string.IsNullOrEmpty(_card?.AppearanceStyleJson))
        {
            try
            {
                _cardStyle = System.Text.Json.JsonSerializer.Deserialize<CardStyleModel>(_card.AppearanceStyleJson) ?? new();
                
                // Load ThemeTokens from preset registry
                if (!string.IsNullOrEmpty(_cardStyle.PresetId))
                {
                    var preset = PresetRegistry.GetById(_cardStyle.PresetId);
                    if (preset != null)
                    {
                        _themeTokens = preset.Tokens;
                    }
                }
            }
            catch { _cardStyle = new(); }
        }

        BuildMudTheme();
    }
    
    private string GetDisplayCompanyName()
    {
        if (!string.IsNullOrEmpty(_card?.CompanyName))
            return _card.CompanyName;
        return _organization?.Name ?? "";
    }

    private async Task DownloadVCard()
    {
        if (_card == null) return;

        var vcard = $@"BEGIN:VCARD
VERSION:3.0
FN:{_card.FullName}
TITLE:{_card.Title}
TEL:{GetFullPhoneForLink()}
EMAIL:{_card.Email}
ORG:{_organization?.Name}
END:VCARD";

        var bytes = System.Text.Encoding.UTF8.GetBytes(vcard);
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"{_card.FullName?.Replace(" ", "_")}.vcf";

        await JSRuntime.InvokeVoidAsync("eval", $@"
            var link = document.createElement('a');
            link.href = 'data:text/vcard;base64,{base64}';
            link.download = '{fileName}';
            link.click();
        ");
        Snackbar.Add("Contacto guardado", Severity.Success);
    }

    private async Task OpenSocialLink(string url)
    {
        await JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }

    private async Task SubmitContact()
    {
        if (_card == null || _organization == null) return;
        if (!CanSubmit) return;

        _isSubmitting = true;
        _submitError = false;
        
        try
        {
            var lead = new Lead
            {
                Id = Guid.NewGuid(),
                OrganizationId = _organization.Id,
                CardId = _card.Id,
                OwnerUserId = _card.UserId,
                FullName = _contactForm.FullName.Trim(),
                Email = _contactForm.Email.Trim().ToLowerInvariant(),
                Phone = _contactForm.Phone,
                PhoneCountryCode = GetDialCodeFromCountryCode(_contactForm.PhoneCountryCode),
                PhoneE164 = _contactForm.PhoneE164,
                Message = _contactForm.Message?.Trim(),
                Source = "CARD_CONTACT_FORM",
                Status = "New",
                CreatedAt = DateTime.UtcNow
            };

            DbContext.Leads.Add(lead);
            await DbContext.SaveChangesAsync();

            // Show success animation
            _showSuccess = true;
            _isSubmitting = false;
        }
        catch
        {
            _submitError = true;
            _isSubmitting = false;
        }
    }
    
    private string GetDialCodeFromCountryCode(string countryCode)
    {
        // Map country codes to dial codes
        var dialCodes = new Dictionary<string, string>
        {
            { "SV", "+503" }, { "GT", "+502" }, { "HN", "+504" }, { "NI", "+505" },
            { "CR", "+506" }, { "PA", "+507" }, { "BZ", "+501" }, { "MX", "+52" },
            { "US", "+1" }, { "CA", "+1" }, { "CO", "+57" }, { "PE", "+51" },
            { "AR", "+54" }, { "CL", "+56" }, { "EC", "+593" }, { "VE", "+58" },
            { "BO", "+591" }, { "PY", "+595" }, { "UY", "+598" }, { "DO", "+1" },
            { "PR", "+1" }, { "CU", "+53" }, { "ES", "+34" }, { "FR", "+33" },
            { "DE", "+49" }, { "IT", "+39" }, { "GB", "+44" }, { "PT", "+351" }
        };
        return dialCodes.TryGetValue(countryCode, out var dial) ? dial : "+503";
    }
    
    private void ResetForm()
    {
        _contactForm = new ContactFormModel();
        _showSuccess = false;
        _submitError = false;
        _isPhoneValid = false;
    }
    
    private string GetSubmitButtonClass()
    {
        if (_isSubmitting) return "loading";
        if (_submitError) return "error";
        if (!CanSubmit) return "disabled";
        return "ready";
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Services/Booking Methods
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    private string GetBookingUrl()
    {
        if (_organization == null || _card == null) return "#";
        return $"/p/{_organization.Slug}/{_card.Slug}/book";
    }
    
    private async Task ScrollToContactForm()
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", ".lead-form-card");
    }
    
    private async Task OpenQuoteModal()
    {
        var parameters = new DialogParameters<QuoteRequestModal>
        {
            { x => x.Services, _services },
            { x => x.CardId, _card!.Id }
        };
        
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true,
            BackdropClick = false
        };
        
        await DialogService.ShowAsync<QuoteRequestModal>("Solicitar CotizaciÃ³n", parameters, options);
    }

    private async Task OpenPublicQuoteModal()
    {
        Logger.LogInformation("OpenPublicQuoteModal called. _card is {CardNull}", _card == null ? "null" : _card.Id.ToString());
        if (_card == null) return;

        try { await AnalyticsService.TrackQuoteCtaClickAsync(_card.Id); } catch { /* analytics must never block UI */ }
        try { await AnalyticsService.TrackQuoteModalOpenAsync(_card.Id); } catch { /* analytics must never block UI */ }

        _quoteModalOpen = true;
        _quoteSubmitting = false;
        _quoteSuccess = false;
        _quoteError = null;
        _quoteRequestNumber = null;
        StateHasChanged();
    }

    private void OpenSchedulerModal()
    {
        _appointmentModalOpen = true;
        StateHasChanged();
    }

    private async Task OpenReservationModal()
    {
        _reservationModalOpen = true;
        StateHasChanged();
        // Load blocked dates for current + next month
        if (_card != null)
        {
            try
            {
                var now = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
                var end = now.AddMonths(2);
                _reservationBlockedDates = await ReservationService.GetBlockedDatesAsync(_card.Id, null, now, end);
                StateHasChanged();
            }
            catch { /* Don't block modal opening if blocked dates fail */ }
        }
    }

    private async Task LoadBlockedDatesForMonth(DateTime monthStart)
    {
        if (_card == null) return;
        try
        {
            var end = monthStart.AddMonths(2);
            var newBlocked = await ReservationService.GetBlockedDatesAsync(_card.Id, null, monthStart, end);
            foreach (var d in newBlocked) _reservationBlockedDates.Add(d);
            StateHasChanged();
        }
        catch { /* Silently fail â€” calendar still works, just without blocked dates */ }
    }

    private void CloseQuoteModal()
    {
        _quoteModalOpen = false;
        // Reset form for next open
        _qFullName = "";
        _qEmail = "";
        _qPhone = "";
        _qPhoneCountryCode = "SV";
        _qPhoneE164 = null;
        _qPhoneValid = false;
        _qDetails = "";
        _qBudget = "";
        _qDeadline = "";
        _qPreferredContact = "";
        _quoteSubmitting = false;
        _quoteSuccess = false;
        _quoteError = null;
        _quoteRequestNumber = null;
        _qIdempotencyKey = Guid.NewGuid().ToString();
        _qFormStartTracked = false;
        StateHasChanged();
    }

    private bool QuoteCanSubmit
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_qFullName)) return false;
            if (string.IsNullOrWhiteSpace(_qDetails)) return false;
            var hasEmail = IsValidQuoteEmail(_qEmail);
            var hasPhone = !string.IsNullOrWhiteSpace(_qPhone);
            if (!hasEmail && !hasPhone) return false;
            if (_quoteSettings.EmailRequired && !hasEmail) return false;
            if (_quoteSettings.PhoneRequired && !hasPhone) return false;
            return true;
        }
    }

    private bool IsValidQuoteEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email)) return false;
        try { var addr = new System.Net.Mail.MailAddress(email); return addr.Address == email.Trim(); }
        catch { return false; }
    }

    private async Task SubmitQuoteRequest()
    {
        if (!QuoteCanSubmit || _card == null) return;

        _quoteSubmitting = true;
        _quoteError = null;
        StateHasChanged();

        try
        {
            try { await AnalyticsService.TrackQuoteSubmitAttemptAsync(_card.Id); } catch { }

            var dto = new CreatePublicCardQuoteDto
            {
                CardId = _card.Id,
                CustomerName = _qFullName.Trim(),
                CustomerEmail = IsValidQuoteEmail(_qEmail) ? _qEmail.Trim().ToLowerInvariant() : null,
                CustomerPhone = !string.IsNullOrWhiteSpace(_qPhone) ? _qPhone.Trim() : null,
                CustomerPhoneCountryCode = !string.IsNullOrWhiteSpace(_qPhone) ? _qPhoneCountryCode : null,
                Details = _qDetails.Trim(),
                Budget = !string.IsNullOrEmpty(_qBudget) ? _qBudget : null,
                Deadline = !string.IsNullOrEmpty(_qDeadline) ? _qDeadline : null,
                PreferredContact = !string.IsNullOrEmpty(_qPreferredContact) ? _qPreferredContact : null,
                IdempotencyKey = _qIdempotencyKey
            };

            var result = await QuoteService.CreateQuoteFromPublicCardRequestAsync(dto);

            if (result.Success)
            {
                _quoteSuccess = true;
                _quoteRequestNumber = result.RequestNumber;
                try { await AnalyticsService.TrackQuoteSubmitSuccessAsync(_card.Id, result.Quote?.Id); } catch { }
            }
            else
            {
                _quoteError = result.Error ?? "Error al enviar la solicitud";
                try { await AnalyticsService.TrackQuoteSubmitErrorAsync(_card.Id, result.Error); } catch { }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SubmitQuoteRequest failed");
            _quoteError = "Error inesperado. Por favor intenta de nuevo.";
            try { await AnalyticsService.TrackQuoteSubmitErrorAsync(_card.Id, ex.Message); } catch { }
        }
        finally
        {
            _quoteSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task TrackQuoteFormStart(FocusEventArgs? e = null)
    {
        if (!_qFormStartTracked && _card != null)
        {
            _qFormStartTracked = true;
            try { await AnalyticsService.TrackQuoteFormStartAsync(_card.Id); } catch { }
        }
    }

    private void ClearQuoteError()
    {
        _quoteError = null;
        StateHasChanged();
    }

    private string GetServiceIconColor(int index)
    {
        var colors = new[] { 
            "linear-gradient(135deg, #EC4899, #F97316)", // Pink to Orange
            "linear-gradient(135deg, #3B82F6, #8B5CF6)", // Blue to Purple
            "linear-gradient(135deg, #14B8A6, #10B981)", // Teal to Green
            "linear-gradient(135deg, #F59E0B, #EF4444)", // Amber to Red
            "linear-gradient(135deg, #8B5CF6, #EC4899)"  // Purple to Pink
        };
        return colors[index % colors.Length];
    }
    
    // ViewModels for JSON fields
    private class SocialLinksModel
    {
        public string? LinkedIn { get; set; }
        public string? Instagram { get; set; }
        public string? Facebook { get; set; }
        public string? YouTube { get; set; }
        public string? Twitter { get; set; }
        public string? Website { get; set; }

        public bool HasAnyLink()
        {
            return !string.IsNullOrEmpty(LinkedIn) ||
                   !string.IsNullOrEmpty(Instagram) ||
                   !string.IsNullOrEmpty(Facebook) ||
                   !string.IsNullOrEmpty(YouTube) ||
                   !string.IsNullOrEmpty(Twitter) ||
                   !string.IsNullOrEmpty(Website);
        }
    }

    private class WebsiteLinkModel
    {
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }
    
    private class GalleryImageModel
    {
        public string Url { get; set; } = "";
        public string? Title { get; set; }
        public string? Description { get; set; }
        public int Order { get; set; }
    }
    
    // CardStyleModel is now shared: see Models/CardStyleModel.cs
    
    private string GetDynamicBackgroundStyle()
    {
        if (_cardStyle.BackgroundType == "image" && !string.IsNullOrEmpty(_cardStyle.BackgroundImageUrl))
            return $"background: url('{_cardStyle.BackgroundImageUrl}') center/cover no-repeat, linear-gradient(180deg, #0d0a1a 0%, #1a1035 100%);";
        if (_cardStyle.BackgroundType == "solid")
            return $"background: {_themeTokens.BgValue};";
        return $"background: {_themeTokens.BgValue};";
    }
    
    private string GetThemeCssVariables()
    {
        return ThemeHelper.GenerateCssVariables(_themeTokens);
    }
    
    private string GetCardBackgroundStyle()
    {
        if (_cardStyle.CardLinkedToBackground) return "";
        return $"background: {_cardStyle.CardBackgroundColor} !important;";
    }
    
    // Get contrast class for background surface
    private string GetBackgroundContrastClass()
    {
        if (_cardStyle.ContrastMode == "force-light") return "contrast-light";
        if (_cardStyle.ContrastMode == "force-dark") return "contrast-dark";
        return _cardStyle.BackgroundIsDark ? "contrast-dark" : "contrast-light";
    }
    
    // Get contrast class for card surface
    private string GetCardContrastClass()
    {
        if (_cardStyle.ContrastMode == "force-light") return "contrast-light";
        if (_cardStyle.ContrastMode == "force-dark") return "contrast-dark";
        
        if (!_cardStyle.CardLinkedToBackground)
        {
            return _cardStyle.CardIsDarkOverride ? "contrast-dark" : "contrast-light";
        }
        
        return _cardStyle.CardIsDark ? "contrast-dark" : "contrast-light";
    }
    
    // Gallery click handlers (bridge from shared component to lightbox)
    private async Task OnGalleryPhotoClick(DataTouch.Web.Models.GalleryItemModel item)
    {
        var match = _galleryImages.FirstOrDefault(i => i.Url == item.Url);
        if (match != null) await OpenLightbox(match);
    }

    private async Task OnGalleryVideoClick(DataTouch.Web.Models.GalleryItemModel item)
    {
        await OpenVideoLightbox(item);
    }

    // Gallery Lightbox Methods
    private async Task OpenLightbox(GalleryImageModel image)
    {
        _selectedImage = image;
        _selectedIndex = _galleryImages.OrderBy(i => i.Order).ToList().IndexOf(image);
        _lightboxOpen = true;
        await RegisterKeyboardListener();
    }
    
    private async Task CloseLightbox()
    {
        _lightboxOpen = false;
        _selectedImage = null;
        await RemoveKeyboardListener();
    }
    
    private void PrevImage()
    {
        if (_galleryImages.Count == 0) return;
        var ordered = _galleryImages.OrderBy(i => i.Order).ToList();
        _selectedIndex = (_selectedIndex - 1 + ordered.Count) % ordered.Count;
        _selectedImage = ordered[_selectedIndex];
    }
    
    private void NextImage()
    {
        if (_galleryImages.Count == 0) return;
        var ordered = _galleryImages.OrderBy(i => i.Order).ToList();
        _selectedIndex = (_selectedIndex + 1) % ordered.Count;
        _selectedImage = ordered[_selectedIndex];
    }

    // Video Lightbox Methods
    private async Task OpenVideoLightbox(DataTouch.Web.Models.GalleryItemModel video)
    {
        var ordered = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
        _selectedVideo = video;
        _selectedVideoIndex = ordered.IndexOf(video);
        if (_selectedVideoIndex < 0) _selectedVideoIndex = 0;
        _videoPlayError = false;
        _videoLightboxOpen = true;
        StateHasChanged();
        await RegisterKeyboardListener();
        // Init the video player via JS (attach error listeners + call .load())
        _lightboxDotNetRef ??= DotNetObjectReference.Create(this);
        try { await JSRuntime.InvokeVoidAsync("initVideoPlayer", "#lightbox-video-player", _lightboxDotNetRef); } catch { }
    }

    private async Task CloseVideoLightbox()
    {
        try { await JSRuntime.InvokeVoidAsync("pauseVideo", "#lightbox-video-player"); } catch { }
        _videoLightboxOpen = false;
        _selectedVideo = null;
        _videoPlayError = false;
        await RemoveKeyboardListener();
    }

    private async Task PrevVideo()
    {
        var ordered = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
        if (ordered.Count == 0 || _selectedVideoIndex <= 0) return;
        try { await JSRuntime.InvokeVoidAsync("pauseVideo", "#lightbox-video-player"); } catch { }
        _selectedVideoIndex--;
        _selectedVideo = ordered[_selectedVideoIndex];
        _videoPlayError = false;
        StateHasChanged();
        // Reload the video element with the new src
        _lightboxDotNetRef ??= DotNetObjectReference.Create(this);
        try { await JSRuntime.InvokeVoidAsync("reloadVideo", "#lightbox-video-player", _lightboxDotNetRef); } catch { }
    }

    private async Task NextVideo()
    {
        var ordered = _portfolioGallery.Videos.OrderBy(v => v.Order).ToList();
        if (ordered.Count == 0 || _selectedVideoIndex >= ordered.Count - 1) return;
        try { await JSRuntime.InvokeVoidAsync("pauseVideo", "#lightbox-video-player"); } catch { }
        _selectedVideoIndex++;
        _selectedVideo = ordered[_selectedVideoIndex];
        _videoPlayError = false;
        StateHasChanged();
        // Reload the video element with the new src
        _lightboxDotNetRef ??= DotNetObjectReference.Create(this);
        try { await JSRuntime.InvokeVoidAsync("reloadVideo", "#lightbox-video-player", _lightboxDotNetRef); } catch { }
    }

    [JSInvokable]
    public void OnVideoPlayError()
    {
        _videoPlayError = true;
        InvokeAsync(StateHasChanged);
    }

    // Keyboard listener for lightboxes (ESC / â† / â†’)
    private async Task RegisterKeyboardListener()
    {
        _lightboxDotNetRef ??= DotNetObjectReference.Create(this);
        try { await JSRuntime.InvokeVoidAsync("addLightboxKeyListener", _lightboxDotNetRef); } catch { }
    }

    private async Task RemoveKeyboardListener()
    {
        if (!_lightboxOpen && !_videoLightboxOpen)
        {
            try { await JSRuntime.InvokeVoidAsync("removeLightboxKeyListener"); } catch { }
        }
    }

    [JSInvokable]
    public async Task OnLightboxKeyClose()
    {
        if (_videoLightboxOpen) await CloseVideoLightbox();
        else if (_lightboxOpen) await CloseLightbox();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnLightboxKeyPrev()
    {
        if (_videoLightboxOpen) await PrevVideo();
        else if (_lightboxOpen) PrevImage();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnLightboxKeyNext()
    {
        if (_videoLightboxOpen) await NextVideo();
        else if (_lightboxOpen) NextImage();
        StateHasChanged();
    }
    private string GetFullPhoneForLink()
    {
        if (_card == null) return "";
        var code = _card.PhoneCountryCode ?? "";
        var number = _card.Phone?.Replace(" ", "").Replace("-", "") ?? "";
        return $"{code}{number}";
    }

    private string GetFullWhatsAppForLink() 
    {
        if (_card == null) return "";
        var code = _card.WhatsAppCountryCode?.Replace("+", "") ?? ""; // WA expects 52... not +52
        var number = _card.WhatsAppNumber?.Replace(" ", "").Replace("-", "") ?? "";
        return $"{code}{number}";
    }

    public void Dispose()
    {
        _lightboxDotNetRef?.Dispose();
    }
}
