@page "/quotes"
@layout MainLayout
@inject DataTouchDbContext DbContext
@inject QuoteService QuoteService
@inject CardAnalyticsService AnalyticsService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using DataTouch.Domain.Entities
@using DataTouch.Infrastructure.Data
@using DataTouch.Web.Services

<PageTitle>Cotizaciones - DataTouch</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6 quotes-container">
    @* ═══════════════════════════════════════════════════════════════
       HEADER (DESKTOP)
       ═══════════════════════════════════════════════════════════════ *@
    <div class="quotes-header desktop-only">
        <div class="header-left">
            <MudText Typo="Typo.h4" Class="page-title">Cotizaciones</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Gestiona las solicitudes de cotización de tus clientes
            </MudText>
        </div>
        <div class="header-right">
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadQuotes"
                       Size="Size.Small">
                Actualizar
            </MudButton>
        </div>
    </div>

    @* ═══════════════════════════════════════════════════════════════
       MOBILE TOOLBAR
       ═══════════════════════════════════════════════════════════════ *@
    <div class="mobile-toolbar mobile-only">
        <div class="toolbar-left">
            <span class="toolbar-title">COTIZACIONES</span>
            <span class="toolbar-count">@_filteredQuotes.Count</span>
        </div>
        <button class="btn-refresh-mobile" @onclick="LoadQuotes">
            <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" />
        </button>
    </div>

    @* ═══════════════════════════════════════════════════════════════
       TABS: GESTIÓN + DASHBOARD
       ═══════════════════════════════════════════════════════════════ *@
    <MudTabs ActivePanelIndex="_activeTab" ActivePanelIndexChanged="OnTabChanged"
             Rounded="true" ApplyEffectsToContainer="true" Class="quotes-tabs mb-4">
        <MudTabPanel Text="Gestión" Icon="@Icons.Material.Filled.TableChart">

    @* ═══════════════════════════════════════════════════════════════
       STATUS COUNTS (KPI Cards)
       ═══════════════════════════════════════════════════════════════ *@
    <div class="status-cards">
        @foreach (var status in _statusCounts)
        {
            <div class="status-card @(status.Key == _selectedStatus ? "status-card-active" : "")"
                 @onclick="@(() => FilterByStatus(status.Key))">
                <div class="status-count">@status.Value</div>
                <div class="status-label">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(status.Key)" Class="status-chip">
                        @GetStatusLabel(status.Key)
                    </MudChip>
                </div>
            </div>
        }
        <div class="status-card @(_selectedStatus == null ? "status-card-active" : "")"
             @onclick="@(() => FilterByStatus(null))">
            <div class="status-count">@_quotes.Count</div>
            <div class="status-label">
                <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="status-chip">Todas</MudChip>
            </div>
        </div>
    </div>

    @* ═══════════════════════════════════════════════════════════════
       FILTERS BAR
       ═══════════════════════════════════════════════════════════════ *@
    <MudPaper Class="filters-bar pa-3 mb-4" Elevation="0">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_searchTerm"
                              Placeholder="Buscar por nombre o email..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              DebounceInterval="300"
                              OnDebounceIntervalElapsed="SearchChanged"
                              Class="filter-input" />
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudSelect T="Guid?" @bind-Value="_selectedServiceId"
                           Label="Servicio"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Class="filter-input">
                    @foreach (var service in _services)
                    {
                        <MudSelectItem T="Guid?" Value="@((Guid?)service.Id)">@service.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudSelect @bind-Value="_dateRange"
                           Label="Fecha"
                           Variant="Variant.Outlined"
                           Class="filter-input">
                    <MudSelectItem Value="@("all")">Todas</MudSelectItem>
                    <MudSelectItem Value="@("today")">Hoy</MudSelectItem>
                    <MudSelectItem Value="@("week")">Últimos 7 días</MudSelectItem>
                    <MudSelectItem Value="@("month")">Este mes</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="2" Class="d-flex align-center justify-end">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary"
                           OnClick="ClearFilters"
                           Size="Size.Small">
                    Limpiar filtros
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* ═══════════════════════════════════════════════════════════════
       QUOTES TABLE
       ═══════════════════════════════════════════════════════════════ *@
    @if (_isLoading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    @if (_filteredQuotes.Any())
    {
        @* ═══════════════ DESKTOP TABLE VIEW ═══════════════ *@
        <div class="quotes-desktop-view">
            <MudPaper Class="quotes-table" Elevation="0">
                <MudTable Items="_filteredQuotes"
                          Hover="true"
                          Dense="true"
                          OnRowClick="@((TableRowClickEventArgs<QuoteRequest> args) => OpenDetails(args.Item))"
                          Class="quote-table-content">
                    <HeaderContent>
                        <MudTh>Solicitud</MudTh>
                        <MudTh>Cliente</MudTh>
                        <MudTh>Origen</MudTh>
                        <MudTh>Estado</MudTh>
                        <MudTh>Fecha</MudTh>
                        <MudTh>SLA</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Solicitud">
                            <span class="request-number">@context.RequestNumber</span>
                        </MudTd>
                        <MudTd DataLabel="Cliente">
                            <div class="customer-cell">
                                <span class="customer-name">@context.CustomerName</span>
                                <span class="customer-email">@context.CustomerEmail</span>
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Origen">
                            @{
                                var origin = GetQuoteOrigin(context);
                            }
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@origin.Color">
                                @origin.Label
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Estado">
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                @GetStatusLabel(context.Status)
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Fecha">
                            <span class="date-cell">@context.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </MudTd>
                        <MudTd DataLabel="SLA">
                            @if (context.Status == QuoteStatus.New || context.Status == QuoteStatus.InReview)
                            {
                                var slaStatus = GetSlaStatus(context);
                                <MudChip T="string" Size="Size.Small" Color="@slaStatus.Color" Variant="Variant.Outlined">
                                    @slaStatus.Label
                                </MudChip>
                            }
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                           Size="Size.Small"
                                           OnClick="@(() => OpenDetails(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </div>

        @* ═══════════════ MOBILE/TABLET CARDS VIEW ═══════════════ *@
        <div class="quotes-mobile-view">
            <div class="quotes-cards-container">
                @foreach (var quote in _filteredQuotes)
                {
                    <div class="quote-card" @onclick="@(() => OpenDetails(quote))">
                        <div class="quote-card-header">
                            <span class="quote-request-number">@quote.RequestNumber</span>
                            <span class="quote-status-badge @GetStatusBadgeClass(quote.Status)">
                                @GetStatusLabel(quote.Status)
                            </span>
                        </div>
                        <div class="quote-card-body">
                            <h3 class="quote-customer-name">@quote.CustomerName</h3>
                            <span class="quote-customer-email">@quote.CustomerEmail</span>
                            <span class="quote-service-name">@quote.Service?.Name</span>
                        </div>
                        <div class="quote-card-footer">
                            <span class="quote-date">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                @quote.CreatedAt.ToString("dd/MM HH:mm")
                            </span>
                            @if (quote.Status == QuoteStatus.New || quote.Status == QuoteStatus.InReview)
                            {
                                var slaStatus = GetSlaStatus(quote);
                                <span class="quote-sla-badge @GetSlaBadgeClass(slaStatus.Color)">
                                    @slaStatus.Label
                                </span>
                            }
                        </div>
                        <div class="quote-card-actions" @onclick:stopPropagation="true">
                            <div class="quote-quick-actions">
                                @if (!string.IsNullOrEmpty(quote.CustomerPhone))
                                {
                                    <a href="tel:@quote.CustomerPhone" class="quote-action-btn phone">
                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                                    </a>
                                    <a href="https://wa.me/@(quote.CustomerPhone.Replace(" ", "").Replace("-", ""))"
                                       target="_blank" class="quote-action-btn whatsapp">
                                        <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" />
                                    </a>
                                }
                                <a href="mailto:@quote.CustomerEmail" class="quote-action-btn email">
                                    <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" />
                                </a>
                            </div>
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Class="quote-card-chevron" />
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (!_isLoading)
    {
        <MudPaper Class="empty-state pa-8" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Color="Color.Default" />
            <MudText Typo="Typo.h6" Class="mt-4">No hay cotizaciones</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Las solicitudes de cotización aparecerán aquí
            </MudText>
        </MudPaper>
    }

        </MudTabPanel>

        @* ═══════════════════════════════════════════════════════════════
           DASHBOARD TAB
           ═══════════════════════════════════════════════════════════════ *@
        <MudTabPanel Text="Dashboard" Icon="@Icons.Material.Filled.Analytics">
            <div class="qa-filters">
                <div class="qa-filter-chips">
                    <MudChipSet T="string" SelectedValue="@_dashRange" SelectedValueChanged="OnDashRangeChanged" SelectionMode="SelectionMode.SingleSelection">
                        <MudChip T="string" Value="@("7")">7 días</MudChip>
                        <MudChip T="string" Value="@("15")">15 días</MudChip>
                        <MudChip T="string" Value="@("30")">30 días</MudChip>
                    </MudChipSet>
                </div>
                @if (_dashCards.Count > 1)
                {
                    <div class="qa-card-filter">
                        <MudSelect T="Guid?" Value="_dashCardId" Label="Filtrar por tarjeta" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" ValueChanged="OnDashCardChanged">
                            <MudSelectItem T="Guid?" Value="@((Guid?)null)">Todas las tarjetas</MudSelectItem>
                            @foreach (var card in _dashCards)
                            {
                                <MudSelectItem T="Guid?" Value="@((Guid?)card.Id)">@card.FullName</MudSelectItem>
                            }
                        </MudSelect>
                    </div>
                }
            </div>

            @if (_dashLoading)
            {
                <div class="qa-loading">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                </div>
            }
            else
            {
                @* ═══════════════ KPI CARDS ═══════════════ *@
                <div class="qa-kpis">
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(139,92,246,0.15); color: #A78BFA;">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("page_view", 0)</span>
                            <span class="qa-kpi-label">Vistas</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(236,72,153,0.15); color: #EC4899;">
                            <MudIcon Icon="@Icons.Material.Filled.TouchApp" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("quote_cta_click", 0)</span>
                            <span class="qa-kpi-label">Clicks CTA</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(34,211,238,0.15); color: #22D3EE;">
                            <MudIcon Icon="@Icons.Material.Filled.OpenInNew" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("quote_modal_open", 0)</span>
                            <span class="qa-kpi-label">Modal abierto</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(245,158,11,0.15); color: #F59E0B;">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("quote_form_start", 0)</span>
                            <span class="qa-kpi-label">Inicio form</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(16,185,129,0.15); color: #10B981;">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("quote_submit_success", 0)</span>
                            <span class="qa-kpi-label">Enviados</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(239,68,68,0.15); color: #EF4444;">
                            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashFunnel.GetValueOrDefault("quote_submit_error", 0)</span>
                            <span class="qa-kpi-label">Errores</span>
                        </div>
                    </div>
                    <div class="qa-kpi qa-kpi-highlight">
                        <div class="qa-kpi-icon" style="background: rgba(139,92,246,0.2); color: #C084FC;">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashConversion.ToString("F1")%</span>
                            <span class="qa-kpi-label">Conversión</span>
                        </div>
                    </div>
                    <div class="qa-kpi">
                        <div class="qa-kpi-icon" style="background: rgba(167,139,250,0.15); color: #A78BFA;">
                            <MudIcon Icon="@Icons.Material.Filled.Mouse" />
                        </div>
                        <div class="qa-kpi-data">
                            <span class="qa-kpi-value">@_dashCtr.ToString("F1")%</span>
                            <span class="qa-kpi-label">CTR</span>
                        </div>
                    </div>
                </div>

                @* ═══════════════ CHARTS ═══════════════ *@
                <div class="qa-charts-grid">
                    <div class="qa-chart-card qa-chart-wide">
                        <div class="qa-chart-title">
                            <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" Style="color: #A78BFA;" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Funnel de Conversión</MudText>
                        </div>
                        <div id="dash-chart-funnel" class="qa-chart-container" style="height: 340px;"></div>
                    </div>

                    <div class="qa-chart-card qa-chart-wide">
                        <div class="qa-chart-title">
                            <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Small" Style="color: #22D3EE;" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Solicitudes por Día</MudText>
                        </div>
                        <div id="dash-chart-timeseries" class="qa-chart-container" style="height: 300px;"></div>
                    </div>

                    <div class="qa-chart-card">
                        <div class="qa-chart-title">
                            <MudIcon Icon="@Icons.Material.Filled.BarChart" Size="Size.Small" Style="color: #F59E0B;" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Estado de Cotizaciones</MudText>
                        </div>
                        <div id="dash-chart-status" class="qa-chart-container" style="height: 280px;"></div>
                    </div>

                    <div class="qa-chart-card">
                        <div class="qa-chart-title">
                            <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Small" Style="color: #10B981;" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Preferencia de Contacto</MudText>
                        </div>
                        <div id="dash-chart-contact" class="qa-chart-container" style="height: 280px;"></div>
                    </div>

                    <div class="qa-chart-card">
                        <div class="qa-chart-title">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Style="color: #EC4899;" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Urgencia / Deadline</MudText>
                        </div>
                        <div id="dash-chart-deadline" class="qa-chart-container" style="height: 280px;"></div>
                    </div>
                </div>
            }
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@* ═══════════════════════════════════════════════════════════════
   QUOTE DETAILS DRAWER
   ═══════════════════════════════════════════════════════════════ *@
<MudDrawer @bind-Open="_drawerOpen" 
           Anchor="Anchor.End" 
           Width="480px" 
           Elevation="2"
           Variant="DrawerVariant.Temporary"
           Class="quote-drawer">
    @if (_selectedQuote != null)
    {
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <MudText Typo="Typo.h6">@_selectedQuote.RequestNumber</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_selectedQuote.Status)">
                        @GetStatusLabel(_selectedQuote.Status)
                    </MudChip>
                </div>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDrawer" />
            </div>
            
            @* Customer Info *@
            <MudPaper Class="drawer-section" Elevation="0">
                <MudText Typo="Typo.overline">CLIENTE</MudText>
                <div class="customer-info">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                    <span>@_selectedQuote.CustomerName</span>
                </div>
                <div class="customer-info">
                    <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" />
                    <a href="mailto:@_selectedQuote.CustomerEmail">@_selectedQuote.CustomerEmail</a>
                </div>
                @if (!string.IsNullOrEmpty(_selectedQuote.CustomerPhone))
                {
                    <div class="customer-info">
                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                        <a href="tel:@_selectedQuote.CustomerPhone">@_selectedQuote.CustomerPhone</a>
                    </div>
                }
            </MudPaper>
            
            @* Service & Description *@
            <MudPaper Class="drawer-section" Elevation="0">
                <MudText Typo="Typo.overline">SERVICIO SOLICITADO</MudText>
                <MudText Typo="Typo.subtitle1">@_selectedQuote.Service?.Name</MudText>
                @if (!string.IsNullOrEmpty(_selectedQuote.Description))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        "@_selectedQuote.Description"
                    </MudText>
                }
            </MudPaper>
            
            @* Quick Actions *@
            <MudPaper Class="drawer-section" Elevation="0">
                <MudText Typo="Typo.overline">ACCIONES</MudText>
                <div class="quick-actions">
                    @if (_selectedQuote.Status == QuoteStatus.New)
                    {
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="@(() => ChangeStatus(QuoteStatus.InReview))">
                            Iniciar Revisión
                        </MudButton>
                    }
                    @if (_selectedQuote.Status == QuoteStatus.InReview)
                    {
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.Send"
                                   OnClick="@(() => ChangeStatus(QuoteStatus.Quoted))">
                            Marcar como Cotizada
                        </MudButton>
                    }
                    @if (_selectedQuote.Status == QuoteStatus.Quoted || _selectedQuote.Status == QuoteStatus.Negotiation)
                    {
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   OnClick="@(() => ChangeStatus(QuoteStatus.Won))">
                            Marcar Ganada
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Cancel"
                                   OnClick="OpenLostDialog">
                            Marcar Perdida
                        </MudButton>
                    }
                    @if (_selectedQuote.Status != QuoteStatus.Won && _selectedQuote.Status != QuoteStatus.Archived)
                    {
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Default"
                                   StartIcon="@Icons.Material.Filled.CalendarMonth"
                                   OnClick="ConvertToAppointment">
                            Convertir a Cita
                        </MudButton>
                    }
                </div>
            </MudPaper>
            
            @* Timeline *@
            <MudPaper Class="drawer-section timeline-section" Elevation="0">
                <MudText Typo="Typo.overline">HISTORIAL</MudText>
                @if (_timeline.Any())
                {
                    <div class="timeline">
                        @foreach (var activity in _timeline)
                        {
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <span class="timeline-desc">@activity.Description</span>
                                    <span class="timeline-date">@activity.CreatedAt.ToString("dd/MM HH:mm")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Sin actividad registrada</MudText>
                }
            </MudPaper>
            
            @* Add Note *@
            <MudPaper Class="drawer-section" Elevation="0">
                <MudTextField @bind-Value="_newNote"
                              Label="Agregar nota"
                              Variant="Variant.Outlined"
                              Lines="2"
                              Class="mb-2" />
                <MudButton Variant="Variant.Outlined" 
                           Size="Size.Small"
                           OnClick="AddNote"
                           Disabled="@(string.IsNullOrWhiteSpace(_newNote))">
                    Guardar nota
                </MudButton>
            </MudPaper>
        </div>
    }
</MudDrawer>

@code {
    private List<QuoteRequest> _quotes = new();
    private List<QuoteRequest> _filteredQuotes = new();
    private List<Service> _services = new();
    private List<Activity> _timeline = new();
    private Dictionary<QuoteStatus, int> _statusCounts = new();
    
    private bool _isLoading = true;
    private bool _drawerOpen = false;
    private QuoteRequest? _selectedQuote;
    
    // Filters
    private string _searchTerm = "";
    private Guid? _selectedServiceId;
    private QuoteStatus? _selectedStatus;
    private string _dateRange = "all";
    
    private string _newNote = "";
    private int _activeTab = 0;
    
    // TODO: Get from auth
    private Guid _currentOrgId = Guid.Empty;
    private Guid _currentCardId = Guid.Empty;
    
    // Dashboard state
    private bool _dashLoading = false;
    private bool _dashLoaded = false;
    private string _dashRange = "30";
    private Guid? _dashCardId;
    private Dictionary<string, int> _dashFunnel = new();
    private List<DailyEventCount> _dashDaily = new();
    private QuoteMetadataAggregation _dashMeta = new();
    private List<CardFilterItem> _dashCards = new();
    private double _dashConversion;
    private double _dashCtr;
    
    protected override async Task OnInitializedAsync()
    {
        // No auth yet — derive org/card from the most recent quote, then fallback to any active card
        var latestQuote = await DbContext.QuoteRequests
            .OrderByDescending(q => q.CreatedAt)
            .FirstOrDefaultAsync();

        if (latestQuote != null)
        {
            _currentOrgId = latestQuote.OrganizationId;
            _currentCardId = latestQuote.CardId;
        }
        else
        {
            var card = await DbContext.Cards.FirstOrDefaultAsync(c => c.IsActive);
            if (card != null)
            {
                _currentOrgId = card.OrganizationId;
                _currentCardId = card.Id;
            }
        }

        Console.WriteLine($"[Quotes] Resolved OrgId={_currentOrgId}, CardId={_currentCardId}");
        
        await LoadServices();
        await LoadQuotes();
    }
    
    private async Task LoadServices()
    {
        _services = await DbContext.Services
            .Where(s => s.CardId == _currentCardId && s.IsActive)
            .OrderBy(s => s.DisplayOrder)
            .ToListAsync();
    }
    
    private async Task LoadQuotes()
    {
        _isLoading = true;
        StateHasChanged();
        
        _quotes = await DbContext.QuoteRequests
            .Include(q => q.Service)
            .Where(q => q.OrganizationId == _currentOrgId)
            .Where(q => q.Status != QuoteStatus.Archived)
            .OrderByDescending(q => q.CreatedAt)
            .ToListAsync();

        Console.WriteLine($"[Quotes] LoadQuotes: OrgId={_currentOrgId}, found {_quotes.Count} quotes");
        
        _statusCounts = _quotes
            .GroupBy(q => q.Status)
            .ToDictionary(g => g.Key, g => g.Count());
        
        ApplyFilters();
        
        _isLoading = false;
        StateHasChanged();
    }
    
    private void ApplyFilters()
    {
        var query = _quotes.AsEnumerable();
        
        if (_selectedStatus.HasValue)
            query = query.Where(q => q.Status == _selectedStatus.Value);
        
        if (_selectedServiceId.HasValue)
            query = query.Where(q => q.ServiceId == _selectedServiceId.Value);
        
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            var term = _searchTerm.ToLower();
            query = query.Where(q => 
                q.CustomerName.ToLower().Contains(term) ||
                q.CustomerEmail.ToLower().Contains(term) ||
                (q.RequestNumber?.ToLower().Contains(term) ?? false));
        }
        
        if (_dateRange != "all")
        {
            var now = DateTime.UtcNow;
            query = _dateRange switch
            {
                "today" => query.Where(q => q.CreatedAt.Date == now.Date),
                "week" => query.Where(q => q.CreatedAt >= now.AddDays(-7)),
                "month" => query.Where(q => q.CreatedAt.Month == now.Month && q.CreatedAt.Year == now.Year),
                _ => query
            };
        }
        
        _filteredQuotes = query.ToList();
    }
    
    private void FilterByStatus(QuoteStatus? status)
    {
        _selectedStatus = status;
        ApplyFilters();
    }
    
    private void SearchChanged(string value)
    {
        _searchTerm = value;
        ApplyFilters();
    }
    
    private void ClearFilters()
    {
        _searchTerm = "";
        _selectedServiceId = null;
        _selectedStatus = null;
        _dateRange = "all";
        ApplyFilters();
    }
    
    private async Task OpenDetails(QuoteRequest quote)
    {
        _selectedQuote = quote;
        _timeline = await QuoteService.GetTimelineAsync(quote.Id);
        _drawerOpen = true;
    }
    
    private void CloseDrawer()
    {
        _drawerOpen = false;
        _selectedQuote = null;
        _newNote = "";
    }
    
    private async Task ChangeStatus(QuoteStatus newStatus)
    {
        if (_selectedQuote == null) return;
        
        await QuoteService.UpdateStatusAsync(_selectedQuote.Id, newStatus);
        _selectedQuote.Status = newStatus;
        _timeline = await QuoteService.GetTimelineAsync(_selectedQuote.Id);
        
        Snackbar.Add($"Estado actualizado a: {GetStatusLabel(newStatus)}", Severity.Success);
        await LoadQuotes();
    }
    
    private async Task OpenLostDialog()
    {
        var dialog = await DialogService.ShowMessageBox(
            "Marcar como Perdida",
            "¿Cuál fue la razón de pérdida?",
            yesText: "Confirmar",
            cancelText: "Cancelar");
        
        if (dialog == true && _selectedQuote != null)
        {
            await QuoteService.UpdateStatusAsync(_selectedQuote.Id, QuoteStatus.Lost, "Cliente no interesado");
            await LoadQuotes();
            CloseDrawer();
        }
    }
    
    private async Task ConvertToAppointment()
    {
        Snackbar.Add("Función de conversión próximamente", Severity.Info);
    }
    
    private async Task AddNote()
    {
        if (_selectedQuote == null || string.IsNullOrWhiteSpace(_newNote)) return;
        
        await QuoteService.AddNoteAsync(_selectedQuote.Id, _newNote);
        _newNote = "";
        _timeline = await QuoteService.GetTimelineAsync(_selectedQuote.Id);
        
        Snackbar.Add("Nota agregada", Severity.Success);
    }
    
    private Color GetStatusColor(QuoteStatus status) => status switch
    {
        QuoteStatus.New => Color.Info,
        QuoteStatus.InReview => Color.Warning,
        QuoteStatus.NeedsInfo => Color.Dark,
        QuoteStatus.Quoted => Color.Secondary,
        QuoteStatus.Negotiation => Color.Primary,
        QuoteStatus.Won => Color.Success,
        QuoteStatus.Lost => Color.Error,
        QuoteStatus.Archived => Color.Default,
        _ => Color.Default
    };
    
    private string GetStatusLabel(QuoteStatus status) => status switch
    {
        QuoteStatus.New => "Nueva",
        QuoteStatus.InReview => "En revisión",
        QuoteStatus.NeedsInfo => "Falta info",
        QuoteStatus.Quoted => "Cotizada",
        QuoteStatus.Negotiation => "Negociación",
        QuoteStatus.Won => "Ganada",
        QuoteStatus.Lost => "Perdida",
        QuoteStatus.Archived => "Archivada",
        _ => status.ToString()
    };
    
    private (string Label, Color Color) GetSlaStatus(QuoteRequest quote)
    {
        if (quote.SlaDeadlineAt == null)
            return ("—", Color.Default);

        var remaining = quote.SlaDeadlineAt.Value - DateTime.UtcNow;

        if (remaining.TotalHours < 0)
            return ("Vencido", Color.Error);
        if (remaining.TotalHours < 2)
            return ($"{(int)remaining.TotalMinutes}m", Color.Warning);
        if (remaining.TotalHours < 24)
            return ($"{(int)remaining.TotalHours}h", Color.Info);

        return ($"{(int)remaining.TotalDays}d", Color.Success);
    }

    private (string Label, Color Color) GetQuoteOrigin(QuoteRequest quote)
    {
        // Check CustomFieldsJson for source
        if (!string.IsNullOrEmpty(quote.CustomFieldsJson))
        {
            try
            {
                var fields = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(quote.CustomFieldsJson);
                if (fields.TryGetProperty("source", out var src) && src.GetString() == "PublicCard")
                    return ("Tarjeta Pública", Color.Info);
            }
            catch { }
        }

        if (quote.Service != null)
            return (quote.Service.Name, Color.Primary);

        return ("Manual", Color.Default);
    }

    private string GetStatusBadgeClass(QuoteStatus status) => status switch
    {
        QuoteStatus.New => "status-new",
        QuoteStatus.InReview => "status-inreview",
        QuoteStatus.NeedsInfo => "status-needsinfo",
        QuoteStatus.Quoted => "status-quoted",
        QuoteStatus.Negotiation => "status-negotiation",
        QuoteStatus.Won => "status-won",
        QuoteStatus.Lost => "status-lost",
        QuoteStatus.Archived => "status-archived",
        _ => ""
    };

    private string GetSlaBadgeClass(Color color) => color switch
    {
        Color.Error => "sla-error",
        Color.Warning => "sla-warning",
        Color.Info => "sla-info",
        Color.Success => "sla-success",
        _ => ""
    };

    // ═══════════════════════════════════════════════════════════════
    // DASHBOARD TAB METHODS
    // ═══════════════════════════════════════════════════════════════

    private async Task OnTabChanged(int index)
    {
        _activeTab = index;
        if (index == 1 && !_dashLoaded)
        {
            _dashCards = await AnalyticsService.GetCardsWithQuoteEventsAsync();
            await LoadDashboardData();
        }
    }

    private async Task OnDashRangeChanged(string value)
    {
        _dashRange = value ?? "30";
        await LoadDashboardData();
    }

    private async Task OnDashCardChanged(Guid? value)
    {
        _dashCardId = value;
        await LoadDashboardData();
    }

    private (DateTime from, DateTime to) GetDashDateRange()
    {
        var to = DateTime.UtcNow;
        var from = _dashRange switch
        {
            "7" => to.AddDays(-7),
            "15" => to.AddDays(-15),
            _ => to.AddDays(-30)
        };
        return (from, to);
    }

    private async Task LoadDashboardData()
    {
        _dashLoading = true;
        StateHasChanged();

        var (from, to) = GetDashDateRange();

        _dashFunnel = await AnalyticsService.GetQuoteFunnelAsync(from, to, _dashCardId);
        _dashDaily = await AnalyticsService.GetDailyQuoteEventsAsync(from, to, _dashCardId);
        _dashMeta = await AnalyticsService.GetQuoteMetadataAsync(from, to, _dashCardId);

        var views = _dashFunnel.GetValueOrDefault("page_view", 0);
        var success = _dashFunnel.GetValueOrDefault("quote_submit_success", 0);
        var ctaClicks = _dashFunnel.GetValueOrDefault("quote_cta_click", 0);
        _dashConversion = views > 0 ? (double)success / views * 100 : 0;
        _dashCtr = views > 0 ? (double)ctaClicks / views * 100 : 0;

        _dashLoading = false;
        _dashLoaded = true;
        StateHasChanged();

        await Task.Delay(50);
        await RenderDashCharts();
    }

    private async Task RenderDashCharts()
    {
        try
        {
            // 1. Funnel
            await JSRuntime.InvokeVoidAsync("EChartsAnalytics.renderFunnel", "dash-chart-funnel", new
            {
                labels = new[] { "Vistas", "Click CTA", "Modal abierto", "Inicio form", "Enviados" },
                values = new[]
                {
                    _dashFunnel.GetValueOrDefault("page_view", 0),
                    _dashFunnel.GetValueOrDefault("quote_cta_click", 0),
                    _dashFunnel.GetValueOrDefault("quote_modal_open", 0),
                    _dashFunnel.GetValueOrDefault("quote_form_start", 0),
                    _dashFunnel.GetValueOrDefault("quote_submit_success", 0)
                }
            });

            // 2. Time Series
            var (from, to) = GetDashDateRange();
            var allDates = Enumerable.Range(0, (int)(to - from).TotalDays)
                .Select(d => from.AddDays(d).Date)
                .ToList();

            var viewsByDay = _dashDaily.Where(e => e.EventType == "page_view").ToDictionary(e => e.Date.Date, e => e.Count);
            var successByDay = _dashDaily.Where(e => e.EventType == "quote_submit_success").ToDictionary(e => e.Date.Date, e => e.Count);

            await JSRuntime.InvokeVoidAsync("EChartsAnalytics.renderTimeSeries", "dash-chart-timeseries", new
            {
                dates = allDates.Select(d => d.ToString("dd/MM")).ToArray(),
                seriesNames = new[] { "Vistas", "Cotizaciones enviadas" },
                series = new object[]
                {
                    new { name = "Vistas", data = allDates.Select(d => viewsByDay.GetValueOrDefault(d, 0)).ToArray() },
                    new { name = "Cotizaciones enviadas", data = allDates.Select(d => successByDay.GetValueOrDefault(d, 0)).ToArray() }
                }
            });

            // 3. Status Bars
            var statusLabels = new Dictionary<string, string>
            {
                ["New"] = "Nuevas", ["InReview"] = "En revisión", ["NeedsInfo"] = "Necesita info",
                ["Quoted"] = "Cotizada", ["Negotiation"] = "Negociación", ["Won"] = "Ganada",
                ["Lost"] = "Perdida", ["Archived"] = "Archivada"
            };
            var statusData = _dashMeta.StatusBreakdown.Where(kvp => kvp.Value > 0).OrderByDescending(kvp => kvp.Value).ToList();
            if (statusData.Count > 0)
            {
                await JSRuntime.InvokeVoidAsync("EChartsAnalytics.renderStackedBars", "dash-chart-status", new
                {
                    labels = statusData.Select(s => statusLabels.GetValueOrDefault(s.Key, s.Key)).ToArray(),
                    values = statusData.Select(s => s.Value).ToArray(),
                    keys = statusData.Select(s => s.Key).ToArray()
                });
            }

            // 4. Preferred Contact Pie
            if (_dashMeta.PreferredContactBreakdown.Count > 0)
            {
                await JSRuntime.InvokeVoidAsync("EChartsAnalytics.renderPie", "dash-chart-contact", new
                {
                    labels = _dashMeta.PreferredContactBreakdown.Keys.ToArray(),
                    values = _dashMeta.PreferredContactBreakdown.Values.ToArray()
                });
            }

            // 5. Deadline Horizontal Bar
            if (_dashMeta.DeadlineBreakdown.Count > 0)
            {
                await JSRuntime.InvokeVoidAsync("EChartsAnalytics.renderHorizontalBar", "dash-chart-deadline", new
                {
                    labels = _dashMeta.DeadlineBreakdown.Keys.ToArray(),
                    values = _dashMeta.DeadlineBreakdown.Values.ToArray()
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard chart rendering error: {ex.Message}");
        }
    }
}

<style>
    /* ═══════════════ GLOBAL OVERFLOW CONTAINMENT ═══════════════ */
    .quotes-container {
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
    }

    .quotes-header,
    .mobile-toolbar,
    .status-cards,
    .filters-bar {
        max-width: 100%;
        box-sizing: border-box;
    }

    /* ═══════════════ VISIBILITY TOGGLES ═══════════════ */
    .mobile-only, .quotes-mobile-view { display: none; }
    .desktop-only, .quotes-desktop-view { display: block; }

    /* ═══════════════ MOBILE TOOLBAR ═══════════════ */
    .mobile-toolbar {
        display: none;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        margin-bottom: 12px;
    }

    .toolbar-left {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }

    .toolbar-title {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: var(--mud-palette-text-primary);
    }

    .toolbar-count {
        font-size: 0.875rem;
        color: #9CA3AF;
        background: #162234;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
    }

    .btn-refresh-mobile {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--mud-palette-text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-refresh-mobile:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--mud-palette-text-primary);
    }

    /* Header */
    .quotes-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .page-title {
        margin-bottom: 0.25rem;
    }

    /* Status Cards */
    .status-cards {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        -webkit-overflow-scrolling: touch;
    }

    .status-card {
        flex: 0 0 auto;
        min-width: 100px;
        padding: 1rem;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .status-card:hover {
        background: rgba(255,255,255,0.08);
        transform: translateY(-2px);
    }

    .status-card-active {
        border-color: var(--mud-palette-primary);
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
    }

    .status-count {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    /* Filters Bar */
    .filters-bar {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
    }

    /* Table */
    .quotes-table {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        overflow: hidden;
    }

    .request-number {
        font-family: monospace;
        font-weight: 600;
        color: var(--mud-palette-primary);
    }

    .customer-cell {
        display: flex;
        flex-direction: column;
    }

    .customer-name {
        font-weight: 500;
    }

    .customer-email {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
    }

    .service-name {
        font-size: 0.9rem;
    }

    .date-cell {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        text-align: center;
    }

    /* ═══════════════ QUOTE CARDS (MOBILE) ═══════════════ */
    .quotes-cards-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .quote-card {
        background: linear-gradient(135deg, rgba(22, 34, 52, 0.9) 0%, rgba(17, 24, 39, 0.95) 100%);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(46, 62, 87, 0.5);
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }

    .quote-card:hover {
        border-color: rgba(99, 102, 241, 0.4);
        background: linear-gradient(135deg, rgba(26, 40, 60, 0.95) 0%, rgba(20, 28, 46, 0.98) 100%);
    }

    .quote-card:active {
        transform: scale(0.99);
    }

    .quote-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .quote-request-number {
        font-family: monospace;
        font-weight: 600;
        color: #6366F1;
        font-size: 0.875rem;
    }

    .quote-status-badge {
        padding: 0.1875rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .quote-status-badge.status-new {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        color: white;
    }

    .quote-status-badge.status-inreview {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        color: white;
    }

    .quote-status-badge.status-needsinfo {
        background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
        color: white;
    }

    .quote-status-badge.status-quoted {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        color: white;
    }

    .quote-status-badge.status-negotiation {
        background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
        color: white;
    }

    .quote-status-badge.status-won {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
    }

    .quote-status-badge.status-lost {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
    }

    .quote-status-badge.status-archived {
        background: linear-gradient(135deg, #4B5563 0%, #374151 100%);
        color: white;
    }

    .quote-card-body {
        margin-bottom: 0.75rem;
    }

    .quote-customer-name {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
        color: var(--mud-palette-text-primary);
    }

    .quote-customer-email {
        font-size: 0.75rem;
        color: #9CA3AF;
        display: block;
        margin-bottom: 0.375rem;
    }

    .quote-service-name {
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.7);
        display: block;
        padding-top: 0.375rem;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .quote-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 0.5rem;
    }

    .quote-date {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        color: #9CA3AF;
    }

    .quote-date .mud-icon-root {
        font-size: 0.875rem;
        opacity: 0.7;
    }

    .quote-sla-badge {
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 600;
    }

    .quote-sla-badge.sla-error {
        background: rgba(239, 68, 68, 0.15);
        color: #EF4444;
    }

    .quote-sla-badge.sla-warning {
        background: rgba(245, 158, 11, 0.15);
        color: #F59E0B;
    }

    .quote-sla-badge.sla-info {
        background: rgba(59, 130, 246, 0.15);
        color: #3B82F6;
    }

    .quote-sla-badge.sla-success {
        background: rgba(16, 185, 129, 0.15);
        color: #10B981;
    }

    .quote-card-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .quote-quick-actions {
        display: flex;
        gap: 0.375rem;
    }

    .quote-action-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 1px solid #233044;
        background: #111827;
        color: #9CA3AF;
        text-decoration: none;
        transition: all 0.15s ease;
    }

    .quote-action-btn:hover {
        border-color: #2E3E57;
        color: var(--mud-palette-text-primary);
        transform: scale(1.1);
    }

    .quote-action-btn.phone:hover {
        background: rgba(99, 102, 241, 0.15);
        border-color: #6366F1;
        color: #818CF8;
    }

    .quote-action-btn.whatsapp {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.3);
        color: #34D399;
    }

    .quote-action-btn.whatsapp:hover {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10B981;
        color: #6EE7B7;
    }

    .quote-action-btn.email:hover {
        background: rgba(59, 130, 246, 0.15);
        border-color: #3B82F6;
        color: #60A5FA;
    }

    .quote-card-chevron {
        color: var(--mud-palette-text-disabled);
        transition: transform 0.15s ease;
    }

    .quote-card:hover .quote-card-chevron {
        color: var(--mud-palette-text-secondary);
        transform: translateX(2px);
    }

    /* Drawer */
    .drawer-content {
        padding: 1.5rem;
        height: 100%;
        overflow-y: auto;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .drawer-title {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .drawer-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
    }

    .customer-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .customer-info a {
        color: var(--mud-palette-primary);
        text-decoration: none;
    }

    .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    /* Timeline */
    .timeline {
        margin-top: 0.75rem;
    }

    .timeline-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.5rem 0;
    }

    .timeline-dot {
        width: 8px;
        height: 8px;
        background: var(--mud-palette-primary);
        border-radius: 50%;
        margin-top: 6px;
        flex-shrink: 0;
    }

    .timeline-content {
        display: flex;
        flex-direction: column;
    }

    .timeline-desc {
        font-size: 0.9rem;
    }

    .timeline-date {
        font-size: 0.75rem;
        color: var(--mud-palette-text-secondary);
    }

    /* ═══════════════ DASHBOARD TAB STYLES ═══════════════ */
    .quotes-tabs {
        margin-bottom: 1rem;
    }

    .qa-filters {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        padding: 12px 16px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
    }

    .qa-filter-chips { display: flex; gap: 8px; }
    .qa-card-filter { min-width: 220px; }
    .qa-loading { display: flex; justify-content: center; padding: 80px 0; }

    .qa-kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
    }

    .qa-kpi {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .qa-kpi:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.1);
    }

    .qa-kpi-highlight {
        background: rgba(139,92,246,0.08);
        border-color: rgba(139,92,246,0.2);
    }

    .qa-kpi-icon {
        width: 40px; height: 40px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }

    .qa-kpi-data { display: flex; flex-direction: column; }
    .qa-kpi-value { font-size: 1.4rem; font-weight: 700; color: white; line-height: 1.2; }
    .qa-kpi-label { font-size: 0.75rem; color: rgba(255,255,255,0.5); font-weight: 500; }

    .qa-charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .qa-chart-wide { grid-column: 1 / -1; }

    .qa-chart-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 16px;
    }

    .qa-chart-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .qa-chart-container { width: 100%; }

    /* ═══════════════ TABLET BREAKPOINT (601px - 1024px) ═══════════════ */
    @@media (max-width: 1024px) and (min-width: 601px) {
        .desktop-only { display: none !important; }
        .quotes-desktop-view { display: none !important; }
        .quotes-mobile-view { display: block !important; }
        .mobile-toolbar { display: flex !important; }

        /* Hide the filters bar on tablet - use mobile view */
        .filters-bar { display: none !important; }

        .quotes-cards-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .status-cards {
            gap: 0.75rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .status-card {
            min-width: 85px;
            flex: 0 0 auto;
            padding: 0.75rem;
        }

        .status-count {
            font-size: 1.5rem;
        }

        ::deep .quote-drawer {
            width: 380px !important;
        }
    }

    /* ═══════════════ MOBILE BREAKPOINT (max 600px) ═══════════════ */
    @@media (max-width: 600px) {
        /* Hide desktop elements */
        .desktop-only, .quotes-desktop-view { display: none !important; }
        .mobile-only, .quotes-mobile-view { display: block !important; }
        .mobile-toolbar { display: flex !important; }

        .quotes-header.desktop-only {
            display: none !important;
        }

        /* Force container to respect viewport */
        .quotes-container {
            max-width: 100% !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
            overflow-x: hidden !important;
        }

        /* MudContainer override */
        ::deep .mud-container-maxwidth-lg {
            max-width: 100% !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Hide filters bar on mobile - use mobile toolbar instead */
        .filters-bar {
            display: none !important;
        }

        /* Status cards - horizontal scroll */
        .status-cards {
            display: flex !important;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap !important;
            max-width: 100%;
            padding-bottom: 4px;
        }

        .status-card {
            flex: 0 0 auto;
            min-width: 75px;
            padding: 0.625rem;
        }

        .status-count {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .status-card .status-chip {
            font-size: 0.625rem !important;
        }

        /* Quotes cards container */
        .quotes-cards-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            max-width: 100%;
        }

        /* Ensure all cards stay within bounds */
        .quote-card {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Drawer full width */
        ::deep .quote-drawer {
            width: 100% !important;
        }

        .drawer-content {
            padding: 1rem;
            padding-bottom: 100px;
        }

        .drawer-header {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 30, 0.98);
            z-index: 10;
            padding: 12px 0;
            margin: 0 0 1rem 0;
        }

        .quick-actions {
            flex-direction: column;
            gap: 8px;
        }

        .quick-actions .mud-button {
            width: 100%;
        }

        .qa-charts-grid { grid-template-columns: 1fr; }
        .qa-kpis { grid-template-columns: repeat(2, 1fr); }
        .qa-filters { flex-direction: column; align-items: stretch; }
    }

    /* ═══════════════ SMALL MOBILE (max 430px) ═══════════════ */
    @@media (max-width: 429px) {
        .quote-card {
            padding: 0.875rem;
        }

        .quote-customer-name {
            font-size: 0.9375rem;
        }

        .quote-action-btn {
            width: 32px;
            height: 32px;
        }
    }
</style>
