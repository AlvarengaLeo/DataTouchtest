@page "/templates"
@attribute [Authorize]
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject DataTouch.Web.Services.AuthService AuthService
@inject DataTouch.Infrastructure.Data.DataTouchDbContext DbContext
@using Microsoft.EntityFrameworkCore

<PageTitle>Elegir Plantilla - DataTouch</PageTitle>

<div class="templates-module @(_navDirection)" @onkeydown="HandleKeyDown" tabindex="0">
    <header class="module-header">
        <h1 class="header-title">Elige el diseÃ±o de tu tarjeta</h1>
        <p class="header-subtitle">Selecciona ahora. Personaliza los detalles despuÃ©s.</p>
    </header>

    <section class="carousel-section">
        <button class="nav-arrow nav-arrow--left" @onclick="NavigatePrev" aria-label="Plantilla anterior">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
        </button>

        <div class="carousel-container">
            <div class="carousel-track">
                @foreach (var pos in _visiblePositions)
                {
                    var template = GetTemplateAt(pos);
                    var isActive = pos == 0;
                    <div class="carousel-item @GetStateClass(pos)" style="@GetItemStyle(pos)" @onclick="() => HandleCardClick(pos)">
                        <div class="page-wrapper">
                            <div class="iphone-frame">
                                <div class="dynamic-island"></div>
                                <div class="iphone-screen" @onwheel:stopPropagation="true" @onwheel="e => HandlePhoneScroll(e)">
                                    <div class="screen-content">
                                        @if (template.IsPortfolio)
                                        {
                                            @* Portfolio Creative Full Preview - Matches Public Card 1:1 *@
                                            <div class="portfolio-preview-full">
                                                @* Hero Section *@
                                                <div class="pp-hero">
                                                    <div class="pp-avatar">
                                                        <span>@GetUserInitials()</span>
                                                    </div>
                                                    <h3 class="pp-name">@GetUserDisplayName()</h3>
                                                    <p class="pp-title">@(_userCard?.Title ?? "Tu Cargo")</p>
                                                    <p class="pp-company"><span class="pp-company-icon">ğŸ¢</span> @(_userCard?.CompanyName ?? _userCard?.Organization?.Name ?? "Tu Empresa")</p>
                                                    <p class="pp-bio">@(_userCard?.Bio ?? "Tu biografÃ­a aparecerÃ¡ aquÃ­. Describe tu experiencia y especialidades.")</p>
                                                    
                                                    @* Social Icons *@
                                                    <div class="pp-social-row">
                                                        <span class="pp-social-icon">in</span>
                                                        <span class="pp-social-icon">ğŸ“·</span>
                                                        <span class="pp-social-icon">ğ•</span>
                                                        <span class="pp-social-icon">â–¶</span>
                                                    </div>
                                                </div>

                                                @* Status Chips *@
                                                <div class="pp-chips">
                                                    <span class="pp-chip"><span class="pp-chip-dot"></span> Disponible</span>
                                                    <span class="pp-chip">â± Responde &lt; 1h</span>
                                                    <span class="pp-chip">ğŸ“ El Salvador</span>
                                                </div>

                                                @* Mi Trabajo Section with REAL images *@
                                                <div class="pp-work-section">
                                                    <h4 class="pp-section-title">MI TRABAJO</h4>
                                                    <div class="pp-gallery-grid">
                                                        <div class="pp-gallery-item">
                                                            <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=400&fit=crop" alt="Portfolio 1" />
                                                        </div>
                                                        <div class="pp-gallery-item">
                                                            <img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=400&h=400&fit=crop" alt="Portfolio 2" />
                                                        </div>
                                                        <div class="pp-gallery-item">
                                                            <img src="https://images.unsplash.com/photo-1433086966358-54859d0ed716?w=400&h=400&fit=crop" alt="Portfolio 3" />
                                                        </div>
                                                        <div class="pp-gallery-item">
                                                            <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=400&h=400&fit=crop" alt="Portfolio 4" />
                                                        </div>
                                                    </div>
                                                </div>

                                                @* CTAs *@
                                                <div class="pp-cta-section">
                                                    <button class="pp-cta-primary">ğŸ‘¤ Guardar Contacto</button>
                                                    <div class="pp-cta-row">
                                                        <button class="pp-cta-secondary pp-whatsapp">ğŸ’¬ WhatsApp</button>
                                                        <button class="pp-cta-secondary pp-call">ğŸ“ Llamar</button>
                                                        <button class="pp-cta-secondary pp-email">ğŸ“§ Email</button>
                                                    </div>
                                                </div>

                                                @* Contact Form *@
                                                <div class="pp-form-section">
                                                    <h4 class="pp-form-title">Â¿Quieres que te contacte?</h4>
                                                    <p class="pp-form-subtitle">DÃ©jame tus datos y te respondo pronto</p>
                                                    
                                                    <div class="pp-form-field">
                                                        <label>ğŸ‘¤ Nombre completo *</label>
                                                        <div class="pp-input">Juan PÃ©rez</div>
                                                    </div>
                                                    <div class="pp-form-field">
                                                        <label>ğŸ“§ Correo electrÃ³nico *</label>
                                                        <div class="pp-input">tu@email.com</div>
                                                    </div>
                                                    <div class="pp-form-field">
                                                        <label>ğŸ“± TelÃ©fono *</label>
                                                        <div class="pp-phone-row">
                                                            <div class="pp-country-code">SV +503</div>
                                                            <div class="pp-input pp-phone-input">7000 0000</div>
                                                        </div>
                                                    </div>
                                                    <div class="pp-form-field">
                                                        <label>ğŸ’¬ Mensaje (opcional)</label>
                                                        <div class="pp-textarea">Â¿En quÃ© puedo ayudarte?</div>
                                                    </div>
                                                    <button class="pp-submit-btn">â¤ Enviar mensaje</button>
                                                </div>

                                                @* Footer *@
                                                <div class="pp-footer">
                                                    <span>Powered by <strong>DataTouch</strong></span>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            @* Standard Template Preview *@
                                            <div class="preview-hero" style="background: @template.HeroGradient;">
                                                <div class="preview-avatar"><span>S</span></div>
                                                <h3 class="preview-name">Sarah Johnson</h3>
                                                <p class="preview-title">Marketing Director</p>
                                                <p class="preview-company">Nurtured â€¢ Devoted</p>
                                            </div>
                                            <div class="preview-actions">
                                                <button class="action-btn">ğŸ“</button>
                                                <button class="action-btn">ğŸ“¹</button>
                                                <button class="action-btn">ğŸ’¬</button>
                                                <button class="action-btn">âœ‰ï¸</button>
                                            </div>
                                            <div class="preview-section">
                                                <h4 class="section-title">Acerca de</h4>
                                                <p class="section-text">Profesional de marketing con mÃ¡s de 10 aÃ±os en estrategia digital y desarrollo de marca.</p>
                                            </div>
                                            <div class="preview-section">
                                                <h4 class="section-title">Contacto</h4>
                                                <div class="contact-item">ğŸ“§ sarah.johnson@example.com</div>
                                                <div class="contact-item">ğŸ“± +1 (555) 123-4567</div>
                                            </div>
                                            <div class="preview-section">
                                                <h4 class="section-title">Enlaces</h4>
                                                <div class="link-btn">ğŸ”— Perfil de LinkedIn</div>
                                                <div class="link-btn">ğŸŒ Sitio Web Personal</div>
                                            </div>
                                        }
                                    </div>
                                    @if (isActive && !_hasScrolled)
                                    {
                                        <div class="scroll-hint"><span>Desliza para explorar</span></div>
                                    }
                                </div>
                                <div class="home-indicator"></div>
                            </div>
                            <div class="page-shadow"></div>
                        </div>
                        <div class="item-label">
                            <span class="item-name">@template.Name</span>
                            @if (isActive) { <span class="selected-badge">âœ“ Seleccionado</span> }
                        </div>
                    </div>
                }
            </div>
        </div>

        <button class="nav-arrow nav-arrow--right" @onclick="NavigateNext" aria-label="Siguiente plantilla">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        </button>
    </section>

    <footer class="decision-dock">
        <div class="dock-content">
            <div class="dock-info">
                <span class="dock-name">@SelectedTemplate?.Name</span>
                <span class="dock-desc">@SelectedTemplate?.Description</span>
            </div>
            <div class="dock-dots">
                @for (int i = 0; i < _templates.Count; i++)
                {
                    var idx = i;
                    <button class="dot @(idx == _activeIndex ? "dot--active" : "")" @onclick="() => GoToIndex(idx)"></button>
                }
            </div>
            <button class="cta-primary" @onclick="UseThisDesign">
                <span>Usar este diseÃ±o</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </footer>
</div>

<style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       3D BOOK PAGE TURN - PREMIUM ANIMATION SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .templates-module {
        /* Phone dimensions */
        --phone-width: clamp(260px, 22vw, 320px);
        --phone-height: clamp(540px, 65vh, 680px);
        --phone-radius: 52px;
        
        /* 3D Perspective */
        --perspective: 1600px;
        
        /* Page Turn Animation - REFINED */
        --page-turn-duration: 850ms;
        --page-turn-easing: cubic-bezier(0.16, 1, 0.3, 1); /* Heavy ease-out, organic deceleration */
        
        /* Spacing - Increased for openness */
        --spacing-adjacent: 1.1;
        --spacing-far: 1.65;
        
        /* Z-Depth - Enhanced separation */
        --z-active: 80px;
        --z-adjacent: -60px;
        --z-far: -140px;
        
        min-height: 100vh;
        padding: 80px 32px 24px;
        background: linear-gradient(165deg, #0a0d12 0%, #111720 50%, #0c1015 100%);
        display: flex;
        flex-direction: column;
        outline: none;
        overflow: hidden;
    }

    .module-header { text-align: left; margin-bottom: 20px; padding-left: 48px; }
    .header-title { font-size: 1.75rem; font-weight: 600; color: #f3f4f6; margin: 0 0 4px 0; }
    .header-subtitle { font-size: 0.925rem; color: #9ca3af; margin: 0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CAROUSEL - 3D PERSPECTIVE STAGE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .carousel-section {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        min-height: 500px;
        padding: 0 80px;
        perspective: var(--perspective);
        perspective-origin: center center;
    }

    .carousel-container {
        width: 100%;
        max-width: 1400px;
        display: flex;
        justify-content: center;
        transform-style: preserve-3d;
    }

    .carousel-track {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        height: calc(var(--phone-height) + 100px);
        width: 100%;
        transform-style: preserve-3d;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CAROUSEL ITEMS - BOOK PAGE BEHAVIOR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .carousel-item {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        transform-style: preserve-3d;
        transition: 
            transform var(--page-turn-duration) var(--page-turn-easing),
            opacity var(--page-turn-duration) var(--page-turn-easing);
        will-change: transform, opacity;
        cursor: pointer;
    }

    .page-wrapper {
        position: relative;
        transform-style: preserve-3d;
    }

    /* Dynamic page shadow during turn */
    .page-shadow {
        position: absolute;
        top: 5%;
        left: -20px;
        right: -20px;
        bottom: 5%;
        background: transparent;
        border-radius: var(--phone-radius);
        pointer-events: none;
        opacity: 0;
        transition: opacity var(--page-turn-duration) var(--page-turn-easing);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACTIVE STATE - CENTER HERO (100% SHARP - NO BLUR)
       Key fix: Override transform-style to FLAT to break 3D context
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .carousel-item--active {
        z-index: 50;
        /* CRITICAL: Override preserve-3d to flat - this breaks 3D blur */
        transform-style: flat !important;
        /* Simple 2D transform - NO scale to prevent interpolation blur */
        transform: translateX(0) translateY(0);
        opacity: 1;
        /* Ensure no filters */
        filter: none !important;
        -webkit-filter: none !important;
    }
    
    .carousel-item--active .page-wrapper {
        transform-style: flat !important;
    }
    
    .carousel-item--active .iphone-frame {
        transform-style: flat !important;
        filter: none !important;
        -webkit-filter: none !important;
        box-shadow: 
            0 4px 12px rgba(0,0,0,0.08),
            0 12px 40px rgba(0,0,0,0.12),
            0 32px 80px rgba(0,0,0,0.18),
            0 0 100px rgba(99, 102, 241, 0.15);
    }
    
    .carousel-item--active .iphone-screen {
        filter: none !important;
        -webkit-filter: none !important;
        backdrop-filter: none !important;
        overflow: hidden;
    }
    
    /* SCROLL FIX: Ensure screen-content can scroll */
    .carousel-item--active .screen-content {
        filter: none !important;
        -webkit-filter: none !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .carousel-item--active .screen-content::-webkit-scrollbar {
        display: none;
    }
    
    .carousel-item--active .portfolio-preview-full,
    .carousel-item--active .portfolio-preview-full * {
        filter: none !important;
        -webkit-filter: none !important;
        backdrop-filter: none !important;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LEFT PAGES - Turned/Stacked Behind (like read pages)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .carousel-item--adjacent-left {
        z-index: 30;
        transform-origin: right center;
        transform: 
            translateX(calc(-1 * var(--spacing-adjacent) * var(--phone-width))) 
            translateZ(var(--z-adjacent)) 
            rotateY(42deg) 
            scale(0.82);
        opacity: 0.50;
        filter: blur(0.8px) brightness(0.78);
    }

    .carousel-item--adjacent-left .page-shadow {
        opacity: 0.35;
        background: linear-gradient(to right, rgba(0,0,0,0.25), transparent);
    }

    .carousel-item--far-left {
        z-index: 15;
        transform-origin: right center;
        transform: 
            translateX(calc(-1 * var(--spacing-far) * var(--phone-width))) 
            translateZ(var(--z-far)) 
            rotateY(55deg) 
            scale(0.65);
        opacity: 0.20;
        filter: blur(1.5px) brightness(0.6);
        pointer-events: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RIGHT PAGES - Waiting to be turned (unread stack)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .carousel-item--adjacent-right {
        z-index: 30;
        transform-origin: left center;
        transform: 
            translateX(calc(var(--spacing-adjacent) * var(--phone-width))) 
            translateZ(var(--z-adjacent)) 
            rotateY(-42deg) 
            scale(0.82);
        opacity: 0.50;
        filter: blur(0.8px) brightness(0.78);
    }

    .carousel-item--adjacent-right .page-shadow {
        opacity: 0.35;
        background: linear-gradient(to left, rgba(0,0,0,0.25), transparent);
    }

    .carousel-item--far-right {
        z-index: 15;
        transform-origin: left center;
        transform: 
            translateX(calc(var(--spacing-far) * var(--phone-width))) 
            translateZ(var(--z-far)) 
            rotateY(-55deg) 
            scale(0.65);
        opacity: 0.20;
        filter: blur(1.5px) brightness(0.6);
        pointer-events: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DIRECTION-BASED PAGE TURN ANIMATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .nav-next .carousel-item--active {
        animation: pageEnterFromRight var(--page-turn-duration) var(--page-turn-easing) forwards;
    }

    .nav-prev .carousel-item--active {
        animation: pageEnterFromLeft var(--page-turn-duration) var(--page-turn-easing) forwards;
    }

    @@keyframes pageEnterFromRight {
        0% {
            transform: 
                translateX(calc(var(--spacing-adjacent) * var(--phone-width))) 
                translateZ(var(--z-adjacent)) 
                rotateY(-42deg) 
                scale(0.82);
            opacity: 0.50;
        }
        60% {
            transform: 
                translateX(calc(0.15 * var(--phone-width))) 
                translateZ(40px) 
                rotateY(-8deg) 
                scale(0.98);
            opacity: 0.92;
        }
        100% {
            /* CRITICAL: Pure 2D transform at end - no translateZ to avoid blur */
            transform: translateX(0) translateY(0);
            opacity: 1;
            filter: none;
        }
    }

    @@keyframes pageEnterFromLeft {
        0% {
            transform: 
                translateX(calc(-1 * var(--spacing-adjacent) * var(--phone-width))) 
                translateZ(var(--z-adjacent)) 
                rotateY(42deg) 
                scale(0.82);
            opacity: 0.50;
        }
        60% {
            transform: 
                translateX(calc(-0.15 * var(--phone-width))) 
                translateZ(40px) 
                rotateY(8deg) 
                scale(0.98);
            opacity: 0.92;
        }
        100% {
            /* CRITICAL: Pure 2D transform at end - no translateZ to avoid blur */
            transform: translateX(0) translateY(0);
            opacity: 1;
            filter: none;
        }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       iPHONE FRAME (unchanged)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .iphone-frame {
        width: var(--phone-width);
        height: var(--phone-height);
        background: linear-gradient(145deg, #2a2f3a, #1a1f28);
        border-radius: var(--phone-radius);
        padding: 10px;
        position: relative;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08), 0 30px 60px -15px rgba(0,0,0,0.5);
    }

    .dynamic-island {
        position: absolute;
        top: 18px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 28px;
        background: #0a0c10;
        border-radius: 20px;
        z-index: 20;
    }

    .iphone-screen {
        flex: 1;
        height: calc(100% - 10px);
        background: #0f1218;
        border-radius: calc(var(--phone-radius) - 10px);
        overflow: hidden;
        position: relative;
    }

    .screen-content {
        height: 100%;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .screen-content::-webkit-scrollbar { display: none; }

    .home-indicator {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36%;
        height: 4px;
        background: rgba(255,255,255,0.2);
        border-radius: 2px;
    }

    /* Preview content styles */
    .preview-hero { padding: 52px 20px 24px; text-align: center; }
    .preview-avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem; margin: 0 auto 12px; }
    .preview-name { font-size: 1.1rem; font-weight: 600; color: #f9fafb; margin: 0 0 4px 0; }
    .preview-title { font-size: 0.8rem; color: #d1d5db; margin: 0; }
    .preview-company { font-size: 0.7rem; color: #9ca3af; margin: 0; }
    .preview-actions { display: flex; justify-content: center; gap: 14px; padding: 16px 20px; }
    .action-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; }
    .preview-section { padding: 18px 20px; border-top: 1px solid rgba(255,255,255,0.06); }
    .section-title { font-size: 0.75rem; font-weight: 600; color: #9ca3af; margin: 0 0 10px 0; text-transform: uppercase; }
    .section-text { font-size: 0.8rem; color: #e5e7eb; margin: 0; line-height: 1.6; }
    .contact-item { font-size: 0.75rem; color: #d1d5db; padding: 8px 0; }
    .link-btn { font-size: 0.75rem; color: #a5b4fc; padding: 12px 16px; background: rgba(99,102,241,0.1); border-radius: 12px; margin-bottom: 8px; }
    .scroll-hint { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 10px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PORTFOLIO PREVIEW FULL - Matches Public Card 1:1
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .portfolio-preview-full {
        min-height: 100%;
        background: linear-gradient(180deg, #0d0a1a 0%, #1a1035 30%, #2d1b4e 60%, #1a1035 100%);
        padding: 20px 16px;
    }
    
    /* Hero Section */
    .pp-hero {
        text-align: center;
        padding-bottom: 16px;
    }
    
    .pp-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 50%, #7C3AED 100%);
        border: 3px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3), 0 0 30px rgba(139, 92, 246, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.75rem;
        margin: 0 auto 12px;
    }
    
    .pp-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #fff;
        margin: 0 0 4px;
    }
    
    .pp-title {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        margin: 0 0 6px;
    }
    
    .pp-company {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.5);
        margin: 0 0 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    
    .pp-company-icon {
        font-size: 0.65rem;
    }
    
    .pp-bio {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.85);
        line-height: 1.5;
        margin: 0 0 12px;
        max-width: 280px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Social Row */
    .pp-social-row {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .pp-social-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: rgba(255,255,255,0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: rgba(255,255,255,0.7);
    }
    
    /* Status Chips */
    .pp-chips {
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 16px;
    }
    
    .pp-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(255,255,255,0.06);
        border-radius: 14px;
        font-size: 0.6rem;
        color: rgba(255,255,255,0.7);
        border: 1px solid rgba(255,255,255,0.08);
    }
    
    .pp-chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #22C55E;
        box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
    }
    
    /* Mi Trabajo Section */
    .pp-work-section {
        border-top: 1px solid rgba(139, 92, 246, 0.15);
        padding-top: 14px;
        margin-bottom: 14px;
    }
    
    .pp-section-title {
        font-size: 0.6rem;
        font-weight: 600;
        color: rgba(255,255,255,0.5);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0 0 10px;
        text-align: center;
    }
    
    .pp-gallery-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .pp-gallery-item {
        aspect-ratio: 1;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        overflow: hidden;
        background: rgba(30, 41, 59, 0.5);
    }
    
    .pp-gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        image-rendering: -webkit-optimize-contrast;
    }
    
    /* CTAs */
    .pp-cta-section {
        margin-bottom: 16px;
    }
    
    .pp-cta-primary {
        width: 100%;
        padding: 10px 16px;
        background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #7C3AED 100%);
        border: none;
        border-radius: 20px;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.35);
    }
    
    .pp-cta-row {
        display: flex;
        gap: 6px;
    }
    
    .pp-cta-secondary {
        flex: 1;
        padding: 8px 10px;
        border-radius: 16px;
        border: 2px solid;
        background: transparent;
        font-size: 0.65rem;
        font-weight: 500;
        cursor: pointer;
    }
    
    .pp-whatsapp {
        border-color: #25D366;
        color: #25D366;
    }
    
    .pp-call {
        border-color: #8B5CF6;
        color: #A78BFA;
    }
    
    .pp-email {
        border-color: #F59E0B;
        color: #FBBF24;
    }
    
    /* Contact Form */
    .pp-form-section {
        border-top: 1px solid rgba(139, 92, 246, 0.15);
        padding-top: 14px;
    }
    
    .pp-form-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(255,255,255,0.9);
        margin: 0 0 4px;
    }
    
    .pp-form-subtitle {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.5);
        margin: 0 0 12px;
    }
    
    .pp-form-field {
        margin-bottom: 10px;
    }
    
    .pp-form-field label {
        display: block;
        font-size: 0.6rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 4px;
    }
    
    .pp-input {
        padding: 8px 10px;
        background: rgba(25, 18, 45, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        font-size: 0.65rem;
        color: rgba(255,255,255,0.6);
    }
    
    .pp-phone-row {
        display: flex;
        gap: 6px;
    }
    
    .pp-country-code {
        padding: 8px 10px;
        background: rgba(25, 18, 45, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        font-size: 0.6rem;
        color: rgba(255,255,255,0.7);
        white-space: nowrap;
    }
    
    .pp-phone-input {
        flex: 1;
    }
    
    .pp-textarea {
        padding: 8px 10px;
        background: rgba(25, 18, 45, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        font-size: 0.65rem;
        color: rgba(255,255,255,0.5);
        min-height: 40px;
    }
    
    .pp-submit-btn {
        width: 100%;
        padding: 10px 16px;
        background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);
        border: none;
        border-radius: 10px;
        color: rgba(255,255,255,0.6);
        font-size: 0.7rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
    }
    
    /* Footer */
    .pp-footer {
        text-align: center;
        padding: 16px 0 8px;
        font-size: 0.55rem;
        color: rgba(255,255,255,0.4);
    }
    
    .pp-footer strong {
        color: rgba(255,255,255,0.6);
    }


    /* Labels */
    .item-label { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-top: 16px; }
    .item-name { font-size: 1rem; font-weight: 600; color: #f3f4f6; }
    .carousel-item:not(.carousel-item--active) .item-name { color: #9ca3af; }
    .selected-badge { font-size: 0.7rem; color: #a5b4fc; background: rgba(99,102,241,0.15); padding: 5px 12px; border-radius: 14px; }

    /* Navigation arrows */
    .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 180ms; z-index: 60; }
    .nav-arrow:hover { background: rgba(255,255,255,0.08); color: #f3f4f6; }
    .nav-arrow--left { left: 16px; }
    .nav-arrow--right { right: 16px; }

    /* Decision dock */
    .decision-dock { padding: 16px 32px 20px; }
    .dock-content { display: flex; align-items: center; justify-content: center; gap: 36px; padding: 16px 28px; background: rgba(18,24,32,0.9); border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; backdrop-filter: blur(16px); max-width: 720px; margin: 0 auto; }
    .dock-info { display: flex; flex-direction: column; min-width: 160px; }
    .dock-name { font-size: 1.1rem; font-weight: 600; color: #f3f4f6; }
    .dock-desc { font-size: 0.825rem; color: #9ca3af; }
    .dock-dots { display: flex; gap: 10px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; border: none; background: rgba(255,255,255,0.12); cursor: pointer; padding: 0; transition: all 220ms; }
    .dot--active { background: #6366f1; width: 28px; border-radius: 6px; }
    .cta-primary { display: flex; align-items: center; gap: 8px; padding: 13px 26px; border-radius: 26px; border: none; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 200ms; }
    .cta-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(99,102,241,0.35); }

    /* Reduced motion */
    @@media (prefers-reduced-motion: reduce) {
        .carousel-item { transition: opacity 200ms ease, transform 200ms ease; }
        .nav-next .carousel-item--active, .nav-prev .carousel-item--active { animation: none; }
    }

    /* Responsive */
    @@media (max-width: 900px) {
        .templates-module { padding: 70px 16px 20px; --phone-width: clamp(200px, 50vw, 260px); --phone-height: clamp(420px, 55vh, 520px); }
        .carousel-section { padding: 0 48px; }
        .dock-content { gap: 20px; padding: 14px 20px; flex-wrap: wrap; }
    }
</style>

@code {
    private class TemplateData
    {
        public Guid Id { get; init; } = Guid.NewGuid();
        public required string Name { get; init; }
        public required string Description { get; init; }
        public required string HeroGradient { get; init; }
        public bool IsPortfolio { get; init; } = false;
        public string TemplateType { get; init; } = "default";
    }

    // User data for portfolio preview
    private DataTouch.Domain.Entities.Card? _userCard;

    private int _activeIndex = 3; // Start at Portafolio Creativo (index 3)
    private bool _hasScrolled = false;
    private string _navDirection = "";
    private DateTime _lastNavTime = DateTime.MinValue;
    private readonly int[] _visiblePositions = { -2, -1, 0, 1, 2 };

    protected override async Task OnInitializedAsync()
    {
        // Load authenticated user's card data
        var email = AuthService.GetCurrentEmail();
        if (!string.IsNullOrEmpty(email))
        {
            _userCard = await DbContext.Cards
                .Include(c => c.Organization)
                .FirstOrDefaultAsync(c => c.Email == email);
        }
    }

    private string GetUserDisplayName()
    {
        // Priority: FullName > Email username > "Tu Nombre"
        if (!string.IsNullOrEmpty(_userCard?.FullName))
            return _userCard.FullName;
        
        var email = AuthService.GetCurrentEmail();
        if (!string.IsNullOrEmpty(email))
        {
            var atIndex = email.IndexOf('@');
            if (atIndex > 0)
                return email.Substring(0, atIndex);
        }
        
        return "Tu Nombre";
    }

    private string GetUserInitials()
    {
        var name = GetUserDisplayName();
        if (string.IsNullOrEmpty(name) || name == "Tu Nombre")
            return "TN";
        
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private readonly List<TemplateData> _templates = new()
    {
        new() { Name = "Creative", Description = "Stand out with modern designs.", HeroGradient = "linear-gradient(135deg, #ec4899, #f97316)", TemplateType = "creative" },
        new() { Name = "Minimal", Description = "Clean and distraction-free.", HeroGradient = "linear-gradient(135deg, #6b7280, #4b5563)", TemplateType = "minimal" },
        new() { Name = "Professional", Description = "Best for sales and enterprise.", HeroGradient = "linear-gradient(135deg, #6366f1, #8b5cf6)", TemplateType = "professional" },
        new() { Name = "Portafolio Creativo", Description = "GalerÃ­a visual para creativos y artistas.", HeroGradient = "linear-gradient(135deg, #8B5CF6, #EC4899)", IsPortfolio = true, TemplateType = "portfolio-creative" },
        new() { Name = "Corporate", Description = "Strong branding presence.", HeroGradient = "linear-gradient(135deg, #0ea5e9, #3b82f6)", TemplateType = "corporate" },
        new() { Name = "Bold", Description = "Make a powerful statement.", HeroGradient = "linear-gradient(135deg, #f43f5e, #e11d48)", TemplateType = "bold" }
    };

    private TemplateData? SelectedTemplate => _templates.Count > 0 ? _templates[_activeIndex] : null;

    private int WrapIndex(int index) { var c = _templates.Count; return ((index % c) + c) % c; }
    private TemplateData GetTemplateAt(int pos) => _templates[WrapIndex(_activeIndex + pos)];
    private string GetStateClass(int pos) => pos switch { 0 => "carousel-item--active", -1 => "carousel-item--adjacent-left", 1 => "carousel-item--adjacent-right", -2 => "carousel-item--far-left", 2 => "carousel-item--far-right", _ => "" };
    private string GetItemStyle(int pos) => $"z-index: {pos switch { 0 => 50, -1 or 1 => 30, _ => 15 }};";

    private async Task NavigateNext()
    {
        if (IsThrottled()) return;
        _navDirection = "nav-next";
        _activeIndex = WrapIndex(_activeIndex + 1);
        StateHasChanged();
        await Task.Delay(750);
        _navDirection = "";
    }

    private async Task NavigatePrev()
    {
        if (IsThrottled()) return;
        _navDirection = "nav-prev";
        _activeIndex = WrapIndex(_activeIndex - 1);
        StateHasChanged();
        await Task.Delay(750);
        _navDirection = "";
    }

    private void GoToIndex(int idx) { if (idx != _activeIndex) { _navDirection = idx > _activeIndex ? "nav-next" : "nav-prev"; _activeIndex = WrapIndex(idx); } }
    private void HandleCardClick(int pos) { if (pos > 0) _ = NavigateNext(); else if (pos < 0) _ = NavigatePrev(); }
    private bool IsThrottled() { var now = DateTime.Now; if ((now - _lastNavTime).TotalMilliseconds < 700) return true; _lastNavTime = now; return false; }
    private async Task HandleKeyDown(KeyboardEventArgs e) { if (e.Key == "ArrowRight") await NavigateNext(); else if (e.Key == "ArrowLeft") await NavigatePrev(); else if (e.Key == "Enter" || e.Key == " ") UseThisDesign(); }
    private void HandlePhoneScroll(WheelEventArgs e) { if (!_hasScrolled) { _hasScrolled = true; StateHasChanged(); } }
    private void HandleWheel(WheelEventArgs e) { }
    private void UseThisDesign() { if (SelectedTemplate != null) { Snackbar.Add($"âœ“ DiseÃ±o seleccionado: {SelectedTemplate.Name}", Severity.Success); Navigation.NavigateTo($"/cards/mine?template={SelectedTemplate.TemplateType}"); } }
}
