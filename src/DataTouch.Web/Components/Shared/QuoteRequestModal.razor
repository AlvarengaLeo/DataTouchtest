@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUOTE REQUEST MODAL - Progressive 3-Step Form
   Enterprise-grade quote request capture from public card
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@
@using DataTouch.Web.Services

<MudDialog Class="quote-request-modal">
    <TitleContent>
        <div class="modal-header-custom">
            <MudText Typo="Typo.h6">ğŸ“ Solicita tu cotizaciÃ³n personalizada</MudText>
            <div class="step-indicator">
                @for (int i = 1; i <= 3; i++)
                {
                    var step = i;
                    <div class="step-dot @(CurrentStep >= step ? "step-active" : "") @(CurrentStep == step ? "step-current" : "")"></div>
                    @if (i < 3)
                    {
                        <div class="step-line @(CurrentStep > step ? "step-line-active" : "")"></div>
                    }
                }
            </div>
        </div>
    </TitleContent>
    <DialogContent>
        @if (_isSubmitting)
        {
            <div class="loading-state">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body1" Class="mt-3">Enviando tu solicitud...</MudText>
            </div>
        }
        else if (_isSuccess)
        {
            <div class="success-state">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.h5" Class="mt-3">Â¡Solicitud enviada!</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                    Te contactaremos en menos de 24 horas
                </MudText>
                <div class="success-summary">
                    <div class="summary-item">
                        <span class="summary-label">Servicio:</span>
                        <span class="summary-value">@_selectedService?.Name</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Email:</span>
                        <span class="summary-value">@_email</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            @* STEP 1: Service Selection *@
            @if (CurrentStep == 1)
            {
                <div class="step-content">
                    <MudText Typo="Typo.subtitle1" Class="step-title">Â¿QuÃ© servicio te interesa?</MudText>
                    
                    @if (Services?.Any() == true)
                    {
                        <div class="service-select-list">
                            @foreach (var service in Services.Where(s => s.IsActive))
                            {
                                <div class="service-select-card @(_selectedServiceId == service.Id ? "service-selected" : "")"
                                     @onclick="@(() => SelectService(service))">
                                    <div class="service-select-icon">ğŸ’¼</div>
                                    <div class="service-select-info">
                                        <span class="service-select-name">@service.Name</span>
                                        <span class="service-select-meta">
                                            @if (service.DurationMinutes > 0)
                                            {
                                                <span>@service.DurationMinutes min</span>
                                            }
                                            @if (service.PriceFrom.HasValue)
                                            {
                                                <span>Â· Desde $@service.PriceFrom</span>
                                            }
                                        </span>
                                    </div>
                                    @if (_selectedServiceId == service.Id)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" />
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">No hay servicios disponibles actualmente.</MudAlert>
                    }
                </div>
            }
            
            @* STEP 2: Contact Information *@
            @if (CurrentStep == 2)
            {
                <div class="step-content">
                    <MudText Typo="Typo.subtitle1" Class="step-title">Â¿CÃ³mo te contactamos?</MudText>
                    
                    <MudTextField @bind-Value="_fullName"
                                  Label="Nombre completo"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  Immediate="true"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_email"
                                  Label="Email"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Required="true"
                                  Immediate="true"
                                  Class="mb-3" />
                    
                    <MudTextField @bind-Value="_phone"
                                  Label="TelÃ©fono (recomendado)"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Telephone"
                                  Immediate="true"
                                  HelperText="Para una respuesta mÃ¡s rÃ¡pida" />
                </div>
            }
            
            @* STEP 3: Details (Optional) *@
            @if (CurrentStep == 3)
            {
                <div class="step-content">
                    <MudText Typo="Typo.subtitle1" Class="step-title">
                        CuÃ©ntanos mÃ¡s <MudChip T="string" Size="Size.Small" Color="Color.Default">Opcional</MudChip>
                    </MudText>
                    
                    <MudTextField @bind-Value="_description"
                                  Label="Â¿QuÃ© necesitas?"
                                  Variant="Variant.Outlined"
                                  Lines="4"
                                  MaxLength="500"
                                  Counter="500"
                                  Immediate="true"
                                  HelperText="Describe brevemente tu necesidad para darte una mejor cotizaciÃ³n" />
                </div>
            }
        }
    </DialogContent>
    <DialogActions>
        @if (!_isSuccess && !_isSubmitting)
        {
            @if (CurrentStep > 1)
            {
                <MudButton OnClick="PreviousStep" Variant="Variant.Text" Color="Color.Default">
                    â† AtrÃ¡s
                </MudButton>
            }
            
            <MudSpacer />
            
            @if (CurrentStep < 3)
            {
                <MudButton OnClick="NextStep" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary"
                           Disabled="@(!CanProceed)">
                    Continuar â†’
                </MudButton>
            }
            else
            {
                <MudButton OnClick="Submit" 
                           Variant="Variant.Filled" 
                           Color="Color.Primary"
                           Disabled="@(!CanSubmit)">
                    Enviar solicitud
                </MudButton>
            }
        }
        else if (_isSuccess)
        {
            <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">
                Cerrar
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [Inject] private QuoteService QuoteService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }
    
    [Parameter] public List<DataTouch.Domain.Entities.Service>? Services { get; set; }
    [Parameter] public Guid CardId { get; set; }
    [Parameter] public Guid? PreselectedServiceId { get; set; }
    
    private int CurrentStep { get; set; } = 1;
    
    // Form fields
    private Guid? _selectedServiceId;
    private DataTouch.Domain.Entities.Service? _selectedService;
    private string _fullName = "";
    private string _email = "";
    private string _phone = "";
    private string _description = "";
    
    // State
    private bool _isSubmitting = false;
    private bool _isSuccess = false;
    private string? _errorMessage;
    private string? _requestNumber;
    private string _idempotencyKey = Guid.NewGuid().ToString();
    
    protected override void OnInitialized()
    {
        // If preselected or only one service, auto-select
        if (PreselectedServiceId.HasValue)
        {
            _selectedServiceId = PreselectedServiceId;
            _selectedService = Services?.FirstOrDefault(s => s.Id == PreselectedServiceId);
        }
        else if (Services?.Count == 1)
        {
            var single = Services.First();
            _selectedServiceId = single.Id;
            _selectedService = single;
            CurrentStep = 2; // Skip step 1
        }
    }
    
    private void SelectService(DataTouch.Domain.Entities.Service service)
    {
        _selectedServiceId = service.Id;
        _selectedService = service;
    }
    
    private bool CanProceed => CurrentStep switch
    {
        1 => _selectedServiceId.HasValue,
        2 => !string.IsNullOrWhiteSpace(_fullName) && IsValidEmail(_email),
        _ => true
    };
    
    private bool CanSubmit => CanProceed && CurrentStep == 3;
    
    private bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email)) return false;
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email.Trim();
        }
        catch
        {
            return false;
        }
    }
    
    private void NextStep()
    {
        if (CurrentStep < 3 && CanProceed)
            CurrentStep++;
    }
    
    private void PreviousStep()
    {
        if (CurrentStep > 1)
            CurrentStep--;
    }
    
    private async Task Submit()
    {
        if (!CanSubmit && CurrentStep != 3) return;
        if (!_selectedServiceId.HasValue) return;
        
        _isSubmitting = true;
        StateHasChanged();
        
        try
        {
            var dto = new CreateQuoteDto
            {
                CardId = CardId,
                ServiceId = _selectedServiceId.Value,
                CustomerName = _fullName.Trim(),
                CustomerEmail = _email.Trim().ToLowerInvariant(),
                CustomerPhone = string.IsNullOrWhiteSpace(_phone) ? null : _phone.Trim(),
                Description = string.IsNullOrWhiteSpace(_description) ? null : _description.Trim(),
                IdempotencyKey = _idempotencyKey
            };
            
            var result = await QuoteService.CreatePublicQuoteAsync(dto);
            
            if (result.Success)
            {
                _isSuccess = true;
                _requestNumber = result.RequestNumber;
                
                if (result.IsDuplicate)
                {
                    Snackbar.Add("Tu solicitud ya fue registrada anteriormente", Severity.Info);
                }
            }
            else
            {
                _errorMessage = result.Error;
                Snackbar.Add(result.Error ?? "Error al enviar la solicitud", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            Snackbar.Add("Error inesperado. Por favor intenta de nuevo.", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }
    
    private void Close()
    {
        MudDialog?.Close(DialogResult.Ok(true));
    }
}

<style>
    .quote-request-modal {
        max-width: 480px;
    }
    
    .modal-header-custom {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .step-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }
    
    .step-dot.step-active {
        background: var(--mud-palette-primary);
    }
    
    .step-dot.step-current {
        transform: scale(1.3);
        box-shadow: 0 0 0 3px rgba(var(--mud-palette-primary-rgb), 0.3);
    }
    
    .step-line {
        width: 40px;
        height: 2px;
        background: rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }
    
    .step-line-active {
        background: var(--mud-palette-primary);
    }
    
    .step-content {
        min-height: 200px;
    }
    
    .step-title {
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .service-select-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .service-select-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .service-select-card:hover {
        background: rgba(255,255,255,0.08);
        border-color: var(--mud-palette-primary);
    }
    
    .service-select-card.service-selected {
        background: rgba(var(--mud-palette-primary-rgb), 0.15);
        border-color: var(--mud-palette-primary);
    }
    
    .service-select-icon {
        font-size: 1.5rem;
    }
    
    .service-select-info {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .service-select-name {
        font-weight: 500;
    }
    
    .service-select-meta {
        font-size: 0.85rem;
        color: var(--mud-palette-text-secondary);
    }
    
    .loading-state, .success-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
    }
    
    .success-summary {
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        width: 100%;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
    }
    
    .summary-label {
        color: var(--mud-palette-text-secondary);
    }
    
    .summary-value {
        font-weight: 500;
    }
</style>
